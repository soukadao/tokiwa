{
  "version": 3,
  "sources": ["../src/core/errors.ts", "../src/core/config.ts", "../src/core/database-adapter.ts", "../src/core/file-system.ts", "../src/core/generate-id.ts", "../node_modules/.pnpm/@date-fns+tz@1.4.1/node_modules/@date-fns/tz/tzName/index.js", "../node_modules/.pnpm/@date-fns+tz@1.4.1/node_modules/@date-fns/tz/tzOffset/index.js", "../node_modules/.pnpm/@date-fns+tz@1.4.1/node_modules/@date-fns/tz/date/mini.js", "../node_modules/.pnpm/@date-fns+tz@1.4.1/node_modules/@date-fns/tz/date/index.js", "../src/core/logger.ts", "../src/cron/cron.ts", "../src/cron/leader-scheduler.ts", "../src/cron/scheduler.ts", "../src/orchestrator/connection.ts", "../src/orchestrator/event.ts", "../src/orchestrator/subscriber.ts", "../src/orchestrator/event-dispatcher.ts", "../src/orchestrator/notification.ts", "../src/workflow/run-store.ts", "../src/workflow/runner.ts", "../src/orchestrator/queue.ts", "../src/orchestrator/snapshot.ts", "../src/orchestrator/orchestrator.ts", "../src/utils/exec-async.ts", "../src/utils/command.ts", "../src/utils/performance.ts", "../src/workflow/memory-diff.ts", "../src/workflow/conversation-store.ts", "../src/workflow/node.ts", "../src/workflow/workflow.ts"],
  "sourcesContent": ["/**\n * \u30A2\u30D7\u30EA\u30B1\u30FC\u30B7\u30E7\u30F3\u5171\u901A\u306E\u57FA\u5E95\u30A8\u30E9\u30FC\u30AF\u30E9\u30B9\n * \u30B5\u30D6\u30AF\u30E9\u30B9\u540D\u3092\u81EA\u52D5\u7684\u306Bname\u30D7\u30ED\u30D1\u30C6\u30A3\u306B\u8A2D\u5B9A\u3059\u308B\n */\nexport class AppError extends Error {\n  /**\n   * @param message \u30A8\u30E9\u30FC\u30E1\u30C3\u30BB\u30FC\u30B8\n   * @param options \u30A8\u30E9\u30FC\u30AA\u30D7\u30B7\u30E7\u30F3\uFF08cause\u306A\u3069\uFF09\n   */\n  constructor(message: string, options: ErrorOptions = {}) {\n    super(message, options);\n    this.name = this.constructor.name;\n  }\n}\n\n/** \u7121\u52B9\u306A\u5F15\u6570\u304C\u6E21\u3055\u308C\u305F\u5834\u5408\u306E\u30A8\u30E9\u30FC */\nexport class InvalidArgumentError extends AppError {}\n\n/** \u5B9F\u884C\u6642\u30A8\u30E9\u30FC */\nexport class RuntimeError extends AppError {}\n\n/** \u30EA\u30BD\u30FC\u30B9\u304C\u898B\u3064\u304B\u3089\u306A\u3044\u5834\u5408\u306E\u30A8\u30E9\u30FC */\nexport class NotFoundError extends AppError {}\n\n/** \u30EA\u30BD\u30FC\u30B9\u306E\u7AF6\u5408\u304C\u767A\u751F\u3057\u305F\u5834\u5408\u306E\u30A8\u30E9\u30FC */\nexport class ConflictError extends AppError {}\n\n/** \u4E0D\u6B63\u306A\u72B6\u614B\u3067\u64CD\u4F5C\u304C\u5B9F\u884C\u3055\u308C\u305F\u5834\u5408\u306E\u30A8\u30E9\u30FC */\nexport class StateError extends AppError {}\n\n/** \u4F9D\u5B58\u95A2\u4FC2\u306B\u554F\u984C\u304C\u3042\u308B\u5834\u5408\u306E\u30A8\u30E9\u30FC */\nexport class DependencyError extends AppError {}\n\n/** \u5FAA\u74B0\u4F9D\u5B58\u304C\u691C\u51FA\u3055\u308C\u305F\u5834\u5408\u306E\u30A8\u30E9\u30FC */\nexport class CyclicDependencyError extends DependencyError {}\n\n/** \u30B7\u30EA\u30A2\u30E9\u30A4\u30BA/\u30C7\u30B7\u30EA\u30A2\u30E9\u30A4\u30BA\u306B\u5931\u6557\u3057\u305F\u5834\u5408\u306E\u30A8\u30E9\u30FC */\nexport class SerializationError extends AppError {}\n", "import { InvalidArgumentError } from \"./errors.js\";\n\nconst NUMBER_PATTERN = /^-?\\d+(\\.\\d+)?$/;\nconst BOOLEAN_TRUE_VALUES = new Set([\"true\", \"1\", \"yes\", \"on\"]);\nconst BOOLEAN_FALSE_VALUES = new Set([\"false\", \"0\", \"no\", \"off\"]);\nconst EMPTY_PREFIX = \"\";\n\nexport interface EnvLoadOptions {\n  prefix?: string;\n  parseNumbers?: boolean;\n  parseBooleans?: boolean;\n}\n\n/**\n * \u30AD\u30FC\u30D0\u30EA\u30E5\u30FC\u5F62\u5F0F\u306E\u8A2D\u5B9A\u30B9\u30C8\u30A2\n * \u74B0\u5883\u5909\u6570\u304B\u3089\u306E\u8AAD\u307F\u8FBC\u307F\u3084\u578B\u5B89\u5168\u306A\u5024\u53D6\u5F97\u3092\u30B5\u30DD\u30FC\u30C8\u3059\u308B\n */\nexport class Config {\n  private readonly store = new Map<string, unknown>();\n\n  /**\n   * \u8A2D\u5B9A\u5024\u3092\u4FDD\u5B58\u3059\u308B\n   * @param key \u8A2D\u5B9A\u30AD\u30FC\n   * @param value \u8A2D\u5B9A\u5024\n   */\n  set<T>(key: string, value: T): void {\n    this.store.set(key, value);\n  }\n\n  /**\n   * \u8A2D\u5B9A\u5024\u3092\u53D6\u5F97\u3059\u308B\n   * @param key \u8A2D\u5B9A\u30AD\u30FC\n   * @returns \u8A2D\u5B9A\u5024\u3002\u30AD\u30FC\u304C\u5B58\u5728\u3057\u306A\u3044\u5834\u5408\u306Fundefined\n   */\n  get<T>(key: string): T | undefined {\n    return this.store.get(key) as T | undefined;\n  }\n\n  /**\n   * \u6307\u5B9A\u30AD\u30FC\u304C\u5B58\u5728\u3059\u308B\u304B\u78BA\u8A8D\u3059\u308B\n   * @param key \u8A2D\u5B9A\u30AD\u30FC\n   * @returns \u30AD\u30FC\u304C\u5B58\u5728\u3059\u308C\u3070true\n   */\n  has(key: string): boolean {\n    return this.store.has(key);\n  }\n\n  /**\n   * \u6307\u5B9A\u30AD\u30FC\u306E\u8A2D\u5B9A\u5024\u3092\u524A\u9664\u3059\u308B\n   * @param key \u8A2D\u5B9A\u30AD\u30FC\n   * @returns \u30AD\u30FC\u304C\u5B58\u5728\u3057\u3066\u524A\u9664\u3055\u308C\u305F\u3089true\n   */\n  delete(key: string): boolean {\n    return this.store.delete(key);\n  }\n\n  /** \u3059\u3079\u3066\u306E\u8A2D\u5B9A\u5024\u3092\u30AF\u30EA\u30A2\u3059\u308B */\n  clear(): void {\n    this.store.clear();\n  }\n\n  /**\n   * \u74B0\u5883\u5909\u6570\u304B\u3089\u8A2D\u5B9A\u3092\u8AAD\u307F\u8FBC\u3080\n   * prefix\u3067\u7D5E\u308A\u8FBC\u307F\u3001\u6570\u5024\u30FB\u771F\u507D\u5024\u306E\u81EA\u52D5\u30D1\u30FC\u30B9\u304C\u53EF\u80FD\n   * @param options \u8AAD\u307F\u8FBC\u307F\u30AA\u30D7\u30B7\u30E7\u30F3\n   */\n  loadFromEnv(options: EnvLoadOptions = {}): void {\n    const prefix = options.prefix ?? EMPTY_PREFIX;\n    const parseNumbers = options.parseNumbers ?? true;\n    const parseBooleans = options.parseBooleans ?? true;\n\n    for (const [key, value] of Object.entries(process.env)) {\n      if (!key.startsWith(prefix) || value === undefined) {\n        continue;\n      }\n\n      const normalizedKey = prefix ? key.slice(prefix.length) : key;\n      const parsed = this.parseEnvValue(value, parseNumbers, parseBooleans);\n      this.set(normalizedKey, parsed);\n    }\n  }\n\n  /**\n   * \u6587\u5B57\u5217\u578B\u3068\u3057\u3066\u8A2D\u5B9A\u5024\u3092\u53D6\u5F97\u3059\u308B\n   * @param key \u8A2D\u5B9A\u30AD\u30FC\n   * @param fallback \u30AD\u30FC\u304C\u5B58\u5728\u3057\u306A\u3044\u5834\u5408\u306E\u30C7\u30D5\u30A9\u30EB\u30C8\u5024\n   * @returns \u6587\u5B57\u5217\u5024\u3002\u30AD\u30FC\u304C\u5B58\u5728\u305B\u305Afallback\u3082\u306A\u3044\u5834\u5408\u306Fundefined\n   * @throws {InvalidArgumentError} \u5024\u304C\u6587\u5B57\u5217\u3067\u306A\u3044\u5834\u5408\n   */\n  getString(key: string, fallback?: string): string | undefined {\n    const value = this.get<unknown>(key);\n    if (value === undefined) {\n      return fallback;\n    }\n    if (typeof value === \"string\") {\n      return value;\n    }\n    throw new InvalidArgumentError(`Config value for ${key} is not a string`);\n  }\n\n  /**\n   * \u6570\u5024\u578B\u3068\u3057\u3066\u8A2D\u5B9A\u5024\u3092\u53D6\u5F97\u3059\u308B\n   * @param key \u8A2D\u5B9A\u30AD\u30FC\n   * @param fallback \u30AD\u30FC\u304C\u5B58\u5728\u3057\u306A\u3044\u5834\u5408\u306E\u30C7\u30D5\u30A9\u30EB\u30C8\u5024\n   * @returns \u6570\u5024\u3002\u30AD\u30FC\u304C\u5B58\u5728\u305B\u305Afallback\u3082\u306A\u3044\u5834\u5408\u306Fundefined\n   * @throws {InvalidArgumentError} \u5024\u304C\u6570\u5024\u306B\u5909\u63DB\u3067\u304D\u306A\u3044\u5834\u5408\n   */\n  getNumber(key: string, fallback?: number): number | undefined {\n    const value = this.get<unknown>(key);\n    if (value === undefined) {\n      return fallback;\n    }\n    if (typeof value === \"number\" && Number.isFinite(value)) {\n      return value;\n    }\n    if (typeof value === \"string\" && NUMBER_PATTERN.test(value)) {\n      const parsed = Number(value);\n      if (Number.isFinite(parsed)) {\n        return parsed;\n      }\n    }\n    throw new InvalidArgumentError(`Config value for ${key} is not a number`);\n  }\n\n  /**\n   * \u771F\u507D\u5024\u578B\u3068\u3057\u3066\u8A2D\u5B9A\u5024\u3092\u53D6\u5F97\u3059\u308B\n   * \u6587\u5B57\u5217\u306E\u5834\u5408\u3001\"true\"/\"1\"/\"yes\"/\"on\"\u306Ftrue\u3001\"false\"/\"0\"/\"no\"/\"off\"\u306Ffalse\u3068\u3057\u3066\u6271\u3046\n   * @param key \u8A2D\u5B9A\u30AD\u30FC\n   * @param fallback \u30AD\u30FC\u304C\u5B58\u5728\u3057\u306A\u3044\u5834\u5408\u306E\u30C7\u30D5\u30A9\u30EB\u30C8\u5024\n   * @returns \u771F\u507D\u5024\u3002\u30AD\u30FC\u304C\u5B58\u5728\u305B\u305Afallback\u3082\u306A\u3044\u5834\u5408\u306Fundefined\n   * @throws {InvalidArgumentError} \u5024\u304C\u771F\u507D\u5024\u306B\u5909\u63DB\u3067\u304D\u306A\u3044\u5834\u5408\n   */\n  getBoolean(key: string, fallback?: boolean): boolean | undefined {\n    const value = this.get<unknown>(key);\n    if (value === undefined) {\n      return fallback;\n    }\n    if (typeof value === \"boolean\") {\n      return value;\n    }\n    if (typeof value === \"string\") {\n      const normalized = value.toLowerCase();\n      if (BOOLEAN_TRUE_VALUES.has(normalized)) {\n        return true;\n      }\n      if (BOOLEAN_FALSE_VALUES.has(normalized)) {\n        return false;\n      }\n    }\n    throw new InvalidArgumentError(`Config value for ${key} is not a boolean`);\n  }\n\n  /**\n   * \u5FC5\u9808\u306E\u8A2D\u5B9A\u5024\u3092\u53D6\u5F97\u3059\u308B\n   * @param key \u8A2D\u5B9A\u30AD\u30FC\n   * @returns \u8A2D\u5B9A\u5024\n   * @throws {InvalidArgumentError} \u30AD\u30FC\u304C\u5B58\u5728\u3057\u306A\u3044\u5834\u5408\n   */\n  getRequired<T>(key: string): T {\n    const value = this.get<T>(key);\n    if (value === undefined) {\n      throw new InvalidArgumentError(`Missing required config value: ${key}`);\n    }\n    return value;\n  }\n\n  /**\n   * \u74B0\u5883\u5909\u6570\u306E\u6587\u5B57\u5217\u5024\u3092\u9069\u5207\u306A\u578B\u306B\u30D1\u30FC\u30B9\u3059\u308B\n   * @param value \u74B0\u5883\u5909\u6570\u306E\u6587\u5B57\u5217\u5024\n   * @param parseNumbers \u6570\u5024\u30D1\u30FC\u30B9\u3092\u6709\u52B9\u306B\u3059\u308B\u304B\n   * @param parseBooleans \u771F\u507D\u5024\u30D1\u30FC\u30B9\u3092\u6709\u52B9\u306B\u3059\u308B\u304B\n   * @returns \u30D1\u30FC\u30B9\u3055\u308C\u305F\u5024\n   */\n  private parseEnvValue(\n    value: string,\n    parseNumbers: boolean,\n    parseBooleans: boolean,\n  ): string | number | boolean {\n    if (parseBooleans) {\n      const normalized = value.toLowerCase();\n      if (BOOLEAN_TRUE_VALUES.has(normalized)) {\n        return true;\n      }\n      if (BOOLEAN_FALSE_VALUES.has(normalized)) {\n        return false;\n      }\n    }\n\n    if (parseNumbers && NUMBER_PATTERN.test(value)) {\n      const parsed = Number(value);\n      if (Number.isFinite(parsed)) {\n        return parsed;\n      }\n    }\n\n    return value;\n  }\n}\n/**\n * \u65B0\u3057\u3044Config\u30A4\u30F3\u30B9\u30BF\u30F3\u30B9\u3092\u751F\u6210\u3059\u308B\u30D5\u30A1\u30AF\u30C8\u30EA\u95A2\u6570\n * @returns \u65B0\u3057\u3044Config\u30A4\u30F3\u30B9\u30BF\u30F3\u30B9\n */\nexport const createConfig = (): Config => new Config();\n", "import { StateError } from \"./errors.js\";\n\nexport type DatabaseType = \"postgres\" | \"mysql\" | \"sqlite\";\n\nexport type QueryValue = string | number | boolean | null | Date | Buffer;\n\nexport interface QueryResult<T = Record<string, unknown>> {\n  rows: T[];\n  rowCount: number;\n}\n\nexport interface DatabaseDriver {\n  connect(): Promise<void>;\n  disconnect(): Promise<void>;\n  query<T = Record<string, unknown>>(\n    sql: string,\n    params?: readonly QueryValue[],\n  ): Promise<QueryResult<T>>;\n}\n\nexport interface DatabaseAdapterOptions {\n  type: DatabaseType;\n  driver: DatabaseDriver;\n}\n\nconst DISCONNECTED_MESSAGE = \"Database is not connected\";\n\n/**\n * \u30C7\u30FC\u30BF\u30D9\u30FC\u30B9\u30C9\u30E9\u30A4\u30D0\u30FC\u306E\u30E9\u30C3\u30D1\u30FC\n * \u63A5\u7D9A\u72B6\u614B\u306E\u7BA1\u7406\u3068\u30AF\u30A8\u30EA\u5B9F\u884C\u6642\u306E\u72B6\u614B\u30C1\u30A7\u30C3\u30AF\u3092\u884C\u3046\n */\nexport class DatabaseAdapter {\n  readonly type: DatabaseType;\n  private readonly driver: DatabaseDriver;\n  private connected = false;\n\n  /**\n   * @param options \u30C7\u30FC\u30BF\u30D9\u30FC\u30B9\u306E\u7A2E\u985E\u3068\u30C9\u30E9\u30A4\u30D0\u30FC\u8A2D\u5B9A\n   */\n  constructor(options: DatabaseAdapterOptions) {\n    this.type = options.type;\n    this.driver = options.driver;\n  }\n\n  /** \u30C7\u30FC\u30BF\u30D9\u30FC\u30B9\u304C\u63A5\u7D9A\u4E2D\u304B\u3069\u3046\u304B\u3092\u8FD4\u3059 */\n  get isConnected(): boolean {\n    return this.connected;\n  }\n\n  /** \u30C7\u30FC\u30BF\u30D9\u30FC\u30B9\u306B\u63A5\u7D9A\u3059\u308B\u3002\u65E2\u306B\u63A5\u7D9A\u6E08\u307F\u306E\u5834\u5408\u306F\u4F55\u3082\u3057\u306A\u3044 */\n  async connect(): Promise<void> {\n    if (this.connected) {\n      return;\n    }\n    await this.driver.connect();\n    this.connected = true;\n  }\n\n  /** \u30C7\u30FC\u30BF\u30D9\u30FC\u30B9\u304B\u3089\u5207\u65AD\u3059\u308B\u3002\u65E2\u306B\u5207\u65AD\u6E08\u307F\u306E\u5834\u5408\u306F\u4F55\u3082\u3057\u306A\u3044 */\n  async disconnect(): Promise<void> {\n    if (!this.connected) {\n      return;\n    }\n    await this.driver.disconnect();\n    this.connected = false;\n  }\n\n  /**\n   * SQL\u30AF\u30A8\u30EA\u3092\u5B9F\u884C\u3059\u308B\n   * @param sql SQL\u6587\n   * @param params \u30D0\u30A4\u30F3\u30C9\u30D1\u30E9\u30E1\u30FC\u30BF\n   * @returns \u30AF\u30A8\u30EA\u7D50\u679C\n   * @throws {StateError} \u672A\u63A5\u7D9A\u306E\u5834\u5408\n   */\n  async query<T = Record<string, unknown>>(\n    sql: string,\n    params: readonly QueryValue[] = [],\n  ): Promise<QueryResult<T>> {\n    if (!this.connected) {\n      throw new StateError(DISCONNECTED_MESSAGE);\n    }\n    return this.driver.query<T>(sql, params);\n  }\n}\n", "import { promises as fs, type Stats } from \"node:fs\";\nimport { dirname, resolve } from \"node:path\";\nimport { SerializationError } from \"./errors.js\";\n\nconst DEFAULT_ENCODING: BufferEncoding = \"utf8\";\nconst DEFAULT_JSON_INDENT = 2;\nconst JSON_LINE_ENDING = \"\\n\";\n\nexport interface FileSystemOptions {\n  baseDir?: string;\n}\n\n/**\n * \u30D5\u30A1\u30A4\u30EB\u30B7\u30B9\u30C6\u30E0\u64CD\u4F5C\u306E\u30E9\u30C3\u30D1\u30FC\u30AF\u30E9\u30B9\n * baseDir\u3092\u57FA\u6E96\u3068\u3057\u305F\u30D1\u30B9\u89E3\u6C7A\u3068\u30C6\u30AD\u30B9\u30C8/JSON/\u30C7\u30A3\u30EC\u30AF\u30C8\u30EA\u64CD\u4F5C\u3092\u63D0\u4F9B\u3059\u308B\n */\nexport class FileSystem {\n  private readonly baseDir: string | null;\n\n  /**\n   * @param options \u30D9\u30FC\u30B9\u30C7\u30A3\u30EC\u30AF\u30C8\u30EA\u7B49\u306E\u30AA\u30D7\u30B7\u30E7\u30F3\n   */\n  constructor(options: FileSystemOptions = {}) {\n    this.baseDir = options.baseDir ?? null;\n  }\n\n  /**\n   * baseDir\u3092\u57FA\u6E96\u306B\u30D1\u30B9\u3092\u89E3\u6C7A\u3059\u308B\n   * @param path \u76F8\u5BFE\u30D1\u30B9\u307E\u305F\u306F\u7D76\u5BFE\u30D1\u30B9\n   * @returns \u89E3\u6C7A\u6E08\u307F\u306E\u30D1\u30B9\n   */\n  resolvePath(path: string): string {\n    return this.baseDir ? resolve(this.baseDir, path) : path;\n  }\n\n  /**\n   * \u30C6\u30AD\u30B9\u30C8\u30D5\u30A1\u30A4\u30EB\u3092\u8AAD\u307F\u8FBC\u3080\n   * @param path \u30D5\u30A1\u30A4\u30EB\u30D1\u30B9\n   * @returns \u30D5\u30A1\u30A4\u30EB\u306E\u5185\u5BB9\n   */\n  async readText(path: string): Promise<string> {\n    return fs.readFile(this.resolvePath(path), { encoding: DEFAULT_ENCODING });\n  }\n\n  /**\n   * \u30C6\u30AD\u30B9\u30C8\u30D5\u30A1\u30A4\u30EB\u306B\u66F8\u304D\u8FBC\u3080\u3002\u89AA\u30C7\u30A3\u30EC\u30AF\u30C8\u30EA\u304C\u306A\u3051\u308C\u3070\u81EA\u52D5\u4F5C\u6210\u3059\u308B\n   * @param path \u30D5\u30A1\u30A4\u30EB\u30D1\u30B9\n   * @param contents \u66F8\u304D\u8FBC\u3080\u5185\u5BB9\n   */\n  async writeText(path: string, contents: string): Promise<void> {\n    const fullPath = this.resolvePath(path);\n    await fs.mkdir(dirname(fullPath), { recursive: true });\n    await fs.writeFile(fullPath, contents, { encoding: DEFAULT_ENCODING });\n  }\n\n  /**\n   * \u30C6\u30AD\u30B9\u30C8\u30D5\u30A1\u30A4\u30EB\u306B\u8FFD\u8A18\u3059\u308B\u3002\u89AA\u30C7\u30A3\u30EC\u30AF\u30C8\u30EA\u304C\u306A\u3051\u308C\u3070\u81EA\u52D5\u4F5C\u6210\u3059\u308B\n   * @param path \u30D5\u30A1\u30A4\u30EB\u30D1\u30B9\n   * @param contents \u8FFD\u8A18\u3059\u308B\u5185\u5BB9\n   */\n  async appendText(path: string, contents: string): Promise<void> {\n    const fullPath = this.resolvePath(path);\n    await fs.mkdir(dirname(fullPath), { recursive: true });\n    await fs.appendFile(fullPath, contents, { encoding: DEFAULT_ENCODING });\n  }\n\n  /**\n   * JSON\u30D5\u30A1\u30A4\u30EB\u3092\u8AAD\u307F\u8FBC\u307F\u30D1\u30FC\u30B9\u3059\u308B\n   * @param path \u30D5\u30A1\u30A4\u30EB\u30D1\u30B9\n   * @returns \u30D1\u30FC\u30B9\u3055\u308C\u305F\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\n   * @throws {SerializationError} JSON\u30D1\u30FC\u30B9\u306B\u5931\u6557\u3057\u305F\u5834\u5408\n   */\n  async readJson<T = unknown>(path: string): Promise<T> {\n    const text = await this.readText(path);\n    try {\n      return JSON.parse(text) as T;\n    } catch (error: unknown) {\n      const message = error instanceof Error ? error.message : String(error);\n      throw new SerializationError(\n        `Failed to parse JSON at ${path}: ${message}`,\n      );\n    }\n  }\n\n  /**\n   * \u5024\u3092JSON\u5F62\u5F0F\u3067\u30D5\u30A1\u30A4\u30EB\u306B\u66F8\u304D\u8FBC\u3080\n   * @param path \u30D5\u30A1\u30A4\u30EB\u30D1\u30B9\n   * @param value \u66F8\u304D\u8FBC\u3080\u5024\n   * @param indent \u30A4\u30F3\u30C7\u30F3\u30C8\u5E45\uFF08\u30C7\u30D5\u30A9\u30EB\u30C8: 2\uFF09\n   * @throws {SerializationError} JSON\u30B7\u30EA\u30A2\u30E9\u30A4\u30BA\u306B\u5931\u6557\u3057\u305F\u5834\u5408\n   */\n  async writeJson(\n    path: string,\n    value: unknown,\n    indent: number = DEFAULT_JSON_INDENT,\n  ): Promise<void> {\n    const json = JSON.stringify(value, null, indent);\n    if (json === undefined) {\n      throw new SerializationError(`Value is not JSON serializable: ${path}`);\n    }\n    await this.writeText(path, `${json}${JSON_LINE_ENDING}`);\n  }\n\n  /**\n   * \u30C7\u30A3\u30EC\u30AF\u30C8\u30EA\u3092\u4F5C\u6210\u3059\u308B\u3002\u65E2\u306B\u5B58\u5728\u3059\u308B\u5834\u5408\u306F\u4F55\u3082\u3057\u306A\u3044\n   * @param path \u30C7\u30A3\u30EC\u30AF\u30C8\u30EA\u30D1\u30B9\n   */\n  async ensureDir(path: string): Promise<void> {\n    await fs.mkdir(this.resolvePath(path), { recursive: true });\n  }\n\n  /**\n   * \u30D5\u30A1\u30A4\u30EB\u307E\u305F\u306F\u30C7\u30A3\u30EC\u30AF\u30C8\u30EA\u304C\u5B58\u5728\u3059\u308B\u304B\u78BA\u8A8D\u3059\u308B\n   * @param path \u30D1\u30B9\n   * @returns \u5B58\u5728\u3059\u308C\u3070true\n   */\n  async exists(path: string): Promise<boolean> {\n    try {\n      await fs.access(this.resolvePath(path));\n      return true;\n    } catch {\n      return false;\n    }\n  }\n\n  /**\n   * \u30D5\u30A1\u30A4\u30EB\u307E\u305F\u306F\u30C7\u30A3\u30EC\u30AF\u30C8\u30EA\u306E\u60C5\u5831\u3092\u53D6\u5F97\u3059\u308B\n   * @param path \u30D1\u30B9\n   * @returns \u30D5\u30A1\u30A4\u30EB\u30B9\u30C6\u30FC\u30BF\u30B9\n   */\n  async stat(path: string): Promise<Stats> {\n    return fs.stat(this.resolvePath(path));\n  }\n\n  /**\n   * \u30C7\u30A3\u30EC\u30AF\u30C8\u30EA\u5185\u306E\u30A8\u30F3\u30C8\u30EA\u4E00\u89A7\u3092\u53D6\u5F97\u3059\u308B\n   * @param path \u30C7\u30A3\u30EC\u30AF\u30C8\u30EA\u30D1\u30B9\n   * @returns \u30D5\u30A1\u30A4\u30EB\u540D\u306E\u914D\u5217\n   */\n  async listDir(path: string): Promise<string[]> {\n    return fs.readdir(this.resolvePath(path));\n  }\n\n  /**\n   * \u30D5\u30A1\u30A4\u30EB\u307E\u305F\u306F\u30C7\u30A3\u30EC\u30AF\u30C8\u30EA\u3092\u518D\u5E30\u7684\u306B\u524A\u9664\u3059\u308B\n   * @param path \u524A\u9664\u5BFE\u8C61\u306E\u30D1\u30B9\n   */\n  async remove(path: string): Promise<void> {\n    await fs.rm(this.resolvePath(path), { recursive: true, force: true });\n  }\n}\n", "import { randomUUID } from \"node:crypto\";\n\n/**\n * UUIDv4\u5F62\u5F0F\u306E\u4E00\u610F\u306AID\u3092\u751F\u6210\u3059\u308B\n * @returns \u751F\u6210\u3055\u308C\u305FUUID\u6587\u5B57\u5217\n */\nexport function generateId(): string {\n  return randomUUID();\n}\n", "/**\n * Time zone name format.\n */\n\n/**\n * The function returns the time zone name for the given date in the specified\n * time zone.\n *\n * It uses the `Intl.DateTimeFormat` API and by default outputs the time zone\n * name in a long format, e.g. \"Pacific Standard Time\" or\n * \"Singapore Standard Time\".\n *\n * It is possible to specify the format as the third argument using one of the following options\n *\n * - \"short\": e.g. \"EDT\" or \"GMT+8\".\n * - \"long\": e.g. \"Eastern Daylight Time\".\n * - \"shortGeneric\": e.g. \"ET\" or \"Singapore Time\".\n * - \"longGeneric\": e.g. \"Eastern Time\" or \"Singapore Standard Time\".\n *\n * These options correspond to TR35 tokens `z..zzz`, `zzzz`, `v`, and `vvvv` respectively: https://www.unicode.org/reports/tr35/tr35-dates.html#dfst-zone\n *\n * @param timeZone - Time zone name (IANA or UTC offset)\n * @param date - Date object to get the time zone name for\n * @param format - Optional format of the time zone name. Defaults to \"long\". Can be \"short\", \"long\", \"shortGeneric\", or \"longGeneric\".\n *\n * @returns Time zone name (e.g. \"Singapore Standard Time\")\n */\nexport function tzName(timeZone, date, format = \"long\") {\n  return new Intl.DateTimeFormat(\"en-US\", {\n    // Enforces engine to render the time. Without the option JavaScriptCore omits it.\n    hour: \"numeric\",\n    timeZone: timeZone,\n    timeZoneName: format\n  }).format(date).split(/\\s/g) // Format.JS uses non-breaking spaces\n  .slice(2) // Skip the hour and AM/PM parts\n  .join(\" \");\n}", "const offsetFormatCache = {};\nconst offsetCache = {};\n\n/**\n * The function extracts UTC offset in minutes from the given date in specified\n * time zone.\n *\n * Unlike `Date.prototype.getTimezoneOffset`, this function returns the value\n * mirrored to the sign of the offset in the time zone. For Asia/Singapore\n * (UTC+8), `tzOffset` returns 480, while `getTimezoneOffset` returns -480.\n *\n * @param timeZone - Time zone name (IANA or UTC offset)\n * @param date - Date to check the offset for\n *\n * @returns UTC offset in minutes\n */\nexport function tzOffset(timeZone, date) {\n  try {\n    const format = offsetFormatCache[timeZone] ||= new Intl.DateTimeFormat(\"en-US\", {\n      timeZone,\n      timeZoneName: \"longOffset\"\n    }).format;\n    const offsetStr = format(date).split(\"GMT\")[1];\n    if (offsetStr in offsetCache) return offsetCache[offsetStr];\n    return calcOffset(offsetStr, offsetStr.split(\":\"));\n  } catch {\n    // Fallback to manual parsing if the runtime doesn't support \u00B1HH:MM/\u00B1HHMM/\u00B1HH\n    // See: https://github.com/nodejs/node/issues/53419\n    if (timeZone in offsetCache) return offsetCache[timeZone];\n    const captures = timeZone?.match(offsetRe);\n    if (captures) return calcOffset(timeZone, captures.slice(1));\n    return NaN;\n  }\n}\nconst offsetRe = /([+-]\\d\\d):?(\\d\\d)?/;\nfunction calcOffset(cacheStr, values) {\n  const hours = +(values[0] || 0);\n  const minutes = +(values[1] || 0);\n  // Convert seconds to minutes by dividing by 60 to keep the function return in minutes.\n  const seconds = +(values[2] || 0) / 60;\n  return offsetCache[cacheStr] = hours * 60 + minutes > 0 ? hours * 60 + minutes + seconds : hours * 60 - minutes - seconds;\n}", "import { tzOffset } from \"../tzOffset/index.js\";\nexport class TZDateMini extends Date {\n  //#region static\n\n  constructor(...args) {\n    super();\n    if (args.length > 1 && typeof args[args.length - 1] === \"string\") {\n      this.timeZone = args.pop();\n    }\n    this.internal = new Date();\n    if (isNaN(tzOffset(this.timeZone, this))) {\n      this.setTime(NaN);\n    } else {\n      if (!args.length) {\n        this.setTime(Date.now());\n      } else if (typeof args[0] === \"number\" && (args.length === 1 || args.length === 2 && typeof args[1] !== \"number\")) {\n        this.setTime(args[0]);\n      } else if (typeof args[0] === \"string\") {\n        this.setTime(+new Date(args[0]));\n      } else if (args[0] instanceof Date) {\n        this.setTime(+args[0]);\n      } else {\n        this.setTime(+new Date(...args));\n        adjustToSystemTZ(this, NaN);\n        syncToInternal(this);\n      }\n    }\n  }\n  static tz(tz, ...args) {\n    return args.length ? new TZDateMini(...args, tz) : new TZDateMini(Date.now(), tz);\n  }\n\n  //#endregion\n\n  //#region time zone\n\n  withTimeZone(timeZone) {\n    return new TZDateMini(+this, timeZone);\n  }\n  getTimezoneOffset() {\n    const offset = -tzOffset(this.timeZone, this);\n    // Remove the seconds offset\n    // use Math.floor for negative GMT timezones and Math.ceil for positive GMT timezones.\n    return offset > 0 ? Math.floor(offset) : Math.ceil(offset);\n  }\n\n  //#endregion\n\n  //#region time\n\n  setTime(time) {\n    Date.prototype.setTime.apply(this, arguments);\n    syncToInternal(this);\n    return +this;\n  }\n\n  //#endregion\n\n  //#region date-fns integration\n\n  [Symbol.for(\"constructDateFrom\")](date) {\n    return new TZDateMini(+new Date(date), this.timeZone);\n  }\n\n  //#endregion\n}\n\n// Assign getters and setters\nconst re = /^(get|set)(?!UTC)/;\nObject.getOwnPropertyNames(Date.prototype).forEach(method => {\n  if (!re.test(method)) return;\n  const utcMethod = method.replace(re, \"$1UTC\");\n  // Filter out methods without UTC counterparts\n  if (!TZDateMini.prototype[utcMethod]) return;\n  if (method.startsWith(\"get\")) {\n    // Delegate to internal date's UTC method\n    TZDateMini.prototype[method] = function () {\n      return this.internal[utcMethod]();\n    };\n  } else {\n    // Assign regular setter\n    TZDateMini.prototype[method] = function () {\n      Date.prototype[utcMethod].apply(this.internal, arguments);\n      syncFromInternal(this);\n      return +this;\n    };\n\n    // Assign UTC setter\n    TZDateMini.prototype[utcMethod] = function () {\n      Date.prototype[utcMethod].apply(this, arguments);\n      syncToInternal(this);\n      return +this;\n    };\n  }\n});\n\n/**\n * Function syncs time to internal date, applying the time zone offset.\n *\n * @param {Date} date - Date to sync\n */\nfunction syncToInternal(date) {\n  date.internal.setTime(+date);\n  date.internal.setUTCSeconds(date.internal.getUTCSeconds() - Math.round(-tzOffset(date.timeZone, date) * 60));\n}\n\n/**\n * Function syncs the internal date UTC values to the date. It allows to get\n * accurate timestamp value.\n *\n * @param {Date} date - The date to sync\n */\nfunction syncFromInternal(date) {\n  // First we transpose the internal values\n  Date.prototype.setFullYear.call(date, date.internal.getUTCFullYear(), date.internal.getUTCMonth(), date.internal.getUTCDate());\n  Date.prototype.setHours.call(date, date.internal.getUTCHours(), date.internal.getUTCMinutes(), date.internal.getUTCSeconds(), date.internal.getUTCMilliseconds());\n\n  // Now we have to adjust the date to the system time zone\n  adjustToSystemTZ(date);\n}\n\n/**\n * Function adjusts the date to the system time zone. It uses the time zone\n * differences to calculate the offset and adjust the date.\n *\n * @param {Date} date - Date to adjust\n */\nfunction adjustToSystemTZ(date) {\n  // Save the time zone offset before all the adjustments\n  const baseOffset = tzOffset(date.timeZone, date);\n  // Remove the seconds offset\n  // use Math.floor for negative GMT timezones and Math.ceil for positive GMT timezones.\n  const offset = baseOffset > 0 ? Math.floor(baseOffset) : Math.ceil(baseOffset);\n  //#region System DST adjustment\n\n  // The biggest problem with using the system time zone is that when we create\n  // a date from internal values stored in UTC, the system time zone might end\n  // up on the DST hour:\n  //\n  //   $ TZ=America/New_York node\n  //   > new Date(2020, 2, 8, 1).toString()\n  //   'Sun Mar 08 2020 01:00:00 GMT-0500 (Eastern Standard Time)'\n  //   > new Date(2020, 2, 8, 2).toString()\n  //   'Sun Mar 08 2020 03:00:00 GMT-0400 (Eastern Daylight Time)'\n  //   > new Date(2020, 2, 8, 3).toString()\n  //   'Sun Mar 08 2020 03:00:00 GMT-0400 (Eastern Daylight Time)'\n  //   > new Date(2020, 2, 8, 4).toString()\n  //   'Sun Mar 08 2020 04:00:00 GMT-0400 (Eastern Daylight Time)'\n  //\n  // Here we get the same hour for both 2 and 3, because the system time zone\n  // has DST beginning at 8 March 2020, 2 a.m. and jumps to 3 a.m. So we have\n  // to adjust the internal date to reflect that.\n  //\n  // However we want to adjust only if that's the DST hour the change happenes,\n  // not the hour where DST moves to.\n\n  // We calculate the previous hour to see if the time zone offset has changed\n  // and we have landed on the DST hour.\n  const prevHour = new Date(+date);\n  // We use UTC methods here as we don't want to land on the same hour again\n  // in case of DST.\n  prevHour.setUTCHours(prevHour.getUTCHours() - 1);\n\n  // Calculate if we are on the system DST hour.\n  const systemOffset = -new Date(+date).getTimezoneOffset();\n  const prevHourSystemOffset = -new Date(+prevHour).getTimezoneOffset();\n  const systemDSTChange = systemOffset - prevHourSystemOffset;\n  // Detect the DST shift. System DST change will occur both on\n  const dstShift = Date.prototype.getHours.apply(date) !== date.internal.getUTCHours();\n\n  // Move the internal date when we are on the system DST hour.\n  if (systemDSTChange && dstShift) date.internal.setUTCMinutes(date.internal.getUTCMinutes() + systemDSTChange);\n\n  //#endregion\n\n  //#region System diff adjustment\n\n  // Now we need to adjust the date, since we just applied internal values.\n  // We need to calculate the difference between the system and date time zones\n  // and apply it to the date.\n\n  const offsetDiff = systemOffset - offset;\n  if (offsetDiff) Date.prototype.setUTCMinutes.call(date, Date.prototype.getUTCMinutes.call(date) + offsetDiff);\n\n  //#endregion\n\n  //#region Seconds System diff adjustment\n\n  const systemDate = new Date(+date);\n  // Set the UTC seconds to 0 to isolate the timezone offset in seconds.\n  systemDate.setUTCSeconds(0);\n  // For negative systemOffset, invert the seconds.\n  const systemSecondsOffset = systemOffset > 0 ? systemDate.getSeconds() : (systemDate.getSeconds() - 60) % 60;\n\n  // Calculate the seconds offset based on the timezone offset.\n  const secondsOffset = Math.round(-(tzOffset(date.timeZone, date) * 60)) % 60;\n  if (secondsOffset || systemSecondsOffset) {\n    date.internal.setUTCSeconds(date.internal.getUTCSeconds() + secondsOffset);\n    Date.prototype.setUTCSeconds.call(date, Date.prototype.getUTCSeconds.call(date) + secondsOffset + systemSecondsOffset);\n  }\n\n  //#endregion\n\n  //#region Post-adjustment DST fix\n\n  const postBaseOffset = tzOffset(date.timeZone, date);\n  // Remove the seconds offset\n  // use Math.floor for negative GMT timezones and Math.ceil for positive GMT timezones.\n  const postOffset = postBaseOffset > 0 ? Math.floor(postBaseOffset) : Math.ceil(postBaseOffset);\n  const postSystemOffset = -new Date(+date).getTimezoneOffset();\n  const postOffsetDiff = postSystemOffset - postOffset;\n  const offsetChanged = postOffset !== offset;\n  const postDiff = postOffsetDiff - offsetDiff;\n  if (offsetChanged && postDiff) {\n    Date.prototype.setUTCMinutes.call(date, Date.prototype.getUTCMinutes.call(date) + postDiff);\n\n    // Now we need to check if got offset change during the post-adjustment.\n    // If so, we also need both dates to reflect that.\n\n    const newBaseOffset = tzOffset(date.timeZone, date);\n    // Remove the seconds offset\n    // use Math.floor for negative GMT timezones and Math.ceil for positive GMT timezones.\n    const newOffset = newBaseOffset > 0 ? Math.floor(newBaseOffset) : Math.ceil(newBaseOffset);\n    const offsetChange = postOffset - newOffset;\n    if (offsetChange) {\n      date.internal.setUTCMinutes(date.internal.getUTCMinutes() + offsetChange);\n      Date.prototype.setUTCMinutes.call(date, Date.prototype.getUTCMinutes.call(date) + offsetChange);\n    }\n  }\n\n  //#endregion\n}", "import { tzName } from \"../tzName/index.js\";\nimport { TZDateMini } from \"./mini.js\";\nexport class TZDate extends TZDateMini {\n  //#region static\n\n  static tz(tz, ...args) {\n    return args.length ? new TZDate(...args, tz) : new TZDate(Date.now(), tz);\n  }\n\n  //#endregion\n\n  //#region representation\n\n  toISOString() {\n    const [sign, hours, minutes] = this.tzComponents();\n    const tz = `${sign}${hours}:${minutes}`;\n    return this.internal.toISOString().slice(0, -1) + tz;\n  }\n  toString() {\n    // \"Tue Aug 13 2024 07:50:19 GMT+0800 (Singapore Standard Time)\";\n    return `${this.toDateString()} ${this.toTimeString()}`;\n  }\n  toDateString() {\n    // toUTCString returns RFC 7231 (\"Mon, 12 Aug 2024 23:36:08 GMT\")\n    const [day, date, month, year] = this.internal.toUTCString().split(\" \");\n    // \"Tue Aug 13 2024\"\n    return `${day?.slice(0, -1) /* Remove \",\" */} ${month} ${date} ${year}`;\n  }\n  toTimeString() {\n    // toUTCString returns RFC 7231 (\"Mon, 12 Aug 2024 23:36:08 GMT\")\n    const time = this.internal.toUTCString().split(\" \")[4];\n    const [sign, hours, minutes] = this.tzComponents();\n    // \"07:42:23 GMT+0800 (Singapore Standard Time)\"\n    return `${time} GMT${sign}${hours}${minutes} (${tzName(this.timeZone, this)})`;\n  }\n  toLocaleString(locales, options) {\n    return Date.prototype.toLocaleString.call(this, locales, {\n      ...options,\n      timeZone: options?.timeZone || this.timeZone\n    });\n  }\n  toLocaleDateString(locales, options) {\n    return Date.prototype.toLocaleDateString.call(this, locales, {\n      ...options,\n      timeZone: options?.timeZone || this.timeZone\n    });\n  }\n  toLocaleTimeString(locales, options) {\n    return Date.prototype.toLocaleTimeString.call(this, locales, {\n      ...options,\n      timeZone: options?.timeZone || this.timeZone\n    });\n  }\n\n  //#endregion\n\n  //#region private\n\n  tzComponents() {\n    const offset = this.getTimezoneOffset();\n    const sign = offset > 0 ? \"-\" : \"+\";\n    const hours = String(Math.floor(Math.abs(offset) / 60)).padStart(2, \"0\");\n    const minutes = String(Math.abs(offset) % 60).padStart(2, \"0\");\n    return [sign, hours, minutes];\n  }\n\n  //#endregion\n\n  withTimeZone(timeZone) {\n    return new TZDate(+this, timeZone);\n  }\n\n  //#region date-fns integration\n\n  [Symbol.for(\"constructDateFrom\")](date) {\n    return new TZDate(+new Date(date), this.timeZone);\n  }\n\n  //#endregion\n}", "import { TZDate } from \"@date-fns/tz\";\n\nexport const LOG_LEVEL = {\n  emergency: 0,\n  alert: 1,\n  critical: 2,\n  error: 3,\n  warning: 4,\n  notice: 5,\n  info: 6,\n  debug: 7,\n} as const;\n\nexport type LogLevel = keyof typeof LOG_LEVEL;\n\nexport interface LogEntry {\n  level: LogLevel;\n  message: string;\n  timestamp: Date;\n  context?: Record<string, unknown>;\n}\n\nexport type LogSink = (entry: LogEntry) => void;\n\nexport interface LoggerOptions {\n  level?: LogLevel;\n  sink?: LogSink;\n}\n\nconst DEFAULT_LOG_LEVEL: LogLevel = \"info\";\nconst UNSERIALIZABLE_PLACEHOLDER = \"[Unserializable]\";\n\nconst LEVEL_METHOD_MAP: Record<\n  LogLevel,\n  \"debug\" | \"info\" | \"warn\" | \"error\" | \"log\"\n> = {\n  emergency: \"error\",\n  alert: \"error\",\n  critical: \"error\",\n  error: \"error\",\n  warning: \"warn\",\n  notice: \"info\",\n  info: \"info\",\n  debug: \"debug\",\n};\n\nconst safeStringify = (value: unknown): string => {\n  try {\n    return JSON.stringify(value);\n  } catch {\n    return UNSERIALIZABLE_PLACEHOLDER;\n  }\n};\n\nconst createDefaultSink = (): LogSink => {\n  return (entry: LogEntry): void => {\n    const method = LEVEL_METHOD_MAP[entry.level];\n    const timestamp = entry.timestamp.toISOString();\n    const contextText = entry.context ? ` ${safeStringify(entry.context)}` : \"\";\n    console[method](\n      `[${timestamp}] ${entry.level}: ${entry.message}${contextText}`,\n    );\n  };\n};\n\n/**\n * \u30EC\u30D9\u30EB\u4ED8\u304D\u30ED\u30AC\u30FC\n * \u30B7\u30F3\u30AF\uFF08\u51FA\u529B\u5148\uFF09\u3092\u5DEE\u3057\u66FF\u3048\u53EF\u80FD\u3067\u3001\u30EC\u30D9\u30EB\u306B\u3088\u308B\u30D5\u30A3\u30EB\u30BF\u30EA\u30F3\u30B0\u3092\u884C\u3046\n */\nexport class Logger {\n  private level: LogLevel = DEFAULT_LOG_LEVEL;\n  private levelValue: number = LOG_LEVEL[DEFAULT_LOG_LEVEL];\n  private sink: LogSink = createDefaultSink();\n\n  /**\n   * @param options \u30ED\u30B0\u30EC\u30D9\u30EB\u3084\u30B7\u30F3\u30AF\u306E\u8A2D\u5B9A\n   */\n  constructor(options: LoggerOptions = {}) {\n    if (options.level) {\n      this.setLevel(options.level);\n    }\n    if (options.sink) {\n      this.setSink(options.sink);\n    }\n  }\n\n  /**\n   * \u30ED\u30B0\u30EC\u30D9\u30EB\u3092\u5909\u66F4\u3059\u308B\n   * @param level \u65B0\u3057\u3044\u30ED\u30B0\u30EC\u30D9\u30EB\n   */\n  setLevel(level: LogLevel): void {\n    this.level = level;\n    this.levelValue = LOG_LEVEL[level];\n  }\n\n  /**\n   * \u73FE\u5728\u306E\u30ED\u30B0\u30EC\u30D9\u30EB\u3092\u8FD4\u3059\n   * @returns \u73FE\u5728\u306E\u30ED\u30B0\u30EC\u30D9\u30EB\n   */\n  getLevel(): LogLevel {\n    return this.level;\n  }\n\n  /**\n   * \u30ED\u30B0\u51FA\u529B\u5148\uFF08\u30B7\u30F3\u30AF\uFF09\u3092\u5909\u66F4\u3059\u308B\n   * @param sink \u65B0\u3057\u3044\u30ED\u30B0\u30B7\u30F3\u30AF\n   */\n  setSink(sink: LogSink): void {\n    this.sink = sink;\n  }\n\n  /**\n   * \u6307\u5B9A\u30EC\u30D9\u30EB\u3067\u30ED\u30B0\u3092\u8A18\u9332\u3059\u308B\u3002\u73FE\u5728\u306E\u30EC\u30D9\u30EB\u4EE5\u4E0B\u306E\u5834\u5408\u306E\u307F\u51FA\u529B\u3055\u308C\u308B\n   * @param level \u30ED\u30B0\u30EC\u30D9\u30EB\n   * @param message \u30ED\u30B0\u30E1\u30C3\u30BB\u30FC\u30B8\n   * @param context \u8FFD\u52A0\u306E\u30B3\u30F3\u30C6\u30AD\u30B9\u30C8\u60C5\u5831\n   */\n  log(\n    level: LogLevel,\n    message: string,\n    context?: Record<string, unknown>,\n  ): void {\n    if (LOG_LEVEL[level] > this.levelValue) {\n      return;\n    }\n    this.sink({ level, message, timestamp: new TZDate(), context });\n  }\n\n  /**\n   * emergency\u30EC\u30D9\u30EB\u306E\u30ED\u30B0\u3092\u8A18\u9332\u3059\u308B\n   * @param message \u30ED\u30B0\u30E1\u30C3\u30BB\u30FC\u30B8\n   * @param context \u8FFD\u52A0\u306E\u30B3\u30F3\u30C6\u30AD\u30B9\u30C8\u60C5\u5831\n   */\n  emergency(message: string, context?: Record<string, unknown>): void {\n    this.log(\"emergency\", message, context);\n  }\n\n  /**\n   * alert\u30EC\u30D9\u30EB\u306E\u30ED\u30B0\u3092\u8A18\u9332\u3059\u308B\n   * @param message \u30ED\u30B0\u30E1\u30C3\u30BB\u30FC\u30B8\n   * @param context \u8FFD\u52A0\u306E\u30B3\u30F3\u30C6\u30AD\u30B9\u30C8\u60C5\u5831\n   */\n  alert(message: string, context?: Record<string, unknown>): void {\n    this.log(\"alert\", message, context);\n  }\n\n  /**\n   * critical\u30EC\u30D9\u30EB\u306E\u30ED\u30B0\u3092\u8A18\u9332\u3059\u308B\n   * @param message \u30ED\u30B0\u30E1\u30C3\u30BB\u30FC\u30B8\n   * @param context \u8FFD\u52A0\u306E\u30B3\u30F3\u30C6\u30AD\u30B9\u30C8\u60C5\u5831\n   */\n  critical(message: string, context?: Record<string, unknown>): void {\n    this.log(\"critical\", message, context);\n  }\n\n  /**\n   * error\u30EC\u30D9\u30EB\u306E\u30ED\u30B0\u3092\u8A18\u9332\u3059\u308B\n   * @param message \u30ED\u30B0\u30E1\u30C3\u30BB\u30FC\u30B8\n   * @param context \u8FFD\u52A0\u306E\u30B3\u30F3\u30C6\u30AD\u30B9\u30C8\u60C5\u5831\n   */\n  error(message: string, context?: Record<string, unknown>): void {\n    this.log(\"error\", message, context);\n  }\n\n  /**\n   * warning\u30EC\u30D9\u30EB\u306E\u30ED\u30B0\u3092\u8A18\u9332\u3059\u308B\n   * @param message \u30ED\u30B0\u30E1\u30C3\u30BB\u30FC\u30B8\n   * @param context \u8FFD\u52A0\u306E\u30B3\u30F3\u30C6\u30AD\u30B9\u30C8\u60C5\u5831\n   */\n  warning(message: string, context?: Record<string, unknown>): void {\n    this.log(\"warning\", message, context);\n  }\n\n  /**\n   * notice\u30EC\u30D9\u30EB\u306E\u30ED\u30B0\u3092\u8A18\u9332\u3059\u308B\n   * @param message \u30ED\u30B0\u30E1\u30C3\u30BB\u30FC\u30B8\n   * @param context \u8FFD\u52A0\u306E\u30B3\u30F3\u30C6\u30AD\u30B9\u30C8\u60C5\u5831\n   */\n  notice(message: string, context?: Record<string, unknown>): void {\n    this.log(\"notice\", message, context);\n  }\n\n  /**\n   * info\u30EC\u30D9\u30EB\u306E\u30ED\u30B0\u3092\u8A18\u9332\u3059\u308B\n   * @param message \u30ED\u30B0\u30E1\u30C3\u30BB\u30FC\u30B8\n   * @param context \u8FFD\u52A0\u306E\u30B3\u30F3\u30C6\u30AD\u30B9\u30C8\u60C5\u5831\n   */\n  info(message: string, context?: Record<string, unknown>): void {\n    this.log(\"info\", message, context);\n  }\n\n  /**\n   * debug\u30EC\u30D9\u30EB\u306E\u30ED\u30B0\u3092\u8A18\u9332\u3059\u308B\n   * @param message \u30ED\u30B0\u30E1\u30C3\u30BB\u30FC\u30B8\n   * @param context \u8FFD\u52A0\u306E\u30B3\u30F3\u30C6\u30AD\u30B9\u30C8\u60C5\u5831\n   */\n  debug(message: string, context?: Record<string, unknown>): void {\n    this.log(\"debug\", message, context);\n  }\n}\n/**\n * \u65B0\u3057\u3044Logger\u30A4\u30F3\u30B9\u30BF\u30F3\u30B9\u3092\u751F\u6210\u3059\u308B\u30D5\u30A1\u30AF\u30C8\u30EA\u95A2\u6570\n * @param options \u30ED\u30B0\u30EC\u30D9\u30EB\u3084\u30B7\u30F3\u30AF\u306E\u8A2D\u5B9A\n * @returns \u65B0\u3057\u3044Logger\u30A4\u30F3\u30B9\u30BF\u30F3\u30B9\n */\nexport const createLogger = (options: LoggerOptions = {}): Logger =>\n  new Logger(options);\n", "import { TZDate } from \"@date-fns/tz\";\nimport { InvalidArgumentError, RuntimeError } from \"../core/index.js\";\n\n/**\n * Parsed cron fields in local time.\n * dayOfWeek uses 0 (Sunday) through 6 (Saturday).\n */\ninterface CronFields {\n  minute: number[];\n  hour: number[];\n  dayOfMonth: number[];\n  month: number[];\n  dayOfWeek: number[];\n}\n\ntype CronFieldKey = keyof CronFields;\n\ninterface CronFieldSpec {\n  key: CronFieldKey;\n  min: number;\n  max: number;\n}\n\nconst CRON_FIELD_SPECS: ReadonlyArray<CronFieldSpec> = [\n  { key: \"minute\", min: 0, max: 59 },\n  { key: \"hour\", min: 0, max: 23 },\n  { key: \"dayOfMonth\", min: 1, max: 31 },\n  { key: \"month\", min: 1, max: 12 },\n  { key: \"dayOfWeek\", min: 0, max: 6 },\n];\n\nconst CRON_FIELD_COUNT = CRON_FIELD_SPECS.length;\nconst BASE_10 = 10;\nconst MIN_STEP_VALUE = 1;\nconst DEFAULT_RANGE_STEP = 1;\nconst NEXT_MINUTE_INCREMENT = 1;\nconst NEXT_HOUR_INCREMENT = 1;\nconst NEXT_DAY_INCREMENT = 1;\nconst NEXT_YEAR_INCREMENT = 1;\nconst MONTH_OFFSET = 1;\nconst RESET_HOURS = 0;\nconst RESET_MINUTES = 0;\nconst RESET_SECONDS = 0;\nconst RESET_MILLISECONDS = 0;\nconst LOOKAHEAD_YEARS = 4;\nconst DAYS_PER_YEAR = 365;\nconst HOURS_PER_DAY = 24;\nconst MINUTES_PER_HOUR = 60;\nconst CRON_MAX_ITERATIONS =\n  LOOKAHEAD_YEARS * DAYS_PER_YEAR * HOURS_PER_DAY * MINUTES_PER_HOUR;\n\n/**\n * Parses a 5-field cron expression and evaluates dates in local time.\n */\nexport class Cron {\n  private static readonly MAX_ITERATIONS = CRON_MAX_ITERATIONS;\n  private readonly fields: CronFields;\n\n  /**\n   * @param expression minute hour dayOfMonth month dayOfWeek\n   */\n  constructor(expression: string) {\n    this.fields = this.parse(expression);\n  }\n\n  /**\n   * 5\u30D5\u30A3\u30FC\u30EB\u30C9\u306Ecron\u5F0F\u3092\u30D1\u30FC\u30B9\u3057\u3001CronFields\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\u306B\u5909\u63DB\u3059\u308B\u3002\n   * @param expression \u30B9\u30DA\u30FC\u30B9\u533A\u5207\u308A\u306Ecron\u5F0F\u6587\u5B57\u5217\n   * @returns \u30D1\u30FC\u30B9\u6E08\u307F\u306ECronFields\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\n   */\n  private parse(expression: string): CronFields {\n    const parts = expression.trim().split(/\\s+/);\n\n    if (parts.length !== CRON_FIELD_COUNT) {\n      throw new InvalidArgumentError(\n        \"Cron expression must have exactly 5 fields\",\n      );\n    }\n\n    const fields: Record<CronFieldKey, number[]> = {\n      minute: [],\n      hour: [],\n      dayOfMonth: [],\n      month: [],\n      dayOfWeek: [],\n    };\n\n    CRON_FIELD_SPECS.forEach((spec, index) => {\n      fields[spec.key] = this.parseField(parts[index], spec.min, spec.max);\n    });\n\n    return fields;\n  }\n\n  /**\n   * \u5358\u4E00\u30D5\u30A3\u30FC\u30EB\u30C9\u3092\u30D1\u30FC\u30B9\u3059\u308B\u3002\u30EF\u30A4\u30EB\u30C9\u30AB\u30FC\u30C9(*)\u3001\u7BC4\u56F2\u3001\u30B9\u30C6\u30C3\u30D7\u3001\u30AB\u30F3\u30DE\u533A\u5207\u308A\u306B\u5BFE\u5FDC\u3059\u308B\u3002\n   * @param field \u30D1\u30FC\u30B9\u5BFE\u8C61\u306E\u30D5\u30A3\u30FC\u30EB\u30C9\u6587\u5B57\u5217\n   * @param min \u30D5\u30A3\u30FC\u30EB\u30C9\u306E\u6700\u5C0F\u8A31\u5BB9\u5024\n   * @param max \u30D5\u30A3\u30FC\u30EB\u30C9\u306E\u6700\u5927\u8A31\u5BB9\u5024\n   * @returns \u30BD\u30FC\u30C8\u6E08\u307F\u306E\u8A31\u5BB9\u5024\u914D\u5217\n   */\n  private parseField(field: string, min: number, max: number): number[] {\n    if (field === \"*\") {\n      return this.buildRange(min, max);\n    }\n\n    const values = new Set<number>();\n    const parts = field.split(\",\");\n\n    for (const part of parts) {\n      this.parseFieldPart(part, min, max, values);\n    }\n\n    return this.sortedValues(values);\n  }\n\n  /**\n   * \u30AB\u30F3\u30DE\u533A\u5207\u308A\u30D5\u30A3\u30FC\u30EB\u30C9\u306E1\u30D1\u30FC\u30C8\u3092\u30D1\u30FC\u30B9\u3057\u3001\u5024\u3092\u30BB\u30C3\u30C8\u306B\u8FFD\u52A0\u3059\u308B\u3002\n   * \u30B9\u30C6\u30C3\u30D7\u5F0F(/)\u3001\u7BC4\u56F2\u5F0F(-)\u3001\u5358\u4E00\u5024\u306E\u3044\u305A\u308C\u304B\u3092\u51E6\u7406\u3059\u308B\u3002\n   * @param part \u30D1\u30FC\u30B9\u5BFE\u8C61\u306E\u30D1\u30FC\u30C8\u6587\u5B57\u5217\n   * @param min \u30D5\u30A3\u30FC\u30EB\u30C9\u306E\u6700\u5C0F\u8A31\u5BB9\u5024\n   * @param max \u30D5\u30A3\u30FC\u30EB\u30C9\u306E\u6700\u5927\u8A31\u5BB9\u5024\n   * @param values \u30D1\u30FC\u30B9\u7D50\u679C\u3092\u683C\u7D0D\u3059\u308B\u30BB\u30C3\u30C8\n   */\n  private parseFieldPart(\n    part: string,\n    min: number,\n    max: number,\n    values: Set<number>,\n  ): void {\n    if (part.includes(\"/\")) {\n      const [range, step] = part.split(\"/\");\n      const stepValue = this.parseStepValue(step);\n      const { start, end } = this.parseStepRange(range, min, max);\n      this.addRange(values, start, end, stepValue, min, max);\n      return;\n    }\n\n    if (part.includes(\"-\")) {\n      const [start, end] = part.split(\"-\");\n      const startValue = parseInt(start, BASE_10);\n      const endValue = parseInt(end, BASE_10);\n\n      if (Number.isNaN(startValue) || Number.isNaN(endValue)) {\n        throw new InvalidArgumentError(`Invalid range: ${part}`);\n      }\n\n      if (startValue < min || endValue > max || startValue > endValue) {\n        throw new InvalidArgumentError(`Range out of bounds: ${part}`);\n      }\n\n      this.addRange(values, startValue, endValue, DEFAULT_RANGE_STEP, min, max);\n      return;\n    }\n\n    const value = parseInt(part, BASE_10);\n\n    if (Number.isNaN(value)) {\n      throw new InvalidArgumentError(`Invalid value: ${part}`);\n    }\n\n    if (value < min || value > max) {\n      throw new InvalidArgumentError(\n        `Value out of bounds: ${value} (must be between ${min} and ${max})`,\n      );\n    }\n\n    values.add(value);\n  }\n\n  /**\n   * \u30B9\u30C6\u30C3\u30D7\u5024\u3092\u30D1\u30FC\u30B9\u3057\u3001\u6709\u52B9\u306A\u6B63\u306E\u6574\u6570\u3067\u3042\u308B\u3053\u3068\u3092\u691C\u8A3C\u3059\u308B\u3002\n   * @param step \u30B9\u30C6\u30C3\u30D7\u5024\u306E\u6587\u5B57\u5217\n   * @returns \u30D1\u30FC\u30B9\u6E08\u307F\u306E\u30B9\u30C6\u30C3\u30D7\u5024\n   * @throws {InvalidArgumentError} \u30B9\u30C6\u30C3\u30D7\u5024\u304C\u7121\u52B9\u307E\u305F\u306F1\u672A\u6E80\u306E\u5834\u5408\n   */\n  private parseStepValue(step: string): number {\n    const stepValue = parseInt(step, BASE_10);\n\n    if (Number.isNaN(stepValue) || stepValue < MIN_STEP_VALUE) {\n      throw new InvalidArgumentError(`Invalid step value: ${step}`);\n    }\n\n    return stepValue;\n  }\n\n  /**\n   * \u30B9\u30C6\u30C3\u30D7\u5F0F\u306E\u7BC4\u56F2\u90E8\u5206\u3092\u30D1\u30FC\u30B9\u3059\u308B\u3002*(\u5168\u7BC4\u56F2)\u3001\u6570\u5024-\u6570\u5024(\u660E\u793A\u7BC4\u56F2)\u3001\u5358\u4E00\u6570\u5024(\u958B\u59CB\u5024\u306E\u307F)\u306B\u5BFE\u5FDC\u3059\u308B\u3002\n   * @param range \u7BC4\u56F2\u6587\u5B57\u5217\uFF08\u4F8B: \"*\", \"1-5\", \"3\"\uFF09\n   * @param min \u30D5\u30A3\u30FC\u30EB\u30C9\u306E\u6700\u5C0F\u8A31\u5BB9\u5024\n   * @param max \u30D5\u30A3\u30FC\u30EB\u30C9\u306E\u6700\u5927\u8A31\u5BB9\u5024\n   * @returns \u958B\u59CB\u5024\u3068\u7D42\u4E86\u5024\u3092\u542B\u3080\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\n   */\n  private parseStepRange(\n    range: string,\n    min: number,\n    max: number,\n  ): { start: number; end: number } {\n    if (range === \"*\") {\n      return { start: min, end: max };\n    }\n\n    if (range.includes(\"-\")) {\n      const [start, end] = range.split(\"-\");\n      const startValue = this.parseBoundedValue(start, min, max, range);\n      const endValue = this.parseBoundedValue(end, min, max, range);\n\n      if (startValue > endValue) {\n        throw new InvalidArgumentError(`Range out of bounds: ${range}`);\n      }\n\n      return { start: startValue, end: endValue };\n    }\n\n    return {\n      start: this.parseBoundedValue(range, min, max, range),\n      end: max,\n    };\n  }\n\n  /**\n   * \u6574\u6570\u5024\u3092\u30D1\u30FC\u30B9\u3057\u3001\u6307\u5B9A\u3055\u308C\u305F\u7BC4\u56F2\u5185\u3067\u3042\u308B\u3053\u3068\u3092\u691C\u8A3C\u3059\u308B\u3002\n   * @param value \u30D1\u30FC\u30B9\u5BFE\u8C61\u306E\u6587\u5B57\u5217\n   * @param min \u8A31\u5BB9\u3055\u308C\u308B\u6700\u5C0F\u5024\n   * @param max \u8A31\u5BB9\u3055\u308C\u308B\u6700\u5927\u5024\n   * @param label \u30A8\u30E9\u30FC\u30E1\u30C3\u30BB\u30FC\u30B8\u7528\u306E\u30E9\u30D9\u30EB\u6587\u5B57\u5217\n   * @returns \u30D1\u30FC\u30B9\u6E08\u307F\u306E\u6574\u6570\u5024\n   * @throws {InvalidArgumentError} \u5024\u304C\u7121\u52B9\u307E\u305F\u306F\u7BC4\u56F2\u5916\u306E\u5834\u5408\n   */\n  private parseBoundedValue(\n    value: string,\n    min: number,\n    max: number,\n    label: string,\n  ): number {\n    const parsed = parseInt(value, BASE_10);\n\n    if (Number.isNaN(parsed)) {\n      throw new InvalidArgumentError(`Invalid range: ${label}`);\n    }\n\n    if (parsed < min || parsed > max) {\n      throw new InvalidArgumentError(`Range out of bounds: ${label}`);\n    }\n\n    return parsed;\n  }\n\n  /**\n   * \u6307\u5B9A\u3055\u308C\u305F\u30B9\u30C6\u30C3\u30D7\u9593\u9694\u3067\u7BC4\u56F2\u5185\u306E\u5024\u3092\u30BB\u30C3\u30C8\u306B\u8FFD\u52A0\u3059\u308B\u3002\n   * @param values \u5024\u3092\u8FFD\u52A0\u3059\u308B\u30BB\u30C3\u30C8\n   * @param start \u7BC4\u56F2\u306E\u958B\u59CB\u5024\n   * @param end \u7BC4\u56F2\u306E\u7D42\u4E86\u5024\n   * @param step \u30B9\u30C6\u30C3\u30D7\u9593\u9694\n   * @param min \u30D5\u30A3\u30FC\u30EB\u30C9\u306E\u6700\u5C0F\u8A31\u5BB9\u5024\n   * @param max \u30D5\u30A3\u30FC\u30EB\u30C9\u306E\u6700\u5927\u8A31\u5BB9\u5024\n   */\n  private addRange(\n    values: Set<number>,\n    start: number,\n    end: number,\n    step: number,\n    min: number,\n    max: number,\n  ): void {\n    for (let i = start; i <= end; i += step) {\n      if (i >= min && i <= max) {\n        values.add(i);\n      }\n    }\n  }\n\n  /**\n   * \u6700\u5C0F\u5024\u304B\u3089\u6700\u5927\u5024\u307E\u3067\u306E\u9023\u7D9A\u3057\u305F\u6574\u6570\u914D\u5217\u3092\u751F\u6210\u3059\u308B\u3002\n   * @param min \u7BC4\u56F2\u306E\u958B\u59CB\u5024\n   * @param max \u7BC4\u56F2\u306E\u7D42\u4E86\u5024\n   * @returns \u9023\u7D9A\u3057\u305F\u6574\u6570\u306E\u914D\u5217\n   */\n  private buildRange(min: number, max: number): number[] {\n    const values: number[] = [];\n    for (let i = min; i <= max; i++) {\n      values.push(i);\n    }\n    return values;\n  }\n\n  /**\n   * \u30BB\u30C3\u30C8\u3092\u6607\u9806\u306B\u30BD\u30FC\u30C8\u3055\u308C\u305F\u914D\u5217\u306B\u5909\u63DB\u3059\u308B\u3002\n   * @param values \u5909\u63DB\u5BFE\u8C61\u306E\u30BB\u30C3\u30C8\n   * @returns \u30BD\u30FC\u30C8\u6E08\u307F\u306E\u6570\u5024\u914D\u5217\n   */\n  private sortedValues(values: Set<number>): number[] {\n    return Array.from(values).sort((a, b) => a - b);\n  }\n\n  /**\n   * Returns true when the date matches the cron fields.\n   */\n  public matches(date: Date): boolean {\n    return (\n      this.fields.minute.includes(date.getMinutes()) &&\n      this.fields.hour.includes(date.getHours()) &&\n      this.fields.dayOfMonth.includes(date.getDate()) &&\n      this.fields.month.includes(date.getMonth() + MONTH_OFFSET) &&\n      this.fields.dayOfWeek.includes(date.getDay())\n    );\n  }\n\n  /**\n   * Returns the next execution time after the given date.\n   * Seconds and milliseconds are cleared before searching.\n   */\n  public getNextExecution(after: Date = new TZDate()): Date {\n    const next = new TZDate(after);\n    next.setSeconds(RESET_SECONDS, RESET_MILLISECONDS);\n    next.setMinutes(next.getMinutes() + NEXT_MINUTE_INCREMENT);\n\n    let iterations = 0;\n\n    while (iterations < Cron.MAX_ITERATIONS) {\n      const month = next.getMonth() + MONTH_OFFSET;\n      if (!this.fields.month.includes(month)) {\n        const { value, carry } = this.nextAllowedValue(\n          this.fields.month,\n          month,\n        );\n        if (carry) {\n          next.setFullYear(next.getFullYear() + NEXT_YEAR_INCREMENT);\n        }\n        next.setMonth(value - MONTH_OFFSET, 1);\n        next.setHours(\n          RESET_HOURS,\n          RESET_MINUTES,\n          RESET_SECONDS,\n          RESET_MILLISECONDS,\n        );\n        iterations++;\n        continue;\n      }\n\n      if (!this.matchesDay(next)) {\n        next.setDate(next.getDate() + NEXT_DAY_INCREMENT);\n        next.setHours(\n          RESET_HOURS,\n          RESET_MINUTES,\n          RESET_SECONDS,\n          RESET_MILLISECONDS,\n        );\n        iterations++;\n        continue;\n      }\n\n      const hour = next.getHours();\n      if (!this.fields.hour.includes(hour)) {\n        const { value, carry } = this.nextAllowedValue(this.fields.hour, hour);\n        if (carry) {\n          next.setDate(next.getDate() + NEXT_DAY_INCREMENT);\n        }\n        next.setHours(value, RESET_MINUTES, RESET_SECONDS, RESET_MILLISECONDS);\n        iterations++;\n        continue;\n      }\n\n      const minute = next.getMinutes();\n      if (!this.fields.minute.includes(minute)) {\n        const { value, carry } = this.nextAllowedValue(\n          this.fields.minute,\n          minute,\n        );\n        if (carry) {\n          next.setHours(\n            next.getHours() + NEXT_HOUR_INCREMENT,\n            value,\n            RESET_SECONDS,\n            RESET_MILLISECONDS,\n          );\n        } else {\n          next.setMinutes(value, RESET_SECONDS, RESET_MILLISECONDS);\n        }\n        iterations++;\n        continue;\n      }\n\n      return next;\n    }\n\n    if (iterations >= Cron.MAX_ITERATIONS) {\n      throw new RuntimeError(\n        `Could not find next execution time within ${LOOKAHEAD_YEARS} years`,\n      );\n    }\n\n    return next;\n  }\n\n  /**\n   * Returns a shallow copy of the parsed fields.\n   */\n  public getFields(): CronFields {\n    return { ...this.fields };\n  }\n\n  /**\n   * \u6307\u5B9A\u3055\u308C\u305F\u65E5\u4ED8\u304CdayOfMonth\u3068dayOfWeek\u306E\u4E21\u65B9\u306B\u4E00\u81F4\u3059\u308B\u304B\u5224\u5B9A\u3059\u308B\u3002\n   * @param date \u5224\u5B9A\u5BFE\u8C61\u306E\u65E5\u4ED8\n   * @returns \u4E21\u30D5\u30A3\u30FC\u30EB\u30C9\u306B\u4E00\u81F4\u3059\u308B\u5834\u5408true\n   */\n  private matchesDay(date: Date): boolean {\n    return (\n      this.fields.dayOfMonth.includes(date.getDate()) &&\n      this.fields.dayOfWeek.includes(date.getDay())\n    );\n  }\n\n  /**\n   * \u30BD\u30FC\u30C8\u6E08\u307F\u30EA\u30B9\u30C8\u304B\u3089\u73FE\u5728\u5024\u4EE5\u4E0A\u306E\u6B21\u306E\u8A31\u5BB9\u5024\u3092\u63A2\u3059\u3002\n   * \u73FE\u5728\u5024\u4EE5\u4E0A\u306E\u5024\u304C\u898B\u3064\u304B\u3089\u306A\u3044\u5834\u5408\u3001\u30EA\u30B9\u30C8\u306E\u5148\u982D\u306B\u623B\u308A\u30AD\u30E3\u30EA\u30FC\u30D5\u30E9\u30B0\u3092true\u306B\u3059\u308B\u3002\n   * @param values \u30BD\u30FC\u30C8\u6E08\u307F\u306E\u8A31\u5BB9\u5024\u30EA\u30B9\u30C8\n   * @param current \u73FE\u5728\u306E\u5024\n   * @returns \u6B21\u306E\u8A31\u5BB9\u5024\u3068\u30AD\u30E3\u30EA\u30FC\u30D5\u30E9\u30B0\u3092\u542B\u3080\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\n   */\n  private nextAllowedValue(\n    values: number[],\n    current: number,\n  ): { value: number; carry: boolean } {\n    for (const value of values) {\n      if (value >= current) {\n        return { value, carry: false };\n      }\n    }\n\n    return { value: values[0], carry: true };\n  }\n}\n", "import type { DistributedLock, LockHandle } from \"../core/lock.js\";\nimport type { CronScheduler } from \"../orchestrator/orchestrator.js\";\n\nconst DEFAULT_LOCK_KEY = \"tokiwa:locks:cron\";\nconst DEFAULT_LOCK_TTL_MS = 60_000;\nconst DEFAULT_REFRESH_INTERVAL_MS = 20_000;\nconst DEFAULT_RETRY_INTERVAL_MS = 5_000;\n\nexport interface LeaderSchedulerOptions {\n  scheduler: CronScheduler;\n  lock: DistributedLock;\n  lockKey?: string;\n  lockTtlMs?: number;\n  refreshIntervalMs?: number;\n  retryIntervalMs?: number;\n}\n\n/**\n * \u5206\u6563\u30EA\u30FC\u30C0\u30FC\u9078\u51FA\u6A5F\u80FD\u3092\u5099\u3048\u305FCronScheduler\u30E9\u30C3\u30D1\u30FC\u3002\n * \u30ED\u30C3\u30AF\u3092\u53D6\u5F97\u3057\u305F\u30A4\u30F3\u30B9\u30BF\u30F3\u30B9\u306E\u307F\u304C\u30B8\u30E7\u30D6\u3092\u5B9F\u884C\u3057\u3001\u30ED\u30C3\u30AF\u55AA\u5931\u6642\u306F\u81EA\u52D5\u7684\u306B\u30EA\u30FC\u30C0\u30FC\u30B7\u30C3\u30D7\u3092\u518D\u53D6\u5F97\u3059\u308B\u3002\n */\nexport class LeaderScheduler implements CronScheduler {\n  private readonly scheduler: CronScheduler;\n  private readonly lock: DistributedLock;\n  private readonly lockKey: string;\n  private readonly lockTtlMs: number;\n  private readonly refreshIntervalMs: number;\n  private readonly retryIntervalMs: number;\n  private running = false;\n  private leaderHandle: LockHandle | null = null;\n  private refreshTimer: ReturnType<typeof setInterval> | null = null;\n  private retryTimer: ReturnType<typeof setTimeout> | null = null;\n  private schedulerStarted = false;\n\n  /**\n   * \u30B9\u30B1\u30B8\u30E5\u30FC\u30E9\u30FC\u3001\u30ED\u30C3\u30AF\u3001\u30BF\u30A4\u30DF\u30F3\u30B0\u30AA\u30D7\u30B7\u30E7\u30F3\u3067\u521D\u671F\u5316\u3059\u308B\u3002\n   * @param options \u30B9\u30B1\u30B8\u30E5\u30FC\u30E9\u30FC\u3001\u30ED\u30C3\u30AF\u3001\u304A\u3088\u3073\u30BF\u30A4\u30DF\u30F3\u30B0\u8A2D\u5B9A\u3092\u542B\u3080\u30AA\u30D7\u30B7\u30E7\u30F3\n   */\n  constructor(options: LeaderSchedulerOptions) {\n    this.scheduler = options.scheduler;\n    this.lock = options.lock;\n    this.lockKey = options.lockKey ?? DEFAULT_LOCK_KEY;\n    this.lockTtlMs = options.lockTtlMs ?? DEFAULT_LOCK_TTL_MS;\n    this.refreshIntervalMs =\n      options.refreshIntervalMs ?? DEFAULT_REFRESH_INTERVAL_MS;\n    this.retryIntervalMs = options.retryIntervalMs ?? DEFAULT_RETRY_INTERVAL_MS;\n  }\n\n  /**\n   * \u30EA\u30FC\u30C0\u30FC\u9078\u51FA\u3092\u958B\u59CB\u3059\u308B\u3002\u30ED\u30C3\u30AF\u306E\u53D6\u5F97\u3092\u8A66\u307F\u3001\u6210\u529F\u3059\u308C\u3070\u30B9\u30B1\u30B8\u30E5\u30FC\u30E9\u30FC\u3092\u8D77\u52D5\u3059\u308B\u3002\n   */\n  async start(): Promise<void> {\n    if (this.running) {\n      return;\n    }\n\n    this.running = true;\n    await this.tryAcquire();\n  }\n\n  /**\n   * \u30B9\u30B1\u30B8\u30E5\u30FC\u30E9\u30FC\u3092\u505C\u6B62\u3057\u3001\u30EA\u30FC\u30C0\u30FC\u30B7\u30C3\u30D7\u3092\u89E3\u653E\u3059\u308B\u3002\n   */\n  async stop(): Promise<void> {\n    this.running = false;\n    this.clearRetry();\n    await this.stopLeader();\n  }\n\n  /**\n   * \u5185\u90E8\u30B9\u30B1\u30B8\u30E5\u30FC\u30E9\u30FC\u306B\u30B8\u30E7\u30D6\u3092\u8FFD\u52A0\u3059\u308B\u3002\n   * @param cronExpression cron\u5F0F\u6587\u5B57\u5217\n   * @param name \u30B8\u30E7\u30D6\u306E\u8868\u793A\u540D\n   * @param handler \u30B8\u30E7\u30D6\u5B9F\u884C\u6642\u306B\u547C\u3073\u51FA\u3055\u308C\u308B\u30CF\u30F3\u30C9\u30E9\u30FC\n   * @returns \u751F\u6210\u3055\u308C\u305F\u30B8\u30E7\u30D6ID\n   */\n  addJob(\n    cronExpression: string,\n    name: string,\n    handler: () => void | Promise<void>,\n  ): string {\n    return this.scheduler.addJob(cronExpression, name, handler);\n  }\n\n  /**\n   * \u5185\u90E8\u30B9\u30B1\u30B8\u30E5\u30FC\u30E9\u30FC\u304B\u3089\u30B8\u30E7\u30D6\u3092\u524A\u9664\u3059\u308B\u3002\n   * @param id \u524A\u9664\u5BFE\u8C61\u306E\u30B8\u30E7\u30D6ID\n   * @returns \u30B8\u30E7\u30D6\u304C\u5B58\u5728\u3057\u524A\u9664\u3055\u308C\u305F\u5834\u5408true\n   */\n  removeJob(id: string): boolean {\n    return this.scheduler.removeJob(id);\n  }\n\n  /**\n   * \u6307\u5B9A\u3055\u308C\u305FID\u306E\u30B8\u30E7\u30D6\u304C\u767B\u9332\u3055\u308C\u3066\u3044\u308B\u304B\u78BA\u8A8D\u3059\u308B\u3002\n   * @param id \u78BA\u8A8D\u5BFE\u8C61\u306E\u30B8\u30E7\u30D6ID\n   * @returns \u30B8\u30E7\u30D6\u304C\u767B\u9332\u3055\u308C\u3066\u3044\u308B\u5834\u5408true\n   */\n  isJobScheduled(id: string): boolean {\n    return this.scheduler.isJobScheduled(id);\n  }\n\n  /**\n   * \u30EA\u30FC\u30C0\u30FC\u30B7\u30C3\u30D7\u30ED\u30C3\u30AF\u306E\u53D6\u5F97\u3092\u8A66\u307F\u308B\u3002\u53D6\u5F97\u6210\u529F\u6642\u306F\u30EA\u30FC\u30C0\u30FC\u3068\u3057\u3066\u8D77\u52D5\u3057\u3001\u5931\u6557\u6642\u306F\u30EA\u30C8\u30E9\u30A4\u3092\u30B9\u30B1\u30B8\u30E5\u30FC\u30EB\u3059\u308B\u3002\n   */\n  private async tryAcquire(): Promise<void> {\n    if (!this.running) {\n      return;\n    }\n\n    const handle = await this.lock.acquire(this.lockKey, {\n      ttlMs: this.lockTtlMs,\n    });\n\n    if (!handle) {\n      this.scheduleRetry();\n      return;\n    }\n\n    this.leaderHandle = handle;\n    this.startLeader();\n  }\n\n  /**\n   * \u5185\u90E8\u30B9\u30B1\u30B8\u30E5\u30FC\u30E9\u30FC\u3092\u8D77\u52D5\u3057\u3001\u30ED\u30C3\u30AF\u306E\u30EA\u30D5\u30EC\u30C3\u30B7\u30E5\u30BF\u30A4\u30DE\u30FC\u3092\u958B\u59CB\u3059\u308B\u3002\n   */\n  private startLeader(): void {\n    if (this.schedulerStarted) {\n      return;\n    }\n\n    this.scheduler.start();\n    this.schedulerStarted = true;\n\n    if (this.refreshIntervalMs > 0 && this.lock.refresh) {\n      this.refreshTimer = setInterval(() => {\n        void this.refresh();\n      }, this.refreshIntervalMs);\n    }\n  }\n\n  /**\n   * \u30ED\u30C3\u30AF\u306ETTL\u3092\u30EA\u30D5\u30EC\u30C3\u30B7\u30E5\u3059\u308B\u3002\u30EA\u30D5\u30EC\u30C3\u30B7\u30E5\u306B\u5931\u6557\u3057\u305F\u5834\u5408\u306F\u964D\u683C\u51E6\u7406\u3092\u884C\u3046\u3002\n   */\n  private async refresh(): Promise<void> {\n    if (!this.leaderHandle || !this.lock.refresh) {\n      return;\n    }\n\n    const ok = await this.lock.refresh(this.leaderHandle, this.lockTtlMs);\n    if (!ok) {\n      await this.demote();\n    }\n  }\n\n  /**\n   * \u30EA\u30FC\u30C0\u30FC\u30B7\u30C3\u30D7\u3092\u653E\u68C4\u3059\u308B\u3002\u30B9\u30B1\u30B8\u30E5\u30FC\u30E9\u30FC\u3092\u505C\u6B62\u3057\u3001\u30ED\u30C3\u30AF\u3092\u89E3\u653E\u3057\u305F\u5F8C\u3001\u30EA\u30FC\u30C0\u30FC\u30B7\u30C3\u30D7\u306E\u518D\u53D6\u5F97\u3092\u8A66\u307F\u308B\u3002\n   */\n  private async demote(): Promise<void> {\n    if (!this.leaderHandle) {\n      return;\n    }\n\n    const handle = this.leaderHandle;\n    this.leaderHandle = null;\n\n    this.stopRefresh();\n    if (this.schedulerStarted) {\n      await this.scheduler.stop();\n      this.schedulerStarted = false;\n    }\n\n    await this.lock.release(handle);\n\n    if (this.running) {\n      this.scheduleRetry();\n    }\n  }\n\n  /**\n   * \u30ED\u30C3\u30AF\u53D6\u5F97\u306E\u30EA\u30C8\u30E9\u30A4\u3092retryIntervalMs\u5F8C\u306B\u30B9\u30B1\u30B8\u30E5\u30FC\u30EB\u3059\u308B\u3002\n   */\n  private scheduleRetry(): void {\n    if (!this.running) {\n      return;\n    }\n\n    this.clearRetry();\n    this.retryTimer = setTimeout(() => {\n      void this.tryAcquire();\n    }, this.retryIntervalMs);\n  }\n\n  /**\n   * \u30EA\u30C8\u30E9\u30A4\u30BF\u30A4\u30DE\u30FC\u3092\u30AF\u30EA\u30A2\u3059\u308B\u3002\n   */\n  private clearRetry(): void {\n    if (this.retryTimer) {\n      clearTimeout(this.retryTimer);\n      this.retryTimer = null;\n    }\n  }\n\n  /**\n   * \u30EA\u30D5\u30EC\u30C3\u30B7\u30E5\u30BF\u30A4\u30DE\u30FC\u3092\u30AF\u30EA\u30A2\u3059\u308B\u3002\n   */\n  private stopRefresh(): void {\n    if (this.refreshTimer) {\n      clearInterval(this.refreshTimer);\n      this.refreshTimer = null;\n    }\n  }\n\n  /**\n   * \u30B9\u30B1\u30B8\u30E5\u30FC\u30E9\u30FC\u3092\u505C\u6B62\u3057\u3001\u30ED\u30C3\u30AF\u3092\u89E3\u653E\u3057\u3066\u30EA\u30FC\u30C0\u30FC\u30B7\u30C3\u30D7\u3092\u7D42\u4E86\u3059\u308B\u3002\n   */\n  private async stopLeader(): Promise<void> {\n    this.stopRefresh();\n    if (this.schedulerStarted) {\n      await this.scheduler.stop();\n      this.schedulerStarted = false;\n    }\n    if (this.leaderHandle) {\n      await this.lock.release(this.leaderHandle);\n      this.leaderHandle = null;\n    }\n  }\n}\n", "import { TZDate } from \"@date-fns/tz\";\nimport { generateId } from \"../core/index.js\";\nimport { Logger } from \"../core/logger.js\";\nimport { Cron } from \"./cron.js\";\n\ntype JobHandler = () => void | Promise<void>;\n\ninterface Job {\n  id: string;\n  cron: Cron;\n  handler: JobHandler;\n  name: string;\n}\n\nconst MILLISECONDS_PER_SECOND = 1_000;\nconst SECONDS_PER_MINUTE = 60;\nconst MILLISECONDS_PER_MINUTE = MILLISECONDS_PER_SECOND * SECONDS_PER_MINUTE;\nconst DEFAULT_CHECK_INTERVAL_MS = MILLISECONDS_PER_MINUTE;\nconst MIN_CHECK_INTERVAL_MS = 1;\nconst RESET_SECONDS = 0;\nconst RESET_MILLISECONDS = 0;\nconst NEXT_MINUTE_INCREMENT = 1;\n\nexport interface SchedulerLogger {\n  error(message: string, context?: Record<string, unknown>): void;\n}\n\nexport interface SchedulerOptions {\n  checkIntervalMs?: number;\n  logger?: SchedulerLogger;\n}\n\n/**\n * Runs cron jobs on minute boundaries using local time.\n * When checkIntervalMs is set, it checks at a fixed interval and avoids duplicate runs per minute.\n */\nexport class Scheduler {\n  private readonly jobs = new Map<string, Job>();\n  private timerId: ReturnType<typeof setTimeout> | null = null;\n  private isRunning = false;\n  private checkIntervalMs: number = DEFAULT_CHECK_INTERVAL_MS;\n  private readonly logger: SchedulerLogger;\n  private readonly inFlight = new Set<Promise<void>>();\n  private readonly lastRunKeyByJob = new Map<string, string>();\n\n  /**\n   * @param options Default is minute boundary scheduling.\n   */\n  constructor(options: SchedulerOptions | number = {}) {\n    if (typeof options === \"number\") {\n      this.checkIntervalMs = options;\n      this.logger = new Logger({ level: \"error\" });\n    } else {\n      this.checkIntervalMs =\n        options.checkIntervalMs ?? DEFAULT_CHECK_INTERVAL_MS;\n      this.logger = options.logger ?? new Logger({ level: \"error\" });\n    }\n\n    this.checkIntervalMs = Math.max(\n      MIN_CHECK_INTERVAL_MS,\n      this.checkIntervalMs,\n    );\n  }\n\n  /**\n   * Adds a job with a generated id.\n   * @param cronExpression cron\u5F0F\u6587\u5B57\u5217\n   * @param name \u30B8\u30E7\u30D6\u306E\u8868\u793A\u540D\n   * @param handler \u30B8\u30E7\u30D6\u5B9F\u884C\u6642\u306B\u547C\u3073\u51FA\u3055\u308C\u308B\u30CF\u30F3\u30C9\u30E9\u30FC\n   * @returns \u751F\u6210\u3055\u308C\u305F\u30B8\u30E7\u30D6ID\n   */\n  public addJob(\n    cronExpression: string,\n    name: string,\n    handler: JobHandler,\n  ): string {\n    const cron = new Cron(cronExpression);\n    const id = this.generateJobId();\n    const job: Job = { id, cron, handler, name };\n    this.jobs.set(id, job);\n    this.lastRunKeyByJob.delete(id);\n    return id;\n  }\n\n  /**\n   * Removes a job by id.\n   */\n  public removeJob(id: string): boolean {\n    this.lastRunKeyByJob.delete(id);\n    return this.jobs.delete(id);\n  }\n\n  /**\n   * Returns a job by id, if present.\n   */\n  public getJob(id: string): Job | undefined {\n    return this.jobs.get(id);\n  }\n\n  /**\n   * Returns all registered jobs.\n   */\n  public getAllJobs(): Job[] {\n    return Array.from(this.jobs.values());\n  }\n\n  /**\n   * Starts scheduling if not already running.\n   */\n  public start(): void {\n    if (this.isRunning) {\n      return;\n    }\n\n    this.isRunning = true;\n    this.scheduleNextCheck();\n  }\n\n  /**\n   * Stops scheduling and clears the pending timer.\n   */\n  public async stop(): Promise<void> {\n    if (!this.isRunning) {\n      return;\n    }\n\n    this.isRunning = false;\n    this.clearTimer();\n    await this.waitForInFlight();\n  }\n\n  /**\n   * \u6B21\u306E\u30BF\u30A4\u30DE\u30FC\u30C6\u30A3\u30C3\u30AF\u3092\u30B9\u30B1\u30B8\u30E5\u30FC\u30EB\u3059\u308B\u3002\n   * \u30C7\u30D5\u30A9\u30EB\u30C8\u9593\u9694\u306E\u5834\u5408\u306F\u6B21\u306E\u5206\u5883\u754C\u307E\u3067\u3001\u305D\u308C\u4EE5\u5916\u306FcheckIntervalMs\u3067\u5F85\u6A5F\u3059\u308B\u3002\n   */\n  private scheduleNextCheck(): void {\n    if (!this.isRunning) {\n      return;\n    }\n\n    const delay =\n      this.checkIntervalMs === DEFAULT_CHECK_INTERVAL_MS\n        ? Scheduler.getDelayUntilNextMinute(new TZDate())\n        : this.checkIntervalMs;\n    this.timerId = setTimeout(this.handleTick, delay);\n  }\n\n  /**\n   * \u30BF\u30A4\u30DE\u30FC\u30B3\u30FC\u30EB\u30D0\u30C3\u30AF\u3002\u30B8\u30E7\u30D6\u306E\u5B9F\u884C\u30C1\u30A7\u30C3\u30AF\u3092\u884C\u3044\u3001\u6B21\u306E\u30C6\u30A3\u30C3\u30AF\u3092\u518D\u30B9\u30B1\u30B8\u30E5\u30FC\u30EB\u3059\u308B\u3002\n   */\n  private handleTick = (): void => {\n    void this.checkAndExecuteJobs();\n    this.scheduleNextCheck();\n  };\n\n  /**\n   * \u5168\u30B8\u30E7\u30D6\u3092\u73FE\u5728\u6642\u523B\u3068\u7167\u5408\u3057\u3001\u4E00\u81F4\u3059\u308B\u30B8\u30E7\u30D6\u3092\u5B9F\u884C\u3059\u308B\u3002\n   * \u540C\u4E00\u5206\u5185\u3067\u306E\u91CD\u8907\u5B9F\u884C\u3092\u9632\u6B62\u3059\u308B\u305F\u3081\u30DF\u30CB\u30C3\u30C8\u30AD\u30FC\u3067\u7BA1\u7406\u3059\u308B\u3002\n   */\n  private async checkAndExecuteJobs(): Promise<void> {\n    const now = new TZDate();\n    const minuteKey = Scheduler.buildMinuteKey(now);\n    const tasks: Promise<void>[] = [];\n\n    for (const job of this.jobs.values()) {\n      if (!job.cron.matches(now)) {\n        continue;\n      }\n\n      if (this.lastRunKeyByJob.get(job.id) === minuteKey) {\n        continue;\n      }\n\n      this.lastRunKeyByJob.set(job.id, minuteKey);\n      tasks.push(this.runJob(job));\n    }\n\n    if (tasks.length > 0) {\n      await Promise.allSettled(tasks);\n    }\n  }\n\n  /**\n   * \u4FDD\u7559\u4E2D\u306EsetTimeout\u30BF\u30A4\u30DE\u30FC\u3092\u30AF\u30EA\u30A2\u3059\u308B\u3002\n   */\n  private clearTimer(): void {\n    if (this.timerId) {\n      clearTimeout(this.timerId);\n      this.timerId = null;\n    }\n  }\n\n  /**\n   * \u30B8\u30E7\u30D6\u306E\u30CF\u30F3\u30C9\u30E9\u30FC\u3092\u5B9F\u884C\u3057\u3001\u30A8\u30E9\u30FC\u767A\u751F\u6642\u306F\u30ED\u30B0\u306B\u8A18\u9332\u3059\u308B\u3002\n   * \u5B9F\u884C\u4E2D\u306E\u30B8\u30E7\u30D6\u306FinFlight\u30BB\u30C3\u30C8\u3067\u8FFD\u8DE1\u3055\u308C\u308B\u3002\n   * @param job \u5B9F\u884C\u5BFE\u8C61\u306E\u30B8\u30E7\u30D6\n   * @returns \u30B8\u30E7\u30D6\u5B8C\u4E86\u3092\u8868\u3059Promise\n   */\n  private runJob(job: Job): Promise<void> {\n    const task = (async () => {\n      try {\n        await job.handler();\n      } catch (error: unknown) {\n        this.logger.error(`Error executing job ${job.id}`, {\n          jobId: job.id,\n          name: job.name,\n          error,\n        });\n      }\n    })();\n\n    this.inFlight.add(task);\n    task.finally(() => {\n      this.inFlight.delete(task);\n    });\n\n    return task;\n  }\n\n  /**\n   * \u5B9F\u884C\u4E2D\u306E\u5168\u30B8\u30E7\u30D6\u304C\u5B8C\u4E86\u3059\u308B\u307E\u3067\u5F85\u6A5F\u3059\u308B\u3002\n   */\n  private async waitForInFlight(): Promise<void> {\n    if (this.inFlight.size === 0) {\n      return;\n    }\n    await Promise.allSettled(this.inFlight);\n  }\n\n  /**\n   * \u73FE\u5728\u6642\u523B\u304B\u3089\u6B21\u306E\u5206\u5883\u754C\u307E\u3067\u306E\u30DF\u30EA\u79D2\u6570\u3092\u8A08\u7B97\u3059\u308B\u3002\n   * @param now \u73FE\u5728\u6642\u523B\n   * @returns \u6B21\u306E\u5206\u5883\u754C\u307E\u3067\u306E\u30DF\u30EA\u79D2\u6570\n   */\n  private static getDelayUntilNextMinute(now: Date): number {\n    const nextMinute = new TZDate(now);\n    nextMinute.setSeconds(RESET_SECONDS, RESET_MILLISECONDS);\n    nextMinute.setMinutes(nextMinute.getMinutes() + NEXT_MINUTE_INCREMENT);\n    return nextMinute.getTime() - now.getTime();\n  }\n\n  /**\n   * \u6307\u5B9A\u3055\u308C\u305F\u65E5\u6642\u304B\u3089\u5206\u5358\u4F4D\u306E\u4E00\u610F\u30AD\u30FC\u3092\u751F\u6210\u3059\u308B\u3002\u91CD\u8907\u5B9F\u884C\u9632\u6B62\u306B\u4F7F\u7528\u3055\u308C\u308B\u3002\n   * @param date \u30AD\u30FC\u751F\u6210\u5BFE\u8C61\u306E\u65E5\u6642\n   * @returns \"\u5E74-\u6708-\u65E5-\u6642-\u5206\" \u5F62\u5F0F\u306E\u6587\u5B57\u5217\u30AD\u30FC\n   */\n  private static buildMinuteKey(date: Date): string {\n    return [\n      date.getFullYear(),\n      date.getMonth(),\n      date.getDate(),\n      date.getHours(),\n      date.getMinutes(),\n    ].join(\"-\");\n  }\n\n  /**\n   * Returns the next execution time for a job, or null if missing.\n   */\n  public getNextExecutionTime(jobId: string): Date | null {\n    const job = this.jobs.get(jobId);\n    if (!job) {\n      return null;\n    }\n\n    return job.cron.getNextExecution();\n  }\n\n  /**\n   * Returns true when a job id is registered.\n   */\n  public isJobScheduled(jobId: string): boolean {\n    return this.jobs.has(jobId);\n  }\n\n  /**\n   * \u65E2\u5B58\u30B8\u30E7\u30D6\u3068\u91CD\u8907\u3057\u306A\u3044ID\u3092\u751F\u6210\u3059\u308B\u3002\n   * @returns \u30B8\u30E7\u30D6ID\n   */\n  private generateJobId(): string {\n    let id = generateId();\n    while (this.jobs.has(id)) {\n      id = generateId();\n    }\n    return id;\n  }\n}\n", "import { generateId } from \"../core/index.js\";\n\nexport type ConnectionState = \"connected\" | \"disconnected\";\n\nexport interface ConnectionInit {\n  name?: string;\n  metadata?: Record<string, unknown>;\n}\n\n/**\n * \u540D\u524D\u4ED8\u304D\u306E\u63A5\u7D9A\u3092\u8868\u3059\u30AF\u30E9\u30B9\u3002\u63A5\u7D9A\u72B6\u614B\u306E\u7BA1\u7406\u3068\u30E1\u30BF\u30C7\u30FC\u30BF\u306E\u4FDD\u6301\u3092\u884C\u3046\u3002\n */\nexport class Connection {\n  readonly id: string;\n  readonly name?: string;\n  private state: ConnectionState = \"disconnected\";\n  private metadata: Record<string, unknown>;\n\n  /**\n   * \u63A5\u7D9A\u3092\u751F\u6210\u3059\u308B\u3002\u521D\u671F\u72B6\u614B\u306F\"disconnected\"\u3068\u306A\u308B\u3002\n   *\n   * @param init - \u63A5\u7D9A\u306E\u521D\u671F\u5316\u30D1\u30E9\u30E1\u30FC\u30BF\uFF08\u540D\u524D\u3068\u30E1\u30BF\u30C7\u30FC\u30BF\uFF09\n   */\n  constructor(init: ConnectionInit = {}) {\n    this.id = generateId();\n    this.name = init.name;\n    this.metadata = init.metadata ?? {};\n  }\n\n  /**\n   * \u63A5\u7D9A\u72B6\u614B\u3092\"connected\"\u306B\u8A2D\u5B9A\u3059\u308B\u3002\n   */\n  connect(): void {\n    this.state = \"connected\";\n  }\n\n  /**\n   * \u63A5\u7D9A\u72B6\u614B\u3092\"disconnected\"\u306B\u8A2D\u5B9A\u3059\u308B\u3002\n   */\n  disconnect(): void {\n    this.state = \"disconnected\";\n  }\n\n  /**\n   * \u73FE\u5728\u306E\u63A5\u7D9A\u72B6\u614B\u3092\u8FD4\u3059\u3002\n   *\n   * @returns \u73FE\u5728\u306E\u63A5\u7D9A\u72B6\u614B\uFF08\"connected\" \u307E\u305F\u306F \"disconnected\"\uFF09\n   */\n  getState(): ConnectionState {\n    return this.state;\n  }\n\n  /**\n   * \u30E1\u30BF\u30C7\u30FC\u30BF\u3092\u30DE\u30FC\u30B8\u3057\u3066\u66F4\u65B0\u3059\u308B\u3002\u65E2\u5B58\u306E\u30AD\u30FC\u306F\u4E0A\u66F8\u304D\u3055\u308C\u308B\u3002\n   *\n   * @param update - \u30DE\u30FC\u30B8\u3059\u308B\u30E1\u30BF\u30C7\u30FC\u30BF\u306E\u30AD\u30FC\u3068\u5024\u306E\u30DA\u30A2\n   */\n  updateMetadata(update: Record<string, unknown>): void {\n    this.metadata = { ...this.metadata, ...update };\n  }\n\n  /**\n   * \u30E1\u30BF\u30C7\u30FC\u30BF\u306E\u30B7\u30E3\u30ED\u30FC\u30B3\u30D4\u30FC\u3092\u8FD4\u3059\u3002\n   *\n   * @returns \u30E1\u30BF\u30C7\u30FC\u30BF\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\u306E\u6D45\u3044\u30B3\u30D4\u30FC\n   */\n  getMetadata(): Record<string, unknown> {\n    return { ...this.metadata };\n  }\n}\n", "import { TZDate } from \"@date-fns/tz\";\nimport { generateId, InvalidArgumentError } from \"../core/index.js\";\n\nexport interface EventMetadata {\n  correlationId?: string;\n  causationId?: string;\n  source?: string;\n  tags?: string[];\n}\n\nexport interface EventInit<TPayload = unknown> {\n  type: string;\n  payload?: TPayload;\n  timestamp?: Date;\n  metadata?: EventMetadata;\n}\n\n/**\n * \u30C9\u30E1\u30A4\u30F3\u30A4\u30D9\u30F3\u30C8\u3092\u8868\u3059\u30AF\u30E9\u30B9\u3002\u578B\u3001\u30DA\u30A4\u30ED\u30FC\u30C9\u3001\u30BF\u30A4\u30E0\u30B9\u30BF\u30F3\u30D7\u3001\u30E1\u30BF\u30C7\u30FC\u30BF\u3092\u4FDD\u6301\u3059\u308B\u3002\n *\n * @template TPayload - \u30A4\u30D9\u30F3\u30C8\u306E\u30DA\u30A4\u30ED\u30FC\u30C9\u306E\u578B\n */\nexport class Event<TPayload = unknown> {\n  readonly id: string;\n  readonly type: string;\n  readonly payload: TPayload;\n  readonly timestamp: Date;\n  readonly metadata: EventMetadata;\n\n  /**\n   * EventInit\u304B\u3089\u30A4\u30D9\u30F3\u30C8\u3092\u751F\u6210\u3059\u308B\u3002type\u304C\u7A7A\u6587\u5B57\u5217\u306E\u5834\u5408\u306F\u30A8\u30E9\u30FC\u3092\u30B9\u30ED\u30FC\u3059\u308B\u3002\n   *\n   * @param init - \u30A4\u30D9\u30F3\u30C8\u306E\u521D\u671F\u5316\u30D1\u30E9\u30E1\u30FC\u30BF\n   * @throws {InvalidArgumentError} type\u304C\u7A7A\u6587\u5B57\u5217\u306E\u5834\u5408\n   */\n  constructor(init: EventInit<TPayload>) {\n    if (!init.type || init.type.trim().length === 0) {\n      throw new InvalidArgumentError(\"Event type must be a non-empty string\");\n    }\n\n    this.id = generateId();\n    this.type = init.type;\n    this.payload = init.payload as TPayload;\n    this.timestamp = init.timestamp ?? new TZDate();\n    this.metadata = init.metadata ?? {};\n  }\n\n  /**\n   * \u30A4\u30D9\u30F3\u30C8\u3092\u751F\u6210\u3059\u308B\u30D5\u30A1\u30AF\u30C8\u30EA\u30E1\u30BD\u30C3\u30C9\u3002\u578B\u3001\u30DA\u30A4\u30ED\u30FC\u30C9\u3001\u30E1\u30BF\u30C7\u30FC\u30BF\u3092\u6307\u5B9A\u3057\u3066\u30A4\u30D9\u30F3\u30C8\u3092\u4F5C\u6210\u3059\u308B\u3002\n   *\n   * @template TPayload - \u30A4\u30D9\u30F3\u30C8\u306E\u30DA\u30A4\u30ED\u30FC\u30C9\u306E\u578B\n   * @param type - \u30A4\u30D9\u30F3\u30C8\u306E\u7A2E\u5225\u3092\u793A\u3059\u6587\u5B57\u5217\n   * @param payload - \u30A4\u30D9\u30F3\u30C8\u306B\u4ED8\u968F\u3059\u308B\u30C7\u30FC\u30BF\n   * @param metadata - \u30A4\u30D9\u30F3\u30C8\u306E\u30E1\u30BF\u30C7\u30FC\u30BF\uFF08\u76F8\u95A2ID\u3001\u539F\u56E0ID\u3001\u30BD\u30FC\u30B9\u3001\u30BF\u30B0\u306A\u3069\uFF09\n   * @returns \u65B0\u3057\u3044Event\u30A4\u30F3\u30B9\u30BF\u30F3\u30B9\n   */\n  static create<TPayload = unknown>(\n    type: string,\n    payload?: TPayload,\n    metadata?: EventMetadata,\n  ): Event<TPayload> {\n    return new Event<TPayload>({ type, payload, metadata });\n  }\n}\n", "import { generateId, InvalidArgumentError } from \"../core/index.js\";\nimport type { Event } from \"./event.js\";\n\n/**\n * \u30A4\u30D9\u30F3\u30C8\u30CF\u30F3\u30C9\u30E9\u30FC\u306B\u6E21\u3055\u308C\u308B\u30B3\u30F3\u30C6\u30AD\u30B9\u30C8\u60C5\u5831\u3002\n */\nexport interface HandlerContext {\n  /** \u30CF\u30F3\u30C9\u30E9\u30FC\u3092\u6240\u6709\u3059\u308B\u30B5\u30D6\u30B9\u30AF\u30E9\u30A4\u30D0\u30FC\u306EID */\n  subscriberId: string;\n}\n\n/**\n * \u30A4\u30D9\u30F3\u30C8\u3092\u51E6\u7406\u3059\u308B\u30CF\u30F3\u30C9\u30E9\u30FC\u95A2\u6570\u306E\u578B\u5B9A\u7FA9\u3002\n * @typeParam TPayload - \u30A4\u30D9\u30F3\u30C8\u30DA\u30A4\u30ED\u30FC\u30C9\u306E\u578B\n * @param event - \u53D7\u4FE1\u3057\u305F\u30A4\u30D9\u30F3\u30C8\n * @param context - \u30CF\u30F3\u30C9\u30E9\u30FC\u30B3\u30F3\u30C6\u30AD\u30B9\u30C8\n */\nexport type EventHandler<TPayload = unknown> = (\n  event: Event<TPayload>,\n  context: HandlerContext,\n) => void | Promise<void>;\n\n/**\n * \u30B5\u30D6\u30B9\u30AF\u30E9\u30A4\u30D0\u30FC\u4F5C\u6210\u6642\u306E\u30AA\u30D7\u30B7\u30E7\u30F3\u8A2D\u5B9A\u3002\n */\nexport interface SubscriberOptions {\n  /** \u30B5\u30D6\u30B9\u30AF\u30E9\u30A4\u30D0\u30FC\u306E\u540D\u524D\uFF08\u30C7\u30D0\u30C3\u30B0\u7528\u9014\uFF09 */\n  name?: string;\n  /** `true` \u306E\u5834\u5408\u3001\u30CF\u30F3\u30C9\u30E9\u30FC\u306F\u4E00\u5EA6\u3060\u3051\u5B9F\u884C\u3055\u308C\u81EA\u52D5\u7684\u306B\u767B\u9332\u89E3\u9664\u3055\u308C\u308B */\n  once?: boolean;\n  /** \u30A4\u30D9\u30F3\u30C8\u3092\u30D5\u30A3\u30EB\u30BF\u30EA\u30F3\u30B0\u3059\u308B\u95A2\u6570\u3002`false` \u3092\u8FD4\u3059\u3068\u30CF\u30F3\u30C9\u30E9\u30FC\u306F\u5B9F\u884C\u3055\u308C\u306A\u3044 */\n  filter?: (event: Event) => boolean;\n}\n\n/**\n * \u30A4\u30D9\u30F3\u30C8\u30B5\u30D6\u30B9\u30AF\u30E9\u30A4\u30D0\u30FC\u3092\u8868\u3059\u30AF\u30E9\u30B9\u3002\n * \u30CF\u30F3\u30C9\u30E9\u30FC\u95A2\u6570\u3001\u30AA\u30D7\u30B7\u30E7\u30F3\u306E\u30D5\u30A3\u30EB\u30BF\u30FC\u3001\u304A\u3088\u3073\u4E00\u56DE\u9650\u308A\u306E\u5B9F\u884C\u30D5\u30E9\u30B0\u3092\u4FDD\u6301\u3059\u308B\u3002\n * @typeParam TPayload - \u30A4\u30D9\u30F3\u30C8\u30DA\u30A4\u30ED\u30FC\u30C9\u306E\u578B\n */\nexport class Subscriber<TPayload = unknown> {\n  /** \u30B5\u30D6\u30B9\u30AF\u30E9\u30A4\u30D0\u30FC\u306E\u4E00\u610F\u306A\u8B58\u5225\u5B50 */\n  readonly id: string;\n  /** \u8CFC\u8AAD\u5BFE\u8C61\u306E\u30A4\u30D9\u30F3\u30C8\u30BF\u30A4\u30D7 */\n  readonly type: string;\n  /** \u30B5\u30D6\u30B9\u30AF\u30E9\u30A4\u30D0\u30FC\u306E\u540D\u524D\uFF08\u30C7\u30D0\u30C3\u30B0\u7528\u9014\uFF09 */\n  readonly name?: string;\n  /** \u4E00\u5EA6\u3060\u3051\u5B9F\u884C\u3057\u3066\u81EA\u52D5\u767B\u9332\u89E3\u9664\u3059\u308B\u304B\u3069\u3046\u304B */\n  readonly once: boolean;\n  /** \u30A4\u30D9\u30F3\u30C8\u30D5\u30A3\u30EB\u30BF\u30FC\u95A2\u6570 */\n  readonly filter?: (event: Event) => boolean;\n  /** \u30A4\u30D9\u30F3\u30C8\u30CF\u30F3\u30C9\u30E9\u30FC\u95A2\u6570 */\n  readonly handler: EventHandler<TPayload>;\n\n  /**\n   * \u65B0\u3057\u3044\u30B5\u30D6\u30B9\u30AF\u30E9\u30A4\u30D0\u30FC\u3092\u4F5C\u6210\u3059\u308B\u3002\n   * @param type - \u8CFC\u8AAD\u3059\u308B\u30A4\u30D9\u30F3\u30C8\u30BF\u30A4\u30D7\uFF08\u7A7A\u6587\u5B57\u5217\u306F\u4E0D\u53EF\uFF09\n   * @param handler - \u30A4\u30D9\u30F3\u30C8\u53D7\u4FE1\u6642\u306B\u547C\u3073\u51FA\u3055\u308C\u308B\u30CF\u30F3\u30C9\u30E9\u30FC\u95A2\u6570\n   * @param options - \u30B5\u30D6\u30B9\u30AF\u30E9\u30A4\u30D0\u30FC\u306E\u30AA\u30D7\u30B7\u30E7\u30F3\u8A2D\u5B9A\n   * @throws {InvalidArgumentError} \u30BF\u30A4\u30D7\u304C\u7A7A\u6587\u5B57\u5217\u306E\u5834\u5408\n   */\n  constructor(\n    type: string,\n    handler: EventHandler<TPayload>,\n    options: SubscriberOptions = {},\n  ) {\n    if (!type || type.trim().length === 0) {\n      throw new InvalidArgumentError(\n        \"Subscriber type must be a non-empty string\",\n      );\n    }\n\n    this.id = generateId();\n    this.type = type;\n    this.name = options.name;\n    this.once = options.once ?? false;\n    this.filter = options.filter;\n    this.handler = handler;\n  }\n}\n", "import { RuntimeError } from \"../core/index.js\";\nimport type { Event } from \"./event.js\";\nimport {\n  type EventHandler,\n  type HandlerContext,\n  Subscriber,\n  type SubscriberOptions,\n} from \"./subscriber.js\";\n\n/**\n * \u30A4\u30D9\u30F3\u30C8\u30C7\u30A3\u30B9\u30D1\u30C3\u30C1\u6642\u306B\u30CF\u30F3\u30C9\u30E9\u30FC\u3078\u6E21\u3055\u308C\u308B\u30B3\u30F3\u30C6\u30AD\u30B9\u30C8\u60C5\u5831\u3002\n * @extends HandlerContext\n */\nexport interface DispatchContext extends HandlerContext {\n  /** \u30C7\u30A3\u30B9\u30D1\u30C3\u30C1\u30E3\u30FC\u30A4\u30F3\u30B9\u30BF\u30F3\u30B9\u3078\u306E\u53C2\u7167 */\n  dispatcher: EventDispatcher;\n  /** \u30C7\u30A3\u30B9\u30D1\u30C3\u30C1\u3055\u308C\u305F\u30A4\u30D9\u30F3\u30C8\u306E\u30BF\u30A4\u30D7 */\n  eventType: string;\n}\n\n/**\n * \u30C7\u30A3\u30B9\u30D1\u30C3\u30C1\u4E2D\u306B\u767A\u751F\u3057\u305F\u30A8\u30E9\u30FC\u306E\u8A73\u7D30\u60C5\u5831\u3002\n */\nexport interface DispatchError {\n  /** \u30A8\u30E9\u30FC\u304C\u767A\u751F\u3057\u305F\u30B5\u30D6\u30B9\u30AF\u30E9\u30A4\u30D0\u30FC\u306EID */\n  subscriberId: string;\n  /** \u767A\u751F\u3057\u305F\u30A8\u30E9\u30FC\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8 */\n  error: Error;\n  /** \u30A8\u30E9\u30FC\u304C\u767A\u751F\u3057\u305F\u30B9\u30C6\u30FC\u30B8\uFF08\u30D5\u30A3\u30EB\u30BF\u30FC\u5B9F\u884C\u6642\u307E\u305F\u306F\u30CF\u30F3\u30C9\u30E9\u30FC\u5B9F\u884C\u6642\uFF09 */\n  stage: \"filter\" | \"handler\";\n}\n\n/**\n * \u30A4\u30D9\u30F3\u30C8\u30C7\u30A3\u30B9\u30D1\u30C3\u30C1\u306E\u5B9F\u884C\u7D50\u679C\u3002\n */\nexport interface DispatchResult {\n  /** \u30C7\u30A3\u30B9\u30D1\u30C3\u30C1\u3055\u308C\u305F\u30A4\u30D9\u30F3\u30C8 */\n  event: Event;\n  /** \u6B63\u5E38\u306B\u914D\u4FE1\u3055\u308C\u305F\u30B5\u30D6\u30B9\u30AF\u30E9\u30A4\u30D0\u30FC\u306E\u6570 */\n  delivered: number;\n  /** \u30C7\u30A3\u30B9\u30D1\u30C3\u30C1\u4E2D\u306B\u767A\u751F\u3057\u305F\u30A8\u30E9\u30FC\u306E\u4E00\u89A7 */\n  errors: DispatchError[];\n}\n\n/**\n * \u30B5\u30D6\u30B9\u30AF\u30E9\u30A4\u30D0\u30FC\u306E\u767B\u9332\u3068\u30A4\u30D9\u30F3\u30C8\u30C7\u30A3\u30B9\u30D1\u30C3\u30C1\u3092\u7BA1\u7406\u3059\u308B\u30AF\u30E9\u30B9\u3002\n * \u30EF\u30A4\u30EB\u30C9\u30AB\u30FC\u30C9\uFF08`*`\uFF09\u306B\u3088\u308B\u30A4\u30D9\u30F3\u30C8\u8CFC\u8AAD\u3092\u30B5\u30DD\u30FC\u30C8\u3059\u308B\u3002\n */\nexport class EventDispatcher {\n  /** \u30A4\u30D9\u30F3\u30C8\u30BF\u30A4\u30D7\u3054\u3068\u306E\u30B5\u30D6\u30B9\u30AF\u30E9\u30A4\u30D0\u30FC\u30BB\u30C3\u30C8 */\n  private readonly subscribersByType = new Map<string, Set<Subscriber>>();\n  /** \u30B5\u30D6\u30B9\u30AF\u30E9\u30A4\u30D0\u30FCID\u306B\u3088\u308B\u30B5\u30D6\u30B9\u30AF\u30E9\u30A4\u30D0\u30FC\u306E\u30DE\u30C3\u30D7 */\n  private readonly subscribersById = new Map<string, Subscriber>();\n\n  /**\n   * \u6307\u5B9A\u3055\u308C\u305F\u30A4\u30D9\u30F3\u30C8\u30BF\u30A4\u30D7\u306B\u5BFE\u3057\u3066\u65B0\u3057\u3044\u30CF\u30F3\u30C9\u30E9\u30FC\u3092\u767B\u9332\u3059\u308B\u3002\n   * @param type - \u8CFC\u8AAD\u3059\u308B\u30A4\u30D9\u30F3\u30C8\u30BF\u30A4\u30D7\uFF08`*` \u3067\u30EF\u30A4\u30EB\u30C9\u30AB\u30FC\u30C9\u8CFC\u8AAD\u53EF\u80FD\uFF09\n   * @param handler - \u30A4\u30D9\u30F3\u30C8\u53D7\u4FE1\u6642\u306B\u547C\u3073\u51FA\u3055\u308C\u308B\u30CF\u30F3\u30C9\u30E9\u30FC\u95A2\u6570\n   * @param options - \u30B5\u30D6\u30B9\u30AF\u30E9\u30A4\u30D0\u30FC\u306E\u30AA\u30D7\u30B7\u30E7\u30F3\u8A2D\u5B9A\uFF08\u540D\u524D\u3001\u4E00\u56DE\u9650\u308A\u3001\u30D5\u30A3\u30EB\u30BF\u30FC\u306A\u3069\uFF09\n   * @returns \u4F5C\u6210\u3055\u308C\u305F {@link Subscriber} \u30A4\u30F3\u30B9\u30BF\u30F3\u30B9\n   */\n  public subscribe(\n    type: string,\n    handler: EventHandler,\n    options: SubscriberOptions = {},\n  ): Subscriber {\n    const subscriber = new Subscriber(type, handler, options);\n    const bucket = this.subscribersByType.get(type) ?? new Set<Subscriber>();\n\n    bucket.add(subscriber);\n    this.subscribersByType.set(type, bucket);\n    this.subscribersById.set(subscriber.id, subscriber);\n\n    return subscriber;\n  }\n\n  /**\n   * \u6307\u5B9A\u3055\u308C\u305FID\u306E\u30B5\u30D6\u30B9\u30AF\u30E9\u30A4\u30D0\u30FC\u3092\u767B\u9332\u89E3\u9664\u3059\u308B\u3002\n   * @param subscriberId - \u767B\u9332\u89E3\u9664\u3059\u308B\u30B5\u30D6\u30B9\u30AF\u30E9\u30A4\u30D0\u30FC\u306EID\n   * @returns \u767B\u9332\u89E3\u9664\u306B\u6210\u529F\u3057\u305F\u5834\u5408\u306F `true`\u3001\u8A72\u5F53\u3059\u308B\u30B5\u30D6\u30B9\u30AF\u30E9\u30A4\u30D0\u30FC\u304C\u898B\u3064\u304B\u3089\u306A\u3044\u5834\u5408\u306F `false`\n   */\n  public unsubscribe(subscriberId: string): boolean {\n    const subscriber = this.subscribersById.get(subscriberId);\n    if (!subscriber) {\n      return false;\n    }\n\n    this.subscribersById.delete(subscriberId);\n    const bucket = this.subscribersByType.get(subscriber.type);\n    if (bucket) {\n      bucket.delete(subscriber);\n      if (bucket.size === 0) {\n        this.subscribersByType.delete(subscriber.type);\n      }\n    }\n\n    return true;\n  }\n\n  /**\n   * \u30B5\u30D6\u30B9\u30AF\u30E9\u30A4\u30D0\u30FC\u3092\u3059\u3079\u3066\u3001\u307E\u305F\u306F\u6307\u5B9A\u3057\u305F\u30BF\u30A4\u30D7\u306E\u3082\u306E\u3060\u3051\u30AF\u30EA\u30A2\u3059\u308B\u3002\n   * @param type - \u30AF\u30EA\u30A2\u5BFE\u8C61\u306E\u30A4\u30D9\u30F3\u30C8\u30BF\u30A4\u30D7\u3002\u7701\u7565\u6642\u306F\u3059\u3079\u3066\u306E\u30B5\u30D6\u30B9\u30AF\u30E9\u30A4\u30D0\u30FC\u3092\u524A\u9664\u3059\u308B\u3002\n   */\n  public clear(type?: string): void {\n    if (!type) {\n      this.subscribersByType.clear();\n      this.subscribersById.clear();\n      return;\n    }\n\n    const bucket = this.subscribersByType.get(type);\n    if (!bucket) {\n      return;\n    }\n\n    for (const subscriber of bucket) {\n      this.subscribersById.delete(subscriber.id);\n    }\n\n    this.subscribersByType.delete(type);\n  }\n\n  /**\n   * \u6307\u5B9A\u3055\u308C\u305FID\u306E\u30B5\u30D6\u30B9\u30AF\u30E9\u30A4\u30D0\u30FC\u3092\u53D6\u5F97\u3059\u308B\u3002\n   * @param subscriberId - \u53D6\u5F97\u3059\u308B\u30B5\u30D6\u30B9\u30AF\u30E9\u30A4\u30D0\u30FC\u306EID\n   * @returns \u8A72\u5F53\u3059\u308B {@link Subscriber}\u3001\u898B\u3064\u304B\u3089\u306A\u3044\u5834\u5408\u306F `undefined`\n   */\n  public getSubscriber(subscriberId: string): Subscriber | undefined {\n    return this.subscribersById.get(subscriberId);\n  }\n\n  /**\n   * \u3059\u3079\u3066\u306E\u30B5\u30D6\u30B9\u30AF\u30E9\u30A4\u30D0\u30FC\u3001\u307E\u305F\u306F\u6307\u5B9A\u3057\u305F\u30BF\u30A4\u30D7\u306E\u30B5\u30D6\u30B9\u30AF\u30E9\u30A4\u30D0\u30FC\u4E00\u89A7\u3092\u53D6\u5F97\u3059\u308B\u3002\n   * @param type - \u30D5\u30A3\u30EB\u30BF\u30EA\u30F3\u30B0\u3059\u308B\u30A4\u30D9\u30F3\u30C8\u30BF\u30A4\u30D7\u3002\u7701\u7565\u6642\u306F\u3059\u3079\u3066\u306E\u30B5\u30D6\u30B9\u30AF\u30E9\u30A4\u30D0\u30FC\u3092\u8FD4\u3059\u3002\n   * @returns \u30B5\u30D6\u30B9\u30AF\u30E9\u30A4\u30D0\u30FC\u306E\u914D\u5217\n   */\n  public getSubscribers(type?: string): Subscriber[] {\n    if (type) {\n      return Array.from(this.subscribersByType.get(type) ?? []);\n    }\n\n    return Array.from(this.subscribersById.values());\n  }\n\n  /**\n   * \u30A4\u30D9\u30F3\u30C8\u3092\u30DE\u30C3\u30C1\u3059\u308B\u30B5\u30D6\u30B9\u30AF\u30E9\u30A4\u30D0\u30FC\u306B\u30C7\u30A3\u30B9\u30D1\u30C3\u30C1\u3059\u308B\u3002\n   * \u76F4\u63A5\u4E00\u81F4\u3059\u308B\u30BF\u30A4\u30D7\u306E\u30B5\u30D6\u30B9\u30AF\u30E9\u30A4\u30D0\u30FC\u3068\u30EF\u30A4\u30EB\u30C9\u30AB\u30FC\u30C9\uFF08`*`\uFF09\u30B5\u30D6\u30B9\u30AF\u30E9\u30A4\u30D0\u30FC\u306E\u4E21\u65B9\u306B\u914D\u4FE1\u3059\u308B\u3002\n   * \u30D5\u30A3\u30EB\u30BF\u30FC\u3084\u30CF\u30F3\u30C9\u30E9\u30FC\u3067\u767A\u751F\u3057\u305F\u30A8\u30E9\u30FC\u306F\u53CE\u96C6\u3055\u308C\u3001\u7D50\u679C\u306B\u542B\u307E\u308C\u308B\u3002\n   * `once` \u30D5\u30E9\u30B0\u304C\u8A2D\u5B9A\u3055\u308C\u305F\u30B5\u30D6\u30B9\u30AF\u30E9\u30A4\u30D0\u30FC\u306F\u5B9F\u884C\u5F8C\u306B\u81EA\u52D5\u7684\u306B\u767B\u9332\u89E3\u9664\u3055\u308C\u308B\u3002\n   * @param event - \u30C7\u30A3\u30B9\u30D1\u30C3\u30C1\u3059\u308B\u30A4\u30D9\u30F3\u30C8\n   * @returns \u914D\u4FE1\u6570\u3068\u30A8\u30E9\u30FC\u60C5\u5831\u3092\u542B\u3080 {@link DispatchResult}\n   */\n  public async dispatch(event: Event): Promise<DispatchResult> {\n    const targets = new Set<Subscriber>();\n    const direct = this.subscribersByType.get(event.type);\n    const wildcard = this.subscribersByType.get(\"*\");\n\n    if (direct) {\n      for (const subscriber of direct) {\n        targets.add(subscriber);\n      }\n    }\n\n    if (wildcard) {\n      for (const subscriber of wildcard) {\n        targets.add(subscriber);\n      }\n    }\n\n    const errors: DispatchError[] = [];\n    let delivered = 0;\n\n    for (const subscriber of targets) {\n      let executed = false;\n      if (subscriber.filter) {\n        try {\n          if (!subscriber.filter(event)) {\n            continue;\n          }\n        } catch (error: unknown) {\n          errors.push({\n            subscriberId: subscriber.id,\n            error:\n              error instanceof Error\n                ? error\n                : new RuntimeError(String(error), { cause: error }),\n            stage: \"filter\",\n          });\n          continue;\n        }\n      }\n\n      try {\n        executed = true;\n        const context: DispatchContext = {\n          subscriberId: subscriber.id,\n          dispatcher: this,\n          eventType: event.type,\n        };\n        await subscriber.handler(event, context);\n        delivered += 1;\n      } catch (error: unknown) {\n        errors.push({\n          subscriberId: subscriber.id,\n          error:\n            error instanceof Error\n              ? error\n              : new RuntimeError(String(error), { cause: error }),\n          stage: \"handler\",\n        });\n      } finally {\n        if (subscriber.once && executed) {\n          this.unsubscribe(subscriber.id);\n        }\n      }\n    }\n\n    return { event, delivered, errors };\n  }\n}\n", "import { TZDate } from \"@date-fns/tz\";\nimport { generateId } from \"../core/index.js\";\nimport type { Event } from \"./event.js\";\n\nexport type NotificationLevel = \"info\" | \"warning\" | \"error\";\n\nexport interface NotificationInit {\n  level?: NotificationLevel;\n  message: string;\n  timestamp?: Date;\n  data?: unknown;\n  event?: Event;\n}\n\n/**\n * \u30B7\u30B9\u30C6\u30E0\u901A\u77E5\u3092\u8868\u3059\u30AF\u30E9\u30B9\u3002\u901A\u77E5\u30EC\u30D9\u30EB\u3001\u30E1\u30C3\u30BB\u30FC\u30B8\u3001\u4EFB\u610F\u306E\u30C7\u30FC\u30BF\u304A\u3088\u3073\u95A2\u9023\u30A4\u30D9\u30F3\u30C8\u3092\u4FDD\u6301\u3059\u308B\u3002\n */\nexport class Notification {\n  readonly id: string;\n  readonly level: NotificationLevel;\n  readonly message: string;\n  readonly timestamp: Date;\n  readonly data?: unknown;\n  readonly event?: Event;\n\n  /**\n   * NotificationInit\u304B\u3089\u901A\u77E5\u3092\u751F\u6210\u3059\u308B\u3002\u30EC\u30D9\u30EB\u304C\u672A\u6307\u5B9A\u306E\u5834\u5408\u306F\"info\"\u304C\u30C7\u30D5\u30A9\u30EB\u30C8\u3068\u306A\u308B\u3002\n   *\n   * @param init - \u901A\u77E5\u306E\u521D\u671F\u5316\u30D1\u30E9\u30E1\u30FC\u30BF\n   */\n  constructor(init: NotificationInit) {\n    this.id = generateId();\n    this.level = init.level ?? \"info\";\n    this.message = init.message;\n    this.timestamp = init.timestamp ?? new TZDate();\n    this.data = init.data;\n    this.event = init.event;\n  }\n}\n", "import type { FileSystem } from \"../core/file-system.js\";\nimport { FileSystem as DefaultFileSystem } from \"../core/file-system.js\";\nimport type { ConversationMemory } from \"./conversation-store.js\";\nimport type { WorkflowRunResult, WorkflowTimelineEntry } from \"./runner.js\";\n\nexport interface ErrorInfo {\n  name: string;\n  message: string;\n  stack?: string;\n  cause?: ErrorInfo | string;\n}\n\nexport type WorkflowTimelineRecord =\n  | {\n      type: \"run_start\";\n      timestamp: string;\n    }\n  | {\n      type: \"run_complete\";\n      timestamp: string;\n      status: \"succeeded\" | \"failed\";\n      durationMs: number;\n    }\n  | {\n      type: \"node_start\";\n      nodeId: string;\n      timestamp: string;\n      attempt: number;\n    }\n  | {\n      type: \"node_complete\";\n      nodeId: string;\n      timestamp: string;\n      durationMs: number;\n      attempt: number;\n    }\n  | {\n      type: \"node_retry\";\n      nodeId: string;\n      timestamp: string;\n      attempt: number;\n      nextDelayMs: number;\n      error: ErrorInfo;\n    }\n  | {\n      type: \"node_error\";\n      nodeId: string;\n      timestamp: string;\n      attempt: number;\n      error: ErrorInfo;\n    };\n\nexport interface WorkflowRunRecord {\n  runId: string;\n  workflowId: string;\n  status: \"succeeded\" | \"failed\";\n  startedAt: string;\n  finishedAt: string;\n  durationMs: number;\n  results: Record<string, unknown>;\n  errors: Record<string, ErrorInfo>;\n  attempts: Record<string, number>;\n  timeline: WorkflowTimelineRecord[];\n  conversationId?: string;\n  memory?: ConversationMemory;\n}\n\nexport interface RunStoreListOptions {\n  workflowId?: string;\n  limit?: number;\n}\n\nexport interface RunStore {\n  save(record: WorkflowRunRecord): Promise<void>;\n  get(runId: string): Promise<WorkflowRunRecord | undefined>;\n  list?(options?: RunStoreListOptions): Promise<WorkflowRunRecord[]>;\n}\n\nconst stringifyCause = (cause: unknown): string => {\n  try {\n    return JSON.stringify(cause);\n  } catch {\n    return String(cause);\n  }\n};\n\nconst toErrorInfo = (error: Error): ErrorInfo => {\n  const base: ErrorInfo = {\n    name: error.name,\n    message: error.message,\n    stack: error.stack,\n  };\n  const cause = (error as Error & { cause?: unknown }).cause;\n  if (cause instanceof Error) {\n    return { ...base, cause: toErrorInfo(cause) };\n  }\n  if (cause !== undefined) {\n    return { ...base, cause: stringifyCause(cause) };\n  }\n  return base;\n};\n\nconst serializeTimelineEntry = (\n  entry: WorkflowTimelineEntry,\n): WorkflowTimelineRecord => {\n  switch (entry.type) {\n    case \"run_start\":\n      return {\n        type: entry.type,\n        timestamp: entry.timestamp.toISOString(),\n      };\n    case \"run_complete\":\n      return {\n        type: entry.type,\n        timestamp: entry.timestamp.toISOString(),\n        status: entry.status,\n        durationMs: entry.durationMs,\n      };\n    case \"node_start\":\n      return {\n        type: entry.type,\n        nodeId: entry.nodeId,\n        timestamp: entry.timestamp.toISOString(),\n        attempt: entry.attempt,\n      };\n    case \"node_complete\":\n      return {\n        type: entry.type,\n        nodeId: entry.nodeId,\n        timestamp: entry.timestamp.toISOString(),\n        durationMs: entry.durationMs,\n        attempt: entry.attempt,\n      };\n    case \"node_retry\":\n      return {\n        type: entry.type,\n        nodeId: entry.nodeId,\n        timestamp: entry.timestamp.toISOString(),\n        attempt: entry.attempt,\n        nextDelayMs: entry.nextDelayMs,\n        error: toErrorInfo(entry.error),\n      };\n    case \"node_error\":\n      return {\n        type: entry.type,\n        nodeId: entry.nodeId,\n        timestamp: entry.timestamp.toISOString(),\n        attempt: entry.attempt,\n        error: toErrorInfo(entry.error),\n      };\n  }\n};\n\n/**\n * WorkflowRunResult \u3092\u6C38\u7D9A\u5316\u7528\u306E WorkflowRunRecord \u306B\u5909\u63DB\u3059\u308B\u3002\n *\n * Date \u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\u3092 ISO \u6587\u5B57\u5217\u306B\u3001Error \u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\u3092 ErrorInfo \u306B\u5909\u63DB\u3057\u3001\n * \u30B7\u30EA\u30A2\u30E9\u30A4\u30BA\u53EF\u80FD\u306A\u30EC\u30B3\u30FC\u30C9\u3092\u8FD4\u3059\u3002\n *\n * @param result - \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u5B9F\u884C\u7D50\u679C\n * @returns \u6C38\u7D9A\u5316\u7528\u306B\u5909\u63DB\u3055\u308C\u305F\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u5B9F\u884C\u30EC\u30B3\u30FC\u30C9\n */\nexport const toRunRecord = (result: WorkflowRunResult): WorkflowRunRecord => {\n  const errors: Record<string, ErrorInfo> = {};\n  for (const [nodeId, error] of Object.entries(result.errors)) {\n    errors[nodeId] = toErrorInfo(error);\n  }\n  return {\n    runId: result.runId,\n    workflowId: result.workflowId,\n    status: result.status,\n    startedAt: result.startedAt.toISOString(),\n    finishedAt: result.finishedAt.toISOString(),\n    durationMs: result.durationMs,\n    results: result.results,\n    errors,\n    attempts: result.attempts,\n    timeline: result.timeline.map(serializeTimelineEntry),\n    conversationId: result.conversationId,\n    memory: result.memory,\n  };\n};\n\n/**\n * RunStore \u306E\u30A4\u30F3\u30E1\u30E2\u30EA\u5B9F\u88C5\u3002\n *\n * \u5185\u90E8\u3067 Map \u3092\u4F7F\u7528\u3057\u3066\u30EC\u30B3\u30FC\u30C9\u3092\u4FDD\u6301\u3059\u308B\u3002\n * \u30C6\u30B9\u30C8\u3084\u77ED\u671F\u9593\u306E\u5B9F\u884C\u306A\u3069\u3001\u6C38\u7D9A\u5316\u304C\u4E0D\u8981\u306A\u5834\u5408\u306B\u9069\u3057\u3066\u3044\u308B\u3002\n */\nexport class InMemoryRunStore implements RunStore {\n  private readonly store = new Map<string, WorkflowRunRecord>();\n\n  /**\n   * \u30EC\u30B3\u30FC\u30C9\u3092\u30A4\u30F3\u30E1\u30E2\u30EA\u30B9\u30C8\u30A2\u306B\u4FDD\u5B58\u3059\u308B\u3002\n   *\n   * \u540C\u3058 runId \u306E\u30EC\u30B3\u30FC\u30C9\u304C\u65E2\u306B\u5B58\u5728\u3059\u308B\u5834\u5408\u306F\u4E0A\u66F8\u304D\u3055\u308C\u308B\u3002\n   *\n   * @param record - \u4FDD\u5B58\u3059\u308B\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u5B9F\u884C\u30EC\u30B3\u30FC\u30C9\n   */\n  async save(record: WorkflowRunRecord): Promise<void> {\n    this.store.set(record.runId, record);\n  }\n\n  /**\n   * \u6307\u5B9A\u3055\u308C\u305F runId \u306B\u5BFE\u5FDC\u3059\u308B\u30EC\u30B3\u30FC\u30C9\u3092\u53D6\u5F97\u3059\u308B\u3002\n   *\n   * @param runId - \u53D6\u5F97\u5BFE\u8C61\u306E\u5B9F\u884CID\n   * @returns \u8A72\u5F53\u3059\u308B\u30EC\u30B3\u30FC\u30C9\u3002\u5B58\u5728\u3057\u306A\u3044\u5834\u5408\u306F undefined\n   */\n  async get(runId: string): Promise<WorkflowRunRecord | undefined> {\n    return this.store.get(runId);\n  }\n\n  /**\n   * \u4FDD\u5B58\u3055\u308C\u3066\u3044\u308B\u30EC\u30B3\u30FC\u30C9\u306E\u4E00\u89A7\u3092\u8FD4\u3059\u3002\n   *\n   * workflowId \u306B\u3088\u308B\u30D5\u30A3\u30EB\u30BF\u30EA\u30F3\u30B0\u3084\u3001limit \u306B\u3088\u308B\u4EF6\u6570\u5236\u9650\u304C\u53EF\u80FD\u3002\n   *\n   * @param options - \u30D5\u30A3\u30EB\u30BF\u30EA\u30F3\u30B0\u304A\u3088\u3073\u4EF6\u6570\u5236\u9650\u306E\u30AA\u30D7\u30B7\u30E7\u30F3\n   * @returns \u6761\u4EF6\u306B\u4E00\u81F4\u3059\u308B\u30EC\u30B3\u30FC\u30C9\u306E\u914D\u5217\n   */\n  async list(options: RunStoreListOptions = {}): Promise<WorkflowRunRecord[]> {\n    const records = Array.from(this.store.values());\n    const filtered = options.workflowId\n      ? records.filter((record) => record.workflowId === options.workflowId)\n      : records;\n    if (options.limit && options.limit > 0) {\n      return filtered.slice(0, options.limit);\n    }\n    return filtered;\n  }\n}\n\nexport interface FileRunStoreOptions {\n  directory?: string;\n  fileSystem?: FileSystem;\n}\n\nconst DEFAULT_RUNS_DIRECTORY = \"runs\";\nconst RUN_FILE_EXTENSION = \".json\";\n\n/**\n * RunStore \u306E\u30D5\u30A1\u30A4\u30EB\u30D9\u30FC\u30B9\u5B9F\u88C5\u3002\n *\n * \u5404\u30EC\u30B3\u30FC\u30C9\u3092 JSON \u30D5\u30A1\u30A4\u30EB\u3068\u3057\u3066\u30C7\u30A3\u30EC\u30AF\u30C8\u30EA\u306B\u4FDD\u5B58\u3059\u308B\u3002\n * \u6C38\u7D9A\u5316\u304C\u5FC5\u8981\u306A\u672C\u756A\u74B0\u5883\u3067\u306E\u4F7F\u7528\u306B\u9069\u3057\u3066\u3044\u308B\u3002\n */\nexport class FileRunStore implements RunStore {\n  private readonly directory: string;\n  private readonly fs: FileSystem;\n\n  constructor(options: FileRunStoreOptions = {}) {\n    this.directory = options.directory ?? DEFAULT_RUNS_DIRECTORY;\n    this.fs = options.fileSystem ?? new DefaultFileSystem();\n  }\n\n  /**\n   * \u30EC\u30B3\u30FC\u30C9\u3092 JSON \u30D5\u30A1\u30A4\u30EB\u3068\u3057\u3066\u4FDD\u5B58\u3059\u308B\u3002\n   *\n   * \u30D5\u30A1\u30A4\u30EB\u540D\u306F runId \u306B\u57FA\u3065\u3044\u3066\u81EA\u52D5\u751F\u6210\u3055\u308C\u308B\u3002\n   *\n   * @param record - \u4FDD\u5B58\u3059\u308B\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u5B9F\u884C\u30EC\u30B3\u30FC\u30C9\n   */\n  async save(record: WorkflowRunRecord): Promise<void> {\n    const path = this.pathFor(record.runId);\n    await this.fs.writeJson(path, record);\n  }\n\n  /**\n   * \u6307\u5B9A\u3055\u308C\u305F runId \u306B\u5BFE\u5FDC\u3059\u308B\u30EC\u30B3\u30FC\u30C9\u3092 JSON \u30D5\u30A1\u30A4\u30EB\u304B\u3089\u8AAD\u307F\u8FBC\u3080\u3002\n   *\n   * \u30D5\u30A1\u30A4\u30EB\u304C\u5B58\u5728\u3057\u306A\u3044\u5834\u5408\u306F undefined \u3092\u8FD4\u3059\u3002\n   *\n   * @param runId - \u53D6\u5F97\u5BFE\u8C61\u306E\u5B9F\u884CID\n   * @returns \u8A72\u5F53\u3059\u308B\u30EC\u30B3\u30FC\u30C9\u3002\u30D5\u30A1\u30A4\u30EB\u304C\u5B58\u5728\u3057\u306A\u3044\u5834\u5408\u306F undefined\n   */\n  async get(runId: string): Promise<WorkflowRunRecord | undefined> {\n    const path = this.pathFor(runId);\n    if (!(await this.fs.exists(path))) {\n      return undefined;\n    }\n    return this.fs.readJson<WorkflowRunRecord>(path);\n  }\n\n  /**\n   * \u30C7\u30A3\u30EC\u30AF\u30C8\u30EA\u5185\u306E JSON \u30D5\u30A1\u30A4\u30EB\u304B\u3089\u30EC\u30B3\u30FC\u30C9\u306E\u4E00\u89A7\u3092\u8AAD\u307F\u8FBC\u3080\u3002\n   *\n   * workflowId \u306B\u3088\u308B\u30D5\u30A3\u30EB\u30BF\u30EA\u30F3\u30B0\u3084\u3001limit \u306B\u3088\u308B\u4EF6\u6570\u5236\u9650\u304C\u53EF\u80FD\u3002\n   * \u30C7\u30A3\u30EC\u30AF\u30C8\u30EA\u304C\u5B58\u5728\u3057\u306A\u3044\u5834\u5408\u306F\u7A7A\u914D\u5217\u3092\u8FD4\u3059\u3002\n   *\n   * @param options - \u30D5\u30A3\u30EB\u30BF\u30EA\u30F3\u30B0\u304A\u3088\u3073\u4EF6\u6570\u5236\u9650\u306E\u30AA\u30D7\u30B7\u30E7\u30F3\n   * @returns \u6761\u4EF6\u306B\u4E00\u81F4\u3059\u308B\u30EC\u30B3\u30FC\u30C9\u306E\u914D\u5217\n   */\n  async list(options: RunStoreListOptions = {}): Promise<WorkflowRunRecord[]> {\n    if (!(await this.fs.exists(this.directory))) {\n      return [];\n    }\n    const names = await this.fs.listDir(this.directory);\n    const records: WorkflowRunRecord[] = [];\n    for (const name of names) {\n      if (!name.endsWith(RUN_FILE_EXTENSION)) {\n        continue;\n      }\n      const record = await this.fs.readJson<WorkflowRunRecord>(\n        this.joinPath(name),\n      );\n      if (options.workflowId && record.workflowId !== options.workflowId) {\n        continue;\n      }\n      records.push(record);\n      if (\n        options.limit &&\n        options.limit > 0 &&\n        records.length >= options.limit\n      ) {\n        break;\n      }\n    }\n    return records;\n  }\n\n  /**\n   * \u6307\u5B9A\u3055\u308C\u305F runId \u306B\u5BFE\u5FDC\u3059\u308B\u30D5\u30A1\u30A4\u30EB\u30D1\u30B9\u3092\u751F\u6210\u3059\u308B\u3002\n   *\n   * @param runId - \u5B9F\u884CID\n   * @returns JSON \u30D5\u30A1\u30A4\u30EB\u306E\u30D5\u30EB\u30D1\u30B9\n   */\n  private pathFor(runId: string): string {\n    return this.joinPath(`${runId}${RUN_FILE_EXTENSION}`);\n  }\n\n  /**\n   * \u30C7\u30A3\u30EC\u30AF\u30C8\u30EA\u3068\u30D5\u30A1\u30A4\u30EB\u540D\u3092\u7D50\u5408\u3057\u3066\u30D1\u30B9\u3092\u751F\u6210\u3059\u308B\u3002\n   *\n   * @param fileName - \u30D5\u30A1\u30A4\u30EB\u540D\n   * @returns \u7D50\u5408\u3055\u308C\u305F\u30D5\u30A1\u30A4\u30EB\u30D1\u30B9\n   */\n  private joinPath(fileName: string): string {\n    return `${this.directory}/${fileName}`;\n  }\n}\n", "import { TZDate } from \"@date-fns/tz\";\nimport {\n  CyclicDependencyError,\n  DependencyError,\n  generateId,\n  InvalidArgumentError,\n  RuntimeError,\n} from \"../core/index.js\";\nimport type { ConversationMemory } from \"./conversation-store.js\";\nimport type { Node } from \"./node.js\";\nimport type { Workflow } from \"./workflow.js\";\n\nconst MIN_CONCURRENCY = 1;\nconst DEFAULT_CONCURRENCY = 4;\nconst DEFAULT_CHATFLOW_CONCURRENCY = 1;\nconst DEFAULT_FAIL_FAST = true;\nconst MIN_RETRY_ATTEMPTS = 1;\nconst MIN_BACKOFF_MULTIPLIER = 1;\nconst MIN_DELAY_MS = 0;\nconst DEFAULT_RETRY_MAX_ATTEMPTS = 1;\nconst DEFAULT_RETRY_INITIAL_DELAY_MS = 1000;\nconst DEFAULT_RETRY_BACKOFF_MULTIPLIER = 2;\nconst DEFAULT_RETRY_MAX_DELAY_MS = 30_000;\nconst DEFAULT_RETRY_JITTER_MS = 0;\nconst CHATFLOW_REQUIRES_CONVERSATION_ID =\n  \"Chatflow requires conversationId to run.\";\nconst ABORT_ERROR_NAME = \"AbortError\";\nconst ABORT_ERROR_MESSAGE = \"Workflow aborted\";\n\nexport interface WorkflowRunOptions<Context = unknown, Input = unknown> {\n  input?: Input;\n  context?: Context;\n  event?: unknown;\n  conversationId?: string;\n  memory?: ConversationMemory;\n  concurrency?: number;\n  failFast?: boolean;\n  onNodeStart?: (node: Node<Context, Input>) => void | Promise<void>;\n  onNodeComplete?: (\n    node: Node<Context, Input>,\n    result: unknown,\n  ) => void | Promise<void>;\n  onNodeError?: (\n    node: Node<Context, Input>,\n    error: Error,\n  ) => void | Promise<void>;\n  onNodeRetry?: (\n    node: Node<Context, Input>,\n    error: Error,\n    attempt: number,\n    nextDelayMs: number,\n  ) => void | Promise<void>;\n}\n\nexport type WorkflowTimelineEntry =\n  | {\n      type: \"run_start\";\n      timestamp: Date;\n    }\n  | {\n      type: \"run_complete\";\n      timestamp: Date;\n      status: \"succeeded\" | \"failed\";\n      durationMs: number;\n    }\n  | {\n      type: \"node_start\";\n      nodeId: string;\n      timestamp: Date;\n      attempt: number;\n    }\n  | {\n      type: \"node_complete\";\n      nodeId: string;\n      timestamp: Date;\n      durationMs: number;\n      attempt: number;\n    }\n  | {\n      type: \"node_retry\";\n      nodeId: string;\n      timestamp: Date;\n      attempt: number;\n      nextDelayMs: number;\n      error: Error;\n    }\n  | {\n      type: \"node_error\";\n      nodeId: string;\n      timestamp: Date;\n      attempt: number;\n      error: Error;\n    };\n\nexport interface WorkflowRunResult {\n  runId: string;\n  workflowId: string;\n  status: \"succeeded\" | \"failed\";\n  startedAt: Date;\n  finishedAt: Date;\n  durationMs: number;\n  results: Record<string, unknown>;\n  errors: Record<string, Error>;\n  attempts: Record<string, number>;\n  timeline: WorkflowTimelineEntry[];\n  conversationId?: string;\n  memory?: ConversationMemory;\n}\n\nconst createAbortError = (cause?: unknown): Error => {\n  const error = cause\n    ? new Error(ABORT_ERROR_MESSAGE, { cause })\n    : new Error(ABORT_ERROR_MESSAGE);\n  error.name = ABORT_ERROR_NAME;\n  return error;\n};\n\nconst resolveAbortError = (reason: unknown): Error =>\n  reason instanceof Error ? reason : createAbortError(reason);\n\nconst isAbortError = (error: unknown): error is Error =>\n  error instanceof Error && error.name === ABORT_ERROR_NAME;\n\nconst throwIfAborted = (signal?: AbortSignal): void => {\n  if (!signal?.aborted) {\n    return;\n  }\n  throw resolveAbortError(signal.reason);\n};\n\nconst withAbort = async <T>(\n  promise: Promise<T>,\n  signal?: AbortSignal,\n): Promise<T> => {\n  if (!signal) {\n    return promise;\n  }\n  if (signal.aborted) {\n    throw resolveAbortError(signal.reason);\n  }\n  return new Promise<T>((resolve, reject) => {\n    const onAbort = (): void => {\n      cleanup();\n      reject(resolveAbortError(signal.reason));\n    };\n    const cleanup = (): void => {\n      signal.removeEventListener(\"abort\", onAbort);\n    };\n    signal.addEventListener(\"abort\", onAbort, { once: true });\n    promise.then(\n      (value) => {\n        cleanup();\n        resolve(value);\n      },\n      (error) => {\n        cleanup();\n        reject(error);\n      },\n    );\n  });\n};\n\nconst sleep = (ms: number, signal?: AbortSignal): Promise<void> =>\n  new Promise((resolve, reject) => {\n    if (signal?.aborted) {\n      reject(resolveAbortError(signal.reason));\n      return;\n    }\n    let timeoutId: ReturnType<typeof setTimeout> | undefined;\n    let onAbort: (() => void) | undefined;\n    const cleanup = (): void => {\n      if (signal && onAbort) {\n        signal.removeEventListener(\"abort\", onAbort);\n      }\n    };\n    onAbort = (): void => {\n      if (timeoutId) {\n        clearTimeout(timeoutId);\n      }\n      cleanup();\n      reject(resolveAbortError(signal?.reason));\n    };\n    timeoutId = setTimeout(() => {\n      cleanup();\n      resolve();\n    }, ms);\n    if (!signal) {\n      return;\n    }\n    signal.addEventListener(\"abort\", onAbort, { once: true });\n    if (signal.aborted) {\n      onAbort();\n    }\n  });\n\nconst resolveRetryPolicy = (policy?: {\n  maxAttempts?: number;\n  initialDelayMs?: number;\n  backoffMultiplier?: number;\n  maxDelayMs?: number;\n  jitterMs?: number;\n}): {\n  maxAttempts: number;\n  initialDelayMs: number;\n  backoffMultiplier: number;\n  maxDelayMs: number;\n  jitterMs: number;\n} => ({\n  maxAttempts: Math.max(\n    MIN_RETRY_ATTEMPTS,\n    policy?.maxAttempts ?? DEFAULT_RETRY_MAX_ATTEMPTS,\n  ),\n  initialDelayMs: Math.max(\n    MIN_DELAY_MS,\n    policy?.initialDelayMs ?? DEFAULT_RETRY_INITIAL_DELAY_MS,\n  ),\n  backoffMultiplier: Math.max(\n    MIN_BACKOFF_MULTIPLIER,\n    policy?.backoffMultiplier ?? DEFAULT_RETRY_BACKOFF_MULTIPLIER,\n  ),\n  maxDelayMs: Math.max(\n    MIN_DELAY_MS,\n    policy?.maxDelayMs ?? DEFAULT_RETRY_MAX_DELAY_MS,\n  ),\n  jitterMs: Math.max(MIN_DELAY_MS, policy?.jitterMs ?? DEFAULT_RETRY_JITTER_MS),\n});\n\nconst computeRetryDelayMs = (\n  attempt: number,\n  policy: ReturnType<typeof resolveRetryPolicy>,\n): number => {\n  if (policy.maxAttempts <= 1) {\n    return 0;\n  }\n  const exponentialDelay =\n    policy.initialDelayMs * policy.backoffMultiplier ** (attempt - 1);\n  const boundedDelay = Math.min(exponentialDelay, policy.maxDelayMs);\n  if (policy.jitterMs <= 0) {\n    return boundedDelay;\n  }\n  return boundedDelay + Math.random() * policy.jitterMs;\n};\n\nconst cloneMemory = (memory: ConversationMemory): ConversationMemory =>\n  structuredClone(memory);\n\n/**\n * \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u306E\u5B9F\u884C\u30A8\u30F3\u30B8\u30F3\u3002\n *\n * \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u5185\u306E\u30CE\u30FC\u30C9\u3092\u4F9D\u5B58\u95A2\u4FC2\u306E\u9806\u5E8F\u306B\u5F93\u3063\u3066\u5B9F\u884C\u3059\u308B\u3002\n * \u540C\u6642\u5B9F\u884C\u6570\u306E\u5236\u5FA1\u3001\u30EA\u30C8\u30E9\u30A4\u30DD\u30EA\u30B7\u30FC\u306B\u3088\u308B\u518D\u8A66\u884C\u3001\n * \u304A\u3088\u3073 `AbortSignal` \u3092\u5229\u7528\u3057\u305F\u4E2D\u65AD\u3092\u30B5\u30DD\u30FC\u30C8\u3059\u308B\u3002\n */\nexport class Runner {\n  /**\n   * \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u3092\u5B9F\u884C\u3057\u3001\u3059\u3079\u3066\u306E\u30CE\u30FC\u30C9\u3092\u4F9D\u5B58\u95A2\u4FC2\u306E\u9806\u5E8F\u306B\u5F93\u3063\u3066\u51E6\u7406\u3059\u308B\u3002\n   *\n   * \u4F9D\u5B58\u95A2\u4FC2\u306E\u306A\u3044\u30CE\u30FC\u30C9\u304B\u3089\u9806\u306B\u3001\u8A2D\u5B9A\u3055\u308C\u305F\u540C\u6642\u5B9F\u884C\u6570\uFF08concurrency\uFF09\u306E\u7BC4\u56F2\u5185\u3067\n   * \u4E26\u5217\u306B\u30CE\u30FC\u30C9\u3092\u5B9F\u884C\u3059\u308B\u3002`failFast` \u304C\u6709\u52B9\u306A\u5834\u5408\u3001\u3044\u305A\u308C\u304B\u306E\u30CE\u30FC\u30C9\u3067\u30A8\u30E9\u30FC\u304C\n   * \u767A\u751F\u3057\u305F\u6642\u70B9\u3067\u6B8B\u308A\u306E\u5B9F\u884C\u3092\u4E2D\u65AD\u3059\u308B\u3002chatflow \u30BF\u30A4\u30D7\u306E\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u3067\u306F\n   * `conversationId` \u304C\u5FC5\u9808\u3068\u306A\u308A\u3001\u540C\u6642\u5B9F\u884C\u6570\u306E\u30C7\u30D5\u30A9\u30EB\u30C8\u306F 1 \u3068\u306A\u308B\u3002\n   *\n   * @typeParam Context - \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u5168\u4F53\u3067\u5171\u6709\u3055\u308C\u308B\u30B3\u30F3\u30C6\u30AD\u30B9\u30C8\u306E\u578B\n   * @typeParam Input - \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u3078\u306E\u5165\u529B\u30C7\u30FC\u30BF\u306E\u578B\n   * @param workflow - \u5B9F\u884C\u5BFE\u8C61\u306E\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u5B9A\u7FA9\n   * @param options - \u5B9F\u884C\u30AA\u30D7\u30B7\u30E7\u30F3\uFF08\u5165\u529B\u5024\u3001\u30B3\u30F3\u30C6\u30AD\u30B9\u30C8\u3001\u540C\u6642\u5B9F\u884C\u6570\u3001\u30B3\u30FC\u30EB\u30D0\u30C3\u30AF\u7B49\uFF09\n   * @returns \u5B9F\u884C\u7D50\u679C\uFF08\u30B9\u30C6\u30FC\u30BF\u30B9\u3001\u5404\u30CE\u30FC\u30C9\u306E\u7D50\u679C\u30FB\u30A8\u30E9\u30FC\u3001\u30BF\u30A4\u30E0\u30E9\u30A4\u30F3\u7B49\u3092\u542B\u3080\uFF09\n   * @throws {InvalidArgumentError} chatflow \u30BF\u30A4\u30D7\u3067 conversationId \u304C\u672A\u6307\u5B9A\u306E\u5834\u5408\n   * @throws {DependencyError} \u30CE\u30FC\u30C9\u304C\u5B58\u5728\u3057\u306A\u3044\u4F9D\u5B58\u5148\u3092\u53C2\u7167\u3057\u3066\u3044\u308B\u5834\u5408\n   * @throws {CyclicDependencyError} \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u306B\u5FAA\u74B0\u4F9D\u5B58\u304C\u542B\u307E\u308C\u3066\u3044\u308B\u5834\u5408\n   */\n  async run<Context = unknown, Input = unknown>(\n    workflow: Workflow<Context, Input>,\n    options: WorkflowRunOptions<Context, Input> = {},\n  ): Promise<WorkflowRunResult> {\n    const runId = generateId();\n    const startedAt = new TZDate();\n    const results: Record<string, unknown> = {};\n    const errors: Record<string, Error> = {};\n    const attempts: Record<string, number> = {};\n    const timeline: WorkflowTimelineEntry[] = [\n      { type: \"run_start\", timestamp: startedAt },\n    ];\n    const abortController = new AbortController();\n    const signal = abortController.signal;\n    const abortRun = (cause?: unknown): void => {\n      if (signal.aborted) {\n        return;\n      }\n      abortController.abort(createAbortError(cause));\n    };\n\n    const dependencies = new Map<string, Set<string>>();\n    const dependents = new Map<string, Set<string>>();\n    const nodes = workflow.getNodes();\n    const nodeIds = new Set(nodes.map((node) => node.id));\n    const chatflow = workflow.type === \"chatflow\";\n    if (\n      chatflow &&\n      (!options.conversationId || options.conversationId.trim().length === 0)\n    ) {\n      throw new InvalidArgumentError(CHATFLOW_REQUIRES_CONVERSATION_ID);\n    }\n\n    for (const node of nodes) {\n      for (const dep of node.dependsOn) {\n        if (!nodeIds.has(dep)) {\n          throw new DependencyError(\n            `Node ${node.id} depends on missing node: ${dep}`,\n          );\n        }\n      }\n    }\n\n    for (const node of nodes) {\n      dependencies.set(node.id, new Set(node.dependsOn));\n      dependents.set(node.id, new Set());\n    }\n\n    for (const node of nodes) {\n      for (const dep of node.dependsOn) {\n        const bucket = dependents.get(dep);\n        if (bucket) {\n          bucket.add(node.id);\n        }\n      }\n    }\n\n    const ready: Node<Context, Input>[] = nodes.filter(\n      (node) => (dependencies.get(node.id)?.size ?? 0) === 0,\n    );\n\n    const concurrency = Math.max(\n      MIN_CONCURRENCY,\n      options.concurrency ??\n        (chatflow ? DEFAULT_CHATFLOW_CONCURRENCY : DEFAULT_CONCURRENCY),\n    );\n    const failFast = options.failFast ?? DEFAULT_FAIL_FAST;\n    let memoryState: ConversationMemory | undefined = options.memory\n      ? cloneMemory(options.memory)\n      : chatflow\n        ? {}\n        : undefined;\n    const getMemory = (): ConversationMemory | undefined => memoryState;\n    const setMemory = (next: ConversationMemory): void => {\n      if (!memoryState) {\n        memoryState = {};\n      }\n      for (const key of Object.keys(memoryState)) {\n        delete memoryState[key];\n      }\n      Object.assign(memoryState, next);\n    };\n    const updateMemory = (patch: Partial<ConversationMemory>): void => {\n      if (!memoryState) {\n        memoryState = {};\n      }\n      Object.assign(memoryState, patch);\n    };\n\n    let aborted = false;\n    let completedCount = 0;\n\n    const inFlight = new Set<Promise<void>>();\n\n    const scheduleNode = (node: Node<Context, Input>): void => {\n      const task = this.runNode(\n        node,\n        workflow,\n        runId,\n        options,\n        results,\n        errors,\n        attempts,\n        timeline,\n        options.conversationId,\n        signal,\n        memoryState,\n        getMemory,\n        setMemory,\n        updateMemory,\n      )\n        .then(() => {\n          if (aborted) {\n            return;\n          }\n\n          const downstream = dependents.get(node.id);\n          if (!downstream) {\n            return;\n          }\n\n          for (const dependentId of downstream) {\n            const deps = dependencies.get(dependentId);\n            if (!deps) {\n              continue;\n            }\n\n            deps.delete(node.id);\n            if (deps.size === 0) {\n              const dependentNode = workflow.getNode(dependentId);\n              if (dependentNode) {\n                ready.push(dependentNode);\n              }\n            }\n          }\n        })\n        .catch((error) => {\n          if (failFast) {\n            aborted = true;\n            abortRun(error);\n          }\n        })\n        .finally(() => {\n          completedCount += 1;\n          inFlight.delete(task);\n        });\n      inFlight.add(task);\n    };\n\n    while (ready.length > 0 || inFlight.size > 0) {\n      while (!aborted && ready.length > 0 && inFlight.size < concurrency) {\n        const node = ready.shift();\n        if (!node) {\n          break;\n        }\n        scheduleNode(node);\n      }\n\n      if (inFlight.size === 0) {\n        break;\n      }\n\n      await Promise.race(inFlight);\n    }\n\n    const finishedAt = new TZDate();\n    const status = Object.keys(errors).length > 0 ? \"failed\" : \"succeeded\";\n    const durationMs = finishedAt.getTime() - startedAt.getTime();\n    timeline.push({\n      type: \"run_complete\",\n      timestamp: finishedAt,\n      status,\n      durationMs,\n    });\n\n    if (status === \"succeeded\" && completedCount < nodes.length) {\n      throw new CyclicDependencyError(\"Workflow contains a cyclic dependency\");\n    }\n\n    return {\n      runId,\n      workflowId: workflow.id,\n      status,\n      startedAt,\n      finishedAt,\n      durationMs,\n      results,\n      errors,\n      attempts,\n      timeline,\n      conversationId: options.conversationId,\n      memory: memoryState,\n    };\n  }\n\n  /**\n   * \u5358\u4E00\u30CE\u30FC\u30C9\u3092\u30EA\u30C8\u30E9\u30A4\u30DD\u30EA\u30B7\u30FC\u306B\u57FA\u3065\u3044\u3066\u5B9F\u884C\u3059\u308B\u3002\n   *\n   * \u30CE\u30FC\u30C9\u306E\u30CF\u30F3\u30C9\u30E9\u3092\u547C\u3073\u51FA\u3057\u3001\u6210\u529F\u3057\u305F\u5834\u5408\u306F\u7D50\u679C\u3092 `results` \u306B\u683C\u7D0D\u3059\u308B\u3002\n   * \u5931\u6557\u3057\u305F\u5834\u5408\u306F\u30EA\u30C8\u30E9\u30A4\u30DD\u30EA\u30B7\u30FC\uFF08\u6700\u5927\u8A66\u884C\u56DE\u6570\u3001\u6307\u6570\u30D0\u30C3\u30AF\u30AA\u30D5\u3001\u30B8\u30C3\u30BF\u30FC\uFF09\u306B\n   * \u5F93\u3063\u3066\u518D\u8A66\u884C\u3092\u884C\u3046\u3002\u3059\u3079\u3066\u306E\u8A66\u884C\u304C\u5931\u6557\u3057\u305F\u5834\u5408\u3001\u307E\u305F\u306F\u30A2\u30DC\u30FC\u30C8\u30B7\u30B0\u30CA\u30EB\u3092\n   * \u53D7\u4FE1\u3057\u305F\u5834\u5408\u306F\u30A8\u30E9\u30FC\u3092\u30B9\u30ED\u30FC\u3059\u308B\u3002\u5404\u6BB5\u968E\u3067\u30BF\u30A4\u30E0\u30E9\u30A4\u30F3\u30A8\u30F3\u30C8\u30EA\u306E\u8A18\u9332\u3068\n   * \u30B3\u30FC\u30EB\u30D0\u30C3\u30AF\u306E\u547C\u3073\u51FA\u3057\u3092\u884C\u3046\u3002\n   *\n   * @typeParam Context - \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u5168\u4F53\u3067\u5171\u6709\u3055\u308C\u308B\u30B3\u30F3\u30C6\u30AD\u30B9\u30C8\u306E\u578B\n   * @typeParam Input - \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u3078\u306E\u5165\u529B\u30C7\u30FC\u30BF\u306E\u578B\n   * @param node - \u5B9F\u884C\u5BFE\u8C61\u306E\u30CE\u30FC\u30C9\n   * @param workflow - \u30CE\u30FC\u30C9\u304C\u5C5E\u3059\u308B\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u5B9A\u7FA9\n   * @param runId - \u4ECA\u56DE\u306E\u5B9F\u884C\u3092\u8B58\u5225\u3059\u308B\u4E00\u610F\u306E ID\n   * @param options - \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u5B9F\u884C\u30AA\u30D7\u30B7\u30E7\u30F3\uFF08\u30B3\u30FC\u30EB\u30D0\u30C3\u30AF\u7B49\u3092\u542B\u3080\uFF09\n   * @param results - \u5404\u30CE\u30FC\u30C9\u306E\u5B9F\u884C\u7D50\u679C\u3092\u683C\u7D0D\u3059\u308B\u5171\u6709\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\n   * @param errors - \u5404\u30CE\u30FC\u30C9\u306E\u30A8\u30E9\u30FC\u3092\u683C\u7D0D\u3059\u308B\u5171\u6709\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\n   * @param attempts - \u5404\u30CE\u30FC\u30C9\u306E\u8A66\u884C\u56DE\u6570\u3092\u683C\u7D0D\u3059\u308B\u5171\u6709\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\n   * @param timeline - \u5B9F\u884C\u30BF\u30A4\u30E0\u30E9\u30A4\u30F3\u306E\u30A8\u30F3\u30C8\u30EA\u914D\u5217\n   * @param conversationId - \u4F1A\u8A71 ID\uFF08chatflow \u306E\u5834\u5408\u306B\u4F7F\u7528\uFF09\n   * @param signal - \u4E2D\u65AD\u3092\u691C\u77E5\u3059\u308B\u305F\u3081\u306E AbortSignal\n   * @param memory - \u4F1A\u8A71\u30E1\u30E2\u30EA\u306E\u73FE\u5728\u306E\u72B6\u614B\n   * @param getMemory - \u4F1A\u8A71\u30E1\u30E2\u30EA\u3092\u53D6\u5F97\u3059\u308B\u95A2\u6570\n   * @param setMemory - \u4F1A\u8A71\u30E1\u30E2\u30EA\u3092\u7F6E\u304D\u63DB\u3048\u308B\u95A2\u6570\n   * @param updateMemory - \u4F1A\u8A71\u30E1\u30E2\u30EA\u3092\u90E8\u5206\u66F4\u65B0\u3059\u308B\u95A2\u6570\n   * @throws \u30CE\u30FC\u30C9\u306E\u5168\u30EA\u30C8\u30E9\u30A4\u304C\u5931\u6557\u3057\u305F\u5834\u5408\u3001\u307E\u305F\u306F\u30A2\u30DC\u30FC\u30C8\u3055\u308C\u305F\u5834\u5408\u306B\u30A8\u30E9\u30FC\u3092\u30B9\u30ED\u30FC\u3059\u308B\n   */\n  private async runNode<Context = unknown, Input = unknown>(\n    node: Node<Context, Input>,\n    workflow: Workflow<Context, Input>,\n    runId: string,\n    options: WorkflowRunOptions<Context, Input>,\n    results: Record<string, unknown>,\n    errors: Record<string, Error>,\n    attempts: Record<string, number>,\n    timeline: WorkflowTimelineEntry[],\n    conversationId: string | undefined,\n    signal: AbortSignal,\n    memory: ConversationMemory | undefined,\n    getMemory: () => ConversationMemory | undefined,\n    setMemory: (next: ConversationMemory) => void,\n    updateMemory: (patch: Partial<ConversationMemory>) => void,\n  ): Promise<void> {\n    const policy = resolveRetryPolicy(node.retry);\n    for (let attempt = 1; attempt <= policy.maxAttempts; attempt += 1) {\n      try {\n        throwIfAborted(signal);\n        attempts[node.id] = attempt;\n        const nodeStart = new TZDate();\n        timeline.push({\n          type: \"node_start\",\n          nodeId: node.id,\n          timestamp: nodeStart,\n          attempt,\n        });\n\n        if (options.onNodeStart) {\n          await options.onNodeStart(node);\n        }\n\n        throwIfAborted(signal);\n        const output = await withAbort(\n          Promise.resolve(\n            node.handler({\n              workflowId: workflow.id,\n              nodeId: node.id,\n              runId,\n              conversationId,\n              context: options.context,\n              input: options.input,\n              event: options.event,\n              results,\n              getResult: <T = unknown>(nodeId: string) =>\n                results[nodeId] as T | undefined,\n              memory,\n              getMemory,\n              setMemory,\n              updateMemory,\n              signal,\n            }),\n          ),\n          signal,\n        );\n\n        results[node.id] = output;\n\n        if (options.onNodeComplete) {\n          await options.onNodeComplete(node, output);\n        }\n\n        const nodeFinish = new TZDate();\n        timeline.push({\n          type: \"node_complete\",\n          nodeId: node.id,\n          timestamp: nodeFinish,\n          durationMs: nodeFinish.getTime() - nodeStart.getTime(),\n          attempt,\n        });\n        return;\n      } catch (error: unknown) {\n        const err =\n          error instanceof Error\n            ? error\n            : new RuntimeError(String(error), { cause: error });\n\n        if (isAbortError(err)) {\n          errors[node.id] = err;\n          timeline.push({\n            type: \"node_error\",\n            nodeId: node.id,\n            timestamp: new TZDate(),\n            attempt,\n            error: err,\n          });\n\n          if (options.onNodeError) {\n            await options.onNodeError(node, err);\n          }\n\n          throw err;\n        }\n\n        if (attempt >= policy.maxAttempts) {\n          errors[node.id] = err;\n          timeline.push({\n            type: \"node_error\",\n            nodeId: node.id,\n            timestamp: new TZDate(),\n            attempt,\n            error: err,\n          });\n\n          if (options.onNodeError) {\n            await options.onNodeError(node, err);\n          }\n\n          throw err;\n        }\n\n        const nextDelayMs = computeRetryDelayMs(attempt, policy);\n        timeline.push({\n          type: \"node_retry\",\n          nodeId: node.id,\n          timestamp: new TZDate(),\n          attempt,\n          nextDelayMs,\n          error: err,\n        });\n\n        if (options.onNodeRetry) {\n          await options.onNodeRetry(node, err, attempt, nextDelayMs);\n        }\n\n        if (nextDelayMs > 0) {\n          try {\n            await sleep(nextDelayMs, signal);\n          } catch (sleepError: unknown) {\n            const sleepErr =\n              sleepError instanceof Error\n                ? sleepError\n                : new RuntimeError(String(sleepError), { cause: sleepError });\n            if (isAbortError(sleepErr)) {\n              errors[node.id] = sleepErr;\n              timeline.push({\n                type: \"node_error\",\n                nodeId: node.id,\n                timestamp: new TZDate(),\n                attempt,\n                error: sleepErr,\n              });\n\n              if (options.onNodeError) {\n                await options.onNodeError(node, sleepErr);\n              }\n            }\n            throw sleepErr;\n          }\n        }\n      }\n    }\n  }\n}\n", "import type { Event } from \"./event.js\";\nimport type { EventQueue } from \"./event-queue.js\";\n\nconst COMPACT_AFTER_DEQUEUE_COUNT = 50;\nconst COMPACT_RATIO = 2;\n\n/**\n * \u30A4\u30F3\u30E1\u30E2\u30EA\u306EFIFO\u30A4\u30D9\u30F3\u30C8\u30AD\u30E5\u30FC\u3002\n * \u30C7\u30AD\u30E5\u30FC\u56DE\u6570\u304C\u4E00\u5B9A\u306E\u95BE\u5024\u3092\u8D85\u3048\u305F\u5834\u5408\u306B\u81EA\u52D5\u30B3\u30F3\u30D1\u30AF\u30B7\u30E7\u30F3\u3092\u884C\u3044\u3001\u30E1\u30E2\u30EA\u52B9\u7387\u3092\u7DAD\u6301\u3059\u308B\u3002\n * @implements {EventQueue}\n */\nexport class Queue implements EventQueue {\n  /** \u30AD\u30E5\u30FC\u306B\u683C\u7D0D\u3055\u308C\u305F\u30A4\u30D9\u30F3\u30C8\u306E\u914D\u5217 */\n  private items: Event[] = [];\n  /** \u6B21\u306B\u30C7\u30AD\u30E5\u30FC\u3055\u308C\u308B\u30A4\u30D9\u30F3\u30C8\u306E\u30A4\u30F3\u30C7\u30C3\u30AF\u30B9 */\n  private head = 0;\n\n  /**\n   * \u30A4\u30D9\u30F3\u30C8\u3092\u30AD\u30E5\u30FC\u306E\u672B\u5C3E\u306B\u8FFD\u52A0\u3059\u308B\u3002\n   * @param event - \u30AD\u30E5\u30FC\u306B\u8FFD\u52A0\u3059\u308B\u30A4\u30D9\u30F3\u30C8\n   */\n  enqueue(event: Event): void {\n    this.items.push(event);\n  }\n\n  /**\n   * \u30AD\u30E5\u30FC\u306E\u5148\u982D\u304B\u3089\u30A4\u30D9\u30F3\u30C8\u3092\u53D6\u308A\u51FA\u3057\u3066\u8FD4\u3059\u3002\n   * \u30C7\u30AD\u30E5\u30FC\u56DE\u6570\u304C\u95BE\u5024\u3092\u8D85\u3048\u3001\u304B\u3064\u4F7F\u7528\u6E08\u307F\u9818\u57DF\u304C\u5168\u4F53\u306E\u534A\u5206\u4EE5\u4E0A\u3092\u5360\u3081\u308B\u5834\u5408\u306B\u81EA\u52D5\u30B3\u30F3\u30D1\u30AF\u30B7\u30E7\u30F3\u3092\u5B9F\u884C\u3059\u308B\u3002\n   * @returns \u53D6\u308A\u51FA\u3057\u305F\u30A4\u30D9\u30F3\u30C8\u3002\u30AD\u30E5\u30FC\u304C\u7A7A\u306E\u5834\u5408\u306F `undefined`\u3002\n   */\n  dequeue(): Event | undefined {\n    if (this.head >= this.items.length) {\n      return undefined;\n    }\n\n    const event = this.items[this.head];\n    this.head += 1;\n\n    if (\n      this.head > COMPACT_AFTER_DEQUEUE_COUNT &&\n      this.head * COMPACT_RATIO > this.items.length\n    ) {\n      this.items = this.items.slice(this.head);\n      this.head = 0;\n    }\n\n    return event;\n  }\n\n  /**\n   * \u30AD\u30E5\u30FC\u306E\u5148\u982D\u306E\u30A4\u30D9\u30F3\u30C8\u3092\u53D6\u308A\u51FA\u3055\u305A\u306B\u53C2\u7167\u3059\u308B\u3002\n   * @returns \u5148\u982D\u306E\u30A4\u30D9\u30F3\u30C8\u3002\u30AD\u30E5\u30FC\u304C\u7A7A\u306E\u5834\u5408\u306F `undefined`\u3002\n   */\n  peek(): Event | undefined {\n    return this.items[this.head];\n  }\n\n  /**\n   * \u30AD\u30E5\u30FC\u5185\u306E\u672A\u51E6\u7406\u30A4\u30D9\u30F3\u30C8\u6570\u3092\u8FD4\u3059\u3002\n   * @returns \u672A\u51E6\u7406\u306E\u30A4\u30D9\u30F3\u30C8\u6570\n   */\n  size(): number {\n    return this.items.length - this.head;\n  }\n\n  /**\n   * \u30AD\u30E5\u30FC\u5185\u306E\u3059\u3079\u3066\u306E\u30A4\u30D9\u30F3\u30C8\u3092\u524A\u9664\u3059\u308B\u3002\n   */\n  clear(): void {\n    this.items.length = 0;\n    this.head = 0;\n  }\n\n  /**\n   * \u30AD\u30E5\u30FC\u5185\u306E\u3059\u3079\u3066\u306E\u672A\u51E6\u7406\u30A4\u30D9\u30F3\u30C8\u3092\u914D\u5217\u3068\u3057\u3066\u8FD4\u3059\u3002\u30AD\u30E5\u30FC\u306E\u72B6\u614B\u306F\u5909\u66F4\u3057\u306A\u3044\u3002\n   * @returns \u672A\u51E6\u7406\u30A4\u30D9\u30F3\u30C8\u306E\u914D\u5217\n   */\n  list(): Event[] {\n    return this.items.slice(this.head);\n  }\n\n  /**\n   * \u30AD\u30E5\u30FC\u5185\u306E\u3059\u3079\u3066\u306E\u672A\u51E6\u7406\u30A4\u30D9\u30F3\u30C8\u3092\u53D6\u308A\u51FA\u3057\u3066\u8FD4\u3057\u3001\u30AD\u30E5\u30FC\u3092\u7A7A\u306B\u3059\u308B\u3002\n   * @returns \u53D6\u308A\u51FA\u3055\u308C\u305F\u3059\u3079\u3066\u306E\u672A\u51E6\u7406\u30A4\u30D9\u30F3\u30C8\u306E\u914D\u5217\n   */\n  drain(): Event[] {\n    const drained = this.items.slice(this.head);\n    this.items.length = 0;\n    this.head = 0;\n    return drained;\n  }\n}\n", "import { TZDate } from \"@date-fns/tz\";\n\n/**\n * \u30AA\u30FC\u30B1\u30B9\u30C8\u30EC\u30FC\u30BF\u30FC\u306E\u30E1\u30C8\u30EA\u30AF\u30B9\u60C5\u5831\u3002\n */\nexport interface SnapshotMetrics {\n  /** \u30D1\u30D6\u30EA\u30C3\u30B7\u30E5\u3055\u308C\u305F\u30A4\u30D9\u30F3\u30C8\u306E\u7DCF\u6570 */\n  published: number;\n  /** \u51E6\u7406\u6E08\u307F\u30A4\u30D9\u30F3\u30C8\u306E\u7DCF\u6570 */\n  processed: number;\n  /** \u30C7\u30A3\u30B9\u30D1\u30C3\u30C1\u30A8\u30E9\u30FC\u306E\u7DCF\u6570 */\n  dispatchErrors: number;\n  /** \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u5B9F\u884C\u56DE\u6570 */\n  workflowRuns: number;\n  /** \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u30A8\u30E9\u30FC\u306E\u7DCF\u6570 */\n  workflowErrors: number;\n}\n\n/**\n * \u30B9\u30CA\u30C3\u30D7\u30B7\u30E7\u30C3\u30C8\u4F5C\u6210\u6642\u306E\u521D\u671F\u5316\u30D1\u30E9\u30E1\u30FC\u30BF\u3002\n */\nexport interface SnapshotInit {\n  /** \u30AA\u30FC\u30B1\u30B9\u30C8\u30EC\u30FC\u30BF\u30FC\u304C\u5B9F\u884C\u4E2D\u304B\u3069\u3046\u304B */\n  isRunning: boolean;\n  /** \u30AA\u30FC\u30B1\u30B9\u30C8\u30EC\u30FC\u30BF\u30FC\u306E\u52D5\u4F5C\u30E2\u30FC\u30C9\u3002\u7701\u7565\u6642\u306F `\"all\"` */\n  mode?: \"all\" | \"producer\" | \"worker\";\n  /** \u30AD\u30E5\u30FC\u5185\u306E\u672A\u51E6\u7406\u30A4\u30D9\u30F3\u30C8\u6570 */\n  queueSize: number;\n  /** \u30E1\u30C8\u30EA\u30AF\u30B9\u60C5\u5831 */\n  metrics: SnapshotMetrics;\n  /** \u30B9\u30CA\u30C3\u30D7\u30B7\u30E7\u30C3\u30C8\u53D6\u5F97\u6642\u523B\u3002\u7701\u7565\u6642\u306F\u73FE\u5728\u6642\u523B */\n  timestamp?: Date;\n}\n\n/**\n * \u30AA\u30FC\u30B1\u30B9\u30C8\u30EC\u30FC\u30BF\u30FC\u306E\u72B6\u614B\u3092\u8868\u3059\u4E0D\u5909\u306E\u30B9\u30CA\u30C3\u30D7\u30B7\u30E7\u30C3\u30C8\u3002\n * \u5B9F\u884C\u72B6\u6CC1\u3001\u52D5\u4F5C\u30E2\u30FC\u30C9\u3001\u30AD\u30E5\u30FC\u30B5\u30A4\u30BA\u3001\u30E1\u30C8\u30EA\u30AF\u30B9\u3092\u4FDD\u6301\u3059\u308B\u3002\n */\nexport class Snapshot {\n  /** \u30AA\u30FC\u30B1\u30B9\u30C8\u30EC\u30FC\u30BF\u30FC\u304C\u5B9F\u884C\u4E2D\u304B\u3069\u3046\u304B */\n  readonly isRunning: boolean;\n  /** \u30AA\u30FC\u30B1\u30B9\u30C8\u30EC\u30FC\u30BF\u30FC\u306E\u52D5\u4F5C\u30E2\u30FC\u30C9 */\n  readonly mode: \"all\" | \"producer\" | \"worker\";\n  /** \u30AD\u30E5\u30FC\u5185\u306E\u672A\u51E6\u7406\u30A4\u30D9\u30F3\u30C8\u6570 */\n  readonly queueSize: number;\n  /** \u30E1\u30C8\u30EA\u30AF\u30B9\u60C5\u5831 */\n  readonly metrics: SnapshotMetrics;\n  /** \u30B9\u30CA\u30C3\u30D7\u30B7\u30E7\u30C3\u30C8\u53D6\u5F97\u6642\u523B */\n  readonly timestamp: Date;\n\n  /**\n   * \u521D\u671F\u5316\u30D1\u30E9\u30E1\u30FC\u30BF\u304B\u3089\u30B9\u30CA\u30C3\u30D7\u30B7\u30E7\u30C3\u30C8\u3092\u4F5C\u6210\u3059\u308B\u3002\n   * @param init - \u30B9\u30CA\u30C3\u30D7\u30B7\u30E7\u30C3\u30C8\u306E\u521D\u671F\u5316\u30D1\u30E9\u30E1\u30FC\u30BF\n   */\n  constructor(init: SnapshotInit) {\n    this.isRunning = init.isRunning;\n    this.mode = init.mode ?? \"all\";\n    this.queueSize = init.queueSize;\n    this.metrics = init.metrics;\n    this.timestamp = init.timestamp ?? new TZDate();\n  }\n}\n", "import {\n  ConflictError,\n  InvalidArgumentError,\n  NotFoundError,\n  RuntimeError,\n  StateError,\n} from \"../core/index.js\";\nimport type { DistributedLock, LockHandle } from \"../core/lock.js\";\nimport type {\n  ConversationMemory,\n  ConversationStore,\n} from \"../workflow/conversation-store.js\";\nimport type { RunStore, WorkflowRunRecord } from \"../workflow/run-store.js\";\nimport { toRunRecord } from \"../workflow/run-store.js\";\nimport {\n  Runner,\n  type WorkflowRunOptions,\n  type WorkflowRunResult,\n} from \"../workflow/runner.js\";\nimport type { EventTrigger, Trigger } from \"../workflow/trigger.js\";\nimport type { Workflow } from \"../workflow/workflow.js\";\nimport { Event, type EventMetadata } from \"./event.js\";\nimport { EventDispatcher } from \"./event-dispatcher.js\";\nimport type { DequeuedEvent, EventQueue, QueueMessage } from \"./event-queue.js\";\nimport { Queue } from \"./queue.js\";\nimport { Snapshot } from \"./snapshot.js\";\n\nconst MIN_CONCURRENCY = 1;\nconst DEFAULT_MAX_CONCURRENT_EVENTS = 1;\nconst DEFAULT_WORKFLOW_CONCURRENCY = 2;\nconst DEFAULT_MODE: OrchestratorMode = \"all\";\nconst DEFAULT_ACK_POLICY: AckPolicy = \"always\";\nconst DEFAULT_CONVERSATION_LOCK_TTL_MS = 60_000;\nconst DEFAULT_CONVERSATION_LOCK_REFRESH_MS = 20_000;\nconst DEFAULT_CONVERSATION_LOCK_RETRY_COUNT = 10;\nconst DEFAULT_CONVERSATION_LOCK_RETRY_DELAY_MS = 200;\nconst DEFAULT_CONVERSATION_LOCK_KEY_PREFIX = \"tokiwa:locks:conversation\";\nconst MISSING_SCHEDULER_MESSAGE =\n  \"Cron scheduler is not configured. Provide OrchestratorOptions.scheduler.\";\nconst MISSING_WORKER_MODE_MESSAGE = \"Drain is not available in producer mode.\";\nconst MISSING_CONVERSATION_STORE_MESSAGE =\n  \"Conversation store is not configured. Provide OrchestratorOptions.conversationStore.\";\nconst CHATFLOW_REQUIRES_CONVERSATION_ID =\n  \"Chatflow requires conversationId to run.\";\nconst CHATFLOW_CRON_UNSUPPORTED =\n  \"Chatflow workflows cannot be scheduled by cron.\";\nconst CONVERSATION_LOCK_FAILED =\n  \"Failed to acquire conversation lock for chatflow.\";\n\nexport type CronJobHandler = () => void | Promise<void>;\n\nexport interface CronScheduler {\n  start(): void | Promise<void>;\n  stop(): void | Promise<void>;\n  addJob(cronExpression: string, name: string, handler: CronJobHandler): string;\n  removeJob(id: string): boolean;\n  isJobScheduled(id: string): boolean;\n}\n\nexport interface WorkflowErrorContext {\n  workflowId: string;\n  event: Event;\n  trigger: Trigger<Event, unknown, unknown>;\n}\n\nexport type WorkflowErrorHandler = (\n  error: Error,\n  context: WorkflowErrorContext,\n) => void | Promise<void>;\n\nexport type OrchestratorMode = \"all\" | \"producer\" | \"worker\";\nexport type AckPolicy = \"always\" | \"onSuccess\";\n\nexport type RunStoreErrorHandler = (\n  error: Error,\n  record: WorkflowRunRecord,\n) => void | Promise<void>;\n\nexport interface OrchestratorOptions {\n  maxConcurrentEvents?: number;\n  workflowConcurrency?: number;\n  mode?: OrchestratorMode;\n  ackPolicy?: AckPolicy;\n  queue?: EventQueue;\n  scheduler?: CronScheduler;\n  onWorkflowError?: WorkflowErrorHandler;\n  conversationStore?: ConversationStore;\n  conversationLock?: DistributedLock;\n  conversationLockTtlMs?: number;\n  conversationLockRefreshMs?: number;\n  conversationLockRetryCount?: number;\n  conversationLockRetryDelayMs?: number;\n  conversationLockKeyPrefix?: string;\n  runStore?: RunStore;\n  onRunStoreError?: RunStoreErrorHandler;\n}\n\ninterface RegisteredWorkflow<Context = unknown, Input = unknown> {\n  workflow: Workflow<Context, Input>;\n  trigger: Trigger<Event, Input, Context>;\n  options?: WorkflowRunOptions<Context, Input>;\n}\n\ntype AnyRegisteredWorkflow = RegisteredWorkflow<unknown, unknown>;\ntype EventRegisteredWorkflow = RegisteredWorkflow<unknown, unknown> & {\n  trigger: EventTrigger<Event, unknown, unknown>;\n};\n\ninterface OrchestratorMetrics {\n  published: number;\n  processed: number;\n  dispatchErrors: number;\n  workflowRuns: number;\n  workflowErrors: number;\n}\n\ninterface ProcessResult {\n  dispatchErrors: number;\n  workflowFailures: number;\n}\n\n/**\n * \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u306E\u767B\u9332\u3001\u30A4\u30D9\u30F3\u30C8\u306E\u30D1\u30D6\u30EA\u30C3\u30B7\u30E5\u3001\u30AD\u30E5\u30FC\u51E6\u7406\u3001cron\u30B9\u30B1\u30B8\u30E5\u30FC\u30EA\u30F3\u30B0\u3092\u7BA1\u7406\u3059\u308B\u4E2D\u592E\u30B3\u30FC\u30C7\u30A3\u30CD\u30FC\u30BF\u30FC\u3002\n *\n * \u30AA\u30FC\u30B1\u30B9\u30C8\u30EC\u30FC\u30BF\u30FC\u306F\u300Cproducer\u300D\u300Cworker\u300D\u300Call\u300D\u306E3\u3064\u306E\u30E2\u30FC\u30C9\u3067\u52D5\u4F5C\u3057\u3001\n * \u30A4\u30D9\u30F3\u30C8\u99C6\u52D5\u578B\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u306E\u5B9F\u884C\u30E9\u30A4\u30D5\u30B5\u30A4\u30AF\u30EB\u5168\u4F53\u3092\u7D71\u62EC\u3059\u308B\u3002\n */\nexport class Orchestrator {\n  readonly dispatcher: EventDispatcher;\n  readonly queue: EventQueue;\n  readonly runner: Runner;\n  private readonly workflows = new Map<string, AnyRegisteredWorkflow>();\n  private readonly eventWorkflowIndex = new Map<\n    string,\n    Set<EventRegisteredWorkflow>\n  >();\n  private readonly wildcardEventWorkflows = new Set<EventRegisteredWorkflow>();\n  private readonly regexEventWorkflows = new Set<EventRegisteredWorkflow>();\n  private readonly maxConcurrentEvents: number;\n  private readonly workflowConcurrency: number;\n  private readonly mode: OrchestratorMode;\n  private readonly ackPolicy: AckPolicy;\n  private readonly scheduler?: CronScheduler;\n  private readonly onWorkflowError?: WorkflowErrorHandler;\n  private readonly conversationStore?: ConversationStore;\n  private readonly conversationLock?: DistributedLock;\n  private readonly conversationLockTtlMs: number;\n  private readonly conversationLockRefreshMs: number;\n  private readonly conversationLockRetryCount: number;\n  private readonly conversationLockRetryDelayMs: number;\n  private readonly conversationLockKeyPrefix: string;\n  private readonly runStore?: RunStore;\n  private readonly onRunStoreError?: RunStoreErrorHandler;\n  private readonly conversationLocks = new Map<string, Promise<void>>();\n  private isRunning = false;\n  private processing: Promise<void> | null = null;\n  private metrics: OrchestratorMetrics = {\n    published: 0,\n    processed: 0,\n    dispatchErrors: 0,\n    workflowRuns: 0,\n    workflowErrors: 0,\n  };\n\n  /**\n   * \u30AA\u30FC\u30B1\u30B9\u30C8\u30EC\u30FC\u30BF\u30FC\u3092\u521D\u671F\u5316\u3059\u308B\u3002\n   *\n   * \u540C\u6642\u5B9F\u884C\u6570\u3001\u52D5\u4F5C\u30E2\u30FC\u30C9\u3001ack \u30DD\u30EA\u30B7\u30FC\u3001\u4F1A\u8A71\u30B9\u30C8\u30A2\u3001\u5206\u6563\u30ED\u30C3\u30AF\u3001\u5B9F\u884C\u30B9\u30C8\u30A2\u306A\u3069\u306E\u30AA\u30D7\u30B7\u30E7\u30F3\u3092\u8A2D\u5B9A\u3059\u308B\u3002\n   *\n   * @param options - \u30AA\u30FC\u30B1\u30B9\u30C8\u30EC\u30FC\u30BF\u30FC\u306E\u8A2D\u5B9A\u30AA\u30D7\u30B7\u30E7\u30F3\n   */\n  constructor(options: OrchestratorOptions = {}) {\n    this.dispatcher = new EventDispatcher();\n    this.queue = options.queue ?? new Queue();\n    this.runner = new Runner();\n    this.maxConcurrentEvents = Math.max(\n      MIN_CONCURRENCY,\n      options.maxConcurrentEvents ?? DEFAULT_MAX_CONCURRENT_EVENTS,\n    );\n    this.workflowConcurrency = Math.max(\n      MIN_CONCURRENCY,\n      options.workflowConcurrency ?? DEFAULT_WORKFLOW_CONCURRENCY,\n    );\n    this.mode = options.mode ?? DEFAULT_MODE;\n    this.ackPolicy = options.ackPolicy ?? DEFAULT_ACK_POLICY;\n    this.scheduler = options.scheduler;\n    this.onWorkflowError = options.onWorkflowError;\n    this.conversationStore = options.conversationStore;\n    this.conversationLock = options.conversationLock;\n    this.conversationLockTtlMs =\n      options.conversationLockTtlMs ?? DEFAULT_CONVERSATION_LOCK_TTL_MS;\n    this.conversationLockRefreshMs =\n      options.conversationLockRefreshMs ?? DEFAULT_CONVERSATION_LOCK_REFRESH_MS;\n    this.conversationLockRetryCount =\n      options.conversationLockRetryCount ??\n      DEFAULT_CONVERSATION_LOCK_RETRY_COUNT;\n    this.conversationLockRetryDelayMs =\n      options.conversationLockRetryDelayMs ??\n      DEFAULT_CONVERSATION_LOCK_RETRY_DELAY_MS;\n    this.conversationLockKeyPrefix =\n      options.conversationLockKeyPrefix ?? DEFAULT_CONVERSATION_LOCK_KEY_PREFIX;\n    this.runStore = options.runStore;\n    this.onRunStoreError = options.onRunStoreError;\n  }\n\n  /**\n   * \u30AA\u30FC\u30B1\u30B9\u30C8\u30EC\u30FC\u30BF\u30FC\u3092\u958B\u59CB\u3059\u308B\u3002\n   *\n   * \u52D5\u4F5C\u30E2\u30FC\u30C9\u306B\u5FDC\u3058\u3066\u30B9\u30B1\u30B8\u30E5\u30FC\u30E9\u30FC\u306E\u8D77\u52D5\u3084\u30EF\u30FC\u30AB\u30FC\u30EB\u30FC\u30D7\u306E\u958B\u59CB\u3092\u884C\u3046\u3002\n   * \u65E2\u306B\u8D77\u52D5\u4E2D\u306E\u5834\u5408\u306F\u4F55\u3082\u3057\u306A\u3044\u3002\n   */\n  start(): void {\n    if (this.isRunning) {\n      return;\n    }\n\n    this.isRunning = true;\n    if (this.shouldStartScheduler()) {\n      void Promise.resolve(this.scheduler?.start()).catch(() => {});\n    }\n    if (this.isWorkerMode()) {\n      void this.kick();\n    }\n  }\n\n  /**\n   * \u30AA\u30FC\u30B1\u30B9\u30C8\u30EC\u30FC\u30BF\u30FC\u3092\u6B63\u5E38\u306B\u505C\u6B62\u3059\u308B\u3002\n   *\n   * \u5B9F\u884C\u4E2D\u306E\u51E6\u7406\u306E\u5B8C\u4E86\u3092\u5F85\u6A5F\u3057\u3001\u30B9\u30B1\u30B8\u30E5\u30FC\u30E9\u30FC\u3092\u505C\u6B62\u3059\u308B\u3002\n   */\n  async stop(): Promise<void> {\n    this.isRunning = false;\n    if (this.scheduler && this.shouldStartScheduler()) {\n      await this.scheduler.stop();\n    }\n    if (this.processing) {\n      await this.processing;\n    }\n  }\n\n  /**\n   * \u65B0\u3057\u3044\u30A4\u30D9\u30F3\u30C8\u3092\u4F5C\u6210\u3057\u3066\u30AD\u30E5\u30FC\u306B\u8FFD\u52A0\u3059\u308B\u3002\n   *\n   * @param type - \u30A4\u30D9\u30F3\u30C8\u30BF\u30A4\u30D7\n   * @param payload - \u30A4\u30D9\u30F3\u30C8\u306E\u30DA\u30A4\u30ED\u30FC\u30C9\n   * @param metadata - \u30A4\u30D9\u30F3\u30C8\u306E\u30E1\u30BF\u30C7\u30FC\u30BF\n   * @returns \u4F5C\u6210\u3055\u308C\u305F\u30A4\u30D9\u30F3\u30C8\n   */\n  publish<TPayload = unknown>(\n    type: string,\n    payload?: TPayload,\n    metadata?: EventMetadata,\n  ): Event<TPayload> {\n    const event = Event.create(type, payload, metadata);\n    this.enqueue(event);\n    return event;\n  }\n\n  /**\n   * \u65E2\u5B58\u306E\u30A4\u30D9\u30F3\u30C8\u3092\u30AD\u30E5\u30FC\u306B\u8FFD\u52A0\u3059\u308B\u3002\n   *\n   * \u30AA\u30FC\u30B1\u30B9\u30C8\u30EC\u30FC\u30BF\u30FC\u304C\u8D77\u52D5\u4E2D\u304B\u3064\u30EF\u30FC\u30AB\u30FC\u30E2\u30FC\u30C9\u306E\u5834\u5408\u3001\u30AD\u30E5\u30FC\u51E6\u7406\u3092\u81EA\u52D5\u7684\u306B\u30C8\u30EA\u30AC\u30FC\u3059\u308B\u3002\n   *\n   * @param event - \u30AD\u30E5\u30FC\u306B\u8FFD\u52A0\u3059\u308B\u30A4\u30D9\u30F3\u30C8\n   */\n  enqueue(event: Event): void {\n    void Promise.resolve(this.queue.enqueue(event)).catch(() => {});\n    this.metrics.published += 1;\n\n    if (this.isRunning && this.isWorkerMode()) {\n      void this.kick();\n    }\n  }\n\n  /**\n   * \u30AD\u30E5\u30FC\u306B\u6E9C\u307E\u3063\u305F\u5168\u30A4\u30D9\u30F3\u30C8\u3092\u540C\u671F\u7684\u306B\u51E6\u7406\u3059\u308B\u3002\n   *\n   * \u30EF\u30FC\u30AB\u30FC\u30E2\u30FC\u30C9\u3067\u306E\u307F\u4F7F\u7528\u53EF\u80FD\u3002\u30D7\u30ED\u30C7\u30E5\u30FC\u30B5\u30FC\u30E2\u30FC\u30C9\u3067\u306F {@link StateError} \u3092\u30B9\u30ED\u30FC\u3059\u308B\u3002\n   *\n   * @throws {StateError} \u30D7\u30ED\u30C7\u30E5\u30FC\u30B5\u30FC\u30E2\u30FC\u30C9\u3067\u547C\u3073\u51FA\u3055\u308C\u305F\u5834\u5408\n   */\n  async drain(): Promise<void> {\n    if (!this.isWorkerMode()) {\n      throw new StateError(MISSING_WORKER_MODE_MESSAGE);\n    }\n    await this.kick(true);\n  }\n\n  /**\n   * \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u3092\u30C8\u30EA\u30AC\u30FC\u3068\u3068\u3082\u306B\u767B\u9332\u3059\u308B\u3002\n   *\n   * \u540C\u3058ID\u306E\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u304C\u65E2\u306B\u767B\u9332\u3055\u308C\u3066\u3044\u308B\u5834\u5408\u306F {@link ConflictError} \u3092\u30B9\u30ED\u30FC\u3059\u308B\u3002\n   *\n   * @param workflow - \u767B\u9332\u3059\u308B\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\n   * @param trigger - \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u306E\u30C8\u30EA\u30AC\u30FC\u6761\u4EF6\uFF08\u30C7\u30D5\u30A9\u30EB\u30C8\u306F\u624B\u52D5\u30C8\u30EA\u30AC\u30FC\uFF09\n   * @param options - \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u5B9F\u884C\u6642\u306E\u30AA\u30D7\u30B7\u30E7\u30F3\n   * @throws {ConflictError} \u540C\u3058ID\u306E\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u304C\u65E2\u306B\u767B\u9332\u3055\u308C\u3066\u3044\u308B\u5834\u5408\n   */\n  registerWorkflow<Context = unknown, Input = unknown>(\n    workflow: Workflow<Context, Input>,\n    trigger: Trigger<Event, Input, Context> = { type: \"manual\" },\n    options?: WorkflowRunOptions<Context, Input>,\n  ): void {\n    if (this.workflows.has(workflow.id)) {\n      throw new ConflictError(`Workflow already registered: ${workflow.id}`);\n    }\n\n    const registration: RegisteredWorkflow<Context, Input> = {\n      workflow,\n      trigger,\n      options,\n    };\n\n    const storedRegistration = registration as AnyRegisteredWorkflow;\n    this.workflows.set(workflow.id, storedRegistration);\n    this.indexWorkflow(storedRegistration);\n  }\n\n  /**\n   * \u30B9\u30B1\u30B8\u30E5\u30FC\u30E9\u30FC\u3092\u901A\u3058\u3066cron\u30B8\u30E7\u30D6\u3092\u767B\u9332\u3059\u308B\u3002\n   *\n   * @param cronExpression - cron\u5F0F\uFF08\u4F8B: \"0 * * * *\"\uFF09\n   * @param name - \u30B8\u30E7\u30D6\u306E\u8868\u793A\u540D\n   * @param handler - \u5B9F\u884C\u3059\u308B\u30CF\u30F3\u30C9\u30E9\u30FC\u95A2\u6570\n   * @returns \u751F\u6210\u3055\u308C\u305F\u30B8\u30E7\u30D6ID\n   * @throws {StateError} \u30B9\u30B1\u30B8\u30E5\u30FC\u30E9\u30FC\u304C\u8A2D\u5B9A\u3055\u308C\u3066\u3044\u306A\u3044\u5834\u5408\n   */\n  registerCronJob(\n    cronExpression: string,\n    name: string,\n    handler: CronJobHandler,\n  ): string {\n    return this.getScheduler().addJob(cronExpression, name, handler);\n  }\n\n  /**\n   * \u30B9\u30B1\u30B8\u30E5\u30FC\u30EB\u306B\u5F93\u3063\u3066\u30A4\u30D9\u30F3\u30C8\u3092\u30D1\u30D6\u30EA\u30C3\u30B7\u30E5\u3059\u308Bcron\u30B8\u30E7\u30D6\u3092\u767B\u9332\u3059\u308B\u3002\n   *\n   * @param cronExpression - cron\u5F0F\n   * @param eventType - \u30D1\u30D6\u30EA\u30C3\u30B7\u30E5\u3059\u308B\u30A4\u30D9\u30F3\u30C8\u30BF\u30A4\u30D7\n   * @param name - \u30B8\u30E7\u30D6\u306E\u8868\u793A\u540D\n   * @param payload - \u30A4\u30D9\u30F3\u30C8\u306E\u30DA\u30A4\u30ED\u30FC\u30C9\uFF08\u4EFB\u610F\uFF09\n   * @param metadata - \u30A4\u30D9\u30F3\u30C8\u306E\u30E1\u30BF\u30C7\u30FC\u30BF\uFF08\u4EFB\u610F\uFF09\n   * @returns \u751F\u6210\u3055\u308C\u305F\u30B8\u30E7\u30D6ID\n   */\n  registerCronEvent<TPayload = unknown>(\n    cronExpression: string,\n    eventType: string,\n    name: string,\n    payload?: TPayload,\n    metadata?: EventMetadata,\n  ): string {\n    return this.registerCronJob(cronExpression, name, () => {\n      this.publish(eventType, payload, metadata);\n    });\n  }\n\n  /**\n   * \u30B9\u30B1\u30B8\u30E5\u30FC\u30EB\u306B\u5F93\u3063\u3066\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u3092\u5B9F\u884C\u3059\u308Bcron\u30B8\u30E7\u30D6\u3092\u767B\u9332\u3059\u308B\u3002\n   *\n   * \u30C1\u30E3\u30C3\u30C8\u30D5\u30ED\u30FC\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u306Fcron\u30B9\u30B1\u30B8\u30E5\u30FC\u30EA\u30F3\u30B0\u306B\u5BFE\u5FDC\u3057\u3066\u3044\u306A\u3044\u3002\n   *\n   * @param cronExpression - cron\u5F0F\n   * @param workflowId - \u5B9F\u884C\u3059\u308B\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u306EID\n   * @param name - \u30B8\u30E7\u30D6\u306E\u8868\u793A\u540D\n   * @param options - \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u5B9F\u884C\u6642\u306E\u30AA\u30D7\u30B7\u30E7\u30F3\uFF08\u4EFB\u610F\uFF09\n   * @returns \u751F\u6210\u3055\u308C\u305F\u30B8\u30E7\u30D6ID\n   * @throws {NotFoundError} \u6307\u5B9A\u3055\u308C\u305F\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u304C\u898B\u3064\u304B\u3089\u306A\u3044\u5834\u5408\n   * @throws {InvalidArgumentError} \u30C1\u30E3\u30C3\u30C8\u30D5\u30ED\u30FC\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u304C\u6307\u5B9A\u3055\u308C\u305F\u5834\u5408\n   */\n  registerCronWorkflow<Context = unknown, Input = unknown>(\n    cronExpression: string,\n    workflowId: string,\n    name: string,\n    options?: WorkflowRunOptions<Context, Input>,\n  ): string {\n    const registration = this.workflows.get(workflowId);\n    if (!registration) {\n      throw new NotFoundError(`Unknown workflow: ${workflowId}`);\n    }\n    if (registration.workflow.type === \"chatflow\") {\n      throw new InvalidArgumentError(CHATFLOW_CRON_UNSUPPORTED);\n    }\n\n    return this.registerCronJob(cronExpression, name, async () => {\n      await this.runWorkflow<Context, Input>(workflowId, options);\n    });\n  }\n\n  /**\n   * \u767B\u9332\u6E08\u307F\u306Ecron\u30B8\u30E7\u30D6\u3092\u524A\u9664\u3059\u308B\u3002\n   *\n   * @param jobId - \u524A\u9664\u3059\u308B\u30B8\u30E7\u30D6\u306EID\n   * @returns \u30B8\u30E7\u30D6\u304C\u5B58\u5728\u3057\u3066\u524A\u9664\u3055\u308C\u305F\u5834\u5408\u306F `true`\n   */\n  removeCronJob(jobId: string): boolean {\n    return this.getScheduler().removeJob(jobId);\n  }\n\n  /**\n   * \u6307\u5B9A\u3055\u308C\u305Fcron\u30B8\u30E7\u30D6\u304C\u767B\u9332\u3055\u308C\u3066\u3044\u308B\u304B\u3069\u3046\u304B\u3092\u78BA\u8A8D\u3059\u308B\u3002\n   *\n   * @param jobId - \u78BA\u8A8D\u3059\u308B\u30B8\u30E7\u30D6\u306EID\n   * @returns \u30B8\u30E7\u30D6\u304C\u767B\u9332\u3055\u308C\u3066\u3044\u308B\u5834\u5408\u306F `true`\n   */\n  isCronJobScheduled(jobId: string): boolean {\n    return this.getScheduler().isJobScheduled(jobId);\n  }\n\n  /**\n   * \u767B\u9332\u6E08\u307F\u306E\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u3092\u524A\u9664\u3059\u308B\u3002\n   *\n   * \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u306B\u95A2\u9023\u3059\u308B\u30A4\u30D9\u30F3\u30C8\u30A4\u30F3\u30C7\u30C3\u30AF\u30B9\u3082\u5408\u308F\u305B\u3066\u524A\u9664\u3055\u308C\u308B\u3002\n   *\n   * @param workflowId - \u524A\u9664\u3059\u308B\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u306EID\n   * @returns \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u304C\u5B58\u5728\u3057\u3066\u524A\u9664\u3055\u308C\u305F\u5834\u5408\u306F `true`\n   */\n  unregisterWorkflow(workflowId: string): boolean {\n    const registration = this.workflows.get(workflowId);\n    if (!registration) {\n      return false;\n    }\n\n    this.unindexWorkflow(registration);\n    return this.workflows.delete(workflowId);\n  }\n\n  /**\n   * \u767B\u9332\u6E08\u307F\u306E\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u3092\u624B\u52D5\u3067\u5B9F\u884C\u3059\u308B\u3002\n   *\n   * \u767B\u9332\u6642\u306E\u30AA\u30D7\u30B7\u30E7\u30F3\u3068\u5F15\u6570\u306E\u30AA\u30D7\u30B7\u30E7\u30F3\u304C\u30DE\u30FC\u30B8\u3055\u308C\u3001\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u304C\u5B9F\u884C\u3055\u308C\u308B\u3002\n   *\n   * @param workflowId - \u5B9F\u884C\u3059\u308B\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u306EID\n   * @param options - \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u5B9F\u884C\u6642\u306E\u30AA\u30D7\u30B7\u30E7\u30F3\uFF08\u4EFB\u610F\uFF09\n   * @returns \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u306E\u5B9F\u884C\u7D50\u679C\n   * @throws {NotFoundError} \u6307\u5B9A\u3055\u308C\u305F\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u304C\u898B\u3064\u304B\u3089\u306A\u3044\u5834\u5408\n   */\n  async runWorkflow<Context = unknown, Input = unknown>(\n    workflowId: string,\n    options?: WorkflowRunOptions<Context, Input>,\n  ): Promise<WorkflowRunResult> {\n    const registration = this.workflows.get(workflowId);\n    if (!registration) {\n      throw new NotFoundError(`Unknown workflow: ${workflowId}`);\n    }\n\n    const mergedOptions: WorkflowRunOptions<unknown, unknown> = {\n      ...(registration.options ?? {}),\n      ...(options ?? {}),\n    };\n\n    this.metrics.workflowRuns += 1;\n\n    const result = await this.executeWorkflow(registration, mergedOptions);\n\n    if (result.status === \"failed\") {\n      this.metrics.workflowErrors += 1;\n    }\n\n    return result;\n  }\n\n  /**\n   * \u30AA\u30FC\u30B1\u30B9\u30C8\u30EC\u30FC\u30BF\u30FC\u306E\u73FE\u5728\u306E\u72B6\u614B\u306E\u30B9\u30CA\u30C3\u30D7\u30B7\u30E7\u30C3\u30C8\u3092\u4F5C\u6210\u3059\u308B\u3002\n   *\n   * \u5B9F\u884C\u72B6\u614B\u3001\u30E2\u30FC\u30C9\u3001\u30AD\u30E5\u30FC\u30B5\u30A4\u30BA\u3001\u30E1\u30C8\u30EA\u30AF\u30B9\u3092\u542B\u3080\u30B9\u30CA\u30C3\u30D7\u30B7\u30E7\u30C3\u30C8\u3092\u8FD4\u3059\u3002\n   *\n   * @returns \u30AA\u30FC\u30B1\u30B9\u30C8\u30EC\u30FC\u30BF\u30FC\u306E\u72B6\u614B\u30B9\u30CA\u30C3\u30D7\u30B7\u30E7\u30C3\u30C8\n   */\n  async snapshot(): Promise<Snapshot> {\n    return new Snapshot({\n      isRunning: this.isRunning,\n      mode: this.mode,\n      queueSize: await this.getQueueSize(),\n      metrics: { ...this.metrics },\n    });\n  }\n\n  /**\n   * \u30AD\u30E5\u30FC\u306E\u73FE\u5728\u306E\u30B5\u30A4\u30BA\u3092\u53D6\u5F97\u3059\u308B\u3002\n   *\n   * @returns \u30AD\u30E5\u30FC\u5185\u306E\u30A4\u30D9\u30F3\u30C8\u6570\n   */\n  private async getQueueSize(): Promise<number> {\n    const size = this.queue.size();\n    return await Promise.resolve(size);\n  }\n\n  /**\n   * \u30AD\u30E5\u30FC\u51E6\u7406\u3092\u30C1\u30A7\u30FC\u30F3\u3057\u3066\u5B9F\u884C\u3059\u308B\u3002\n   *\n   * \u524D\u56DE\u306E\u51E6\u7406\u304C\u5B8C\u4E86\u3057\u305F\u5F8C\u306B\u6B21\u306E\u51E6\u7406\u3092\u958B\u59CB\u3057\u3001\u51E6\u7406\u306E\u76F4\u5217\u5316\u3092\u4FDD\u8A3C\u3059\u308B\u3002\n   *\n   * @param allowWhenStopped - \u505C\u6B62\u4E2D\u3067\u3082\u51E6\u7406\u3092\u8A31\u53EF\u3059\u308B\u304B\u3069\u3046\u304B\n   */\n  private async kick(allowWhenStopped: boolean = false): Promise<void> {\n    const run = async (): Promise<void> => {\n      await this.processQueue(allowWhenStopped);\n    };\n\n    const chain = (this.processing ?? Promise.resolve())\n      .then(run, run)\n      .finally(() => {\n        if (this.processing === chain) {\n          this.processing = null;\n        }\n      });\n\n    this.processing = chain;\n    return chain;\n  }\n\n  /**\n   * \u30B9\u30B1\u30B8\u30E5\u30FC\u30E9\u30FC\u3092\u8FD4\u3059\u3002\u8A2D\u5B9A\u3055\u308C\u3066\u3044\u306A\u3044\u5834\u5408\u306F\u4F8B\u5916\u3092\u30B9\u30ED\u30FC\u3059\u308B\u3002\n   *\n   * @returns \u8A2D\u5B9A\u6E08\u307F\u306Ecron\u30B9\u30B1\u30B8\u30E5\u30FC\u30E9\u30FC\n   * @throws {StateError} \u30B9\u30B1\u30B8\u30E5\u30FC\u30E9\u30FC\u304C\u8A2D\u5B9A\u3055\u308C\u3066\u3044\u306A\u3044\u5834\u5408\n   */\n  private getScheduler(): CronScheduler {\n    if (!this.scheduler) {\n      throw new StateError(MISSING_SCHEDULER_MESSAGE);\n    }\n    return this.scheduler;\n  }\n\n  /**\n   * \u4F1A\u8A71\u30B9\u30C8\u30A2\u3092\u8FD4\u3059\u3002\u8A2D\u5B9A\u3055\u308C\u3066\u3044\u306A\u3044\u5834\u5408\u306F\u4F8B\u5916\u3092\u30B9\u30ED\u30FC\u3059\u308B\u3002\n   *\n   * @returns \u8A2D\u5B9A\u6E08\u307F\u306E\u4F1A\u8A71\u30B9\u30C8\u30A2\n   * @throws {StateError} \u4F1A\u8A71\u30B9\u30C8\u30A2\u304C\u8A2D\u5B9A\u3055\u308C\u3066\u3044\u306A\u3044\u5834\u5408\n   */\n  private getConversationStore(): ConversationStore {\n    if (!this.conversationStore) {\n      throw new StateError(MISSING_CONVERSATION_STORE_MESSAGE);\n    }\n    return this.conversationStore;\n  }\n\n  /**\n   * \u73FE\u5728\u306E\u30E2\u30FC\u30C9\u304C\u30EF\u30FC\u30AB\u30FC\u30E2\u30FC\u30C9\uFF08\u300Cproducer\u300D\u4EE5\u5916\uFF09\u304B\u3069\u3046\u304B\u3092\u5224\u5B9A\u3059\u308B\u3002\n   *\n   * @returns \u30EF\u30FC\u30AB\u30FC\u30E2\u30FC\u30C9\u306E\u5834\u5408\u306F `true`\n   */\n  private isWorkerMode(): boolean {\n    return this.mode !== \"producer\";\n  }\n\n  /**\n   * \u30B9\u30B1\u30B8\u30E5\u30FC\u30E9\u30FC\u3092\u8D77\u52D5\u3059\u3079\u304D\u304B\u3069\u3046\u304B\u3092\u5224\u5B9A\u3059\u308B\uFF08\u300Cworker\u300D\u4EE5\u5916\u306E\u30E2\u30FC\u30C9\u3067\u8D77\u52D5\u3059\u308B\uFF09\u3002\n   *\n   * @returns \u30B9\u30B1\u30B8\u30E5\u30FC\u30E9\u30FC\u3092\u8D77\u52D5\u3059\u3079\u304D\u5834\u5408\u306F `true`\n   */\n  private shouldStartScheduler(): boolean {\n    return this.mode !== \"worker\";\n  }\n\n  /**\n   * \u5206\u6563\u30ED\u30C3\u30AF\u3068\u30ED\u30FC\u30AB\u30EB\u4F1A\u8A71\u30ED\u30C3\u30AF\u306E\u4E21\u65B9\u3092\u53D6\u5F97\u3057\u3066\u30BF\u30B9\u30AF\u3092\u5B9F\u884C\u3059\u308B\u3002\n   *\n   * \u5206\u6563\u30ED\u30C3\u30AF\u304C\u8A2D\u5B9A\u3055\u308C\u3066\u3044\u306A\u3044\u5834\u5408\u306F\u30ED\u30FC\u30AB\u30EB\u30ED\u30C3\u30AF\u306E\u307F\u3092\u4F7F\u7528\u3059\u308B\u3002\n   * \u30ED\u30C3\u30AF\u306E\u81EA\u52D5\u30EA\u30D5\u30EC\u30C3\u30B7\u30E5\u3082\u884C\u3044\u3001\u9577\u6642\u9593\u5B9F\u884C\u30BF\u30B9\u30AF\u306E\u30ED\u30C3\u30AF\u5931\u52B9\u3092\u9632\u6B62\u3059\u308B\u3002\n   *\n   * @param conversationId - \u30ED\u30C3\u30AF\u5BFE\u8C61\u306E\u4F1A\u8A71ID\n   * @param task - \u30ED\u30C3\u30AF\u53D6\u5F97\u5F8C\u306B\u5B9F\u884C\u3059\u308B\u30BF\u30B9\u30AF\n   * @returns \u30BF\u30B9\u30AF\u306E\u5B9F\u884C\u7D50\u679C\n   * @throws {StateError} \u5206\u6563\u30ED\u30C3\u30AF\u306E\u53D6\u5F97\u306B\u5931\u6557\u3057\u305F\u5834\u5408\n   */\n  private async withConversationLock<T>(\n    conversationId: string,\n    task: () => Promise<T>,\n  ): Promise<T> {\n    if (!this.conversationLock) {\n      return this.withLocalConversationLock(conversationId, task);\n    }\n\n    const lockKey = `${this.conversationLockKeyPrefix}:${conversationId}`;\n    const handle = await this.acquireConversationLock(lockKey);\n    if (!handle) {\n      throw new StateError(CONVERSATION_LOCK_FAILED);\n    }\n\n    let refreshTimer: ReturnType<typeof setInterval> | null = null;\n    if (this.conversationLockRefreshMs > 0 && this.conversationLock.refresh) {\n      refreshTimer = setInterval(() => {\n        void this.conversationLock\n          ?.refresh?.(handle, this.conversationLockTtlMs)\n          .catch(() => {});\n      }, this.conversationLockRefreshMs);\n    }\n\n    try {\n      return await this.withLocalConversationLock(conversationId, task);\n    } finally {\n      if (refreshTimer) {\n        clearInterval(refreshTimer);\n      }\n      await this.conversationLock.release(handle);\n    }\n  }\n\n  /**\n   * \u30ED\u30FC\u30AB\u30EB\u4F1A\u8A71\u30ED\u30C3\u30AF\uFF08Promise\u30C1\u30A7\u30FC\u30F3\uFF09\u3092\u4F7F\u7528\u3057\u3066\u30BF\u30B9\u30AF\u3092\u5B9F\u884C\u3059\u308B\u3002\n   *\n   * \u540C\u4E00\u4F1A\u8A71ID\u306B\u5BFE\u3059\u308B\u51E6\u7406\u3092\u76F4\u5217\u5316\u3057\u3001\u540C\u6642\u5B9F\u884C\u306B\u3088\u308B\u7AF6\u5408\u3092\u9632\u6B62\u3059\u308B\u3002\n   *\n   * @param conversationId - \u30ED\u30C3\u30AF\u5BFE\u8C61\u306E\u4F1A\u8A71ID\n   * @param task - \u30ED\u30C3\u30AF\u53D6\u5F97\u5F8C\u306B\u5B9F\u884C\u3059\u308B\u30BF\u30B9\u30AF\n   * @returns \u30BF\u30B9\u30AF\u306E\u5B9F\u884C\u7D50\u679C\n   */\n  private async withLocalConversationLock<T>(\n    conversationId: string,\n    task: () => Promise<T>,\n  ): Promise<T> {\n    const previous =\n      this.conversationLocks.get(conversationId) ?? Promise.resolve();\n    let release = (): void => {};\n    const gate = new Promise<void>((resolve) => {\n      release = () => resolve();\n    });\n    const chain = previous.catch(() => {}).then(() => gate);\n    this.conversationLocks.set(conversationId, chain);\n\n    await previous.catch(() => {});\n    try {\n      return await task();\n    } finally {\n      release();\n      if (this.conversationLocks.get(conversationId) === chain) {\n        this.conversationLocks.delete(conversationId);\n      }\n    }\n  }\n\n  /**\n   * \u30EA\u30C8\u30E9\u30A4\u4ED8\u304D\u3067\u5206\u6563\u30ED\u30C3\u30AF\u3092\u53D6\u5F97\u3059\u308B\u3002\n   *\n   * \u8A2D\u5B9A\u3055\u308C\u305F\u30EA\u30C8\u30E9\u30A4\u56DE\u6570\u3068\u9045\u5EF6\u306B\u5F93\u3063\u3066\u3001\u30ED\u30C3\u30AF\u53D6\u5F97\u3092\u7E70\u308A\u8FD4\u3057\u8A66\u884C\u3059\u308B\u3002\n   *\n   * @param key - \u30ED\u30C3\u30AF\u30AD\u30FC\n   * @returns \u53D6\u5F97\u3057\u305F\u30ED\u30C3\u30AF\u30CF\u30F3\u30C9\u30EB\u3002\u53D6\u5F97\u3067\u304D\u306A\u304B\u3063\u305F\u5834\u5408\u306F `null`\n   */\n  private async acquireConversationLock(\n    key: string,\n  ): Promise<LockHandle | null> {\n    if (!this.conversationLock) {\n      return null;\n    }\n\n    for (\n      let attempt = 0;\n      attempt <= this.conversationLockRetryCount;\n      attempt += 1\n    ) {\n      const handle = await this.conversationLock.acquire(key, {\n        ttlMs: this.conversationLockTtlMs,\n      });\n      if (handle) {\n        return handle;\n      }\n      if (\n        attempt < this.conversationLockRetryCount &&\n        this.conversationLockRetryDelayMs > 0\n      ) {\n        await this.sleep(this.conversationLockRetryDelayMs);\n      }\n    }\n\n    return null;\n  }\n\n  /**\n   * \u6307\u5B9A\u30DF\u30EA\u79D2\u9593\u306E\u9045\u5EF6\u3092\u884C\u3046\u30B7\u30F3\u30D7\u30EB\u306A\u30B9\u30EA\u30FC\u30D7\u95A2\u6570\u3002\n   *\n   * @param ms - \u9045\u5EF6\u3059\u308B\u30DF\u30EA\u79D2\u6570\n   */\n  private sleep(ms: number): Promise<void> {\n    return new Promise((resolve) => setTimeout(resolve, ms));\n  }\n\n  /**\n   * \u30E1\u30A4\u30F3\u306E\u30AD\u30E5\u30FC\u51E6\u7406\u30EB\u30FC\u30D7\u3002\u540C\u6642\u5B9F\u884C\u6570\u3092\u5236\u5FA1\u3057\u306A\u304C\u3089\u30A4\u30D9\u30F3\u30C8\u3092\u51E6\u7406\u3059\u308B\u3002\n   *\n   * \u8A2D\u5B9A\u3055\u308C\u305F\u6700\u5927\u540C\u6642\u5B9F\u884C\u6570\u307E\u3067\u4E26\u5217\u306B\u30A4\u30D9\u30F3\u30C8\u3092\u51E6\u7406\u3057\u3001\n   * \u30AD\u30E5\u30FC\u304C\u7A7A\u306B\u306A\u308B\u304B\u505C\u6B62\u3055\u308C\u308B\u307E\u3067\u30EB\u30FC\u30D7\u3092\u7D99\u7D9A\u3059\u308B\u3002\n   *\n   * @param allowWhenStopped - \u505C\u6B62\u4E2D\u3067\u3082\u51E6\u7406\u3092\u8A31\u53EF\u3059\u308B\u304B\u3069\u3046\u304B\n   */\n  private async processQueue(allowWhenStopped: boolean): Promise<void> {\n    const inFlight = new Set<Promise<void>>();\n\n    const schedule = (message: DequeuedEvent): void => {\n      const { event, ack, nack } = this.normalizeQueueMessage(message);\n      const task = this.processEvent(event)\n        .then((result) => this.handleQueueAck(result, ack, nack))\n        .catch((error: unknown) => {\n          if (!nack) {\n            return;\n          }\n          const reason = error instanceof Error ? error.message : String(error);\n          return Promise.resolve(nack(reason));\n        })\n        .finally(() => {\n          inFlight.delete(task);\n        });\n      inFlight.add(task);\n    };\n\n    while (this.isRunning || allowWhenStopped) {\n      while (\n        (this.isRunning || allowWhenStopped) &&\n        inFlight.size < this.maxConcurrentEvents\n      ) {\n        const message = await this.queue.dequeue();\n        if (!message) {\n          break;\n        }\n        schedule(message);\n      }\n\n      if (inFlight.size === 0) {\n        break;\n      }\n\n      await Promise.race(inFlight);\n    }\n  }\n\n  /**\n   * \u30C7\u30AD\u30E5\u30FC\u3055\u308C\u305F\u30E1\u30C3\u30BB\u30FC\u30B8\u304B\u3089\u30A4\u30D9\u30F3\u30C8\u3068ack/nack\u30B3\u30FC\u30EB\u30D0\u30C3\u30AF\u3092\u62BD\u51FA\u3059\u308B\u3002\n   *\n   * {@link QueueMessage} \u5F62\u5F0F\u306E\u5834\u5408\u306F\u30A4\u30D9\u30F3\u30C8\u3068\u30B3\u30FC\u30EB\u30D0\u30C3\u30AF\u3092\u5206\u96E2\u3057\u3001\n   * \u5358\u7D14\u306A\u30A4\u30D9\u30F3\u30C8\u306E\u5834\u5408\u306F\u305D\u306E\u307E\u307E\u8FD4\u3059\u3002\n   *\n   * @param message - \u30C7\u30AD\u30E5\u30FC\u3055\u308C\u305F\u30E1\u30C3\u30BB\u30FC\u30B8\n   * @returns \u30A4\u30D9\u30F3\u30C8\u3068\u30AA\u30D7\u30B7\u30E7\u30F3\u306Eack/nack\u30B3\u30FC\u30EB\u30D0\u30C3\u30AF\n   */\n  private normalizeQueueMessage(message: DequeuedEvent): {\n    event: Event;\n    ack?: QueueMessage[\"ack\"];\n    nack?: QueueMessage[\"nack\"];\n  } {\n    if (this.isQueueMessage(message)) {\n      return {\n        event: message.event,\n        ack: message.ack,\n        nack: message.nack,\n      };\n    }\n\n    return { event: message };\n  }\n\n  /**\n   * ack\u30DD\u30EA\u30B7\u30FC\u3068\u51E6\u7406\u7D50\u679C\u306B\u57FA\u3065\u3044\u3066ack\u307E\u305F\u306Fnack\u3092\u5B9F\u884C\u3059\u308B\u3002\n   *\n   * \u300Calways\u300D\u30DD\u30EA\u30B7\u30FC\u306E\u5834\u5408\u306F\u5E38\u306Back\u3001\u300ConSuccess\u300D\u30DD\u30EA\u30B7\u30FC\u306E\u5834\u5408\u306F\n   * \u5931\u6557\u304C\u306A\u3051\u308C\u3070ack\u3057\u3001\u5931\u6557\u304C\u3042\u308C\u3070nack\u3059\u308B\u3002\n   *\n   * @param result - \u30A4\u30D9\u30F3\u30C8\u51E6\u7406\u306E\u7D50\u679C\n   * @param ack - ack \u30B3\u30FC\u30EB\u30D0\u30C3\u30AF\n   * @param nack - nack \u30B3\u30FC\u30EB\u30D0\u30C3\u30AF\n   */\n  private async handleQueueAck(\n    result: ProcessResult,\n    ack?: QueueMessage[\"ack\"],\n    nack?: QueueMessage[\"nack\"],\n  ): Promise<void> {\n    if (!ack && !nack) {\n      return;\n    }\n\n    const hasFailures =\n      result.dispatchErrors > 0 || result.workflowFailures > 0;\n    const shouldAck = this.ackPolicy === \"always\" || !hasFailures;\n\n    try {\n      if (shouldAck) {\n        await Promise.resolve(ack?.());\n      } else {\n        await Promise.resolve(nack?.(this.buildNackReason(result)));\n      }\n    } catch {\n      // Ignore queue acknowledgement errors to avoid crashing the worker loop.\n    }\n  }\n\n  /**\n   * nack\u7406\u7531\u306E\u6587\u5B57\u5217\u3092\u30D5\u30A9\u30FC\u30DE\u30C3\u30C8\u3059\u308B\u3002\n   *\n   * @param result - \u51E6\u7406\u7D50\u679C\n   * @returns \u30C7\u30A3\u30B9\u30D1\u30C3\u30C1\u30A8\u30E9\u30FC\u6570\u3068\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u5931\u6557\u6570\u3092\u542B\u3080\u7406\u7531\u6587\u5B57\u5217\n   */\n  private buildNackReason(result: ProcessResult): string {\n    return `dispatchErrors=${result.dispatchErrors}, workflowFailures=${result.workflowFailures}`;\n  }\n\n  /**\n   * \u5358\u4E00\u306E\u30A4\u30D9\u30F3\u30C8\u3092\u51E6\u7406\u3059\u308B\u3002\u30C7\u30A3\u30B9\u30D1\u30C3\u30C1\u3068\u30C8\u30EA\u30AC\u30FC\u3055\u308C\u305F\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u306E\u5B9F\u884C\u3092\u884C\u3046\u3002\n   *\n   * @param event - \u51E6\u7406\u3059\u308B\u30A4\u30D9\u30F3\u30C8\n   * @returns \u30C7\u30A3\u30B9\u30D1\u30C3\u30C1\u30A8\u30E9\u30FC\u6570\u3068\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u5931\u6557\u6570\u3092\u542B\u3080\u51E6\u7406\u7D50\u679C\n   */\n  private async processEvent(event: Event): Promise<ProcessResult> {\n    this.metrics.processed += 1;\n    const dispatchResult = await this.dispatcher.dispatch(event);\n    this.metrics.dispatchErrors += dispatchResult.errors.length;\n\n    const workflowFailures = await this.runTriggeredWorkflows(event);\n\n    return {\n      dispatchErrors: dispatchResult.errors.length,\n      workflowFailures,\n    };\n  }\n\n  /**\n   * \u30A4\u30D9\u30F3\u30C8\u306B\u3088\u3063\u3066\u30C8\u30EA\u30AC\u30FC\u3055\u308C\u305F\u5168\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u3092\u4E26\u884C\u5B9F\u884C\u3059\u308B\u3002\n   *\n   * \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u540C\u6642\u5B9F\u884C\u6570\u306E\u5236\u9650\u306B\u5F93\u3044\u3001\u4E26\u5217\u3067\u5B9F\u884C\u3059\u308B\u3002\n   *\n   * @param event - \u30C8\u30EA\u30AC\u30FC\u5143\u306E\u30A4\u30D9\u30F3\u30C8\n   * @returns \u5931\u6557\u3057\u305F\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u306E\u6570\n   */\n  private async runTriggeredWorkflows(event: Event): Promise<number> {\n    const triggered = this.getTriggeredWorkflows(event);\n    if (triggered.length === 0) {\n      return 0;\n    }\n\n    const inFlight = new Set<Promise<void>>();\n    let failures = 0;\n\n    const schedule = (registration: EventRegisteredWorkflow): void => {\n      const task = this.executeTriggeredWorkflow(registration, event)\n        .then((result) => {\n          if (result.status === \"failed\") {\n            failures += 1;\n          }\n        })\n        .catch((error: unknown) => {\n          failures += 1;\n          const err =\n            error instanceof Error\n              ? error\n              : new RuntimeError(String(error), { cause: error });\n          void this.handleWorkflowError(err, registration, event);\n        })\n        .finally(() => {\n          inFlight.delete(task);\n        });\n      inFlight.add(task);\n    };\n\n    for (const registration of triggered) {\n      while (inFlight.size >= this.workflowConcurrency) {\n        await Promise.race(inFlight);\n      }\n      schedule(registration);\n    }\n\n    if (inFlight.size > 0) {\n      await Promise.all(inFlight);\n    }\n\n    return failures;\n  }\n\n  /**\n   * \u5358\u4E00\u306E\u30C8\u30EA\u30AC\u30FC\u6E08\u307F\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u3092\u5B9F\u884C\u3059\u308B\u3002\n   *\n   * \u30C8\u30EA\u30AC\u30FC\u306E mapInput / mapContext / mapConversationId \u3092\u4F7F\u7528\u3057\u3066\n   * \u30A4\u30D9\u30F3\u30C8\u304B\u3089\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u306E\u5165\u529B\u30FB\u30B3\u30F3\u30C6\u30AD\u30B9\u30C8\u30FB\u4F1A\u8A71ID\u3092\u30DE\u30C3\u30D4\u30F3\u30B0\u3059\u308B\u3002\n   *\n   * @param registration - \u767B\u9332\u6E08\u307F\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u60C5\u5831\n   * @param event - \u30C8\u30EA\u30AC\u30FC\u5143\u306E\u30A4\u30D9\u30F3\u30C8\n   * @returns \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u306E\u5B9F\u884C\u7D50\u679C\n   */\n  private async executeTriggeredWorkflow(\n    registration: EventRegisteredWorkflow,\n    event: Event,\n  ): Promise<WorkflowRunResult> {\n    const trigger = registration.trigger;\n    const baseOptions = registration.options ?? {};\n    const input =\n      trigger.mapInput?.(event) ?? baseOptions.input ?? event.payload;\n    const context = trigger.mapContext?.(event) ?? baseOptions.context;\n    const conversationId =\n      trigger.mapConversationId?.(event) ?? baseOptions.conversationId;\n    // DEBUG\n\n    this.metrics.workflowRuns += 1;\n\n    try {\n      const result = await this.executeWorkflow(registration, {\n        ...baseOptions,\n        input,\n        context,\n        event,\n        conversationId,\n      });\n\n      if (result.status === \"failed\") {\n        this.metrics.workflowErrors += 1;\n      }\n\n      return result;\n    } catch (error: unknown) {\n      this.metrics.workflowErrors += 1;\n      throw error;\n    }\n  }\n\n  /**\n   * 2\u3064\u306E\u4F1A\u8A71\u30E1\u30E2\u30EA\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\u3092\u30DE\u30FC\u30B8\u3059\u308B\u3002\n   *\n   * \u4E21\u65B9\u304C\u672A\u5B9A\u7FA9\u306E\u5834\u5408\u306F `undefined` \u3092\u8FD4\u3059\u3002\n   *\n   * @param base - \u30D9\u30FC\u30B9\u3068\u306A\u308B\u30E1\u30E2\u30EA\n   * @param override - \u4E0A\u66F8\u304D\u3059\u308B\u30E1\u30E2\u30EA\n   * @returns \u30DE\u30FC\u30B8\u3055\u308C\u305F\u30E1\u30E2\u30EA\u3001\u307E\u305F\u306F\u4E21\u65B9\u672A\u5B9A\u7FA9\u306E\u5834\u5408\u306F `undefined`\n   */\n  private mergeMemory(\n    base?: ConversationMemory,\n    override?: ConversationMemory,\n  ): ConversationMemory | undefined {\n    if (!base && !override) {\n      return undefined;\n    }\n    return { ...(base ?? {}), ...(override ?? {}) };\n  }\n\n  /**\n   * \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u306E\u5B9F\u884C\u8A18\u9332\u3092\u5B9F\u884C\u30B9\u30C8\u30A2\u306B\u4FDD\u5B58\u3059\u308B\u3002\n   *\n   * \u5B9F\u884C\u30B9\u30C8\u30A2\u304C\u8A2D\u5B9A\u3055\u308C\u3066\u3044\u306A\u3044\u5834\u5408\u306F\u4F55\u3082\u3057\u306A\u3044\u3002\n   * \u4FDD\u5B58\u4E2D\u306E\u30A8\u30E9\u30FC\u306F\u30A8\u30E9\u30FC\u30CF\u30F3\u30C9\u30E9\u30FC\u304C\u3042\u308C\u3070\u305D\u3061\u3089\u306B\u59D4\u8B72\u3057\u3001\u306A\u3051\u308C\u3070\u518D\u30B9\u30ED\u30FC\u3059\u308B\u3002\n   *\n   * @param result - \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u306E\u5B9F\u884C\u7D50\u679C\n   */\n  private async saveRunRecord(result: WorkflowRunResult): Promise<void> {\n    if (!this.runStore) {\n      return;\n    }\n    const record = toRunRecord(result);\n    try {\n      await this.runStore.save(record);\n    } catch (error: unknown) {\n      const err =\n        error instanceof Error\n          ? error\n          : new RuntimeError(String(error), { cause: error });\n      if (this.onRunStoreError) {\n        await this.onRunStoreError(err, record);\n        return;\n      }\n      throw err;\n    }\n  }\n\n  /**\n   * \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u3092\u5B9F\u884C\u3059\u308B\u3002\u30C1\u30E3\u30C3\u30C8\u30D5\u30ED\u30FC\u306E\u5834\u5408\u306F\u4F1A\u8A71\u30ED\u30C3\u30AF\u3068\u30E1\u30E2\u30EA\u7BA1\u7406\u3092\u884C\u3046\u3002\n   *\n   * \u901A\u5E38\u306E\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u306F\u305D\u306E\u307E\u307E\u5B9F\u884C\u3057\u3001\u30C1\u30E3\u30C3\u30C8\u30D5\u30ED\u30FC\u306E\u5834\u5408\u306F\u4F1A\u8A71ID\u306E\u691C\u8A3C\u3001\n   * \u4F1A\u8A71\u30ED\u30C3\u30AF\u306E\u53D6\u5F97\u3001\u30E1\u30E2\u30EA\u306E\u8AAD\u307F\u8FBC\u307F\u30FB\u4FDD\u5B58\u3092\u81EA\u52D5\u7684\u306B\u884C\u3046\u3002\n   *\n   * @param registration - \u767B\u9332\u6E08\u307F\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u60C5\u5831\n   * @param options - \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u5B9F\u884C\u30AA\u30D7\u30B7\u30E7\u30F3\n   * @returns \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u306E\u5B9F\u884C\u7D50\u679C\n   * @throws {InvalidArgumentError} \u30C1\u30E3\u30C3\u30C8\u30D5\u30ED\u30FC\u3067\u4F1A\u8A71ID\u304C\u672A\u6307\u5B9A\u306E\u5834\u5408\n   */\n  private async executeWorkflow(\n    registration: AnyRegisteredWorkflow,\n    options: WorkflowRunOptions<unknown, unknown>,\n  ): Promise<WorkflowRunResult> {\n    const workflow = registration.workflow;\n    if (workflow.type !== \"chatflow\") {\n      const result = await this.runner.run(workflow, options);\n      await this.saveRunRecord(result);\n      return result;\n    }\n\n    const conversationId = options.conversationId;\n    if (!conversationId || conversationId.trim().length === 0) {\n      throw new InvalidArgumentError(CHATFLOW_REQUIRES_CONVERSATION_ID);\n    }\n\n    return this.withConversationLock(conversationId, async () => {\n      const store = this.getConversationStore();\n      const storedMemory = await store.get(conversationId);\n      const memory = this.mergeMemory(storedMemory, options.memory);\n\n      const result = await this.runner.run(workflow, {\n        ...options,\n        conversationId,\n        memory,\n      });\n\n      await store.set(conversationId, result.memory ?? memory ?? {});\n      await this.saveRunRecord(result);\n      return result;\n    });\n  }\n\n  /**\n   * \u30A4\u30D9\u30F3\u30C8\u30BF\u30A4\u30D7\u306B\u4E00\u81F4\u3059\u308B\u30C8\u30EA\u30AC\u30FC\u3092\u6301\u3064\u5168\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u3092\u691C\u7D22\u3059\u308B\u3002\n   *\n   * \u5B8C\u5168\u4E00\u81F4\u3001\u30EF\u30A4\u30EB\u30C9\u30AB\u30FC\u30C9\u3001\u6B63\u898F\u8868\u73FE\u306E\u30A4\u30F3\u30C7\u30C3\u30AF\u30B9\u3092\u9806\u306B\u691C\u7D22\u3057\u3001\n   * \u3055\u3089\u306B\u30D5\u30A3\u30EB\u30BF\u30FC\u95A2\u6570\u306B\u3088\u308B\u7D5E\u308A\u8FBC\u307F\u3092\u884C\u3046\u3002\n   *\n   * @param event - \u30DE\u30C3\u30C1\u30F3\u30B0\u5BFE\u8C61\u306E\u30A4\u30D9\u30F3\u30C8\n   * @returns \u30C8\u30EA\u30AC\u30FC\u6761\u4EF6\u306B\u4E00\u81F4\u3057\u305F\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u306E\u914D\u5217\n   */\n  private getTriggeredWorkflows(event: Event): EventRegisteredWorkflow[] {\n    // DEBUG: trace event matching\n    const candidates = new Set<EventRegisteredWorkflow>();\n\n    const direct = this.eventWorkflowIndex.get(event.type);\n    if (direct) {\n      for (const registration of direct) {\n        candidates.add(registration);\n      }\n    }\n\n    for (const registration of this.wildcardEventWorkflows) {\n      candidates.add(registration);\n    }\n\n    for (const registration of this.regexEventWorkflows) {\n      if (this.matchesEventType(registration.trigger.eventType, event.type)) {\n        candidates.add(registration);\n      }\n    }\n\n    if (candidates.size === 0) {\n      return [];\n    }\n\n    const matches: EventRegisteredWorkflow[] = [];\n    for (const registration of candidates) {\n      if (registration.trigger.filter && !registration.trigger.filter(event)) {\n        continue;\n      }\n      matches.push(registration);\n    }\n\n    return matches;\n  }\n\n  /**\n   * \u30A4\u30D9\u30F3\u30C8\u30BF\u30A4\u30D7\u304C\u30C8\u30EA\u30AC\u30FC\u306E\u30DE\u30C3\u30C1\u30E3\u30FC\u306B\u4E00\u81F4\u3059\u308B\u304B\u3092\u5224\u5B9A\u3059\u308B\u3002\n   *\n   * \u6B63\u898F\u8868\u73FE\u3001\u914D\u5217\u3001\u30EF\u30A4\u30EB\u30C9\u30AB\u30FC\u30C9\uFF08\"*\"\uFF09\u3001\u6587\u5B57\u5217\u306E\u5B8C\u5168\u4E00\u81F4\u306B\u5BFE\u5FDC\u3059\u308B\u3002\n   *\n   * @param matcher - \u30C8\u30EA\u30AC\u30FC\u306E\u30A4\u30D9\u30F3\u30C8\u30BF\u30A4\u30D7\u30DE\u30C3\u30C1\u30E3\u30FC\n   * @param eventType - \u5224\u5B9A\u5BFE\u8C61\u306E\u30A4\u30D9\u30F3\u30C8\u30BF\u30A4\u30D7\n   * @returns \u4E00\u81F4\u3059\u308B\u5834\u5408\u306F `true`\n   */\n  private matchesEventType(\n    matcher: EventTrigger<Event, unknown, unknown>[\"eventType\"],\n    eventType: string,\n  ): boolean {\n    if (matcher instanceof RegExp) {\n      if (matcher.global || matcher.sticky) {\n        matcher.lastIndex = 0;\n      }\n      return matcher.test(eventType);\n    }\n\n    if (Array.isArray(matcher)) {\n      return matcher.includes(eventType);\n    }\n\n    if (matcher === \"*\") {\n      return true;\n    }\n\n    return matcher === eventType;\n  }\n\n  /**\n   * \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u3092\u30A4\u30D9\u30F3\u30C8\u30BF\u30A4\u30D7\u30A4\u30F3\u30C7\u30C3\u30AF\u30B9\u306B\u8FFD\u52A0\u3059\u308B\u3002\n   *\n   * \u30C8\u30EA\u30AC\u30FC\u306E\u30BF\u30A4\u30D7\u306B\u5FDC\u3058\u3066\u3001\u5B8C\u5168\u4E00\u81F4\u30A4\u30F3\u30C7\u30C3\u30AF\u30B9\u3001\u30EF\u30A4\u30EB\u30C9\u30AB\u30FC\u30C9\u30BB\u30C3\u30C8\u3001\n   * \u307E\u305F\u306F\u6B63\u898F\u8868\u73FE\u30BB\u30C3\u30C8\u306B\u767B\u9332\u3059\u308B\u3002\n   *\n   * @param registration - \u30A4\u30F3\u30C7\u30C3\u30AF\u30B9\u306B\u8FFD\u52A0\u3059\u308B\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u767B\u9332\u60C5\u5831\n   */\n  private indexWorkflow(registration: AnyRegisteredWorkflow): void {\n    if (!this.isEventRegistration(registration)) {\n      return;\n    }\n\n    const matcher = registration.trigger.eventType;\n\n    if (matcher instanceof RegExp) {\n      this.regexEventWorkflows.add(registration);\n      return;\n    }\n\n    if (Array.isArray(matcher)) {\n      for (const eventType of matcher) {\n        if (eventType === \"*\") {\n          this.wildcardEventWorkflows.add(registration);\n        } else {\n          this.addEventIndex(eventType, registration);\n        }\n      }\n      return;\n    }\n\n    if (matcher === \"*\") {\n      this.wildcardEventWorkflows.add(registration);\n      return;\n    }\n\n    this.addEventIndex(matcher, registration);\n  }\n\n  /**\n   * \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u3092\u30A4\u30D9\u30F3\u30C8\u30BF\u30A4\u30D7\u30A4\u30F3\u30C7\u30C3\u30AF\u30B9\u304B\u3089\u524A\u9664\u3059\u308B\u3002\n   *\n   * \u30C8\u30EA\u30AC\u30FC\u306E\u30BF\u30A4\u30D7\u306B\u5FDC\u3058\u3066\u3001\u8A72\u5F53\u3059\u308B\u30A4\u30F3\u30C7\u30C3\u30AF\u30B9\u304B\u3089\u767B\u9332\u3092\u9664\u53BB\u3059\u308B\u3002\n   *\n   * @param registration - \u30A4\u30F3\u30C7\u30C3\u30AF\u30B9\u304B\u3089\u524A\u9664\u3059\u308B\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u767B\u9332\u60C5\u5831\n   */\n  private unindexWorkflow(registration: AnyRegisteredWorkflow): void {\n    if (!this.isEventRegistration(registration)) {\n      return;\n    }\n\n    const matcher = registration.trigger.eventType;\n\n    if (matcher instanceof RegExp) {\n      this.regexEventWorkflows.delete(registration);\n      return;\n    }\n\n    if (Array.isArray(matcher)) {\n      for (const eventType of matcher) {\n        if (eventType === \"*\") {\n          this.wildcardEventWorkflows.delete(registration);\n        } else {\n          this.removeEventIndex(eventType, registration);\n        }\n      }\n      return;\n    }\n\n    if (matcher === \"*\") {\n      this.wildcardEventWorkflows.delete(registration);\n      return;\n    }\n\n    this.removeEventIndex(matcher, registration);\n  }\n\n  /**\n   * \u30A4\u30D9\u30F3\u30C8\u30BF\u30A4\u30D7\u304B\u3089\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u3078\u306E\u30DE\u30C3\u30D4\u30F3\u30B0\u3092Set\u306B\u8FFD\u52A0\u3059\u308B\u3002\n   *\n   * \u8A72\u5F53\u3059\u308B\u30A4\u30D9\u30F3\u30C8\u30BF\u30A4\u30D7\u306E\u30D0\u30B1\u30C3\u30C8\u304C\u5B58\u5728\u3057\u306A\u3044\u5834\u5408\u306F\u65B0\u898F\u4F5C\u6210\u3059\u308B\u3002\n   *\n   * @param eventType - \u30A4\u30D9\u30F3\u30C8\u30BF\u30A4\u30D7\n   * @param registration - \u8FFD\u52A0\u3059\u308B\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u767B\u9332\u60C5\u5831\n   */\n  private addEventIndex(\n    eventType: string,\n    registration: EventRegisteredWorkflow,\n  ): void {\n    const bucket = this.eventWorkflowIndex.get(eventType);\n    if (bucket) {\n      bucket.add(registration);\n      return;\n    }\n\n    this.eventWorkflowIndex.set(eventType, new Set([registration]));\n  }\n\n  /**\n   * \u30A4\u30D9\u30F3\u30C8\u30BF\u30A4\u30D7\u304B\u3089\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u3078\u306E\u30DE\u30C3\u30D4\u30F3\u30B0\u3092Set\u304B\u3089\u524A\u9664\u3059\u308B\u3002\n   *\n   * \u30D0\u30B1\u30C3\u30C8\u304C\u7A7A\u306B\u306A\u3063\u305F\u5834\u5408\u306F\u30D0\u30B1\u30C3\u30C8\u81EA\u4F53\u3082\u524A\u9664\u3059\u308B\u3002\n   *\n   * @param eventType - \u30A4\u30D9\u30F3\u30C8\u30BF\u30A4\u30D7\n   * @param registration - \u524A\u9664\u3059\u308B\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u767B\u9332\u60C5\u5831\n   */\n  private removeEventIndex(\n    eventType: string,\n    registration: EventRegisteredWorkflow,\n  ): void {\n    const bucket = this.eventWorkflowIndex.get(eventType);\n    if (!bucket) {\n      return;\n    }\n\n    bucket.delete(registration);\n    if (bucket.size === 0) {\n      this.eventWorkflowIndex.delete(eventType);\n    }\n  }\n\n  /**\n   * \u767B\u9332\u60C5\u5831\u304C\u30A4\u30D9\u30F3\u30C8\u30C8\u30EA\u30AC\u30FC\u578B\u304B\u3069\u3046\u304B\u3092\u5224\u5B9A\u3059\u308B\u578B\u30AC\u30FC\u30C9\u3002\n   *\n   * @param registration - \u5224\u5B9A\u5BFE\u8C61\u306E\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u767B\u9332\u60C5\u5831\n   * @returns \u30A4\u30D9\u30F3\u30C8\u30C8\u30EA\u30AC\u30FC\u578B\u306E\u5834\u5408\u306F `true`\n   */\n  private isEventRegistration(\n    registration: AnyRegisteredWorkflow,\n  ): registration is EventRegisteredWorkflow {\n    return registration.trigger.type === \"event\";\n  }\n\n  /**\n   * \u30C7\u30AD\u30E5\u30FC\u3055\u308C\u305F\u30E1\u30C3\u30BB\u30FC\u30B8\u304C {@link QueueMessage} \u578B\u304B\u3069\u3046\u304B\u3092\u5224\u5B9A\u3059\u308B\u578B\u30AC\u30FC\u30C9\u3002\n   *\n   * @param message - \u5224\u5B9A\u5BFE\u8C61\u306E\u30E1\u30C3\u30BB\u30FC\u30B8\n   * @returns QueueMessage\u578B\u306E\u5834\u5408\u306F `true`\n   */\n  private isQueueMessage(message: DequeuedEvent): message is QueueMessage {\n    return typeof (message as QueueMessage).event !== \"undefined\";\n  }\n\n  /**\n   * \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u30A8\u30E9\u30FC\u30CF\u30F3\u30C9\u30E9\u30FC\u3092\u547C\u3073\u51FA\u3059\u3002\u30CF\u30F3\u30C9\u30E9\u30FC\u81EA\u4F53\u306E\u30A8\u30E9\u30FC\u306F\u7121\u8996\u3059\u308B\u3002\n   *\n   * \u30A8\u30E9\u30FC\u30CF\u30F3\u30C9\u30E9\u30FC\u304C\u8A2D\u5B9A\u3055\u308C\u3066\u3044\u306A\u3044\u5834\u5408\u306F\u4F55\u3082\u3057\u306A\u3044\u3002\n   *\n   * @param error - \u767A\u751F\u3057\u305F\u30A8\u30E9\u30FC\n   * @param registration - \u30A8\u30E9\u30FC\u304C\u767A\u751F\u3057\u305F\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u306E\u767B\u9332\u60C5\u5831\n   * @param event - \u30A8\u30E9\u30FC\u306E\u30C8\u30EA\u30AC\u30FC\u3068\u306A\u3063\u305F\u30A4\u30D9\u30F3\u30C8\n   */\n  private async handleWorkflowError(\n    error: Error,\n    registration: EventRegisteredWorkflow,\n    event: Event,\n  ): Promise<void> {\n    if (!this.onWorkflowError) {\n      return;\n    }\n\n    try {\n      await this.onWorkflowError(error, {\n        workflowId: registration.workflow.id,\n        event,\n        trigger: registration.trigger,\n      });\n    } catch {\n      // Ignore errors raised by the error handler itself.\n    }\n  }\n}\n", "import {\n  type ExecFileOptions,\n  type ExecOptions,\n  exec,\n  execFile,\n} from \"node:child_process\";\nimport { promisify } from \"node:util\";\nimport { InvalidArgumentError } from \"../core/index.js\";\n\nconst DEFAULT_ENCODING: BufferEncoding = \"utf8\";\nconst SHELL_EXEC_DISABLED_MESSAGE =\n  \"Shell execution is disabled. Pass { allowShell: true } to execAsync.\";\n\nexport interface ExecResult {\n  stdout: string;\n  stderr: string;\n}\n\nexport interface ExecAsyncOptions extends ExecOptions {\n  allowShell?: boolean;\n}\n\nconst execAsyncRaw = promisify(exec);\nconst execFileAsyncRaw = promisify(execFile);\n\nconst normalizeOutput = (value: string | Buffer | undefined): string => {\n  if (typeof value === \"string\") {\n    return value;\n  }\n  if (value) {\n    return value.toString(DEFAULT_ENCODING);\n  }\n  return \"\";\n};\n\n/**\n * NOTE: Executes through a shell. Prefer execFileAsync when possible.\n * allowShell \u3092\u660E\u793A\u3057\u306A\u3044\u9650\u308A\u5B9F\u884C\u3055\u308C\u307E\u305B\u3093\u3002\n */\nexport const execAsync = async (\n  command: string,\n  options: ExecAsyncOptions = {},\n): Promise<ExecResult> => {\n  if (!options.allowShell) {\n    throw new InvalidArgumentError(SHELL_EXEC_DISABLED_MESSAGE);\n  }\n  const { allowShell: _allowShell, ...execOptions } = options;\n  const { stdout, stderr } = await execAsyncRaw(command, {\n    encoding: DEFAULT_ENCODING,\n    ...execOptions,\n  });\n  return { stdout: normalizeOutput(stdout), stderr: normalizeOutput(stderr) };\n};\n\n/**\n * \u30B7\u30A7\u30EB\u3092\u4ECB\u3055\u305A\u306B\u30D5\u30A1\u30A4\u30EB\u3092\u76F4\u63A5\u5B9F\u884C\u3059\u308B\n * @param file \u5B9F\u884C\u3059\u308B\u30D5\u30A1\u30A4\u30EB\u30D1\u30B9\n * @param args \u30B3\u30DE\u30F3\u30C9\u30E9\u30A4\u30F3\u5F15\u6570\n * @param options \u5B9F\u884C\u30AA\u30D7\u30B7\u30E7\u30F3\n * @returns \u6A19\u6E96\u51FA\u529B\u3068\u6A19\u6E96\u30A8\u30E9\u30FC\u51FA\u529B\n */\nexport const execFileAsync = async (\n  file: string,\n  args: readonly string[] = [],\n  options: ExecFileOptions = {},\n): Promise<ExecResult> => {\n  const { stdout, stderr } = await execFileAsyncRaw(file, args, {\n    encoding: DEFAULT_ENCODING,\n    ...options,\n  });\n  return { stdout: normalizeOutput(stdout), stderr: normalizeOutput(stderr) };\n};\n", "import { RuntimeError } from \"../core/index.js\";\nimport { execFileAsync } from \"./exec-async.js\";\n\nconst formatCommand = (command: string, args: readonly string[]): string =>\n  [command, ...args].join(\" \");\n\ntype ExecError = Error & { stderr?: string | Buffer; code?: number };\n\nconst isExecError = (error: unknown): error is ExecError =>\n  error instanceof Error && (\"stderr\" in error || \"code\" in error);\n\n/**\n * \u5916\u90E8\u30B3\u30DE\u30F3\u30C9\u3092\u5B9F\u884C\u3057\u3001\u6A19\u6E96\u51FA\u529B\u3092\u8FD4\u3059\n * \u30B7\u30A7\u30EB\u3092\u4ECB\u3055\u305A\u5B89\u5168\u306B\u30B3\u30DE\u30F3\u30C9\u3092\u5B9F\u884C\u3059\u308B\n * @param command \u5B9F\u884C\u3059\u308B\u30B3\u30DE\u30F3\u30C9\n * @param args \u30B3\u30DE\u30F3\u30C9\u30E9\u30A4\u30F3\u5F15\u6570\n * @returns \u6A19\u6E96\u51FA\u529B\u306E\u6587\u5B57\u5217\n * @throws {RuntimeError} \u30B3\u30DE\u30F3\u30C9\u306E\u5B9F\u884C\u306B\u5931\u6557\u3057\u305F\u5834\u5408\n */\nexport const execCommand = async (\n  command: string,\n  args: readonly string[] = [],\n): Promise<string> => {\n  const commandText = formatCommand(command, args);\n\n  try {\n    const { stdout } = await execFileAsync(command, args);\n    return stdout;\n  } catch (error: unknown) {\n    if (isExecError(error)) {\n      const stderr =\n        typeof error.stderr === \"string\"\n          ? error.stderr\n          : (error.stderr?.toString() ?? \"\");\n\n      throw new RuntimeError(\n        `Command failed: ${commandText}\\nExit code: ${error.code}\\n${stderr}`,\n      );\n    }\n\n    throw new RuntimeError(`Command failed: ${commandText}\\n${error}`);\n  }\n};\n", "import { performance } from \"node:perf_hooks\";\n\nconst DEFAULT_MEASUREMENT_TIMES = 10_000;\n\n/**\n * \u95A2\u6570\u306E\u5B9F\u884C\u6642\u9593\u3092\u8A08\u6E2C\u3059\u308B\n * @param fn \u8A08\u6E2C\u5BFE\u8C61\u306E\u95A2\u6570\n * @returns \u5B9F\u884C\u7D50\u679C\u3068\u7D4C\u904E\u6642\u9593\uFF08\u30DF\u30EA\u79D2\uFF09\n */\nexport const runPerformance = <T>(fn: () => T): { result: T; time: number } => {\n  const t0 = performance.now();\n  const result = fn();\n  const t1 = performance.now();\n  const time = t1 - t0;\n\n  return { result, time };\n};\n\n/**\n * \u95A2\u6570\u3092\u8907\u6570\u56DE\u5B9F\u884C\u3057\u3001\u5404\u56DE\u306E\u5B9F\u884C\u6642\u9593\u3092\u53CE\u96C6\u3059\u308B\n * @param fn \u8A08\u6E2C\u5BFE\u8C61\u306E\u95A2\u6570\n * @param times \u5B9F\u884C\u56DE\u6570\uFF08\u30C7\u30D5\u30A9\u30EB\u30C8: 10,000\uFF09\n * @returns \u5404\u56DE\u306E\u5B9F\u884C\u6642\u9593\uFF08\u30DF\u30EA\u79D2\uFF09\u306E\u914D\u5217\n */\nexport const measurePerformance = <T>(\n  fn: () => T,\n  times: number = DEFAULT_MEASUREMENT_TIMES,\n): { times: number[] } => {\n  const resultTimes: number[] = [];\n\n  for (let i = 0; i < times; i++) {\n    const { time } = runPerformance(fn);\n    resultTimes.push(time);\n  }\n\n  return { times: resultTimes };\n};\n", "import type { ConversationMemory } from \"./conversation-store.js\";\n\nexport interface MemoryDiff {\n  set: ConversationMemory;\n  remove: string[];\n}\n\nconst EMPTY_DIFF: MemoryDiff = { set: {}, remove: [] };\n\n/**\n * \u5DEE\u5206\u304C\u7A7A\u304B\u3069\u3046\u304B\u3092\u5224\u5B9A\u3059\u308B\n * @param diff \u30E1\u30E2\u30EA\u5DEE\u5206\n * @returns \u5909\u66F4\u304C\u306A\u3051\u308C\u3070true\n */\nexport const isEmptyDiff = (diff: MemoryDiff): boolean =>\n  Object.keys(diff.set).length === 0 && diff.remove.length === 0;\n\n/**\n * 2\u3064\u306E\u30E1\u30E2\u30EA\u72B6\u614B\u306E\u5DEE\u5206\u3092\u8A08\u7B97\u3059\u308B\n * @param previous \u5909\u66F4\u524D\u306E\u30E1\u30E2\u30EA\n * @param next \u5909\u66F4\u5F8C\u306E\u30E1\u30E2\u30EA\n * @returns \u8A2D\u5B9A\u3055\u308C\u305F\u5024\u3068\u524A\u9664\u3055\u308C\u305F\u30AD\u30FC\u306E\u5DEE\u5206\n */\nexport const diffMemory = (\n  previous: ConversationMemory,\n  next: ConversationMemory,\n): MemoryDiff => {\n  const set: ConversationMemory = {};\n  const remove: string[] = [];\n\n  const prevKeys = Object.keys(previous);\n  const nextKeys = new Set(Object.keys(next));\n\n  for (const key of prevKeys) {\n    if (!nextKeys.has(key)) {\n      remove.push(key);\n      continue;\n    }\n    const prevValue = previous[key];\n    const nextValue = next[key];\n    if (!Object.is(prevValue, nextValue)) {\n      set[key] = nextValue;\n    }\n  }\n\n  for (const key of Object.keys(next)) {\n    if (!(key in previous)) {\n      set[key] = next[key];\n    }\n  }\n\n  if (Object.keys(set).length === 0 && remove.length === 0) {\n    return EMPTY_DIFF;\n  }\n\n  return { set, remove };\n};\n\n/**\n * \u30E1\u30E2\u30EA\u5DEE\u5206\u3092\u30D9\u30FC\u30B9\u306E\u30E1\u30E2\u30EA\u306B\u9069\u7528\u3059\u308B\n * @param base \u30D9\u30FC\u30B9\u3068\u306A\u308B\u30E1\u30E2\u30EA\n * @param diff \u9069\u7528\u3059\u308B\u5DEE\u5206\n * @returns \u5DEE\u5206\u9069\u7528\u5F8C\u306E\u65B0\u3057\u3044\u30E1\u30E2\u30EA\n */\nexport const applyMemoryDiff = (\n  base: ConversationMemory,\n  diff: MemoryDiff,\n): ConversationMemory => {\n  const next: ConversationMemory = { ...base, ...diff.set };\n  for (const key of diff.remove) {\n    delete next[key];\n  }\n  return next;\n};\n", "import { TZDate } from \"@date-fns/tz\";\nimport type { FileSystem } from \"../core/file-system.js\";\nimport { FileSystem as DefaultFileSystem } from \"../core/file-system.js\";\nimport { RuntimeError } from \"../core/index.js\";\nimport {\n  applyMemoryDiff,\n  diffMemory,\n  isEmptyDiff,\n  type MemoryDiff,\n} from \"./memory-diff.js\";\n\nexport type ConversationMemory = Record<string, unknown>;\n\nexport interface ConversationStore {\n  get(conversationId: string): Promise<ConversationMemory | undefined>;\n  set(conversationId: string, memory: ConversationMemory): Promise<void>;\n  delete?(conversationId: string): Promise<void>;\n}\n\nconst cloneMemory = (memory: ConversationMemory): ConversationMemory =>\n  structuredClone(memory);\n\n/**\n * ConversationStore \u306E\u30A4\u30F3\u30E1\u30E2\u30EA\u5B9F\u88C5\u3002\n *\n * \u4F1A\u8A71\u30E1\u30E2\u30EA\u3092 Map \u306B\u4FDD\u6301\u3057\u3001\u5916\u90E8\u304B\u3089\u306E\u5909\u66F4\u3092\u9632\u3050\u305F\u3081\u306B\u30C7\u30A3\u30FC\u30D7\u30AF\u30ED\u30FC\u30F3\u3092\u7528\u3044\u3066\n * \u53D6\u5F97\u30FB\u4FDD\u5B58\u3092\u884C\u3046\u3002\u30C6\u30B9\u30C8\u3084\u77ED\u671F\u9593\u306E\u5229\u7528\u306B\u9069\u3057\u3066\u3044\u308B\u3002\n */\nexport class InMemoryConversationStore implements ConversationStore {\n  private readonly store = new Map<string, ConversationMemory>();\n\n  /**\n   * \u6307\u5B9A\u3055\u308C\u305F\u4F1A\u8A71ID\u306B\u5BFE\u5FDC\u3059\u308B\u30E1\u30E2\u30EA\u3092\u53D6\u5F97\u3059\u308B\u3002\n   *\n   * \u683C\u7D0D\u3055\u308C\u305F\u30E1\u30E2\u30EA\u306E\u30C7\u30A3\u30FC\u30D7\u30AF\u30ED\u30FC\u30F3\u3092\u8FD4\u3059\u305F\u3081\u3001\u8FD4\u5374\u5024\u3092\u5909\u66F4\u3057\u3066\u3082\n   * \u30B9\u30C8\u30A2\u5185\u90E8\u306E\u30C7\u30FC\u30BF\u306B\u306F\u5F71\u97FF\u3057\u306A\u3044\u3002\n   *\n   * @param conversationId - \u53D6\u5F97\u5BFE\u8C61\u306E\u4F1A\u8A71ID\n   * @returns \u4F1A\u8A71\u30E1\u30E2\u30EA\u306E\u30C7\u30A3\u30FC\u30D7\u30AF\u30ED\u30FC\u30F3\u3002\u5B58\u5728\u3057\u306A\u3044\u5834\u5408\u306F `undefined`\n   */\n  async get(conversationId: string): Promise<ConversationMemory | undefined> {\n    const memory = this.store.get(conversationId);\n    if (!memory) {\n      return undefined;\n    }\n    return cloneMemory(memory);\n  }\n\n  /**\n   * \u6307\u5B9A\u3055\u308C\u305F\u4F1A\u8A71ID\u306B\u5BFE\u3057\u3066\u4F1A\u8A71\u30E1\u30E2\u30EA\u3092\u4FDD\u5B58\u3059\u308B\u3002\n   *\n   * \u5F15\u6570\u306E\u30E1\u30E2\u30EA\u3092\u30C7\u30A3\u30FC\u30D7\u30AF\u30ED\u30FC\u30F3\u3057\u3066\u683C\u7D0D\u3059\u308B\u305F\u3081\u3001\u4FDD\u5B58\u5F8C\u306B\u5143\u306E\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\u3092\n   * \u5909\u66F4\u3057\u3066\u3082\u30B9\u30C8\u30A2\u5185\u90E8\u306E\u30C7\u30FC\u30BF\u306B\u306F\u5F71\u97FF\u3057\u306A\u3044\u3002\n   *\n   * @param conversationId - \u4FDD\u5B58\u5BFE\u8C61\u306E\u4F1A\u8A71ID\n   * @param memory - \u4FDD\u5B58\u3059\u308B\u4F1A\u8A71\u30E1\u30E2\u30EA\n   */\n  async set(conversationId: string, memory: ConversationMemory): Promise<void> {\n    this.store.set(conversationId, cloneMemory(memory));\n  }\n\n  /**\n   * \u6307\u5B9A\u3055\u308C\u305F\u4F1A\u8A71ID\u306B\u5BFE\u5FDC\u3059\u308B\u30E1\u30E2\u30EA\u3092\u524A\u9664\u3059\u308B\u3002\n   *\n   * @param conversationId - \u524A\u9664\u5BFE\u8C61\u306E\u4F1A\u8A71ID\n   */\n  async delete(conversationId: string): Promise<void> {\n    this.store.delete(conversationId);\n  }\n}\n\nexport interface DeltaConversationStoreOptions {\n  directory?: string;\n  fileSystem?: FileSystem;\n  compactAfterPatches?: number;\n}\n\ninterface DeltaEntry {\n  timestamp: string;\n  diff: MemoryDiff;\n}\n\nconst DEFAULT_DIRECTORY = \"conversations\";\nconst DEFAULT_COMPACT_AFTER_PATCHES = 50;\nconst MIN_COMPACT_AFTER_PATCHES = 1;\nconst BASE_FILE_NAME = \"base.json\";\nconst DELTA_FILE_NAME = \"deltas.jsonl\";\nconst LINE_ENDING = \"\\n\";\n\n/**\n * \u30D5\u30A1\u30A4\u30EB\u30D9\u30FC\u30B9\u306E ConversationStore \u5B9F\u88C5\u3002\u30D9\u30FC\u30B9\u30D5\u30A1\u30A4\u30EB\u3068\u30C7\u30EB\u30BF\u30D1\u30C3\u30C1\u3092\u7528\u3044\u3066\n * \u4F1A\u8A71\u30E1\u30E2\u30EA\u3092\u52B9\u7387\u7684\u306B\u6C38\u7D9A\u5316\u3059\u308B\u3002\n *\n * \u521D\u56DE\u4FDD\u5B58\u6642\u306B\u30D9\u30FC\u30B9\u30D5\u30A1\u30A4\u30EB (base.json) \u3092\u66F8\u304D\u51FA\u3057\u3001\u4EE5\u964D\u306E\u66F4\u65B0\u306F\u5DEE\u5206 (diff) \u3092\n * \u30C7\u30EB\u30BF\u30D5\u30A1\u30A4\u30EB (deltas.jsonl) \u3078\u8FFD\u8A18\u3059\u308B\u3002\u30C7\u30EB\u30BF\u6570\u304C\u95BE\u5024\u306B\u9054\u3059\u308B\u3068\u81EA\u52D5\u7684\u306B\n * \u30B3\u30F3\u30D1\u30AF\u30B7\u30E7\u30F3\uFF08\u30D9\u30FC\u30B9\u30D5\u30A1\u30A4\u30EB\u306E\u66F8\u304D\u76F4\u3057\u3068\u30C7\u30EB\u30BF\u30D5\u30A1\u30A4\u30EB\u306E\u30AF\u30EA\u30A2\uFF09\u3092\u884C\u3046\u3002\n */\nexport class DeltaConversationStore implements ConversationStore {\n  private readonly directory: string;\n  private readonly fs: FileSystem;\n  private readonly compactAfterPatches: number;\n\n  constructor(options: DeltaConversationStoreOptions = {}) {\n    this.directory = options.directory ?? DEFAULT_DIRECTORY;\n    this.fs = options.fileSystem ?? new DefaultFileSystem();\n    const compactAfterPatches =\n      options.compactAfterPatches ?? DEFAULT_COMPACT_AFTER_PATCHES;\n    this.compactAfterPatches = Math.max(\n      MIN_COMPACT_AFTER_PATCHES,\n      compactAfterPatches,\n    );\n  }\n\n  /**\n   * \u6307\u5B9A\u3055\u308C\u305F\u4F1A\u8A71ID\u306B\u5BFE\u5FDC\u3059\u308B\u30E1\u30E2\u30EA\u3092\u53D6\u5F97\u3059\u308B\u3002\n   *\n   * \u30D9\u30FC\u30B9\u30D5\u30A1\u30A4\u30EB\u3068\u30C7\u30EB\u30BF\u30D5\u30A1\u30A4\u30EB\u304B\u3089\u73FE\u5728\u306E\u72B6\u614B\u3092\u5FA9\u5143\u3059\u308B\u3002\n   * \u30C7\u30EB\u30BF\u6570\u304C\u30B3\u30F3\u30D1\u30AF\u30B7\u30E7\u30F3\u95BE\u5024\u4EE5\u4E0A\u306E\u5834\u5408\u3001\u81EA\u52D5\u7684\u306B\u30B3\u30F3\u30D1\u30AF\u30B7\u30E7\u30F3\u3092\u5B9F\u884C\u3057\u3066\n   * \u6B21\u56DE\u4EE5\u964D\u306E\u8AAD\u307F\u53D6\u308A\u3092\u9AD8\u901F\u5316\u3059\u308B\u3002\n   *\n   * @param conversationId - \u53D6\u5F97\u5BFE\u8C61\u306E\u4F1A\u8A71ID\n   * @returns \u5FA9\u5143\u3055\u308C\u305F\u4F1A\u8A71\u30E1\u30E2\u30EA\u3002\u5B58\u5728\u3057\u306A\u3044\u5834\u5408\u306F `undefined`\n   */\n  async get(conversationId: string): Promise<ConversationMemory | undefined> {\n    const state = await this.readState(conversationId);\n    if (!state.memory) {\n      return undefined;\n    }\n    if (state.deltaCount >= this.compactAfterPatches) {\n      await this.compact(conversationId, state.memory);\n    }\n    return state.memory;\n  }\n\n  /**\n   * \u6307\u5B9A\u3055\u308C\u305F\u4F1A\u8A71ID\u306B\u5BFE\u3057\u3066\u4F1A\u8A71\u30E1\u30E2\u30EA\u3092\u4FDD\u5B58\u3059\u308B\u3002\n   *\n   * \u65E2\u5B58\u306E\u30D9\u30FC\u30B9\u30D5\u30A1\u30A4\u30EB\u304C\u5B58\u5728\u3057\u306A\u3044\u5834\u5408\u306F\u65B0\u898F\u306B\u30D9\u30FC\u30B9\u30D5\u30A1\u30A4\u30EB\u3092\u4F5C\u6210\u3059\u308B\u3002\n   * \u65E2\u5B58\u306E\u72B6\u614B\u304C\u3042\u308B\u5834\u5408\u306F\u3001\u73FE\u5728\u306E\u72B6\u614B\u3068\u306E\u5DEE\u5206\u3092\u8A08\u7B97\u3057\u3066\u30C7\u30EB\u30BF\u30D5\u30A1\u30A4\u30EB\u306B\u8FFD\u8A18\u3059\u308B\u3002\n   * \u5DEE\u5206\u304C\u7A7A\u306E\u5834\u5408\u306F\u66F8\u304D\u8FBC\u307F\u3092\u30B9\u30AD\u30C3\u30D7\u3059\u308B\u3002\u30C7\u30EB\u30BF\u6570\u304C\u30B3\u30F3\u30D1\u30AF\u30B7\u30E7\u30F3\u95BE\u5024\u306B\u9054\u3057\u305F\n   * \u5834\u5408\u306F\u81EA\u52D5\u7684\u306B\u30B3\u30F3\u30D1\u30AF\u30B7\u30E7\u30F3\u3092\u5B9F\u884C\u3059\u308B\u3002\n   *\n   * @param conversationId - \u4FDD\u5B58\u5BFE\u8C61\u306E\u4F1A\u8A71ID\n   * @param memory - \u4FDD\u5B58\u3059\u308B\u4F1A\u8A71\u30E1\u30E2\u30EA\n   */\n  async set(conversationId: string, memory: ConversationMemory): Promise<void> {\n    const state = await this.readState(conversationId);\n    if (!state.memory) {\n      await this.writeBase(conversationId, memory);\n      await this.clearDeltas(conversationId);\n      return;\n    }\n\n    const diff = diffMemory(state.memory, memory);\n    if (isEmptyDiff(diff)) {\n      return;\n    }\n\n    await this.appendDelta(conversationId, diff);\n\n    const nextDeltaCount = state.deltaCount + 1;\n    if (nextDeltaCount >= this.compactAfterPatches) {\n      await this.compact(conversationId, memory);\n    }\n  }\n\n  /**\n   * \u6307\u5B9A\u3055\u308C\u305F\u4F1A\u8A71ID\u306B\u5BFE\u5FDC\u3059\u308B\u30D9\u30FC\u30B9\u30D5\u30A1\u30A4\u30EB\u3068\u30C7\u30EB\u30BF\u30D5\u30A1\u30A4\u30EB\u3092\u524A\u9664\u3059\u308B\u3002\n   *\n   * @param conversationId - \u524A\u9664\u5BFE\u8C61\u306E\u4F1A\u8A71ID\n   */\n  async delete(conversationId: string): Promise<void> {\n    await this.fs.remove(this.basePath(conversationId));\n    await this.fs.remove(this.deltaPath(conversationId));\n  }\n\n  /**\n   * \u6307\u5B9A\u3055\u308C\u305F\u4F1A\u8A71ID\u306B\u5BFE\u5FDC\u3059\u308B\u30D9\u30FC\u30B9\u30D5\u30A1\u30A4\u30EB\u306E\u30D1\u30B9\u3092\u8FD4\u3059\u3002\n   *\n   * @param conversationId - \u4F1A\u8A71ID\n   * @returns \u30D9\u30FC\u30B9\u30D5\u30A1\u30A4\u30EB (base.json) \u306E\u7D76\u5BFE\u30D1\u30B9\n   */\n  private basePath(conversationId: string): string {\n    return `${this.directory}/${conversationId}/${BASE_FILE_NAME}`;\n  }\n\n  /**\n   * \u6307\u5B9A\u3055\u308C\u305F\u4F1A\u8A71ID\u306B\u5BFE\u5FDC\u3059\u308B\u30C7\u30EB\u30BF\u30D5\u30A1\u30A4\u30EB\u306E\u30D1\u30B9\u3092\u8FD4\u3059\u3002\n   *\n   * @param conversationId - \u4F1A\u8A71ID\n   * @returns \u30C7\u30EB\u30BF\u30D5\u30A1\u30A4\u30EB (deltas.jsonl) \u306E\u7D76\u5BFE\u30D1\u30B9\n   */\n  private deltaPath(conversationId: string): string {\n    return `${this.directory}/${conversationId}/${DELTA_FILE_NAME}`;\n  }\n\n  /**\n   * \u30D9\u30FC\u30B9\u30D5\u30A1\u30A4\u30EB\u306B\u4F1A\u8A71\u30E1\u30E2\u30EA\u3092JSON\u5F62\u5F0F\u3067\u66F8\u304D\u8FBC\u3080\u3002\n   *\n   * @param conversationId - \u4F1A\u8A71ID\n   * @param memory - \u66F8\u304D\u8FBC\u3080\u4F1A\u8A71\u30E1\u30E2\u30EA\n   */\n  private async writeBase(\n    conversationId: string,\n    memory: ConversationMemory,\n  ): Promise<void> {\n    await this.fs.writeJson(this.basePath(conversationId), memory);\n  }\n\n  /**\n   * \u30C7\u30EB\u30BF\u30D5\u30A1\u30A4\u30EB\u306B\u5DEE\u5206\u30A8\u30F3\u30C8\u30EA\u30921\u884C\u8FFD\u8A18\u3059\u308B\u3002\n   *\n   * \u30BF\u30A4\u30E0\u30B9\u30BF\u30F3\u30D7\u3068\u3068\u3082\u306B\u5DEE\u5206\u60C5\u5831\u3092JSONL\u5F62\u5F0F\u3067\u8FFD\u8A18\u3059\u308B\u3002\n   *\n   * @param conversationId - \u4F1A\u8A71ID\n   * @param diff - \u8FFD\u8A18\u3059\u308B\u30E1\u30E2\u30EA\u5DEE\u5206\n   */\n  private async appendDelta(\n    conversationId: string,\n    diff: MemoryDiff,\n  ): Promise<void> {\n    const entry: DeltaEntry = {\n      timestamp: new TZDate().toISOString(),\n      diff,\n    };\n    const line = `${JSON.stringify(entry)}${LINE_ENDING}`;\n    await this.fs.appendText(this.deltaPath(conversationId), line);\n  }\n\n  /**\n   * \u30C7\u30EB\u30BF\u30D5\u30A1\u30A4\u30EB\u306E\u5185\u5BB9\u3092\u30AF\u30EA\u30A2\uFF08\u7A7A\u6587\u5B57\u3067\u4E0A\u66F8\u304D\uFF09\u3059\u308B\u3002\n   *\n   * @param conversationId - \u4F1A\u8A71ID\n   */\n  private async clearDeltas(conversationId: string): Promise<void> {\n    await this.fs.writeText(this.deltaPath(conversationId), \"\");\n  }\n\n  /**\n   * \u30B3\u30F3\u30D1\u30AF\u30B7\u30E7\u30F3\u3092\u5B9F\u884C\u3059\u308B\u3002\n   *\n   * \u73FE\u5728\u306E\u30E1\u30E2\u30EA\u72B6\u614B\u3092\u30D9\u30FC\u30B9\u30D5\u30A1\u30A4\u30EB\u306B\u66F8\u304D\u51FA\u3057\u3001\u30C7\u30EB\u30BF\u30D5\u30A1\u30A4\u30EB\u3092\u30AF\u30EA\u30A2\u3059\u308B\u3053\u3068\u3067\n   * \u84C4\u7A4D\u3055\u308C\u305F\u30C7\u30EB\u30BF\u30D1\u30C3\u30C1\u3092\u7D71\u5408\u3057\u3001\u6B21\u56DE\u4EE5\u964D\u306E\u8AAD\u307F\u53D6\u308A\u30D1\u30D5\u30A9\u30FC\u30DE\u30F3\u30B9\u3092\u6539\u5584\u3059\u308B\u3002\n   *\n   * @param conversationId - \u4F1A\u8A71ID\n   * @param memory - \u30B3\u30F3\u30D1\u30AF\u30B7\u30E7\u30F3\u6642\u70B9\u306E\u6700\u65B0\u30E1\u30E2\u30EA\u72B6\u614B\n   */\n  private async compact(\n    conversationId: string,\n    memory: ConversationMemory,\n  ): Promise<void> {\n    await this.writeBase(conversationId, memory);\n    await this.clearDeltas(conversationId);\n  }\n\n  /**\n   * \u30D9\u30FC\u30B9\u30D5\u30A1\u30A4\u30EB\u3068\u30C7\u30EB\u30BF\u30D5\u30A1\u30A4\u30EB\u304B\u3089\u73FE\u5728\u306E\u4F1A\u8A71\u30E1\u30E2\u30EA\u72B6\u614B\u3092\u8AAD\u307F\u53D6\u308B\u3002\n   *\n   * \u30D9\u30FC\u30B9\u30D5\u30A1\u30A4\u30EB\u304C\u5B58\u5728\u3057\u306A\u3044\u5834\u5408\u306F\u672A\u521D\u671F\u5316\u3068\u3057\u3066\u6271\u3046\u3002\u30D9\u30FC\u30B9\u30D5\u30A1\u30A4\u30EB\u306A\u3057\u3067\n   * \u30C7\u30EB\u30BF\u30D5\u30A1\u30A4\u30EB\u306E\u307F\u5B58\u5728\u3059\u308B\u5834\u5408\u306F\u4E0D\u6574\u5408\u3068\u3057\u3066\u30A8\u30E9\u30FC\u3092\u30B9\u30ED\u30FC\u3059\u308B\u3002\n   * \u30D9\u30FC\u30B9\u30D5\u30A1\u30A4\u30EB\u304C\u5B58\u5728\u3059\u308B\u5834\u5408\u3001\u30C7\u30EB\u30BF\u30D5\u30A1\u30A4\u30EB\u306E\u5404\u884C\u3092\u9806\u306B\u9069\u7528\u3057\u3066\n   * \u6700\u65B0\u306E\u30E1\u30E2\u30EA\u72B6\u614B\u3092\u5FA9\u5143\u3059\u308B\u3002\n   *\n   * @param conversationId - \u4F1A\u8A71ID\n   * @returns \u5FA9\u5143\u3055\u308C\u305F\u30E1\u30E2\u30EA\u72B6\u614B\u3068\u9069\u7528\u3055\u308C\u305F\u30C7\u30EB\u30BF\u6570\n   */\n  private async readState(conversationId: string): Promise<{\n    memory?: ConversationMemory;\n    deltaCount: number;\n  }> {\n    const basePath = this.basePath(conversationId);\n    const deltaPath = this.deltaPath(conversationId);\n\n    if (!(await this.fs.exists(basePath))) {\n      if (await this.fs.exists(deltaPath)) {\n        throw new RuntimeError(\n          `Delta file exists without base: ${conversationId}`,\n        );\n      }\n      return { memory: undefined, deltaCount: 0 };\n    }\n\n    let memory = await this.fs.readJson<ConversationMemory>(basePath);\n    if (!(await this.fs.exists(deltaPath))) {\n      return { memory, deltaCount: 0 };\n    }\n\n    const text = await this.fs.readText(deltaPath);\n    const lines = text.split(LINE_ENDING).filter((line) => line.length > 0);\n    for (const line of lines) {\n      const entry = JSON.parse(line) as DeltaEntry;\n      memory = applyMemoryDiff(memory, entry.diff);\n    }\n\n    return { memory, deltaCount: lines.length };\n  }\n}\n", "import { generateId, InvalidArgumentError } from \"../core/index.js\";\nimport type { ConversationMemory } from \"./conversation-store.js\";\n\nexport interface NodeExecutionContext<Context = unknown, Input = unknown> {\n  workflowId: string;\n  nodeId: string;\n  runId: string;\n  conversationId?: string;\n  context?: Context;\n  input?: Input;\n  event?: unknown;\n  signal?: AbortSignal;\n  results: Record<string, unknown>;\n  getResult<T = unknown>(nodeId: string): T | undefined;\n  memory?: ConversationMemory;\n  getMemory?: () => ConversationMemory | undefined;\n  setMemory?: (next: ConversationMemory) => void | Promise<void>;\n  updateMemory?: (patch: Partial<ConversationMemory>) => void | Promise<void>;\n}\n\nexport type NodeHandler<\n  Context = unknown,\n  Input = unknown,\n  Output = unknown,\n> = (context: NodeExecutionContext<Context, Input>) => Output | Promise<Output>;\n\nexport interface RetryPolicy {\n  maxAttempts?: number;\n  initialDelayMs?: number;\n  backoffMultiplier?: number;\n  maxDelayMs?: number;\n  jitterMs?: number;\n}\n\nexport interface NodeDefinition<\n  Context = unknown,\n  Input = unknown,\n  Output = unknown,\n> {\n  name?: string;\n  dependsOn?: string[];\n  handler: NodeHandler<Context, Input, Output>;\n  retry?: RetryPolicy;\n}\n\nconst MIN_RETRY_ATTEMPTS = 1;\nconst MIN_BACKOFF_MULTIPLIER = 1;\nconst MIN_DELAY_MS = 0;\n\nconst validateInteger = (value: number, name: string, min: number): number => {\n  if (!Number.isInteger(value) || value < min) {\n    throw new InvalidArgumentError(\n      `Node retry ${name} must be an integer >= ${min}`,\n    );\n  }\n  return value;\n};\n\nconst validateNumber = (value: number, name: string, min: number): number => {\n  if (!Number.isFinite(value) || value < min) {\n    throw new InvalidArgumentError(\n      `Node retry ${name} must be a number >= ${min}`,\n    );\n  }\n  return value;\n};\n\n/**\n * \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u5185\u306E\u5358\u4E00\u30CE\u30FC\u30C9\u3092\u8868\u3059\u30AF\u30E9\u30B9\u3002\n * \u5404\u30CE\u30FC\u30C9\u306F\u30CF\u30F3\u30C9\u30E9\u95A2\u6570\u3001\u4F9D\u5B58\u95A2\u4FC2\u30EA\u30B9\u30C8\u3001\u304A\u3088\u3073\u30EA\u30C8\u30E9\u30A4\u30DD\u30EA\u30B7\u30FC\u3092\u6301\u3061\u3001\n * \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u306E\u5B9F\u884C\u5358\u4F4D\u3068\u3057\u3066\u52D5\u4F5C\u3059\u308B\u3002\n *\n * @typeParam Context - \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u5168\u4F53\u3067\u5171\u6709\u3055\u308C\u308B\u30B3\u30F3\u30C6\u30AD\u30B9\u30C8\u306E\u578B\n * @typeParam Input - \u30CE\u30FC\u30C9\u306B\u6E21\u3055\u308C\u308B\u5165\u529B\u30C7\u30FC\u30BF\u306E\u578B\n * @typeParam Output - \u30CE\u30FC\u30C9\u306E\u30CF\u30F3\u30C9\u30E9\u304C\u8FD4\u3059\u51FA\u529B\u30C7\u30FC\u30BF\u306E\u578B\n */\nexport class Node<Context = unknown, Input = unknown, Output = unknown> {\n  readonly id: string;\n  readonly name?: string;\n  readonly handler: NodeHandler<Context, Input, Output>;\n  readonly retry?: RetryPolicy;\n  private readonly dependencies = new Set<string>();\n\n  /**\n   * NodeDefinition \u304B\u3089\u30CE\u30FC\u30C9\u3092\u751F\u6210\u3059\u308B\u3002\n   * \u30EA\u30C8\u30E9\u30A4\u30DD\u30EA\u30B7\u30FC\u304C\u6307\u5B9A\u3055\u308C\u3066\u3044\u308B\u5834\u5408\u3001\u5404\u30D1\u30E9\u30E1\u30FC\u30BF\uFF08maxAttempts, initialDelayMs,\n   * backoffMultiplier, maxDelayMs, jitterMs\uFF09\u306E\u30D0\u30EA\u30C7\u30FC\u30B7\u30E7\u30F3\u3092\u884C\u3044\u3001\n   * \u4E0D\u6B63\u306A\u5024\u304C\u542B\u307E\u308C\u3066\u3044\u308B\u5834\u5408\u306F {@link InvalidArgumentError} \u3092\u30B9\u30ED\u30FC\u3059\u308B\u3002\n   * \u307E\u305F\u3001dependsOn \u3067\u6307\u5B9A\u3055\u308C\u305F\u4F9D\u5B58\u30CE\u30FC\u30C9 ID \u3092\u5185\u90E8\u306E\u4F9D\u5B58\u95A2\u4FC2\u30BB\u30C3\u30C8\u306B\u767B\u9332\u3059\u308B\u3002\n   *\n   * @param definition - \u30CE\u30FC\u30C9\u306E\u5B9A\u7FA9\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\uFF08\u540D\u524D\u3001\u30CF\u30F3\u30C9\u30E9\u3001\u4F9D\u5B58\u95A2\u4FC2\u3001\u30EA\u30C8\u30E9\u30A4\u30DD\u30EA\u30B7\u30FC\u3092\u542B\u3080\uFF09\n   * @throws {InvalidArgumentError} \u30EA\u30C8\u30E9\u30A4\u30DD\u30EA\u30B7\u30FC\u306E\u30D1\u30E9\u30E1\u30FC\u30BF\u304C\u4E0D\u6B63\u306A\u5834\u5408\n   */\n  constructor(definition: NodeDefinition<Context, Input, Output>) {\n    this.id = generateId();\n    this.name = definition.name;\n    this.handler = definition.handler;\n    this.retry = definition.retry\n      ? {\n          maxAttempts:\n            definition.retry.maxAttempts === undefined\n              ? undefined\n              : validateInteger(\n                  definition.retry.maxAttempts,\n                  \"maxAttempts\",\n                  MIN_RETRY_ATTEMPTS,\n                ),\n          initialDelayMs:\n            definition.retry.initialDelayMs === undefined\n              ? undefined\n              : validateNumber(\n                  definition.retry.initialDelayMs,\n                  \"initialDelayMs\",\n                  MIN_DELAY_MS,\n                ),\n          backoffMultiplier:\n            definition.retry.backoffMultiplier === undefined\n              ? undefined\n              : validateNumber(\n                  definition.retry.backoffMultiplier,\n                  \"backoffMultiplier\",\n                  MIN_BACKOFF_MULTIPLIER,\n                ),\n          maxDelayMs:\n            definition.retry.maxDelayMs === undefined\n              ? undefined\n              : validateNumber(\n                  definition.retry.maxDelayMs,\n                  \"maxDelayMs\",\n                  MIN_DELAY_MS,\n                ),\n          jitterMs:\n            definition.retry.jitterMs === undefined\n              ? undefined\n              : validateNumber(\n                  definition.retry.jitterMs,\n                  \"jitterMs\",\n                  MIN_DELAY_MS,\n                ),\n        }\n      : undefined;\n\n    if (definition.dependsOn) {\n      for (const dep of definition.dependsOn) {\n        this.dependencies.add(dep);\n      }\n    }\n  }\n\n  /**\n   * \u6307\u5B9A\u3055\u308C\u305F\u30CE\u30FC\u30C9 ID \u3092\u4F9D\u5B58\u95A2\u4FC2\u3068\u3057\u3066\u8FFD\u52A0\u3059\u308B\u3002\n   * \u3053\u306E\u30CE\u30FC\u30C9\u306F\u3001\u8FFD\u52A0\u3055\u308C\u305F\u4F9D\u5B58\u30CE\u30FC\u30C9\u306E\u5B9F\u884C\u304C\u5B8C\u4E86\u3059\u308B\u307E\u3067\u5B9F\u884C\u3055\u308C\u306A\u3044\u3002\n   *\n   * @param nodeId - \u4F9D\u5B58\u5148\u30CE\u30FC\u30C9\u306E ID\n   */\n  addDependency(nodeId: string): void {\n    this.dependencies.add(nodeId);\n  }\n\n  /**\n   * \u3053\u306E\u30CE\u30FC\u30C9\u304C\u4F9D\u5B58\u3057\u3066\u3044\u308B\u30CE\u30FC\u30C9 ID \u306E\u4E00\u89A7\u3092\u8FD4\u3059\u3002\n   * \u8FD4\u3055\u308C\u308B\u914D\u5217\u306F\u5185\u90E8\u306E\u4F9D\u5B58\u95A2\u4FC2\u30BB\u30C3\u30C8\u306E\u30B9\u30CA\u30C3\u30D7\u30B7\u30E7\u30C3\u30C8\u3067\u3042\u308A\u3001\n   * \u5909\u66F4\u3057\u3066\u3082\u5143\u306E\u30C7\u30FC\u30BF\u306B\u306F\u5F71\u97FF\u3057\u306A\u3044\u3002\n   *\n   * @returns \u4F9D\u5B58\u5148\u30CE\u30FC\u30C9 ID \u306E\u914D\u5217\n   */\n  get dependsOn(): string[] {\n    return Array.from(this.dependencies);\n  }\n}\n", "import {\n  ConflictError,\n  CyclicDependencyError,\n  DependencyError,\n  generateId,\n  InvalidArgumentError,\n  NotFoundError,\n} from \"../core/index.js\";\nimport { Node, type NodeDefinition } from \"./node.js\";\n\nexport type WorkflowType = \"workflow\" | \"chatflow\";\n\nexport interface WorkflowDefinition<Context = unknown, Input = unknown> {\n  name?: string;\n  description?: string;\n  type?: WorkflowType;\n  nodes?: Array<Node<Context, Input> | NodeDefinition<Context, Input>>;\n}\n\nconst DEFAULT_WORKFLOW_TYPE: WorkflowType = \"workflow\";\nconst VALID_WORKFLOW_TYPES: readonly WorkflowType[] = [\"workflow\", \"chatflow\"];\n\n/**\n * \u30CE\u30FC\u30C9\u3068\u4F9D\u5B58\u95A2\u4FC2\u3067\u69CB\u6210\u3055\u308C\u308B\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u3092\u8868\u3059\u30AF\u30E9\u30B9\u3002\n *\n * \u30CE\u30FC\u30C9\u306E\u8FFD\u52A0\u30FB\u63A5\u7D9A\u30FB\u30C8\u30DD\u30ED\u30B8\u30AB\u30EB\u30BD\u30FC\u30C8\u306B\u3088\u308B\u5B9F\u884C\u8A08\u753B\u306E\u751F\u6210\u3092\u63D0\u4F9B\u3059\u308B\u3002\n *\n * @typeParam Context - \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u5B9F\u884C\u6642\u306B\u5171\u6709\u3055\u308C\u308B\u30B3\u30F3\u30C6\u30AD\u30B9\u30C8\u306E\u578B\n * @typeParam Input - \u5404\u30CE\u30FC\u30C9\u306B\u6E21\u3055\u308C\u308B\u5165\u529B\u306E\u578B\n */\nexport class Workflow<Context = unknown, Input = unknown> {\n  readonly id: string;\n  readonly name?: string;\n  readonly description?: string;\n  readonly type: WorkflowType;\n  private readonly nodes = new Map<string, Node<Context, Input>>();\n\n  /**\n   * \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u5B9A\u7FA9\u304B\u3089\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u30A4\u30F3\u30B9\u30BF\u30F3\u30B9\u3092\u751F\u6210\u3059\u308B\u3002\n   *\n   * \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u306E\u30BF\u30A4\u30D7\u306F\u300Cworkflow\u300D\u307E\u305F\u306F\u300Cchatflow\u300D\u3092\u6307\u5B9A\u53EF\u80FD\u3002\n   * \u5B9A\u7FA9\u306B\u30CE\u30FC\u30C9\u304C\u542B\u307E\u308C\u3066\u3044\u308B\u5834\u5408\u3001\u305D\u308C\u3089\u3092\u81EA\u52D5\u7684\u306B\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u306B\u8FFD\u52A0\u3059\u308B\u3002\n   *\n   * @param definition - \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u306E\u5B9A\u7FA9\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\n   * @throws {InvalidArgumentError} \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u30BF\u30A4\u30D7\u304C\u4E0D\u6B63\u306A\u5834\u5408\n   */\n  constructor(definition: WorkflowDefinition<Context, Input>) {\n    this.id = generateId();\n    this.name = definition.name;\n    this.description = definition.description;\n    if (definition.type && !VALID_WORKFLOW_TYPES.includes(definition.type)) {\n      throw new InvalidArgumentError(\n        `Workflow type must be one of: ${VALID_WORKFLOW_TYPES.join(\", \")}`,\n      );\n    }\n    this.type = definition.type ?? DEFAULT_WORKFLOW_TYPE;\n\n    if (definition.nodes) {\n      for (const node of definition.nodes) {\n        this.addNode(node instanceof Node ? node : new Node(node));\n      }\n    }\n  }\n\n  /**\n   * \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u306B\u30CE\u30FC\u30C9\u3092\u8FFD\u52A0\u3059\u308B\u3002\n   *\n   * \u540C\u4E00ID\u306E\u30CE\u30FC\u30C9\u304C\u65E2\u306B\u5B58\u5728\u3059\u308B\u5834\u5408\u306F\u30A8\u30E9\u30FC\u3092\u30B9\u30ED\u30FC\u3059\u308B\u3002\n   *\n   * @param node - \u8FFD\u52A0\u3059\u308B\u30CE\u30FC\u30C9\n   * @throws {ConflictError} \u540C\u4E00ID\u306E\u30CE\u30FC\u30C9\u304C\u65E2\u306B\u5B58\u5728\u3059\u308B\u5834\u5408\n   */\n  addNode(node: Node<Context, Input>): void {\n    if (this.nodes.has(node.id)) {\n      throw new ConflictError(`Node already exists: ${node.id}`);\n    }\n\n    this.nodes.set(node.id, node);\n  }\n\n  /**\n   * 2\u3064\u306E\u30CE\u30FC\u30C9\u9593\u306B\u4F9D\u5B58\u95A2\u4FC2\u3092\u4F5C\u6210\u3057\u63A5\u7D9A\u3059\u308B\u3002\n   *\n   * fromNodeId \u304B\u3089 toNodeId \u3078\u306E\u4F9D\u5B58\u95A2\u4FC2\u3092\u8A2D\u5B9A\u3059\u308B\u3002\n   * \u3064\u307E\u308A\u3001toNodeId \u306E\u30CE\u30FC\u30C9\u306F fromNodeId \u306E\u30CE\u30FC\u30C9\u304C\u5B8C\u4E86\u3059\u308B\u307E\u3067\u5B9F\u884C\u3055\u308C\u306A\u3044\u3002\n   *\n   * @param fromNodeId - \u4F9D\u5B58\u5143\u306E\u30CE\u30FC\u30C9ID\uFF08\u5148\u306B\u5B9F\u884C\u3055\u308C\u308B\u30CE\u30FC\u30C9\uFF09\n   * @param toNodeId - \u4F9D\u5B58\u5148\u306E\u30CE\u30FC\u30C9ID\uFF08\u5F8C\u306B\u5B9F\u884C\u3055\u308C\u308B\u30CE\u30FC\u30C9\uFF09\n   * @throws {NotFoundError} \u6307\u5B9A\u3055\u308C\u305F\u30CE\u30FC\u30C9ID\u304C\u5B58\u5728\u3057\u306A\u3044\u5834\u5408\n   */\n  connect(fromNodeId: string, toNodeId: string): void {\n    const toNode = this.nodes.get(toNodeId);\n    if (!toNode) {\n      throw new NotFoundError(`Unknown node: ${toNodeId}`);\n    }\n\n    if (!this.nodes.has(fromNodeId)) {\n      throw new NotFoundError(`Unknown node: ${fromNodeId}`);\n    }\n\n    toNode.addDependency(fromNodeId);\n  }\n\n  /**\n   * \u6307\u5B9A\u3055\u308C\u305FID\u306E\u30CE\u30FC\u30C9\u3092\u53D6\u5F97\u3059\u308B\u3002\n   *\n   * @param nodeId - \u53D6\u5F97\u3059\u308B\u30CE\u30FC\u30C9\u306EID\n   * @returns \u8A72\u5F53\u3059\u308B\u30CE\u30FC\u30C9\u3002\u5B58\u5728\u3057\u306A\u3044\u5834\u5408\u306F `undefined`\n   */\n  getNode(nodeId: string): Node<Context, Input> | undefined {\n    return this.nodes.get(nodeId);\n  }\n\n  /**\n   * \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u306B\u767B\u9332\u3055\u308C\u3066\u3044\u308B\u5168\u30CE\u30FC\u30C9\u3092\u914D\u5217\u3068\u3057\u3066\u53D6\u5F97\u3059\u308B\u3002\n   *\n   * @returns \u5168\u30CE\u30FC\u30C9\u306E\u914D\u5217\n   */\n  getNodes(): Node<Context, Input>[] {\n    return Array.from(this.nodes.values());\n  }\n\n  /**\n   * \u30CE\u30FC\u30C9\u306E\u4F9D\u5B58\u95A2\u4FC2\u306B\u57FA\u3065\u3044\u3066\u30C8\u30DD\u30ED\u30B8\u30AB\u30EB\u30BD\u30FC\u30C8\u3092\u884C\u3044\u3001\u5B9F\u884C\u8A08\u753B\u3092\u751F\u6210\u3059\u308B\u3002\n   *\n   * \u4F9D\u5B58\u95A2\u4FC2\u306E\u306A\u3044\u30CE\u30FC\u30C9\u304B\u3089\u9806\u306B\u4E26\u3079\u3001\u5168\u30CE\u30FC\u30C9\u304C\u6B63\u3057\u3044\u5B9F\u884C\u9806\u5E8F\u3067\u8FD4\u3055\u308C\u308B\u3002\n   * \u5FAA\u74B0\u4F9D\u5B58\u304C\u691C\u51FA\u3055\u308C\u305F\u5834\u5408\u306F\u30A8\u30E9\u30FC\u3092\u30B9\u30ED\u30FC\u3059\u308B\u3002\n   *\n   * @returns \u30C8\u30DD\u30ED\u30B8\u30AB\u30EB\u30BD\u30FC\u30C8\u6E08\u307F\u306E\u30CE\u30FC\u30C9\u914D\u5217\uFF08\u5B9F\u884C\u9806\uFF09\n   * @throws {DependencyError} \u30CE\u30FC\u30C9\u304C\u5B58\u5728\u3057\u306A\u3044\u4F9D\u5B58\u5148\u3092\u53C2\u7167\u3057\u3066\u3044\u308B\u5834\u5408\n   * @throws {CyclicDependencyError} \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u306B\u5FAA\u74B0\u4F9D\u5B58\u304C\u542B\u307E\u308C\u3066\u3044\u308B\u5834\u5408\n   */\n  getExecutionPlan(): Node<Context, Input>[] {\n    const nodes = this.getNodes();\n    const dependencies = new Map<string, Set<string>>();\n    const dependents = new Map<string, Set<string>>();\n\n    for (const node of nodes) {\n      dependencies.set(node.id, new Set(node.dependsOn));\n      if (!dependents.has(node.id)) {\n        dependents.set(node.id, new Set());\n      }\n    }\n\n    for (const node of nodes) {\n      for (const dep of node.dependsOn) {\n        if (!dependencies.has(dep)) {\n          throw new DependencyError(\n            `Node ${node.id} depends on missing node: ${dep}`,\n          );\n        }\n\n        const bucket = dependents.get(dep);\n        if (bucket) {\n          bucket.add(node.id);\n        }\n      }\n    }\n\n    const ready: Node<Context, Input>[] = nodes.filter(\n      (node) => (dependencies.get(node.id)?.size ?? 0) === 0,\n    );\n    const executionPlan: Node<Context, Input>[] = [];\n\n    while (ready.length > 0) {\n      const node = ready.shift();\n      if (!node) {\n        continue;\n      }\n\n      executionPlan.push(node);\n      const downstream = dependents.get(node.id);\n      if (!downstream) {\n        continue;\n      }\n\n      for (const dependentId of downstream) {\n        const deps = dependencies.get(dependentId);\n        if (!deps) {\n          continue;\n        }\n\n        deps.delete(node.id);\n        if (deps.size === 0) {\n          const dependentNode = this.nodes.get(dependentId);\n          if (dependentNode) {\n            ready.push(dependentNode);\n          }\n        }\n      }\n    }\n\n    if (executionPlan.length !== nodes.length) {\n      throw new CyclicDependencyError(\"Workflow contains a cyclic dependency\");\n    }\n\n    return executionPlan;\n  }\n}\n"],
  "mappings": "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",
  "names": ["RESET_SECONDS", "RESET_MILLISECONDS", "NEXT_MINUTE_INCREMENT", "resolve", "MIN_CONCURRENCY", "CHATFLOW_REQUIRES_CONVERSATION_ID", "resolve", "DEFAULT_ENCODING", "cloneMemory", "MIN_RETRY_ATTEMPTS", "MIN_BACKOFF_MULTIPLIER", "MIN_DELAY_MS"]
}
