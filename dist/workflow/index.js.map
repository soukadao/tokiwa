{
  "version": 3,
  "sources": ["../../node_modules/.pnpm/@date-fns+tz@1.4.1/node_modules/@date-fns/tz/tzName/index.js", "../../node_modules/.pnpm/@date-fns+tz@1.4.1/node_modules/@date-fns/tz/tzOffset/index.js", "../../node_modules/.pnpm/@date-fns+tz@1.4.1/node_modules/@date-fns/tz/date/mini.js", "../../node_modules/.pnpm/@date-fns+tz@1.4.1/node_modules/@date-fns/tz/date/index.js", "../../src/core/file-system.ts", "../../src/core/errors.ts", "../../src/core/generate-id.ts", "../../src/workflow/memory-diff.ts", "../../src/workflow/conversation-store.ts", "../../src/workflow/node.ts", "../../src/workflow/run-store.ts", "../../src/workflow/runner.ts", "../../src/workflow/workflow.ts"],
  "sourcesContent": ["/**\n * Time zone name format.\n */\n\n/**\n * The function returns the time zone name for the given date in the specified\n * time zone.\n *\n * It uses the `Intl.DateTimeFormat` API and by default outputs the time zone\n * name in a long format, e.g. \"Pacific Standard Time\" or\n * \"Singapore Standard Time\".\n *\n * It is possible to specify the format as the third argument using one of the following options\n *\n * - \"short\": e.g. \"EDT\" or \"GMT+8\".\n * - \"long\": e.g. \"Eastern Daylight Time\".\n * - \"shortGeneric\": e.g. \"ET\" or \"Singapore Time\".\n * - \"longGeneric\": e.g. \"Eastern Time\" or \"Singapore Standard Time\".\n *\n * These options correspond to TR35 tokens `z..zzz`, `zzzz`, `v`, and `vvvv` respectively: https://www.unicode.org/reports/tr35/tr35-dates.html#dfst-zone\n *\n * @param timeZone - Time zone name (IANA or UTC offset)\n * @param date - Date object to get the time zone name for\n * @param format - Optional format of the time zone name. Defaults to \"long\". Can be \"short\", \"long\", \"shortGeneric\", or \"longGeneric\".\n *\n * @returns Time zone name (e.g. \"Singapore Standard Time\")\n */\nexport function tzName(timeZone, date, format = \"long\") {\n  return new Intl.DateTimeFormat(\"en-US\", {\n    // Enforces engine to render the time. Without the option JavaScriptCore omits it.\n    hour: \"numeric\",\n    timeZone: timeZone,\n    timeZoneName: format\n  }).format(date).split(/\\s/g) // Format.JS uses non-breaking spaces\n  .slice(2) // Skip the hour and AM/PM parts\n  .join(\" \");\n}", "const offsetFormatCache = {};\nconst offsetCache = {};\n\n/**\n * The function extracts UTC offset in minutes from the given date in specified\n * time zone.\n *\n * Unlike `Date.prototype.getTimezoneOffset`, this function returns the value\n * mirrored to the sign of the offset in the time zone. For Asia/Singapore\n * (UTC+8), `tzOffset` returns 480, while `getTimezoneOffset` returns -480.\n *\n * @param timeZone - Time zone name (IANA or UTC offset)\n * @param date - Date to check the offset for\n *\n * @returns UTC offset in minutes\n */\nexport function tzOffset(timeZone, date) {\n  try {\n    const format = offsetFormatCache[timeZone] ||= new Intl.DateTimeFormat(\"en-US\", {\n      timeZone,\n      timeZoneName: \"longOffset\"\n    }).format;\n    const offsetStr = format(date).split(\"GMT\")[1];\n    if (offsetStr in offsetCache) return offsetCache[offsetStr];\n    return calcOffset(offsetStr, offsetStr.split(\":\"));\n  } catch {\n    // Fallback to manual parsing if the runtime doesn't support \u00B1HH:MM/\u00B1HHMM/\u00B1HH\n    // See: https://github.com/nodejs/node/issues/53419\n    if (timeZone in offsetCache) return offsetCache[timeZone];\n    const captures = timeZone?.match(offsetRe);\n    if (captures) return calcOffset(timeZone, captures.slice(1));\n    return NaN;\n  }\n}\nconst offsetRe = /([+-]\\d\\d):?(\\d\\d)?/;\nfunction calcOffset(cacheStr, values) {\n  const hours = +(values[0] || 0);\n  const minutes = +(values[1] || 0);\n  // Convert seconds to minutes by dividing by 60 to keep the function return in minutes.\n  const seconds = +(values[2] || 0) / 60;\n  return offsetCache[cacheStr] = hours * 60 + minutes > 0 ? hours * 60 + minutes + seconds : hours * 60 - minutes - seconds;\n}", "import { tzOffset } from \"../tzOffset/index.js\";\nexport class TZDateMini extends Date {\n  //#region static\n\n  constructor(...args) {\n    super();\n    if (args.length > 1 && typeof args[args.length - 1] === \"string\") {\n      this.timeZone = args.pop();\n    }\n    this.internal = new Date();\n    if (isNaN(tzOffset(this.timeZone, this))) {\n      this.setTime(NaN);\n    } else {\n      if (!args.length) {\n        this.setTime(Date.now());\n      } else if (typeof args[0] === \"number\" && (args.length === 1 || args.length === 2 && typeof args[1] !== \"number\")) {\n        this.setTime(args[0]);\n      } else if (typeof args[0] === \"string\") {\n        this.setTime(+new Date(args[0]));\n      } else if (args[0] instanceof Date) {\n        this.setTime(+args[0]);\n      } else {\n        this.setTime(+new Date(...args));\n        adjustToSystemTZ(this, NaN);\n        syncToInternal(this);\n      }\n    }\n  }\n  static tz(tz, ...args) {\n    return args.length ? new TZDateMini(...args, tz) : new TZDateMini(Date.now(), tz);\n  }\n\n  //#endregion\n\n  //#region time zone\n\n  withTimeZone(timeZone) {\n    return new TZDateMini(+this, timeZone);\n  }\n  getTimezoneOffset() {\n    const offset = -tzOffset(this.timeZone, this);\n    // Remove the seconds offset\n    // use Math.floor for negative GMT timezones and Math.ceil for positive GMT timezones.\n    return offset > 0 ? Math.floor(offset) : Math.ceil(offset);\n  }\n\n  //#endregion\n\n  //#region time\n\n  setTime(time) {\n    Date.prototype.setTime.apply(this, arguments);\n    syncToInternal(this);\n    return +this;\n  }\n\n  //#endregion\n\n  //#region date-fns integration\n\n  [Symbol.for(\"constructDateFrom\")](date) {\n    return new TZDateMini(+new Date(date), this.timeZone);\n  }\n\n  //#endregion\n}\n\n// Assign getters and setters\nconst re = /^(get|set)(?!UTC)/;\nObject.getOwnPropertyNames(Date.prototype).forEach(method => {\n  if (!re.test(method)) return;\n  const utcMethod = method.replace(re, \"$1UTC\");\n  // Filter out methods without UTC counterparts\n  if (!TZDateMini.prototype[utcMethod]) return;\n  if (method.startsWith(\"get\")) {\n    // Delegate to internal date's UTC method\n    TZDateMini.prototype[method] = function () {\n      return this.internal[utcMethod]();\n    };\n  } else {\n    // Assign regular setter\n    TZDateMini.prototype[method] = function () {\n      Date.prototype[utcMethod].apply(this.internal, arguments);\n      syncFromInternal(this);\n      return +this;\n    };\n\n    // Assign UTC setter\n    TZDateMini.prototype[utcMethod] = function () {\n      Date.prototype[utcMethod].apply(this, arguments);\n      syncToInternal(this);\n      return +this;\n    };\n  }\n});\n\n/**\n * Function syncs time to internal date, applying the time zone offset.\n *\n * @param {Date} date - Date to sync\n */\nfunction syncToInternal(date) {\n  date.internal.setTime(+date);\n  date.internal.setUTCSeconds(date.internal.getUTCSeconds() - Math.round(-tzOffset(date.timeZone, date) * 60));\n}\n\n/**\n * Function syncs the internal date UTC values to the date. It allows to get\n * accurate timestamp value.\n *\n * @param {Date} date - The date to sync\n */\nfunction syncFromInternal(date) {\n  // First we transpose the internal values\n  Date.prototype.setFullYear.call(date, date.internal.getUTCFullYear(), date.internal.getUTCMonth(), date.internal.getUTCDate());\n  Date.prototype.setHours.call(date, date.internal.getUTCHours(), date.internal.getUTCMinutes(), date.internal.getUTCSeconds(), date.internal.getUTCMilliseconds());\n\n  // Now we have to adjust the date to the system time zone\n  adjustToSystemTZ(date);\n}\n\n/**\n * Function adjusts the date to the system time zone. It uses the time zone\n * differences to calculate the offset and adjust the date.\n *\n * @param {Date} date - Date to adjust\n */\nfunction adjustToSystemTZ(date) {\n  // Save the time zone offset before all the adjustments\n  const baseOffset = tzOffset(date.timeZone, date);\n  // Remove the seconds offset\n  // use Math.floor for negative GMT timezones and Math.ceil for positive GMT timezones.\n  const offset = baseOffset > 0 ? Math.floor(baseOffset) : Math.ceil(baseOffset);\n  //#region System DST adjustment\n\n  // The biggest problem with using the system time zone is that when we create\n  // a date from internal values stored in UTC, the system time zone might end\n  // up on the DST hour:\n  //\n  //   $ TZ=America/New_York node\n  //   > new Date(2020, 2, 8, 1).toString()\n  //   'Sun Mar 08 2020 01:00:00 GMT-0500 (Eastern Standard Time)'\n  //   > new Date(2020, 2, 8, 2).toString()\n  //   'Sun Mar 08 2020 03:00:00 GMT-0400 (Eastern Daylight Time)'\n  //   > new Date(2020, 2, 8, 3).toString()\n  //   'Sun Mar 08 2020 03:00:00 GMT-0400 (Eastern Daylight Time)'\n  //   > new Date(2020, 2, 8, 4).toString()\n  //   'Sun Mar 08 2020 04:00:00 GMT-0400 (Eastern Daylight Time)'\n  //\n  // Here we get the same hour for both 2 and 3, because the system time zone\n  // has DST beginning at 8 March 2020, 2 a.m. and jumps to 3 a.m. So we have\n  // to adjust the internal date to reflect that.\n  //\n  // However we want to adjust only if that's the DST hour the change happenes,\n  // not the hour where DST moves to.\n\n  // We calculate the previous hour to see if the time zone offset has changed\n  // and we have landed on the DST hour.\n  const prevHour = new Date(+date);\n  // We use UTC methods here as we don't want to land on the same hour again\n  // in case of DST.\n  prevHour.setUTCHours(prevHour.getUTCHours() - 1);\n\n  // Calculate if we are on the system DST hour.\n  const systemOffset = -new Date(+date).getTimezoneOffset();\n  const prevHourSystemOffset = -new Date(+prevHour).getTimezoneOffset();\n  const systemDSTChange = systemOffset - prevHourSystemOffset;\n  // Detect the DST shift. System DST change will occur both on\n  const dstShift = Date.prototype.getHours.apply(date) !== date.internal.getUTCHours();\n\n  // Move the internal date when we are on the system DST hour.\n  if (systemDSTChange && dstShift) date.internal.setUTCMinutes(date.internal.getUTCMinutes() + systemDSTChange);\n\n  //#endregion\n\n  //#region System diff adjustment\n\n  // Now we need to adjust the date, since we just applied internal values.\n  // We need to calculate the difference between the system and date time zones\n  // and apply it to the date.\n\n  const offsetDiff = systemOffset - offset;\n  if (offsetDiff) Date.prototype.setUTCMinutes.call(date, Date.prototype.getUTCMinutes.call(date) + offsetDiff);\n\n  //#endregion\n\n  //#region Seconds System diff adjustment\n\n  const systemDate = new Date(+date);\n  // Set the UTC seconds to 0 to isolate the timezone offset in seconds.\n  systemDate.setUTCSeconds(0);\n  // For negative systemOffset, invert the seconds.\n  const systemSecondsOffset = systemOffset > 0 ? systemDate.getSeconds() : (systemDate.getSeconds() - 60) % 60;\n\n  // Calculate the seconds offset based on the timezone offset.\n  const secondsOffset = Math.round(-(tzOffset(date.timeZone, date) * 60)) % 60;\n  if (secondsOffset || systemSecondsOffset) {\n    date.internal.setUTCSeconds(date.internal.getUTCSeconds() + secondsOffset);\n    Date.prototype.setUTCSeconds.call(date, Date.prototype.getUTCSeconds.call(date) + secondsOffset + systemSecondsOffset);\n  }\n\n  //#endregion\n\n  //#region Post-adjustment DST fix\n\n  const postBaseOffset = tzOffset(date.timeZone, date);\n  // Remove the seconds offset\n  // use Math.floor for negative GMT timezones and Math.ceil for positive GMT timezones.\n  const postOffset = postBaseOffset > 0 ? Math.floor(postBaseOffset) : Math.ceil(postBaseOffset);\n  const postSystemOffset = -new Date(+date).getTimezoneOffset();\n  const postOffsetDiff = postSystemOffset - postOffset;\n  const offsetChanged = postOffset !== offset;\n  const postDiff = postOffsetDiff - offsetDiff;\n  if (offsetChanged && postDiff) {\n    Date.prototype.setUTCMinutes.call(date, Date.prototype.getUTCMinutes.call(date) + postDiff);\n\n    // Now we need to check if got offset change during the post-adjustment.\n    // If so, we also need both dates to reflect that.\n\n    const newBaseOffset = tzOffset(date.timeZone, date);\n    // Remove the seconds offset\n    // use Math.floor for negative GMT timezones and Math.ceil for positive GMT timezones.\n    const newOffset = newBaseOffset > 0 ? Math.floor(newBaseOffset) : Math.ceil(newBaseOffset);\n    const offsetChange = postOffset - newOffset;\n    if (offsetChange) {\n      date.internal.setUTCMinutes(date.internal.getUTCMinutes() + offsetChange);\n      Date.prototype.setUTCMinutes.call(date, Date.prototype.getUTCMinutes.call(date) + offsetChange);\n    }\n  }\n\n  //#endregion\n}", "import { tzName } from \"../tzName/index.js\";\nimport { TZDateMini } from \"./mini.js\";\nexport class TZDate extends TZDateMini {\n  //#region static\n\n  static tz(tz, ...args) {\n    return args.length ? new TZDate(...args, tz) : new TZDate(Date.now(), tz);\n  }\n\n  //#endregion\n\n  //#region representation\n\n  toISOString() {\n    const [sign, hours, minutes] = this.tzComponents();\n    const tz = `${sign}${hours}:${minutes}`;\n    return this.internal.toISOString().slice(0, -1) + tz;\n  }\n  toString() {\n    // \"Tue Aug 13 2024 07:50:19 GMT+0800 (Singapore Standard Time)\";\n    return `${this.toDateString()} ${this.toTimeString()}`;\n  }\n  toDateString() {\n    // toUTCString returns RFC 7231 (\"Mon, 12 Aug 2024 23:36:08 GMT\")\n    const [day, date, month, year] = this.internal.toUTCString().split(\" \");\n    // \"Tue Aug 13 2024\"\n    return `${day?.slice(0, -1) /* Remove \",\" */} ${month} ${date} ${year}`;\n  }\n  toTimeString() {\n    // toUTCString returns RFC 7231 (\"Mon, 12 Aug 2024 23:36:08 GMT\")\n    const time = this.internal.toUTCString().split(\" \")[4];\n    const [sign, hours, minutes] = this.tzComponents();\n    // \"07:42:23 GMT+0800 (Singapore Standard Time)\"\n    return `${time} GMT${sign}${hours}${minutes} (${tzName(this.timeZone, this)})`;\n  }\n  toLocaleString(locales, options) {\n    return Date.prototype.toLocaleString.call(this, locales, {\n      ...options,\n      timeZone: options?.timeZone || this.timeZone\n    });\n  }\n  toLocaleDateString(locales, options) {\n    return Date.prototype.toLocaleDateString.call(this, locales, {\n      ...options,\n      timeZone: options?.timeZone || this.timeZone\n    });\n  }\n  toLocaleTimeString(locales, options) {\n    return Date.prototype.toLocaleTimeString.call(this, locales, {\n      ...options,\n      timeZone: options?.timeZone || this.timeZone\n    });\n  }\n\n  //#endregion\n\n  //#region private\n\n  tzComponents() {\n    const offset = this.getTimezoneOffset();\n    const sign = offset > 0 ? \"-\" : \"+\";\n    const hours = String(Math.floor(Math.abs(offset) / 60)).padStart(2, \"0\");\n    const minutes = String(Math.abs(offset) % 60).padStart(2, \"0\");\n    return [sign, hours, minutes];\n  }\n\n  //#endregion\n\n  withTimeZone(timeZone) {\n    return new TZDate(+this, timeZone);\n  }\n\n  //#region date-fns integration\n\n  [Symbol.for(\"constructDateFrom\")](date) {\n    return new TZDate(+new Date(date), this.timeZone);\n  }\n\n  //#endregion\n}", "import { promises as fs, type Stats } from \"node:fs\";\nimport { dirname, resolve } from \"node:path\";\nimport { SerializationError } from \"./errors.js\";\n\nconst DEFAULT_ENCODING: BufferEncoding = \"utf8\";\nconst DEFAULT_JSON_INDENT = 2;\nconst JSON_LINE_ENDING = \"\\n\";\n\nexport interface FileSystemOptions {\n  baseDir?: string;\n}\n\n/**\n * \u30D5\u30A1\u30A4\u30EB\u30B7\u30B9\u30C6\u30E0\u64CD\u4F5C\u306E\u30E9\u30C3\u30D1\u30FC\u30AF\u30E9\u30B9\n * baseDir\u3092\u57FA\u6E96\u3068\u3057\u305F\u30D1\u30B9\u89E3\u6C7A\u3068\u30C6\u30AD\u30B9\u30C8/JSON/\u30C7\u30A3\u30EC\u30AF\u30C8\u30EA\u64CD\u4F5C\u3092\u63D0\u4F9B\u3059\u308B\n */\nexport class FileSystem {\n  private readonly baseDir: string | null;\n\n  /**\n   * @param options \u30D9\u30FC\u30B9\u30C7\u30A3\u30EC\u30AF\u30C8\u30EA\u7B49\u306E\u30AA\u30D7\u30B7\u30E7\u30F3\n   */\n  constructor(options: FileSystemOptions = {}) {\n    this.baseDir = options.baseDir ?? null;\n  }\n\n  /**\n   * baseDir\u3092\u57FA\u6E96\u306B\u30D1\u30B9\u3092\u89E3\u6C7A\u3059\u308B\n   * @param path \u76F8\u5BFE\u30D1\u30B9\u307E\u305F\u306F\u7D76\u5BFE\u30D1\u30B9\n   * @returns \u89E3\u6C7A\u6E08\u307F\u306E\u30D1\u30B9\n   */\n  resolvePath(path: string): string {\n    return this.baseDir ? resolve(this.baseDir, path) : path;\n  }\n\n  /**\n   * \u30C6\u30AD\u30B9\u30C8\u30D5\u30A1\u30A4\u30EB\u3092\u8AAD\u307F\u8FBC\u3080\n   * @param path \u30D5\u30A1\u30A4\u30EB\u30D1\u30B9\n   * @returns \u30D5\u30A1\u30A4\u30EB\u306E\u5185\u5BB9\n   */\n  async readText(path: string): Promise<string> {\n    return fs.readFile(this.resolvePath(path), { encoding: DEFAULT_ENCODING });\n  }\n\n  /**\n   * \u30C6\u30AD\u30B9\u30C8\u30D5\u30A1\u30A4\u30EB\u306B\u66F8\u304D\u8FBC\u3080\u3002\u89AA\u30C7\u30A3\u30EC\u30AF\u30C8\u30EA\u304C\u306A\u3051\u308C\u3070\u81EA\u52D5\u4F5C\u6210\u3059\u308B\n   * @param path \u30D5\u30A1\u30A4\u30EB\u30D1\u30B9\n   * @param contents \u66F8\u304D\u8FBC\u3080\u5185\u5BB9\n   */\n  async writeText(path: string, contents: string): Promise<void> {\n    const fullPath = this.resolvePath(path);\n    await fs.mkdir(dirname(fullPath), { recursive: true });\n    await fs.writeFile(fullPath, contents, { encoding: DEFAULT_ENCODING });\n  }\n\n  /**\n   * \u30C6\u30AD\u30B9\u30C8\u30D5\u30A1\u30A4\u30EB\u306B\u8FFD\u8A18\u3059\u308B\u3002\u89AA\u30C7\u30A3\u30EC\u30AF\u30C8\u30EA\u304C\u306A\u3051\u308C\u3070\u81EA\u52D5\u4F5C\u6210\u3059\u308B\n   * @param path \u30D5\u30A1\u30A4\u30EB\u30D1\u30B9\n   * @param contents \u8FFD\u8A18\u3059\u308B\u5185\u5BB9\n   */\n  async appendText(path: string, contents: string): Promise<void> {\n    const fullPath = this.resolvePath(path);\n    await fs.mkdir(dirname(fullPath), { recursive: true });\n    await fs.appendFile(fullPath, contents, { encoding: DEFAULT_ENCODING });\n  }\n\n  /**\n   * JSON\u30D5\u30A1\u30A4\u30EB\u3092\u8AAD\u307F\u8FBC\u307F\u30D1\u30FC\u30B9\u3059\u308B\n   * @param path \u30D5\u30A1\u30A4\u30EB\u30D1\u30B9\n   * @returns \u30D1\u30FC\u30B9\u3055\u308C\u305F\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\n   * @throws {SerializationError} JSON\u30D1\u30FC\u30B9\u306B\u5931\u6557\u3057\u305F\u5834\u5408\n   */\n  async readJson<T = unknown>(path: string): Promise<T> {\n    const text = await this.readText(path);\n    try {\n      return JSON.parse(text) as T;\n    } catch (error: unknown) {\n      const message = error instanceof Error ? error.message : String(error);\n      throw new SerializationError(\n        `Failed to parse JSON at ${path}: ${message}`,\n      );\n    }\n  }\n\n  /**\n   * \u5024\u3092JSON\u5F62\u5F0F\u3067\u30D5\u30A1\u30A4\u30EB\u306B\u66F8\u304D\u8FBC\u3080\n   * @param path \u30D5\u30A1\u30A4\u30EB\u30D1\u30B9\n   * @param value \u66F8\u304D\u8FBC\u3080\u5024\n   * @param indent \u30A4\u30F3\u30C7\u30F3\u30C8\u5E45\uFF08\u30C7\u30D5\u30A9\u30EB\u30C8: 2\uFF09\n   * @throws {SerializationError} JSON\u30B7\u30EA\u30A2\u30E9\u30A4\u30BA\u306B\u5931\u6557\u3057\u305F\u5834\u5408\n   */\n  async writeJson(\n    path: string,\n    value: unknown,\n    indent: number = DEFAULT_JSON_INDENT,\n  ): Promise<void> {\n    const json = JSON.stringify(value, null, indent);\n    if (json === undefined) {\n      throw new SerializationError(`Value is not JSON serializable: ${path}`);\n    }\n    await this.writeText(path, `${json}${JSON_LINE_ENDING}`);\n  }\n\n  /**\n   * \u30C7\u30A3\u30EC\u30AF\u30C8\u30EA\u3092\u4F5C\u6210\u3059\u308B\u3002\u65E2\u306B\u5B58\u5728\u3059\u308B\u5834\u5408\u306F\u4F55\u3082\u3057\u306A\u3044\n   * @param path \u30C7\u30A3\u30EC\u30AF\u30C8\u30EA\u30D1\u30B9\n   */\n  async ensureDir(path: string): Promise<void> {\n    await fs.mkdir(this.resolvePath(path), { recursive: true });\n  }\n\n  /**\n   * \u30D5\u30A1\u30A4\u30EB\u307E\u305F\u306F\u30C7\u30A3\u30EC\u30AF\u30C8\u30EA\u304C\u5B58\u5728\u3059\u308B\u304B\u78BA\u8A8D\u3059\u308B\n   * @param path \u30D1\u30B9\n   * @returns \u5B58\u5728\u3059\u308C\u3070true\n   */\n  async exists(path: string): Promise<boolean> {\n    try {\n      await fs.access(this.resolvePath(path));\n      return true;\n    } catch {\n      return false;\n    }\n  }\n\n  /**\n   * \u30D5\u30A1\u30A4\u30EB\u307E\u305F\u306F\u30C7\u30A3\u30EC\u30AF\u30C8\u30EA\u306E\u60C5\u5831\u3092\u53D6\u5F97\u3059\u308B\n   * @param path \u30D1\u30B9\n   * @returns \u30D5\u30A1\u30A4\u30EB\u30B9\u30C6\u30FC\u30BF\u30B9\n   */\n  async stat(path: string): Promise<Stats> {\n    return fs.stat(this.resolvePath(path));\n  }\n\n  /**\n   * \u30C7\u30A3\u30EC\u30AF\u30C8\u30EA\u5185\u306E\u30A8\u30F3\u30C8\u30EA\u4E00\u89A7\u3092\u53D6\u5F97\u3059\u308B\n   * @param path \u30C7\u30A3\u30EC\u30AF\u30C8\u30EA\u30D1\u30B9\n   * @returns \u30D5\u30A1\u30A4\u30EB\u540D\u306E\u914D\u5217\n   */\n  async listDir(path: string): Promise<string[]> {\n    return fs.readdir(this.resolvePath(path));\n  }\n\n  /**\n   * \u30D5\u30A1\u30A4\u30EB\u307E\u305F\u306F\u30C7\u30A3\u30EC\u30AF\u30C8\u30EA\u3092\u518D\u5E30\u7684\u306B\u524A\u9664\u3059\u308B\n   * @param path \u524A\u9664\u5BFE\u8C61\u306E\u30D1\u30B9\n   */\n  async remove(path: string): Promise<void> {\n    await fs.rm(this.resolvePath(path), { recursive: true, force: true });\n  }\n}\n", "/**\n * \u30A2\u30D7\u30EA\u30B1\u30FC\u30B7\u30E7\u30F3\u5171\u901A\u306E\u57FA\u5E95\u30A8\u30E9\u30FC\u30AF\u30E9\u30B9\n * \u30B5\u30D6\u30AF\u30E9\u30B9\u540D\u3092\u81EA\u52D5\u7684\u306Bname\u30D7\u30ED\u30D1\u30C6\u30A3\u306B\u8A2D\u5B9A\u3059\u308B\n */\nexport class AppError extends Error {\n  /**\n   * @param message \u30A8\u30E9\u30FC\u30E1\u30C3\u30BB\u30FC\u30B8\n   * @param options \u30A8\u30E9\u30FC\u30AA\u30D7\u30B7\u30E7\u30F3\uFF08cause\u306A\u3069\uFF09\n   */\n  constructor(message: string, options: ErrorOptions = {}) {\n    super(message, options);\n    this.name = this.constructor.name;\n  }\n}\n\n/** \u7121\u52B9\u306A\u5F15\u6570\u304C\u6E21\u3055\u308C\u305F\u5834\u5408\u306E\u30A8\u30E9\u30FC */\nexport class InvalidArgumentError extends AppError {}\n\n/** \u5B9F\u884C\u6642\u30A8\u30E9\u30FC */\nexport class RuntimeError extends AppError {}\n\n/** \u30EA\u30BD\u30FC\u30B9\u304C\u898B\u3064\u304B\u3089\u306A\u3044\u5834\u5408\u306E\u30A8\u30E9\u30FC */\nexport class NotFoundError extends AppError {}\n\n/** \u30EA\u30BD\u30FC\u30B9\u306E\u7AF6\u5408\u304C\u767A\u751F\u3057\u305F\u5834\u5408\u306E\u30A8\u30E9\u30FC */\nexport class ConflictError extends AppError {}\n\n/** \u4E0D\u6B63\u306A\u72B6\u614B\u3067\u64CD\u4F5C\u304C\u5B9F\u884C\u3055\u308C\u305F\u5834\u5408\u306E\u30A8\u30E9\u30FC */\nexport class StateError extends AppError {}\n\n/** \u4F9D\u5B58\u95A2\u4FC2\u306B\u554F\u984C\u304C\u3042\u308B\u5834\u5408\u306E\u30A8\u30E9\u30FC */\nexport class DependencyError extends AppError {}\n\n/** \u5FAA\u74B0\u4F9D\u5B58\u304C\u691C\u51FA\u3055\u308C\u305F\u5834\u5408\u306E\u30A8\u30E9\u30FC */\nexport class CyclicDependencyError extends DependencyError {}\n\n/** \u30B7\u30EA\u30A2\u30E9\u30A4\u30BA/\u30C7\u30B7\u30EA\u30A2\u30E9\u30A4\u30BA\u306B\u5931\u6557\u3057\u305F\u5834\u5408\u306E\u30A8\u30E9\u30FC */\nexport class SerializationError extends AppError {}\n", "import { randomUUID } from \"node:crypto\";\n\n/**\n * UUIDv4\u5F62\u5F0F\u306E\u4E00\u610F\u306AID\u3092\u751F\u6210\u3059\u308B\n * @returns \u751F\u6210\u3055\u308C\u305FUUID\u6587\u5B57\u5217\n */\nexport function generateId(): string {\n  return randomUUID();\n}\n", "import type { ConversationMemory } from \"./conversation-store.js\";\n\nexport interface MemoryDiff {\n  set: ConversationMemory;\n  remove: string[];\n}\n\nconst EMPTY_DIFF: MemoryDiff = { set: {}, remove: [] };\n\n/**\n * \u5DEE\u5206\u304C\u7A7A\u304B\u3069\u3046\u304B\u3092\u5224\u5B9A\u3059\u308B\n * @param diff \u30E1\u30E2\u30EA\u5DEE\u5206\n * @returns \u5909\u66F4\u304C\u306A\u3051\u308C\u3070true\n */\nexport const isEmptyDiff = (diff: MemoryDiff): boolean =>\n  Object.keys(diff.set).length === 0 && diff.remove.length === 0;\n\n/**\n * 2\u3064\u306E\u30E1\u30E2\u30EA\u72B6\u614B\u306E\u5DEE\u5206\u3092\u8A08\u7B97\u3059\u308B\n * @param previous \u5909\u66F4\u524D\u306E\u30E1\u30E2\u30EA\n * @param next \u5909\u66F4\u5F8C\u306E\u30E1\u30E2\u30EA\n * @returns \u8A2D\u5B9A\u3055\u308C\u305F\u5024\u3068\u524A\u9664\u3055\u308C\u305F\u30AD\u30FC\u306E\u5DEE\u5206\n */\nexport const diffMemory = (\n  previous: ConversationMemory,\n  next: ConversationMemory,\n): MemoryDiff => {\n  const set: ConversationMemory = {};\n  const remove: string[] = [];\n\n  const prevKeys = Object.keys(previous);\n  const nextKeys = new Set(Object.keys(next));\n\n  for (const key of prevKeys) {\n    if (!nextKeys.has(key)) {\n      remove.push(key);\n      continue;\n    }\n    const prevValue = previous[key];\n    const nextValue = next[key];\n    if (!Object.is(prevValue, nextValue)) {\n      set[key] = nextValue;\n    }\n  }\n\n  for (const key of Object.keys(next)) {\n    if (!(key in previous)) {\n      set[key] = next[key];\n    }\n  }\n\n  if (Object.keys(set).length === 0 && remove.length === 0) {\n    return EMPTY_DIFF;\n  }\n\n  return { set, remove };\n};\n\n/**\n * \u30E1\u30E2\u30EA\u5DEE\u5206\u3092\u30D9\u30FC\u30B9\u306E\u30E1\u30E2\u30EA\u306B\u9069\u7528\u3059\u308B\n * @param base \u30D9\u30FC\u30B9\u3068\u306A\u308B\u30E1\u30E2\u30EA\n * @param diff \u9069\u7528\u3059\u308B\u5DEE\u5206\n * @returns \u5DEE\u5206\u9069\u7528\u5F8C\u306E\u65B0\u3057\u3044\u30E1\u30E2\u30EA\n */\nexport const applyMemoryDiff = (\n  base: ConversationMemory,\n  diff: MemoryDiff,\n): ConversationMemory => {\n  const next: ConversationMemory = { ...base, ...diff.set };\n  for (const key of diff.remove) {\n    delete next[key];\n  }\n  return next;\n};\n", "import { TZDate } from \"@date-fns/tz\";\nimport type { FileSystem } from \"../core/file-system.js\";\nimport { FileSystem as DefaultFileSystem } from \"../core/file-system.js\";\nimport { RuntimeError } from \"../core/index.js\";\nimport {\n  applyMemoryDiff,\n  diffMemory,\n  isEmptyDiff,\n  type MemoryDiff,\n} from \"./memory-diff.js\";\n\nexport type ConversationMemory = Record<string, unknown>;\n\nexport interface ConversationStore {\n  get(conversationId: string): Promise<ConversationMemory | undefined>;\n  set(conversationId: string, memory: ConversationMemory): Promise<void>;\n  delete?(conversationId: string): Promise<void>;\n}\n\nconst cloneMemory = (memory: ConversationMemory): ConversationMemory =>\n  structuredClone(memory);\n\n/**\n * ConversationStore \u306E\u30A4\u30F3\u30E1\u30E2\u30EA\u5B9F\u88C5\u3002\n *\n * \u4F1A\u8A71\u30E1\u30E2\u30EA\u3092 Map \u306B\u4FDD\u6301\u3057\u3001\u5916\u90E8\u304B\u3089\u306E\u5909\u66F4\u3092\u9632\u3050\u305F\u3081\u306B\u30C7\u30A3\u30FC\u30D7\u30AF\u30ED\u30FC\u30F3\u3092\u7528\u3044\u3066\n * \u53D6\u5F97\u30FB\u4FDD\u5B58\u3092\u884C\u3046\u3002\u30C6\u30B9\u30C8\u3084\u77ED\u671F\u9593\u306E\u5229\u7528\u306B\u9069\u3057\u3066\u3044\u308B\u3002\n */\nexport class InMemoryConversationStore implements ConversationStore {\n  private readonly store = new Map<string, ConversationMemory>();\n\n  /**\n   * \u6307\u5B9A\u3055\u308C\u305F\u4F1A\u8A71ID\u306B\u5BFE\u5FDC\u3059\u308B\u30E1\u30E2\u30EA\u3092\u53D6\u5F97\u3059\u308B\u3002\n   *\n   * \u683C\u7D0D\u3055\u308C\u305F\u30E1\u30E2\u30EA\u306E\u30C7\u30A3\u30FC\u30D7\u30AF\u30ED\u30FC\u30F3\u3092\u8FD4\u3059\u305F\u3081\u3001\u8FD4\u5374\u5024\u3092\u5909\u66F4\u3057\u3066\u3082\n   * \u30B9\u30C8\u30A2\u5185\u90E8\u306E\u30C7\u30FC\u30BF\u306B\u306F\u5F71\u97FF\u3057\u306A\u3044\u3002\n   *\n   * @param conversationId - \u53D6\u5F97\u5BFE\u8C61\u306E\u4F1A\u8A71ID\n   * @returns \u4F1A\u8A71\u30E1\u30E2\u30EA\u306E\u30C7\u30A3\u30FC\u30D7\u30AF\u30ED\u30FC\u30F3\u3002\u5B58\u5728\u3057\u306A\u3044\u5834\u5408\u306F `undefined`\n   */\n  async get(conversationId: string): Promise<ConversationMemory | undefined> {\n    const memory = this.store.get(conversationId);\n    if (!memory) {\n      return undefined;\n    }\n    return cloneMemory(memory);\n  }\n\n  /**\n   * \u6307\u5B9A\u3055\u308C\u305F\u4F1A\u8A71ID\u306B\u5BFE\u3057\u3066\u4F1A\u8A71\u30E1\u30E2\u30EA\u3092\u4FDD\u5B58\u3059\u308B\u3002\n   *\n   * \u5F15\u6570\u306E\u30E1\u30E2\u30EA\u3092\u30C7\u30A3\u30FC\u30D7\u30AF\u30ED\u30FC\u30F3\u3057\u3066\u683C\u7D0D\u3059\u308B\u305F\u3081\u3001\u4FDD\u5B58\u5F8C\u306B\u5143\u306E\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\u3092\n   * \u5909\u66F4\u3057\u3066\u3082\u30B9\u30C8\u30A2\u5185\u90E8\u306E\u30C7\u30FC\u30BF\u306B\u306F\u5F71\u97FF\u3057\u306A\u3044\u3002\n   *\n   * @param conversationId - \u4FDD\u5B58\u5BFE\u8C61\u306E\u4F1A\u8A71ID\n   * @param memory - \u4FDD\u5B58\u3059\u308B\u4F1A\u8A71\u30E1\u30E2\u30EA\n   */\n  async set(conversationId: string, memory: ConversationMemory): Promise<void> {\n    this.store.set(conversationId, cloneMemory(memory));\n  }\n\n  /**\n   * \u6307\u5B9A\u3055\u308C\u305F\u4F1A\u8A71ID\u306B\u5BFE\u5FDC\u3059\u308B\u30E1\u30E2\u30EA\u3092\u524A\u9664\u3059\u308B\u3002\n   *\n   * @param conversationId - \u524A\u9664\u5BFE\u8C61\u306E\u4F1A\u8A71ID\n   */\n  async delete(conversationId: string): Promise<void> {\n    this.store.delete(conversationId);\n  }\n}\n\nexport interface DeltaConversationStoreOptions {\n  directory?: string;\n  fileSystem?: FileSystem;\n  compactAfterPatches?: number;\n}\n\ninterface DeltaEntry {\n  timestamp: string;\n  diff: MemoryDiff;\n}\n\nconst DEFAULT_DIRECTORY = \"conversations\";\nconst DEFAULT_COMPACT_AFTER_PATCHES = 50;\nconst MIN_COMPACT_AFTER_PATCHES = 1;\nconst BASE_FILE_NAME = \"base.json\";\nconst DELTA_FILE_NAME = \"deltas.jsonl\";\nconst LINE_ENDING = \"\\n\";\n\n/**\n * \u30D5\u30A1\u30A4\u30EB\u30D9\u30FC\u30B9\u306E ConversationStore \u5B9F\u88C5\u3002\u30D9\u30FC\u30B9\u30D5\u30A1\u30A4\u30EB\u3068\u30C7\u30EB\u30BF\u30D1\u30C3\u30C1\u3092\u7528\u3044\u3066\n * \u4F1A\u8A71\u30E1\u30E2\u30EA\u3092\u52B9\u7387\u7684\u306B\u6C38\u7D9A\u5316\u3059\u308B\u3002\n *\n * \u521D\u56DE\u4FDD\u5B58\u6642\u306B\u30D9\u30FC\u30B9\u30D5\u30A1\u30A4\u30EB (base.json) \u3092\u66F8\u304D\u51FA\u3057\u3001\u4EE5\u964D\u306E\u66F4\u65B0\u306F\u5DEE\u5206 (diff) \u3092\n * \u30C7\u30EB\u30BF\u30D5\u30A1\u30A4\u30EB (deltas.jsonl) \u3078\u8FFD\u8A18\u3059\u308B\u3002\u30C7\u30EB\u30BF\u6570\u304C\u95BE\u5024\u306B\u9054\u3059\u308B\u3068\u81EA\u52D5\u7684\u306B\n * \u30B3\u30F3\u30D1\u30AF\u30B7\u30E7\u30F3\uFF08\u30D9\u30FC\u30B9\u30D5\u30A1\u30A4\u30EB\u306E\u66F8\u304D\u76F4\u3057\u3068\u30C7\u30EB\u30BF\u30D5\u30A1\u30A4\u30EB\u306E\u30AF\u30EA\u30A2\uFF09\u3092\u884C\u3046\u3002\n */\nexport class DeltaConversationStore implements ConversationStore {\n  private readonly directory: string;\n  private readonly fs: FileSystem;\n  private readonly compactAfterPatches: number;\n\n  constructor(options: DeltaConversationStoreOptions = {}) {\n    this.directory = options.directory ?? DEFAULT_DIRECTORY;\n    this.fs = options.fileSystem ?? new DefaultFileSystem();\n    const compactAfterPatches =\n      options.compactAfterPatches ?? DEFAULT_COMPACT_AFTER_PATCHES;\n    this.compactAfterPatches = Math.max(\n      MIN_COMPACT_AFTER_PATCHES,\n      compactAfterPatches,\n    );\n  }\n\n  /**\n   * \u6307\u5B9A\u3055\u308C\u305F\u4F1A\u8A71ID\u306B\u5BFE\u5FDC\u3059\u308B\u30E1\u30E2\u30EA\u3092\u53D6\u5F97\u3059\u308B\u3002\n   *\n   * \u30D9\u30FC\u30B9\u30D5\u30A1\u30A4\u30EB\u3068\u30C7\u30EB\u30BF\u30D5\u30A1\u30A4\u30EB\u304B\u3089\u73FE\u5728\u306E\u72B6\u614B\u3092\u5FA9\u5143\u3059\u308B\u3002\n   * \u30C7\u30EB\u30BF\u6570\u304C\u30B3\u30F3\u30D1\u30AF\u30B7\u30E7\u30F3\u95BE\u5024\u4EE5\u4E0A\u306E\u5834\u5408\u3001\u81EA\u52D5\u7684\u306B\u30B3\u30F3\u30D1\u30AF\u30B7\u30E7\u30F3\u3092\u5B9F\u884C\u3057\u3066\n   * \u6B21\u56DE\u4EE5\u964D\u306E\u8AAD\u307F\u53D6\u308A\u3092\u9AD8\u901F\u5316\u3059\u308B\u3002\n   *\n   * @param conversationId - \u53D6\u5F97\u5BFE\u8C61\u306E\u4F1A\u8A71ID\n   * @returns \u5FA9\u5143\u3055\u308C\u305F\u4F1A\u8A71\u30E1\u30E2\u30EA\u3002\u5B58\u5728\u3057\u306A\u3044\u5834\u5408\u306F `undefined`\n   */\n  async get(conversationId: string): Promise<ConversationMemory | undefined> {\n    const state = await this.readState(conversationId);\n    if (!state.memory) {\n      return undefined;\n    }\n    if (state.deltaCount >= this.compactAfterPatches) {\n      await this.compact(conversationId, state.memory);\n    }\n    return state.memory;\n  }\n\n  /**\n   * \u6307\u5B9A\u3055\u308C\u305F\u4F1A\u8A71ID\u306B\u5BFE\u3057\u3066\u4F1A\u8A71\u30E1\u30E2\u30EA\u3092\u4FDD\u5B58\u3059\u308B\u3002\n   *\n   * \u65E2\u5B58\u306E\u30D9\u30FC\u30B9\u30D5\u30A1\u30A4\u30EB\u304C\u5B58\u5728\u3057\u306A\u3044\u5834\u5408\u306F\u65B0\u898F\u306B\u30D9\u30FC\u30B9\u30D5\u30A1\u30A4\u30EB\u3092\u4F5C\u6210\u3059\u308B\u3002\n   * \u65E2\u5B58\u306E\u72B6\u614B\u304C\u3042\u308B\u5834\u5408\u306F\u3001\u73FE\u5728\u306E\u72B6\u614B\u3068\u306E\u5DEE\u5206\u3092\u8A08\u7B97\u3057\u3066\u30C7\u30EB\u30BF\u30D5\u30A1\u30A4\u30EB\u306B\u8FFD\u8A18\u3059\u308B\u3002\n   * \u5DEE\u5206\u304C\u7A7A\u306E\u5834\u5408\u306F\u66F8\u304D\u8FBC\u307F\u3092\u30B9\u30AD\u30C3\u30D7\u3059\u308B\u3002\u30C7\u30EB\u30BF\u6570\u304C\u30B3\u30F3\u30D1\u30AF\u30B7\u30E7\u30F3\u95BE\u5024\u306B\u9054\u3057\u305F\n   * \u5834\u5408\u306F\u81EA\u52D5\u7684\u306B\u30B3\u30F3\u30D1\u30AF\u30B7\u30E7\u30F3\u3092\u5B9F\u884C\u3059\u308B\u3002\n   *\n   * @param conversationId - \u4FDD\u5B58\u5BFE\u8C61\u306E\u4F1A\u8A71ID\n   * @param memory - \u4FDD\u5B58\u3059\u308B\u4F1A\u8A71\u30E1\u30E2\u30EA\n   */\n  async set(conversationId: string, memory: ConversationMemory): Promise<void> {\n    const state = await this.readState(conversationId);\n    if (!state.memory) {\n      await this.writeBase(conversationId, memory);\n      await this.clearDeltas(conversationId);\n      return;\n    }\n\n    const diff = diffMemory(state.memory, memory);\n    if (isEmptyDiff(diff)) {\n      return;\n    }\n\n    await this.appendDelta(conversationId, diff);\n\n    const nextDeltaCount = state.deltaCount + 1;\n    if (nextDeltaCount >= this.compactAfterPatches) {\n      await this.compact(conversationId, memory);\n    }\n  }\n\n  /**\n   * \u6307\u5B9A\u3055\u308C\u305F\u4F1A\u8A71ID\u306B\u5BFE\u5FDC\u3059\u308B\u30D9\u30FC\u30B9\u30D5\u30A1\u30A4\u30EB\u3068\u30C7\u30EB\u30BF\u30D5\u30A1\u30A4\u30EB\u3092\u524A\u9664\u3059\u308B\u3002\n   *\n   * @param conversationId - \u524A\u9664\u5BFE\u8C61\u306E\u4F1A\u8A71ID\n   */\n  async delete(conversationId: string): Promise<void> {\n    await this.fs.remove(this.basePath(conversationId));\n    await this.fs.remove(this.deltaPath(conversationId));\n  }\n\n  /**\n   * \u6307\u5B9A\u3055\u308C\u305F\u4F1A\u8A71ID\u306B\u5BFE\u5FDC\u3059\u308B\u30D9\u30FC\u30B9\u30D5\u30A1\u30A4\u30EB\u306E\u30D1\u30B9\u3092\u8FD4\u3059\u3002\n   *\n   * @param conversationId - \u4F1A\u8A71ID\n   * @returns \u30D9\u30FC\u30B9\u30D5\u30A1\u30A4\u30EB (base.json) \u306E\u7D76\u5BFE\u30D1\u30B9\n   */\n  private basePath(conversationId: string): string {\n    return `${this.directory}/${conversationId}/${BASE_FILE_NAME}`;\n  }\n\n  /**\n   * \u6307\u5B9A\u3055\u308C\u305F\u4F1A\u8A71ID\u306B\u5BFE\u5FDC\u3059\u308B\u30C7\u30EB\u30BF\u30D5\u30A1\u30A4\u30EB\u306E\u30D1\u30B9\u3092\u8FD4\u3059\u3002\n   *\n   * @param conversationId - \u4F1A\u8A71ID\n   * @returns \u30C7\u30EB\u30BF\u30D5\u30A1\u30A4\u30EB (deltas.jsonl) \u306E\u7D76\u5BFE\u30D1\u30B9\n   */\n  private deltaPath(conversationId: string): string {\n    return `${this.directory}/${conversationId}/${DELTA_FILE_NAME}`;\n  }\n\n  /**\n   * \u30D9\u30FC\u30B9\u30D5\u30A1\u30A4\u30EB\u306B\u4F1A\u8A71\u30E1\u30E2\u30EA\u3092JSON\u5F62\u5F0F\u3067\u66F8\u304D\u8FBC\u3080\u3002\n   *\n   * @param conversationId - \u4F1A\u8A71ID\n   * @param memory - \u66F8\u304D\u8FBC\u3080\u4F1A\u8A71\u30E1\u30E2\u30EA\n   */\n  private async writeBase(\n    conversationId: string,\n    memory: ConversationMemory,\n  ): Promise<void> {\n    await this.fs.writeJson(this.basePath(conversationId), memory);\n  }\n\n  /**\n   * \u30C7\u30EB\u30BF\u30D5\u30A1\u30A4\u30EB\u306B\u5DEE\u5206\u30A8\u30F3\u30C8\u30EA\u30921\u884C\u8FFD\u8A18\u3059\u308B\u3002\n   *\n   * \u30BF\u30A4\u30E0\u30B9\u30BF\u30F3\u30D7\u3068\u3068\u3082\u306B\u5DEE\u5206\u60C5\u5831\u3092JSONL\u5F62\u5F0F\u3067\u8FFD\u8A18\u3059\u308B\u3002\n   *\n   * @param conversationId - \u4F1A\u8A71ID\n   * @param diff - \u8FFD\u8A18\u3059\u308B\u30E1\u30E2\u30EA\u5DEE\u5206\n   */\n  private async appendDelta(\n    conversationId: string,\n    diff: MemoryDiff,\n  ): Promise<void> {\n    const entry: DeltaEntry = {\n      timestamp: new TZDate().toISOString(),\n      diff,\n    };\n    const line = `${JSON.stringify(entry)}${LINE_ENDING}`;\n    await this.fs.appendText(this.deltaPath(conversationId), line);\n  }\n\n  /**\n   * \u30C7\u30EB\u30BF\u30D5\u30A1\u30A4\u30EB\u306E\u5185\u5BB9\u3092\u30AF\u30EA\u30A2\uFF08\u7A7A\u6587\u5B57\u3067\u4E0A\u66F8\u304D\uFF09\u3059\u308B\u3002\n   *\n   * @param conversationId - \u4F1A\u8A71ID\n   */\n  private async clearDeltas(conversationId: string): Promise<void> {\n    await this.fs.writeText(this.deltaPath(conversationId), \"\");\n  }\n\n  /**\n   * \u30B3\u30F3\u30D1\u30AF\u30B7\u30E7\u30F3\u3092\u5B9F\u884C\u3059\u308B\u3002\n   *\n   * \u73FE\u5728\u306E\u30E1\u30E2\u30EA\u72B6\u614B\u3092\u30D9\u30FC\u30B9\u30D5\u30A1\u30A4\u30EB\u306B\u66F8\u304D\u51FA\u3057\u3001\u30C7\u30EB\u30BF\u30D5\u30A1\u30A4\u30EB\u3092\u30AF\u30EA\u30A2\u3059\u308B\u3053\u3068\u3067\n   * \u84C4\u7A4D\u3055\u308C\u305F\u30C7\u30EB\u30BF\u30D1\u30C3\u30C1\u3092\u7D71\u5408\u3057\u3001\u6B21\u56DE\u4EE5\u964D\u306E\u8AAD\u307F\u53D6\u308A\u30D1\u30D5\u30A9\u30FC\u30DE\u30F3\u30B9\u3092\u6539\u5584\u3059\u308B\u3002\n   *\n   * @param conversationId - \u4F1A\u8A71ID\n   * @param memory - \u30B3\u30F3\u30D1\u30AF\u30B7\u30E7\u30F3\u6642\u70B9\u306E\u6700\u65B0\u30E1\u30E2\u30EA\u72B6\u614B\n   */\n  private async compact(\n    conversationId: string,\n    memory: ConversationMemory,\n  ): Promise<void> {\n    await this.writeBase(conversationId, memory);\n    await this.clearDeltas(conversationId);\n  }\n\n  /**\n   * \u30D9\u30FC\u30B9\u30D5\u30A1\u30A4\u30EB\u3068\u30C7\u30EB\u30BF\u30D5\u30A1\u30A4\u30EB\u304B\u3089\u73FE\u5728\u306E\u4F1A\u8A71\u30E1\u30E2\u30EA\u72B6\u614B\u3092\u8AAD\u307F\u53D6\u308B\u3002\n   *\n   * \u30D9\u30FC\u30B9\u30D5\u30A1\u30A4\u30EB\u304C\u5B58\u5728\u3057\u306A\u3044\u5834\u5408\u306F\u672A\u521D\u671F\u5316\u3068\u3057\u3066\u6271\u3046\u3002\u30D9\u30FC\u30B9\u30D5\u30A1\u30A4\u30EB\u306A\u3057\u3067\n   * \u30C7\u30EB\u30BF\u30D5\u30A1\u30A4\u30EB\u306E\u307F\u5B58\u5728\u3059\u308B\u5834\u5408\u306F\u4E0D\u6574\u5408\u3068\u3057\u3066\u30A8\u30E9\u30FC\u3092\u30B9\u30ED\u30FC\u3059\u308B\u3002\n   * \u30D9\u30FC\u30B9\u30D5\u30A1\u30A4\u30EB\u304C\u5B58\u5728\u3059\u308B\u5834\u5408\u3001\u30C7\u30EB\u30BF\u30D5\u30A1\u30A4\u30EB\u306E\u5404\u884C\u3092\u9806\u306B\u9069\u7528\u3057\u3066\n   * \u6700\u65B0\u306E\u30E1\u30E2\u30EA\u72B6\u614B\u3092\u5FA9\u5143\u3059\u308B\u3002\n   *\n   * @param conversationId - \u4F1A\u8A71ID\n   * @returns \u5FA9\u5143\u3055\u308C\u305F\u30E1\u30E2\u30EA\u72B6\u614B\u3068\u9069\u7528\u3055\u308C\u305F\u30C7\u30EB\u30BF\u6570\n   */\n  private async readState(conversationId: string): Promise<{\n    memory?: ConversationMemory;\n    deltaCount: number;\n  }> {\n    const basePath = this.basePath(conversationId);\n    const deltaPath = this.deltaPath(conversationId);\n\n    if (!(await this.fs.exists(basePath))) {\n      if (await this.fs.exists(deltaPath)) {\n        throw new RuntimeError(\n          `Delta file exists without base: ${conversationId}`,\n        );\n      }\n      return { memory: undefined, deltaCount: 0 };\n    }\n\n    let memory = await this.fs.readJson<ConversationMemory>(basePath);\n    if (!(await this.fs.exists(deltaPath))) {\n      return { memory, deltaCount: 0 };\n    }\n\n    const text = await this.fs.readText(deltaPath);\n    const lines = text.split(LINE_ENDING).filter((line) => line.length > 0);\n    for (const line of lines) {\n      const entry = JSON.parse(line) as DeltaEntry;\n      memory = applyMemoryDiff(memory, entry.diff);\n    }\n\n    return { memory, deltaCount: lines.length };\n  }\n}\n", "import { generateId, InvalidArgumentError } from \"../core/index.js\";\nimport type { ConversationMemory } from \"./conversation-store.js\";\n\nexport interface NodeExecutionContext<Context = unknown, Input = unknown> {\n  workflowId: string;\n  nodeId: string;\n  runId: string;\n  conversationId?: string;\n  context?: Context;\n  input?: Input;\n  event?: unknown;\n  signal?: AbortSignal;\n  results: Record<string, unknown>;\n  getResult<T = unknown>(nodeId: string): T | undefined;\n  memory?: ConversationMemory;\n  getMemory?: () => ConversationMemory | undefined;\n  setMemory?: (next: ConversationMemory) => void | Promise<void>;\n  updateMemory?: (patch: Partial<ConversationMemory>) => void | Promise<void>;\n}\n\nexport type NodeHandler<\n  Context = unknown,\n  Input = unknown,\n  Output = unknown,\n> = (context: NodeExecutionContext<Context, Input>) => Output | Promise<Output>;\n\nexport interface RetryPolicy {\n  maxAttempts?: number;\n  initialDelayMs?: number;\n  backoffMultiplier?: number;\n  maxDelayMs?: number;\n  jitterMs?: number;\n}\n\nexport interface NodeDefinition<\n  Context = unknown,\n  Input = unknown,\n  Output = unknown,\n> {\n  name?: string;\n  dependsOn?: string[];\n  handler: NodeHandler<Context, Input, Output>;\n  retry?: RetryPolicy;\n}\n\nconst MIN_RETRY_ATTEMPTS = 1;\nconst MIN_BACKOFF_MULTIPLIER = 1;\nconst MIN_DELAY_MS = 0;\n\nconst validateInteger = (value: number, name: string, min: number): number => {\n  if (!Number.isInteger(value) || value < min) {\n    throw new InvalidArgumentError(\n      `Node retry ${name} must be an integer >= ${min}`,\n    );\n  }\n  return value;\n};\n\nconst validateNumber = (value: number, name: string, min: number): number => {\n  if (!Number.isFinite(value) || value < min) {\n    throw new InvalidArgumentError(\n      `Node retry ${name} must be a number >= ${min}`,\n    );\n  }\n  return value;\n};\n\n/**\n * \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u5185\u306E\u5358\u4E00\u30CE\u30FC\u30C9\u3092\u8868\u3059\u30AF\u30E9\u30B9\u3002\n * \u5404\u30CE\u30FC\u30C9\u306F\u30CF\u30F3\u30C9\u30E9\u95A2\u6570\u3001\u4F9D\u5B58\u95A2\u4FC2\u30EA\u30B9\u30C8\u3001\u304A\u3088\u3073\u30EA\u30C8\u30E9\u30A4\u30DD\u30EA\u30B7\u30FC\u3092\u6301\u3061\u3001\n * \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u306E\u5B9F\u884C\u5358\u4F4D\u3068\u3057\u3066\u52D5\u4F5C\u3059\u308B\u3002\n *\n * @typeParam Context - \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u5168\u4F53\u3067\u5171\u6709\u3055\u308C\u308B\u30B3\u30F3\u30C6\u30AD\u30B9\u30C8\u306E\u578B\n * @typeParam Input - \u30CE\u30FC\u30C9\u306B\u6E21\u3055\u308C\u308B\u5165\u529B\u30C7\u30FC\u30BF\u306E\u578B\n * @typeParam Output - \u30CE\u30FC\u30C9\u306E\u30CF\u30F3\u30C9\u30E9\u304C\u8FD4\u3059\u51FA\u529B\u30C7\u30FC\u30BF\u306E\u578B\n */\nexport class Node<Context = unknown, Input = unknown, Output = unknown> {\n  readonly id: string;\n  readonly name?: string;\n  readonly handler: NodeHandler<Context, Input, Output>;\n  readonly retry?: RetryPolicy;\n  private readonly dependencies = new Set<string>();\n\n  /**\n   * NodeDefinition \u304B\u3089\u30CE\u30FC\u30C9\u3092\u751F\u6210\u3059\u308B\u3002\n   * \u30EA\u30C8\u30E9\u30A4\u30DD\u30EA\u30B7\u30FC\u304C\u6307\u5B9A\u3055\u308C\u3066\u3044\u308B\u5834\u5408\u3001\u5404\u30D1\u30E9\u30E1\u30FC\u30BF\uFF08maxAttempts, initialDelayMs,\n   * backoffMultiplier, maxDelayMs, jitterMs\uFF09\u306E\u30D0\u30EA\u30C7\u30FC\u30B7\u30E7\u30F3\u3092\u884C\u3044\u3001\n   * \u4E0D\u6B63\u306A\u5024\u304C\u542B\u307E\u308C\u3066\u3044\u308B\u5834\u5408\u306F {@link InvalidArgumentError} \u3092\u30B9\u30ED\u30FC\u3059\u308B\u3002\n   * \u307E\u305F\u3001dependsOn \u3067\u6307\u5B9A\u3055\u308C\u305F\u4F9D\u5B58\u30CE\u30FC\u30C9 ID \u3092\u5185\u90E8\u306E\u4F9D\u5B58\u95A2\u4FC2\u30BB\u30C3\u30C8\u306B\u767B\u9332\u3059\u308B\u3002\n   *\n   * @param definition - \u30CE\u30FC\u30C9\u306E\u5B9A\u7FA9\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\uFF08\u540D\u524D\u3001\u30CF\u30F3\u30C9\u30E9\u3001\u4F9D\u5B58\u95A2\u4FC2\u3001\u30EA\u30C8\u30E9\u30A4\u30DD\u30EA\u30B7\u30FC\u3092\u542B\u3080\uFF09\n   * @throws {InvalidArgumentError} \u30EA\u30C8\u30E9\u30A4\u30DD\u30EA\u30B7\u30FC\u306E\u30D1\u30E9\u30E1\u30FC\u30BF\u304C\u4E0D\u6B63\u306A\u5834\u5408\n   */\n  constructor(definition: NodeDefinition<Context, Input, Output>) {\n    this.id = generateId();\n    this.name = definition.name;\n    this.handler = definition.handler;\n    this.retry = definition.retry\n      ? {\n          maxAttempts:\n            definition.retry.maxAttempts === undefined\n              ? undefined\n              : validateInteger(\n                  definition.retry.maxAttempts,\n                  \"maxAttempts\",\n                  MIN_RETRY_ATTEMPTS,\n                ),\n          initialDelayMs:\n            definition.retry.initialDelayMs === undefined\n              ? undefined\n              : validateNumber(\n                  definition.retry.initialDelayMs,\n                  \"initialDelayMs\",\n                  MIN_DELAY_MS,\n                ),\n          backoffMultiplier:\n            definition.retry.backoffMultiplier === undefined\n              ? undefined\n              : validateNumber(\n                  definition.retry.backoffMultiplier,\n                  \"backoffMultiplier\",\n                  MIN_BACKOFF_MULTIPLIER,\n                ),\n          maxDelayMs:\n            definition.retry.maxDelayMs === undefined\n              ? undefined\n              : validateNumber(\n                  definition.retry.maxDelayMs,\n                  \"maxDelayMs\",\n                  MIN_DELAY_MS,\n                ),\n          jitterMs:\n            definition.retry.jitterMs === undefined\n              ? undefined\n              : validateNumber(\n                  definition.retry.jitterMs,\n                  \"jitterMs\",\n                  MIN_DELAY_MS,\n                ),\n        }\n      : undefined;\n\n    if (definition.dependsOn) {\n      for (const dep of definition.dependsOn) {\n        this.dependencies.add(dep);\n      }\n    }\n  }\n\n  /**\n   * \u6307\u5B9A\u3055\u308C\u305F\u30CE\u30FC\u30C9 ID \u3092\u4F9D\u5B58\u95A2\u4FC2\u3068\u3057\u3066\u8FFD\u52A0\u3059\u308B\u3002\n   * \u3053\u306E\u30CE\u30FC\u30C9\u306F\u3001\u8FFD\u52A0\u3055\u308C\u305F\u4F9D\u5B58\u30CE\u30FC\u30C9\u306E\u5B9F\u884C\u304C\u5B8C\u4E86\u3059\u308B\u307E\u3067\u5B9F\u884C\u3055\u308C\u306A\u3044\u3002\n   *\n   * @param nodeId - \u4F9D\u5B58\u5148\u30CE\u30FC\u30C9\u306E ID\n   */\n  addDependency(nodeId: string): void {\n    this.dependencies.add(nodeId);\n  }\n\n  /**\n   * \u3053\u306E\u30CE\u30FC\u30C9\u304C\u4F9D\u5B58\u3057\u3066\u3044\u308B\u30CE\u30FC\u30C9 ID \u306E\u4E00\u89A7\u3092\u8FD4\u3059\u3002\n   * \u8FD4\u3055\u308C\u308B\u914D\u5217\u306F\u5185\u90E8\u306E\u4F9D\u5B58\u95A2\u4FC2\u30BB\u30C3\u30C8\u306E\u30B9\u30CA\u30C3\u30D7\u30B7\u30E7\u30C3\u30C8\u3067\u3042\u308A\u3001\n   * \u5909\u66F4\u3057\u3066\u3082\u5143\u306E\u30C7\u30FC\u30BF\u306B\u306F\u5F71\u97FF\u3057\u306A\u3044\u3002\n   *\n   * @returns \u4F9D\u5B58\u5148\u30CE\u30FC\u30C9 ID \u306E\u914D\u5217\n   */\n  get dependsOn(): string[] {\n    return Array.from(this.dependencies);\n  }\n}\n", "import type { FileSystem } from \"../core/file-system.js\";\nimport { FileSystem as DefaultFileSystem } from \"../core/file-system.js\";\nimport type { ConversationMemory } from \"./conversation-store.js\";\nimport type { WorkflowRunResult, WorkflowTimelineEntry } from \"./runner.js\";\n\nexport interface ErrorInfo {\n  name: string;\n  message: string;\n  stack?: string;\n  cause?: ErrorInfo | string;\n}\n\nexport type WorkflowTimelineRecord =\n  | {\n      type: \"run_start\";\n      timestamp: string;\n    }\n  | {\n      type: \"run_complete\";\n      timestamp: string;\n      status: \"succeeded\" | \"failed\";\n      durationMs: number;\n    }\n  | {\n      type: \"node_start\";\n      nodeId: string;\n      timestamp: string;\n      attempt: number;\n    }\n  | {\n      type: \"node_complete\";\n      nodeId: string;\n      timestamp: string;\n      durationMs: number;\n      attempt: number;\n    }\n  | {\n      type: \"node_retry\";\n      nodeId: string;\n      timestamp: string;\n      attempt: number;\n      nextDelayMs: number;\n      error: ErrorInfo;\n    }\n  | {\n      type: \"node_error\";\n      nodeId: string;\n      timestamp: string;\n      attempt: number;\n      error: ErrorInfo;\n    };\n\nexport interface WorkflowRunRecord {\n  runId: string;\n  workflowId: string;\n  status: \"succeeded\" | \"failed\";\n  startedAt: string;\n  finishedAt: string;\n  durationMs: number;\n  results: Record<string, unknown>;\n  errors: Record<string, ErrorInfo>;\n  attempts: Record<string, number>;\n  timeline: WorkflowTimelineRecord[];\n  conversationId?: string;\n  memory?: ConversationMemory;\n}\n\nexport interface RunStoreListOptions {\n  workflowId?: string;\n  limit?: number;\n}\n\nexport interface RunStore {\n  save(record: WorkflowRunRecord): Promise<void>;\n  get(runId: string): Promise<WorkflowRunRecord | undefined>;\n  list?(options?: RunStoreListOptions): Promise<WorkflowRunRecord[]>;\n}\n\nconst stringifyCause = (cause: unknown): string => {\n  try {\n    return JSON.stringify(cause);\n  } catch {\n    return String(cause);\n  }\n};\n\nconst toErrorInfo = (error: Error): ErrorInfo => {\n  const base: ErrorInfo = {\n    name: error.name,\n    message: error.message,\n    stack: error.stack,\n  };\n  const cause = (error as Error & { cause?: unknown }).cause;\n  if (cause instanceof Error) {\n    return { ...base, cause: toErrorInfo(cause) };\n  }\n  if (cause !== undefined) {\n    return { ...base, cause: stringifyCause(cause) };\n  }\n  return base;\n};\n\nconst serializeTimelineEntry = (\n  entry: WorkflowTimelineEntry,\n): WorkflowTimelineRecord => {\n  switch (entry.type) {\n    case \"run_start\":\n      return {\n        type: entry.type,\n        timestamp: entry.timestamp.toISOString(),\n      };\n    case \"run_complete\":\n      return {\n        type: entry.type,\n        timestamp: entry.timestamp.toISOString(),\n        status: entry.status,\n        durationMs: entry.durationMs,\n      };\n    case \"node_start\":\n      return {\n        type: entry.type,\n        nodeId: entry.nodeId,\n        timestamp: entry.timestamp.toISOString(),\n        attempt: entry.attempt,\n      };\n    case \"node_complete\":\n      return {\n        type: entry.type,\n        nodeId: entry.nodeId,\n        timestamp: entry.timestamp.toISOString(),\n        durationMs: entry.durationMs,\n        attempt: entry.attempt,\n      };\n    case \"node_retry\":\n      return {\n        type: entry.type,\n        nodeId: entry.nodeId,\n        timestamp: entry.timestamp.toISOString(),\n        attempt: entry.attempt,\n        nextDelayMs: entry.nextDelayMs,\n        error: toErrorInfo(entry.error),\n      };\n    case \"node_error\":\n      return {\n        type: entry.type,\n        nodeId: entry.nodeId,\n        timestamp: entry.timestamp.toISOString(),\n        attempt: entry.attempt,\n        error: toErrorInfo(entry.error),\n      };\n  }\n};\n\n/**\n * WorkflowRunResult \u3092\u6C38\u7D9A\u5316\u7528\u306E WorkflowRunRecord \u306B\u5909\u63DB\u3059\u308B\u3002\n *\n * Date \u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\u3092 ISO \u6587\u5B57\u5217\u306B\u3001Error \u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\u3092 ErrorInfo \u306B\u5909\u63DB\u3057\u3001\n * \u30B7\u30EA\u30A2\u30E9\u30A4\u30BA\u53EF\u80FD\u306A\u30EC\u30B3\u30FC\u30C9\u3092\u8FD4\u3059\u3002\n *\n * @param result - \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u5B9F\u884C\u7D50\u679C\n * @returns \u6C38\u7D9A\u5316\u7528\u306B\u5909\u63DB\u3055\u308C\u305F\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u5B9F\u884C\u30EC\u30B3\u30FC\u30C9\n */\nexport const toRunRecord = (result: WorkflowRunResult): WorkflowRunRecord => {\n  const errors: Record<string, ErrorInfo> = {};\n  for (const [nodeId, error] of Object.entries(result.errors)) {\n    errors[nodeId] = toErrorInfo(error);\n  }\n  return {\n    runId: result.runId,\n    workflowId: result.workflowId,\n    status: result.status,\n    startedAt: result.startedAt.toISOString(),\n    finishedAt: result.finishedAt.toISOString(),\n    durationMs: result.durationMs,\n    results: result.results,\n    errors,\n    attempts: result.attempts,\n    timeline: result.timeline.map(serializeTimelineEntry),\n    conversationId: result.conversationId,\n    memory: result.memory,\n  };\n};\n\n/**\n * RunStore \u306E\u30A4\u30F3\u30E1\u30E2\u30EA\u5B9F\u88C5\u3002\n *\n * \u5185\u90E8\u3067 Map \u3092\u4F7F\u7528\u3057\u3066\u30EC\u30B3\u30FC\u30C9\u3092\u4FDD\u6301\u3059\u308B\u3002\n * \u30C6\u30B9\u30C8\u3084\u77ED\u671F\u9593\u306E\u5B9F\u884C\u306A\u3069\u3001\u6C38\u7D9A\u5316\u304C\u4E0D\u8981\u306A\u5834\u5408\u306B\u9069\u3057\u3066\u3044\u308B\u3002\n */\nexport class InMemoryRunStore implements RunStore {\n  private readonly store = new Map<string, WorkflowRunRecord>();\n\n  /**\n   * \u30EC\u30B3\u30FC\u30C9\u3092\u30A4\u30F3\u30E1\u30E2\u30EA\u30B9\u30C8\u30A2\u306B\u4FDD\u5B58\u3059\u308B\u3002\n   *\n   * \u540C\u3058 runId \u306E\u30EC\u30B3\u30FC\u30C9\u304C\u65E2\u306B\u5B58\u5728\u3059\u308B\u5834\u5408\u306F\u4E0A\u66F8\u304D\u3055\u308C\u308B\u3002\n   *\n   * @param record - \u4FDD\u5B58\u3059\u308B\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u5B9F\u884C\u30EC\u30B3\u30FC\u30C9\n   */\n  async save(record: WorkflowRunRecord): Promise<void> {\n    this.store.set(record.runId, record);\n  }\n\n  /**\n   * \u6307\u5B9A\u3055\u308C\u305F runId \u306B\u5BFE\u5FDC\u3059\u308B\u30EC\u30B3\u30FC\u30C9\u3092\u53D6\u5F97\u3059\u308B\u3002\n   *\n   * @param runId - \u53D6\u5F97\u5BFE\u8C61\u306E\u5B9F\u884CID\n   * @returns \u8A72\u5F53\u3059\u308B\u30EC\u30B3\u30FC\u30C9\u3002\u5B58\u5728\u3057\u306A\u3044\u5834\u5408\u306F undefined\n   */\n  async get(runId: string): Promise<WorkflowRunRecord | undefined> {\n    return this.store.get(runId);\n  }\n\n  /**\n   * \u4FDD\u5B58\u3055\u308C\u3066\u3044\u308B\u30EC\u30B3\u30FC\u30C9\u306E\u4E00\u89A7\u3092\u8FD4\u3059\u3002\n   *\n   * workflowId \u306B\u3088\u308B\u30D5\u30A3\u30EB\u30BF\u30EA\u30F3\u30B0\u3084\u3001limit \u306B\u3088\u308B\u4EF6\u6570\u5236\u9650\u304C\u53EF\u80FD\u3002\n   *\n   * @param options - \u30D5\u30A3\u30EB\u30BF\u30EA\u30F3\u30B0\u304A\u3088\u3073\u4EF6\u6570\u5236\u9650\u306E\u30AA\u30D7\u30B7\u30E7\u30F3\n   * @returns \u6761\u4EF6\u306B\u4E00\u81F4\u3059\u308B\u30EC\u30B3\u30FC\u30C9\u306E\u914D\u5217\n   */\n  async list(options: RunStoreListOptions = {}): Promise<WorkflowRunRecord[]> {\n    const records = Array.from(this.store.values());\n    const filtered = options.workflowId\n      ? records.filter((record) => record.workflowId === options.workflowId)\n      : records;\n    if (options.limit && options.limit > 0) {\n      return filtered.slice(0, options.limit);\n    }\n    return filtered;\n  }\n}\n\nexport interface FileRunStoreOptions {\n  directory?: string;\n  fileSystem?: FileSystem;\n}\n\nconst DEFAULT_RUNS_DIRECTORY = \"runs\";\nconst RUN_FILE_EXTENSION = \".json\";\n\n/**\n * RunStore \u306E\u30D5\u30A1\u30A4\u30EB\u30D9\u30FC\u30B9\u5B9F\u88C5\u3002\n *\n * \u5404\u30EC\u30B3\u30FC\u30C9\u3092 JSON \u30D5\u30A1\u30A4\u30EB\u3068\u3057\u3066\u30C7\u30A3\u30EC\u30AF\u30C8\u30EA\u306B\u4FDD\u5B58\u3059\u308B\u3002\n * \u6C38\u7D9A\u5316\u304C\u5FC5\u8981\u306A\u672C\u756A\u74B0\u5883\u3067\u306E\u4F7F\u7528\u306B\u9069\u3057\u3066\u3044\u308B\u3002\n */\nexport class FileRunStore implements RunStore {\n  private readonly directory: string;\n  private readonly fs: FileSystem;\n\n  constructor(options: FileRunStoreOptions = {}) {\n    this.directory = options.directory ?? DEFAULT_RUNS_DIRECTORY;\n    this.fs = options.fileSystem ?? new DefaultFileSystem();\n  }\n\n  /**\n   * \u30EC\u30B3\u30FC\u30C9\u3092 JSON \u30D5\u30A1\u30A4\u30EB\u3068\u3057\u3066\u4FDD\u5B58\u3059\u308B\u3002\n   *\n   * \u30D5\u30A1\u30A4\u30EB\u540D\u306F runId \u306B\u57FA\u3065\u3044\u3066\u81EA\u52D5\u751F\u6210\u3055\u308C\u308B\u3002\n   *\n   * @param record - \u4FDD\u5B58\u3059\u308B\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u5B9F\u884C\u30EC\u30B3\u30FC\u30C9\n   */\n  async save(record: WorkflowRunRecord): Promise<void> {\n    const path = this.pathFor(record.runId);\n    await this.fs.writeJson(path, record);\n  }\n\n  /**\n   * \u6307\u5B9A\u3055\u308C\u305F runId \u306B\u5BFE\u5FDC\u3059\u308B\u30EC\u30B3\u30FC\u30C9\u3092 JSON \u30D5\u30A1\u30A4\u30EB\u304B\u3089\u8AAD\u307F\u8FBC\u3080\u3002\n   *\n   * \u30D5\u30A1\u30A4\u30EB\u304C\u5B58\u5728\u3057\u306A\u3044\u5834\u5408\u306F undefined \u3092\u8FD4\u3059\u3002\n   *\n   * @param runId - \u53D6\u5F97\u5BFE\u8C61\u306E\u5B9F\u884CID\n   * @returns \u8A72\u5F53\u3059\u308B\u30EC\u30B3\u30FC\u30C9\u3002\u30D5\u30A1\u30A4\u30EB\u304C\u5B58\u5728\u3057\u306A\u3044\u5834\u5408\u306F undefined\n   */\n  async get(runId: string): Promise<WorkflowRunRecord | undefined> {\n    const path = this.pathFor(runId);\n    if (!(await this.fs.exists(path))) {\n      return undefined;\n    }\n    return this.fs.readJson<WorkflowRunRecord>(path);\n  }\n\n  /**\n   * \u30C7\u30A3\u30EC\u30AF\u30C8\u30EA\u5185\u306E JSON \u30D5\u30A1\u30A4\u30EB\u304B\u3089\u30EC\u30B3\u30FC\u30C9\u306E\u4E00\u89A7\u3092\u8AAD\u307F\u8FBC\u3080\u3002\n   *\n   * workflowId \u306B\u3088\u308B\u30D5\u30A3\u30EB\u30BF\u30EA\u30F3\u30B0\u3084\u3001limit \u306B\u3088\u308B\u4EF6\u6570\u5236\u9650\u304C\u53EF\u80FD\u3002\n   * \u30C7\u30A3\u30EC\u30AF\u30C8\u30EA\u304C\u5B58\u5728\u3057\u306A\u3044\u5834\u5408\u306F\u7A7A\u914D\u5217\u3092\u8FD4\u3059\u3002\n   *\n   * @param options - \u30D5\u30A3\u30EB\u30BF\u30EA\u30F3\u30B0\u304A\u3088\u3073\u4EF6\u6570\u5236\u9650\u306E\u30AA\u30D7\u30B7\u30E7\u30F3\n   * @returns \u6761\u4EF6\u306B\u4E00\u81F4\u3059\u308B\u30EC\u30B3\u30FC\u30C9\u306E\u914D\u5217\n   */\n  async list(options: RunStoreListOptions = {}): Promise<WorkflowRunRecord[]> {\n    if (!(await this.fs.exists(this.directory))) {\n      return [];\n    }\n    const names = await this.fs.listDir(this.directory);\n    const records: WorkflowRunRecord[] = [];\n    for (const name of names) {\n      if (!name.endsWith(RUN_FILE_EXTENSION)) {\n        continue;\n      }\n      const record = await this.fs.readJson<WorkflowRunRecord>(\n        this.joinPath(name),\n      );\n      if (options.workflowId && record.workflowId !== options.workflowId) {\n        continue;\n      }\n      records.push(record);\n      if (\n        options.limit &&\n        options.limit > 0 &&\n        records.length >= options.limit\n      ) {\n        break;\n      }\n    }\n    return records;\n  }\n\n  /**\n   * \u6307\u5B9A\u3055\u308C\u305F runId \u306B\u5BFE\u5FDC\u3059\u308B\u30D5\u30A1\u30A4\u30EB\u30D1\u30B9\u3092\u751F\u6210\u3059\u308B\u3002\n   *\n   * @param runId - \u5B9F\u884CID\n   * @returns JSON \u30D5\u30A1\u30A4\u30EB\u306E\u30D5\u30EB\u30D1\u30B9\n   */\n  private pathFor(runId: string): string {\n    return this.joinPath(`${runId}${RUN_FILE_EXTENSION}`);\n  }\n\n  /**\n   * \u30C7\u30A3\u30EC\u30AF\u30C8\u30EA\u3068\u30D5\u30A1\u30A4\u30EB\u540D\u3092\u7D50\u5408\u3057\u3066\u30D1\u30B9\u3092\u751F\u6210\u3059\u308B\u3002\n   *\n   * @param fileName - \u30D5\u30A1\u30A4\u30EB\u540D\n   * @returns \u7D50\u5408\u3055\u308C\u305F\u30D5\u30A1\u30A4\u30EB\u30D1\u30B9\n   */\n  private joinPath(fileName: string): string {\n    return `${this.directory}/${fileName}`;\n  }\n}\n", "import { TZDate } from \"@date-fns/tz\";\nimport {\n  CyclicDependencyError,\n  DependencyError,\n  generateId,\n  InvalidArgumentError,\n  RuntimeError,\n} from \"../core/index.js\";\nimport type { ConversationMemory } from \"./conversation-store.js\";\nimport type { Node } from \"./node.js\";\nimport type { Workflow } from \"./workflow.js\";\n\nconst MIN_CONCURRENCY = 1;\nconst DEFAULT_CONCURRENCY = 4;\nconst DEFAULT_CHATFLOW_CONCURRENCY = 1;\nconst DEFAULT_FAIL_FAST = true;\nconst MIN_RETRY_ATTEMPTS = 1;\nconst MIN_BACKOFF_MULTIPLIER = 1;\nconst MIN_DELAY_MS = 0;\nconst DEFAULT_RETRY_MAX_ATTEMPTS = 1;\nconst DEFAULT_RETRY_INITIAL_DELAY_MS = 1000;\nconst DEFAULT_RETRY_BACKOFF_MULTIPLIER = 2;\nconst DEFAULT_RETRY_MAX_DELAY_MS = 30_000;\nconst DEFAULT_RETRY_JITTER_MS = 0;\nconst CHATFLOW_REQUIRES_CONVERSATION_ID =\n  \"Chatflow requires conversationId to run.\";\nconst ABORT_ERROR_NAME = \"AbortError\";\nconst ABORT_ERROR_MESSAGE = \"Workflow aborted\";\n\nexport interface WorkflowRunOptions<Context = unknown, Input = unknown> {\n  input?: Input;\n  context?: Context;\n  event?: unknown;\n  conversationId?: string;\n  memory?: ConversationMemory;\n  concurrency?: number;\n  failFast?: boolean;\n  onNodeStart?: (node: Node<Context, Input>) => void | Promise<void>;\n  onNodeComplete?: (\n    node: Node<Context, Input>,\n    result: unknown,\n  ) => void | Promise<void>;\n  onNodeError?: (\n    node: Node<Context, Input>,\n    error: Error,\n  ) => void | Promise<void>;\n  onNodeRetry?: (\n    node: Node<Context, Input>,\n    error: Error,\n    attempt: number,\n    nextDelayMs: number,\n  ) => void | Promise<void>;\n}\n\nexport type WorkflowTimelineEntry =\n  | {\n      type: \"run_start\";\n      timestamp: Date;\n    }\n  | {\n      type: \"run_complete\";\n      timestamp: Date;\n      status: \"succeeded\" | \"failed\";\n      durationMs: number;\n    }\n  | {\n      type: \"node_start\";\n      nodeId: string;\n      timestamp: Date;\n      attempt: number;\n    }\n  | {\n      type: \"node_complete\";\n      nodeId: string;\n      timestamp: Date;\n      durationMs: number;\n      attempt: number;\n    }\n  | {\n      type: \"node_retry\";\n      nodeId: string;\n      timestamp: Date;\n      attempt: number;\n      nextDelayMs: number;\n      error: Error;\n    }\n  | {\n      type: \"node_error\";\n      nodeId: string;\n      timestamp: Date;\n      attempt: number;\n      error: Error;\n    };\n\nexport interface WorkflowRunResult {\n  runId: string;\n  workflowId: string;\n  status: \"succeeded\" | \"failed\";\n  startedAt: Date;\n  finishedAt: Date;\n  durationMs: number;\n  results: Record<string, unknown>;\n  errors: Record<string, Error>;\n  attempts: Record<string, number>;\n  timeline: WorkflowTimelineEntry[];\n  conversationId?: string;\n  memory?: ConversationMemory;\n}\n\nconst createAbortError = (cause?: unknown): Error => {\n  const error = cause\n    ? new Error(ABORT_ERROR_MESSAGE, { cause })\n    : new Error(ABORT_ERROR_MESSAGE);\n  error.name = ABORT_ERROR_NAME;\n  return error;\n};\n\nconst resolveAbortError = (reason: unknown): Error =>\n  reason instanceof Error ? reason : createAbortError(reason);\n\nconst isAbortError = (error: unknown): error is Error =>\n  error instanceof Error && error.name === ABORT_ERROR_NAME;\n\nconst throwIfAborted = (signal?: AbortSignal): void => {\n  if (!signal?.aborted) {\n    return;\n  }\n  throw resolveAbortError(signal.reason);\n};\n\nconst withAbort = async <T>(\n  promise: Promise<T>,\n  signal?: AbortSignal,\n): Promise<T> => {\n  if (!signal) {\n    return promise;\n  }\n  if (signal.aborted) {\n    throw resolveAbortError(signal.reason);\n  }\n  return new Promise<T>((resolve, reject) => {\n    const onAbort = (): void => {\n      cleanup();\n      reject(resolveAbortError(signal.reason));\n    };\n    const cleanup = (): void => {\n      signal.removeEventListener(\"abort\", onAbort);\n    };\n    signal.addEventListener(\"abort\", onAbort, { once: true });\n    promise.then(\n      (value) => {\n        cleanup();\n        resolve(value);\n      },\n      (error) => {\n        cleanup();\n        reject(error);\n      },\n    );\n  });\n};\n\nconst sleep = (ms: number, signal?: AbortSignal): Promise<void> =>\n  new Promise((resolve, reject) => {\n    if (signal?.aborted) {\n      reject(resolveAbortError(signal.reason));\n      return;\n    }\n    let timeoutId: ReturnType<typeof setTimeout> | undefined;\n    let onAbort: (() => void) | undefined;\n    const cleanup = (): void => {\n      if (signal && onAbort) {\n        signal.removeEventListener(\"abort\", onAbort);\n      }\n    };\n    onAbort = (): void => {\n      if (timeoutId) {\n        clearTimeout(timeoutId);\n      }\n      cleanup();\n      reject(resolveAbortError(signal?.reason));\n    };\n    timeoutId = setTimeout(() => {\n      cleanup();\n      resolve();\n    }, ms);\n    if (!signal) {\n      return;\n    }\n    signal.addEventListener(\"abort\", onAbort, { once: true });\n    if (signal.aborted) {\n      onAbort();\n    }\n  });\n\nconst resolveRetryPolicy = (policy?: {\n  maxAttempts?: number;\n  initialDelayMs?: number;\n  backoffMultiplier?: number;\n  maxDelayMs?: number;\n  jitterMs?: number;\n}): {\n  maxAttempts: number;\n  initialDelayMs: number;\n  backoffMultiplier: number;\n  maxDelayMs: number;\n  jitterMs: number;\n} => ({\n  maxAttempts: Math.max(\n    MIN_RETRY_ATTEMPTS,\n    policy?.maxAttempts ?? DEFAULT_RETRY_MAX_ATTEMPTS,\n  ),\n  initialDelayMs: Math.max(\n    MIN_DELAY_MS,\n    policy?.initialDelayMs ?? DEFAULT_RETRY_INITIAL_DELAY_MS,\n  ),\n  backoffMultiplier: Math.max(\n    MIN_BACKOFF_MULTIPLIER,\n    policy?.backoffMultiplier ?? DEFAULT_RETRY_BACKOFF_MULTIPLIER,\n  ),\n  maxDelayMs: Math.max(\n    MIN_DELAY_MS,\n    policy?.maxDelayMs ?? DEFAULT_RETRY_MAX_DELAY_MS,\n  ),\n  jitterMs: Math.max(MIN_DELAY_MS, policy?.jitterMs ?? DEFAULT_RETRY_JITTER_MS),\n});\n\nconst computeRetryDelayMs = (\n  attempt: number,\n  policy: ReturnType<typeof resolveRetryPolicy>,\n): number => {\n  if (policy.maxAttempts <= 1) {\n    return 0;\n  }\n  const exponentialDelay =\n    policy.initialDelayMs * policy.backoffMultiplier ** (attempt - 1);\n  const boundedDelay = Math.min(exponentialDelay, policy.maxDelayMs);\n  if (policy.jitterMs <= 0) {\n    return boundedDelay;\n  }\n  return boundedDelay + Math.random() * policy.jitterMs;\n};\n\nconst cloneMemory = (memory: ConversationMemory): ConversationMemory =>\n  structuredClone(memory);\n\n/**\n * \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u306E\u5B9F\u884C\u30A8\u30F3\u30B8\u30F3\u3002\n *\n * \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u5185\u306E\u30CE\u30FC\u30C9\u3092\u4F9D\u5B58\u95A2\u4FC2\u306E\u9806\u5E8F\u306B\u5F93\u3063\u3066\u5B9F\u884C\u3059\u308B\u3002\n * \u540C\u6642\u5B9F\u884C\u6570\u306E\u5236\u5FA1\u3001\u30EA\u30C8\u30E9\u30A4\u30DD\u30EA\u30B7\u30FC\u306B\u3088\u308B\u518D\u8A66\u884C\u3001\n * \u304A\u3088\u3073 `AbortSignal` \u3092\u5229\u7528\u3057\u305F\u4E2D\u65AD\u3092\u30B5\u30DD\u30FC\u30C8\u3059\u308B\u3002\n */\nexport class Runner {\n  /**\n   * \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u3092\u5B9F\u884C\u3057\u3001\u3059\u3079\u3066\u306E\u30CE\u30FC\u30C9\u3092\u4F9D\u5B58\u95A2\u4FC2\u306E\u9806\u5E8F\u306B\u5F93\u3063\u3066\u51E6\u7406\u3059\u308B\u3002\n   *\n   * \u4F9D\u5B58\u95A2\u4FC2\u306E\u306A\u3044\u30CE\u30FC\u30C9\u304B\u3089\u9806\u306B\u3001\u8A2D\u5B9A\u3055\u308C\u305F\u540C\u6642\u5B9F\u884C\u6570\uFF08concurrency\uFF09\u306E\u7BC4\u56F2\u5185\u3067\n   * \u4E26\u5217\u306B\u30CE\u30FC\u30C9\u3092\u5B9F\u884C\u3059\u308B\u3002`failFast` \u304C\u6709\u52B9\u306A\u5834\u5408\u3001\u3044\u305A\u308C\u304B\u306E\u30CE\u30FC\u30C9\u3067\u30A8\u30E9\u30FC\u304C\n   * \u767A\u751F\u3057\u305F\u6642\u70B9\u3067\u6B8B\u308A\u306E\u5B9F\u884C\u3092\u4E2D\u65AD\u3059\u308B\u3002chatflow \u30BF\u30A4\u30D7\u306E\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u3067\u306F\n   * `conversationId` \u304C\u5FC5\u9808\u3068\u306A\u308A\u3001\u540C\u6642\u5B9F\u884C\u6570\u306E\u30C7\u30D5\u30A9\u30EB\u30C8\u306F 1 \u3068\u306A\u308B\u3002\n   *\n   * @typeParam Context - \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u5168\u4F53\u3067\u5171\u6709\u3055\u308C\u308B\u30B3\u30F3\u30C6\u30AD\u30B9\u30C8\u306E\u578B\n   * @typeParam Input - \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u3078\u306E\u5165\u529B\u30C7\u30FC\u30BF\u306E\u578B\n   * @param workflow - \u5B9F\u884C\u5BFE\u8C61\u306E\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u5B9A\u7FA9\n   * @param options - \u5B9F\u884C\u30AA\u30D7\u30B7\u30E7\u30F3\uFF08\u5165\u529B\u5024\u3001\u30B3\u30F3\u30C6\u30AD\u30B9\u30C8\u3001\u540C\u6642\u5B9F\u884C\u6570\u3001\u30B3\u30FC\u30EB\u30D0\u30C3\u30AF\u7B49\uFF09\n   * @returns \u5B9F\u884C\u7D50\u679C\uFF08\u30B9\u30C6\u30FC\u30BF\u30B9\u3001\u5404\u30CE\u30FC\u30C9\u306E\u7D50\u679C\u30FB\u30A8\u30E9\u30FC\u3001\u30BF\u30A4\u30E0\u30E9\u30A4\u30F3\u7B49\u3092\u542B\u3080\uFF09\n   * @throws {InvalidArgumentError} chatflow \u30BF\u30A4\u30D7\u3067 conversationId \u304C\u672A\u6307\u5B9A\u306E\u5834\u5408\n   * @throws {DependencyError} \u30CE\u30FC\u30C9\u304C\u5B58\u5728\u3057\u306A\u3044\u4F9D\u5B58\u5148\u3092\u53C2\u7167\u3057\u3066\u3044\u308B\u5834\u5408\n   * @throws {CyclicDependencyError} \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u306B\u5FAA\u74B0\u4F9D\u5B58\u304C\u542B\u307E\u308C\u3066\u3044\u308B\u5834\u5408\n   */\n  async run<Context = unknown, Input = unknown>(\n    workflow: Workflow<Context, Input>,\n    options: WorkflowRunOptions<Context, Input> = {},\n  ): Promise<WorkflowRunResult> {\n    const runId = generateId();\n    const startedAt = new TZDate();\n    const results: Record<string, unknown> = {};\n    const errors: Record<string, Error> = {};\n    const attempts: Record<string, number> = {};\n    const timeline: WorkflowTimelineEntry[] = [\n      { type: \"run_start\", timestamp: startedAt },\n    ];\n    const abortController = new AbortController();\n    const signal = abortController.signal;\n    const abortRun = (cause?: unknown): void => {\n      if (signal.aborted) {\n        return;\n      }\n      abortController.abort(createAbortError(cause));\n    };\n\n    const dependencies = new Map<string, Set<string>>();\n    const dependents = new Map<string, Set<string>>();\n    const nodes = workflow.getNodes();\n    const nodeIds = new Set(nodes.map((node) => node.id));\n    const chatflow = workflow.type === \"chatflow\";\n    if (\n      chatflow &&\n      (!options.conversationId || options.conversationId.trim().length === 0)\n    ) {\n      throw new InvalidArgumentError(CHATFLOW_REQUIRES_CONVERSATION_ID);\n    }\n\n    for (const node of nodes) {\n      for (const dep of node.dependsOn) {\n        if (!nodeIds.has(dep)) {\n          throw new DependencyError(\n            `Node ${node.id} depends on missing node: ${dep}`,\n          );\n        }\n      }\n    }\n\n    for (const node of nodes) {\n      dependencies.set(node.id, new Set(node.dependsOn));\n      dependents.set(node.id, new Set());\n    }\n\n    for (const node of nodes) {\n      for (const dep of node.dependsOn) {\n        const bucket = dependents.get(dep);\n        if (bucket) {\n          bucket.add(node.id);\n        }\n      }\n    }\n\n    const ready: Node<Context, Input>[] = nodes.filter(\n      (node) => (dependencies.get(node.id)?.size ?? 0) === 0,\n    );\n\n    const concurrency = Math.max(\n      MIN_CONCURRENCY,\n      options.concurrency ??\n        (chatflow ? DEFAULT_CHATFLOW_CONCURRENCY : DEFAULT_CONCURRENCY),\n    );\n    const failFast = options.failFast ?? DEFAULT_FAIL_FAST;\n    let memoryState: ConversationMemory | undefined = options.memory\n      ? cloneMemory(options.memory)\n      : chatflow\n        ? {}\n        : undefined;\n    const getMemory = (): ConversationMemory | undefined => memoryState;\n    const setMemory = (next: ConversationMemory): void => {\n      if (!memoryState) {\n        memoryState = {};\n      }\n      for (const key of Object.keys(memoryState)) {\n        delete memoryState[key];\n      }\n      Object.assign(memoryState, next);\n    };\n    const updateMemory = (patch: Partial<ConversationMemory>): void => {\n      if (!memoryState) {\n        memoryState = {};\n      }\n      Object.assign(memoryState, patch);\n    };\n\n    let aborted = false;\n    let completedCount = 0;\n\n    const inFlight = new Set<Promise<void>>();\n\n    const scheduleNode = (node: Node<Context, Input>): void => {\n      const task = this.runNode(\n        node,\n        workflow,\n        runId,\n        options,\n        results,\n        errors,\n        attempts,\n        timeline,\n        options.conversationId,\n        signal,\n        memoryState,\n        getMemory,\n        setMemory,\n        updateMemory,\n      )\n        .then(() => {\n          if (aborted) {\n            return;\n          }\n\n          const downstream = dependents.get(node.id);\n          if (!downstream) {\n            return;\n          }\n\n          for (const dependentId of downstream) {\n            const deps = dependencies.get(dependentId);\n            if (!deps) {\n              continue;\n            }\n\n            deps.delete(node.id);\n            if (deps.size === 0) {\n              const dependentNode = workflow.getNode(dependentId);\n              if (dependentNode) {\n                ready.push(dependentNode);\n              }\n            }\n          }\n        })\n        .catch((error) => {\n          if (failFast) {\n            aborted = true;\n            abortRun(error);\n          }\n        })\n        .finally(() => {\n          completedCount += 1;\n          inFlight.delete(task);\n        });\n      inFlight.add(task);\n    };\n\n    while (ready.length > 0 || inFlight.size > 0) {\n      while (!aborted && ready.length > 0 && inFlight.size < concurrency) {\n        const node = ready.shift();\n        if (!node) {\n          break;\n        }\n        scheduleNode(node);\n      }\n\n      if (inFlight.size === 0) {\n        break;\n      }\n\n      await Promise.race(inFlight);\n    }\n\n    const finishedAt = new TZDate();\n    const status = Object.keys(errors).length > 0 ? \"failed\" : \"succeeded\";\n    const durationMs = finishedAt.getTime() - startedAt.getTime();\n    timeline.push({\n      type: \"run_complete\",\n      timestamp: finishedAt,\n      status,\n      durationMs,\n    });\n\n    if (status === \"succeeded\" && completedCount < nodes.length) {\n      throw new CyclicDependencyError(\"Workflow contains a cyclic dependency\");\n    }\n\n    return {\n      runId,\n      workflowId: workflow.id,\n      status,\n      startedAt,\n      finishedAt,\n      durationMs,\n      results,\n      errors,\n      attempts,\n      timeline,\n      conversationId: options.conversationId,\n      memory: memoryState,\n    };\n  }\n\n  /**\n   * \u5358\u4E00\u30CE\u30FC\u30C9\u3092\u30EA\u30C8\u30E9\u30A4\u30DD\u30EA\u30B7\u30FC\u306B\u57FA\u3065\u3044\u3066\u5B9F\u884C\u3059\u308B\u3002\n   *\n   * \u30CE\u30FC\u30C9\u306E\u30CF\u30F3\u30C9\u30E9\u3092\u547C\u3073\u51FA\u3057\u3001\u6210\u529F\u3057\u305F\u5834\u5408\u306F\u7D50\u679C\u3092 `results` \u306B\u683C\u7D0D\u3059\u308B\u3002\n   * \u5931\u6557\u3057\u305F\u5834\u5408\u306F\u30EA\u30C8\u30E9\u30A4\u30DD\u30EA\u30B7\u30FC\uFF08\u6700\u5927\u8A66\u884C\u56DE\u6570\u3001\u6307\u6570\u30D0\u30C3\u30AF\u30AA\u30D5\u3001\u30B8\u30C3\u30BF\u30FC\uFF09\u306B\n   * \u5F93\u3063\u3066\u518D\u8A66\u884C\u3092\u884C\u3046\u3002\u3059\u3079\u3066\u306E\u8A66\u884C\u304C\u5931\u6557\u3057\u305F\u5834\u5408\u3001\u307E\u305F\u306F\u30A2\u30DC\u30FC\u30C8\u30B7\u30B0\u30CA\u30EB\u3092\n   * \u53D7\u4FE1\u3057\u305F\u5834\u5408\u306F\u30A8\u30E9\u30FC\u3092\u30B9\u30ED\u30FC\u3059\u308B\u3002\u5404\u6BB5\u968E\u3067\u30BF\u30A4\u30E0\u30E9\u30A4\u30F3\u30A8\u30F3\u30C8\u30EA\u306E\u8A18\u9332\u3068\n   * \u30B3\u30FC\u30EB\u30D0\u30C3\u30AF\u306E\u547C\u3073\u51FA\u3057\u3092\u884C\u3046\u3002\n   *\n   * @typeParam Context - \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u5168\u4F53\u3067\u5171\u6709\u3055\u308C\u308B\u30B3\u30F3\u30C6\u30AD\u30B9\u30C8\u306E\u578B\n   * @typeParam Input - \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u3078\u306E\u5165\u529B\u30C7\u30FC\u30BF\u306E\u578B\n   * @param node - \u5B9F\u884C\u5BFE\u8C61\u306E\u30CE\u30FC\u30C9\n   * @param workflow - \u30CE\u30FC\u30C9\u304C\u5C5E\u3059\u308B\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u5B9A\u7FA9\n   * @param runId - \u4ECA\u56DE\u306E\u5B9F\u884C\u3092\u8B58\u5225\u3059\u308B\u4E00\u610F\u306E ID\n   * @param options - \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u5B9F\u884C\u30AA\u30D7\u30B7\u30E7\u30F3\uFF08\u30B3\u30FC\u30EB\u30D0\u30C3\u30AF\u7B49\u3092\u542B\u3080\uFF09\n   * @param results - \u5404\u30CE\u30FC\u30C9\u306E\u5B9F\u884C\u7D50\u679C\u3092\u683C\u7D0D\u3059\u308B\u5171\u6709\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\n   * @param errors - \u5404\u30CE\u30FC\u30C9\u306E\u30A8\u30E9\u30FC\u3092\u683C\u7D0D\u3059\u308B\u5171\u6709\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\n   * @param attempts - \u5404\u30CE\u30FC\u30C9\u306E\u8A66\u884C\u56DE\u6570\u3092\u683C\u7D0D\u3059\u308B\u5171\u6709\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\n   * @param timeline - \u5B9F\u884C\u30BF\u30A4\u30E0\u30E9\u30A4\u30F3\u306E\u30A8\u30F3\u30C8\u30EA\u914D\u5217\n   * @param conversationId - \u4F1A\u8A71 ID\uFF08chatflow \u306E\u5834\u5408\u306B\u4F7F\u7528\uFF09\n   * @param signal - \u4E2D\u65AD\u3092\u691C\u77E5\u3059\u308B\u305F\u3081\u306E AbortSignal\n   * @param memory - \u4F1A\u8A71\u30E1\u30E2\u30EA\u306E\u73FE\u5728\u306E\u72B6\u614B\n   * @param getMemory - \u4F1A\u8A71\u30E1\u30E2\u30EA\u3092\u53D6\u5F97\u3059\u308B\u95A2\u6570\n   * @param setMemory - \u4F1A\u8A71\u30E1\u30E2\u30EA\u3092\u7F6E\u304D\u63DB\u3048\u308B\u95A2\u6570\n   * @param updateMemory - \u4F1A\u8A71\u30E1\u30E2\u30EA\u3092\u90E8\u5206\u66F4\u65B0\u3059\u308B\u95A2\u6570\n   * @throws \u30CE\u30FC\u30C9\u306E\u5168\u30EA\u30C8\u30E9\u30A4\u304C\u5931\u6557\u3057\u305F\u5834\u5408\u3001\u307E\u305F\u306F\u30A2\u30DC\u30FC\u30C8\u3055\u308C\u305F\u5834\u5408\u306B\u30A8\u30E9\u30FC\u3092\u30B9\u30ED\u30FC\u3059\u308B\n   */\n  private async runNode<Context = unknown, Input = unknown>(\n    node: Node<Context, Input>,\n    workflow: Workflow<Context, Input>,\n    runId: string,\n    options: WorkflowRunOptions<Context, Input>,\n    results: Record<string, unknown>,\n    errors: Record<string, Error>,\n    attempts: Record<string, number>,\n    timeline: WorkflowTimelineEntry[],\n    conversationId: string | undefined,\n    signal: AbortSignal,\n    memory: ConversationMemory | undefined,\n    getMemory: () => ConversationMemory | undefined,\n    setMemory: (next: ConversationMemory) => void,\n    updateMemory: (patch: Partial<ConversationMemory>) => void,\n  ): Promise<void> {\n    const policy = resolveRetryPolicy(node.retry);\n    for (let attempt = 1; attempt <= policy.maxAttempts; attempt += 1) {\n      try {\n        throwIfAborted(signal);\n        attempts[node.id] = attempt;\n        const nodeStart = new TZDate();\n        timeline.push({\n          type: \"node_start\",\n          nodeId: node.id,\n          timestamp: nodeStart,\n          attempt,\n        });\n\n        if (options.onNodeStart) {\n          await options.onNodeStart(node);\n        }\n\n        throwIfAborted(signal);\n        const output = await withAbort(\n          Promise.resolve(\n            node.handler({\n              workflowId: workflow.id,\n              nodeId: node.id,\n              runId,\n              conversationId,\n              context: options.context,\n              input: options.input,\n              event: options.event,\n              results,\n              getResult: <T = unknown>(nodeId: string) =>\n                results[nodeId] as T | undefined,\n              memory,\n              getMemory,\n              setMemory,\n              updateMemory,\n              signal,\n            }),\n          ),\n          signal,\n        );\n\n        results[node.id] = output;\n\n        if (options.onNodeComplete) {\n          await options.onNodeComplete(node, output);\n        }\n\n        const nodeFinish = new TZDate();\n        timeline.push({\n          type: \"node_complete\",\n          nodeId: node.id,\n          timestamp: nodeFinish,\n          durationMs: nodeFinish.getTime() - nodeStart.getTime(),\n          attempt,\n        });\n        return;\n      } catch (error: unknown) {\n        const err =\n          error instanceof Error\n            ? error\n            : new RuntimeError(String(error), { cause: error });\n\n        if (isAbortError(err)) {\n          errors[node.id] = err;\n          timeline.push({\n            type: \"node_error\",\n            nodeId: node.id,\n            timestamp: new TZDate(),\n            attempt,\n            error: err,\n          });\n\n          if (options.onNodeError) {\n            await options.onNodeError(node, err);\n          }\n\n          throw err;\n        }\n\n        if (attempt >= policy.maxAttempts) {\n          errors[node.id] = err;\n          timeline.push({\n            type: \"node_error\",\n            nodeId: node.id,\n            timestamp: new TZDate(),\n            attempt,\n            error: err,\n          });\n\n          if (options.onNodeError) {\n            await options.onNodeError(node, err);\n          }\n\n          throw err;\n        }\n\n        const nextDelayMs = computeRetryDelayMs(attempt, policy);\n        timeline.push({\n          type: \"node_retry\",\n          nodeId: node.id,\n          timestamp: new TZDate(),\n          attempt,\n          nextDelayMs,\n          error: err,\n        });\n\n        if (options.onNodeRetry) {\n          await options.onNodeRetry(node, err, attempt, nextDelayMs);\n        }\n\n        if (nextDelayMs > 0) {\n          try {\n            await sleep(nextDelayMs, signal);\n          } catch (sleepError: unknown) {\n            const sleepErr =\n              sleepError instanceof Error\n                ? sleepError\n                : new RuntimeError(String(sleepError), { cause: sleepError });\n            if (isAbortError(sleepErr)) {\n              errors[node.id] = sleepErr;\n              timeline.push({\n                type: \"node_error\",\n                nodeId: node.id,\n                timestamp: new TZDate(),\n                attempt,\n                error: sleepErr,\n              });\n\n              if (options.onNodeError) {\n                await options.onNodeError(node, sleepErr);\n              }\n            }\n            throw sleepErr;\n          }\n        }\n      }\n    }\n  }\n}\n", "import {\n  ConflictError,\n  CyclicDependencyError,\n  DependencyError,\n  generateId,\n  InvalidArgumentError,\n  NotFoundError,\n} from \"../core/index.js\";\nimport { Node, type NodeDefinition } from \"./node.js\";\n\nexport type WorkflowType = \"workflow\" | \"chatflow\";\n\nexport interface WorkflowDefinition<Context = unknown, Input = unknown> {\n  name?: string;\n  description?: string;\n  type?: WorkflowType;\n  nodes?: Array<Node<Context, Input> | NodeDefinition<Context, Input>>;\n}\n\nconst DEFAULT_WORKFLOW_TYPE: WorkflowType = \"workflow\";\nconst VALID_WORKFLOW_TYPES: readonly WorkflowType[] = [\"workflow\", \"chatflow\"];\n\n/**\n * \u30CE\u30FC\u30C9\u3068\u4F9D\u5B58\u95A2\u4FC2\u3067\u69CB\u6210\u3055\u308C\u308B\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u3092\u8868\u3059\u30AF\u30E9\u30B9\u3002\n *\n * \u30CE\u30FC\u30C9\u306E\u8FFD\u52A0\u30FB\u63A5\u7D9A\u30FB\u30C8\u30DD\u30ED\u30B8\u30AB\u30EB\u30BD\u30FC\u30C8\u306B\u3088\u308B\u5B9F\u884C\u8A08\u753B\u306E\u751F\u6210\u3092\u63D0\u4F9B\u3059\u308B\u3002\n *\n * @typeParam Context - \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u5B9F\u884C\u6642\u306B\u5171\u6709\u3055\u308C\u308B\u30B3\u30F3\u30C6\u30AD\u30B9\u30C8\u306E\u578B\n * @typeParam Input - \u5404\u30CE\u30FC\u30C9\u306B\u6E21\u3055\u308C\u308B\u5165\u529B\u306E\u578B\n */\nexport class Workflow<Context = unknown, Input = unknown> {\n  readonly id: string;\n  readonly name?: string;\n  readonly description?: string;\n  readonly type: WorkflowType;\n  private readonly nodes = new Map<string, Node<Context, Input>>();\n\n  /**\n   * \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u5B9A\u7FA9\u304B\u3089\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u30A4\u30F3\u30B9\u30BF\u30F3\u30B9\u3092\u751F\u6210\u3059\u308B\u3002\n   *\n   * \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u306E\u30BF\u30A4\u30D7\u306F\u300Cworkflow\u300D\u307E\u305F\u306F\u300Cchatflow\u300D\u3092\u6307\u5B9A\u53EF\u80FD\u3002\n   * \u5B9A\u7FA9\u306B\u30CE\u30FC\u30C9\u304C\u542B\u307E\u308C\u3066\u3044\u308B\u5834\u5408\u3001\u305D\u308C\u3089\u3092\u81EA\u52D5\u7684\u306B\u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u306B\u8FFD\u52A0\u3059\u308B\u3002\n   *\n   * @param definition - \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u306E\u5B9A\u7FA9\u30AA\u30D6\u30B8\u30A7\u30AF\u30C8\n   * @throws {InvalidArgumentError} \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u30BF\u30A4\u30D7\u304C\u4E0D\u6B63\u306A\u5834\u5408\n   */\n  constructor(definition: WorkflowDefinition<Context, Input>) {\n    this.id = generateId();\n    this.name = definition.name;\n    this.description = definition.description;\n    if (definition.type && !VALID_WORKFLOW_TYPES.includes(definition.type)) {\n      throw new InvalidArgumentError(\n        `Workflow type must be one of: ${VALID_WORKFLOW_TYPES.join(\", \")}`,\n      );\n    }\n    this.type = definition.type ?? DEFAULT_WORKFLOW_TYPE;\n\n    if (definition.nodes) {\n      for (const node of definition.nodes) {\n        this.addNode(node instanceof Node ? node : new Node(node));\n      }\n    }\n  }\n\n  /**\n   * \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u306B\u30CE\u30FC\u30C9\u3092\u8FFD\u52A0\u3059\u308B\u3002\n   *\n   * \u540C\u4E00ID\u306E\u30CE\u30FC\u30C9\u304C\u65E2\u306B\u5B58\u5728\u3059\u308B\u5834\u5408\u306F\u30A8\u30E9\u30FC\u3092\u30B9\u30ED\u30FC\u3059\u308B\u3002\n   *\n   * @param node - \u8FFD\u52A0\u3059\u308B\u30CE\u30FC\u30C9\n   * @throws {ConflictError} \u540C\u4E00ID\u306E\u30CE\u30FC\u30C9\u304C\u65E2\u306B\u5B58\u5728\u3059\u308B\u5834\u5408\n   */\n  addNode(node: Node<Context, Input>): void {\n    if (this.nodes.has(node.id)) {\n      throw new ConflictError(`Node already exists: ${node.id}`);\n    }\n\n    this.nodes.set(node.id, node);\n  }\n\n  /**\n   * 2\u3064\u306E\u30CE\u30FC\u30C9\u9593\u306B\u4F9D\u5B58\u95A2\u4FC2\u3092\u4F5C\u6210\u3057\u63A5\u7D9A\u3059\u308B\u3002\n   *\n   * fromNodeId \u304B\u3089 toNodeId \u3078\u306E\u4F9D\u5B58\u95A2\u4FC2\u3092\u8A2D\u5B9A\u3059\u308B\u3002\n   * \u3064\u307E\u308A\u3001toNodeId \u306E\u30CE\u30FC\u30C9\u306F fromNodeId \u306E\u30CE\u30FC\u30C9\u304C\u5B8C\u4E86\u3059\u308B\u307E\u3067\u5B9F\u884C\u3055\u308C\u306A\u3044\u3002\n   *\n   * @param fromNodeId - \u4F9D\u5B58\u5143\u306E\u30CE\u30FC\u30C9ID\uFF08\u5148\u306B\u5B9F\u884C\u3055\u308C\u308B\u30CE\u30FC\u30C9\uFF09\n   * @param toNodeId - \u4F9D\u5B58\u5148\u306E\u30CE\u30FC\u30C9ID\uFF08\u5F8C\u306B\u5B9F\u884C\u3055\u308C\u308B\u30CE\u30FC\u30C9\uFF09\n   * @throws {NotFoundError} \u6307\u5B9A\u3055\u308C\u305F\u30CE\u30FC\u30C9ID\u304C\u5B58\u5728\u3057\u306A\u3044\u5834\u5408\n   */\n  connect(fromNodeId: string, toNodeId: string): void {\n    const toNode = this.nodes.get(toNodeId);\n    if (!toNode) {\n      throw new NotFoundError(`Unknown node: ${toNodeId}`);\n    }\n\n    if (!this.nodes.has(fromNodeId)) {\n      throw new NotFoundError(`Unknown node: ${fromNodeId}`);\n    }\n\n    toNode.addDependency(fromNodeId);\n  }\n\n  /**\n   * \u6307\u5B9A\u3055\u308C\u305FID\u306E\u30CE\u30FC\u30C9\u3092\u53D6\u5F97\u3059\u308B\u3002\n   *\n   * @param nodeId - \u53D6\u5F97\u3059\u308B\u30CE\u30FC\u30C9\u306EID\n   * @returns \u8A72\u5F53\u3059\u308B\u30CE\u30FC\u30C9\u3002\u5B58\u5728\u3057\u306A\u3044\u5834\u5408\u306F `undefined`\n   */\n  getNode(nodeId: string): Node<Context, Input> | undefined {\n    return this.nodes.get(nodeId);\n  }\n\n  /**\n   * \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u306B\u767B\u9332\u3055\u308C\u3066\u3044\u308B\u5168\u30CE\u30FC\u30C9\u3092\u914D\u5217\u3068\u3057\u3066\u53D6\u5F97\u3059\u308B\u3002\n   *\n   * @returns \u5168\u30CE\u30FC\u30C9\u306E\u914D\u5217\n   */\n  getNodes(): Node<Context, Input>[] {\n    return Array.from(this.nodes.values());\n  }\n\n  /**\n   * \u30CE\u30FC\u30C9\u306E\u4F9D\u5B58\u95A2\u4FC2\u306B\u57FA\u3065\u3044\u3066\u30C8\u30DD\u30ED\u30B8\u30AB\u30EB\u30BD\u30FC\u30C8\u3092\u884C\u3044\u3001\u5B9F\u884C\u8A08\u753B\u3092\u751F\u6210\u3059\u308B\u3002\n   *\n   * \u4F9D\u5B58\u95A2\u4FC2\u306E\u306A\u3044\u30CE\u30FC\u30C9\u304B\u3089\u9806\u306B\u4E26\u3079\u3001\u5168\u30CE\u30FC\u30C9\u304C\u6B63\u3057\u3044\u5B9F\u884C\u9806\u5E8F\u3067\u8FD4\u3055\u308C\u308B\u3002\n   * \u5FAA\u74B0\u4F9D\u5B58\u304C\u691C\u51FA\u3055\u308C\u305F\u5834\u5408\u306F\u30A8\u30E9\u30FC\u3092\u30B9\u30ED\u30FC\u3059\u308B\u3002\n   *\n   * @returns \u30C8\u30DD\u30ED\u30B8\u30AB\u30EB\u30BD\u30FC\u30C8\u6E08\u307F\u306E\u30CE\u30FC\u30C9\u914D\u5217\uFF08\u5B9F\u884C\u9806\uFF09\n   * @throws {DependencyError} \u30CE\u30FC\u30C9\u304C\u5B58\u5728\u3057\u306A\u3044\u4F9D\u5B58\u5148\u3092\u53C2\u7167\u3057\u3066\u3044\u308B\u5834\u5408\n   * @throws {CyclicDependencyError} \u30EF\u30FC\u30AF\u30D5\u30ED\u30FC\u306B\u5FAA\u74B0\u4F9D\u5B58\u304C\u542B\u307E\u308C\u3066\u3044\u308B\u5834\u5408\n   */\n  getExecutionPlan(): Node<Context, Input>[] {\n    const nodes = this.getNodes();\n    const dependencies = new Map<string, Set<string>>();\n    const dependents = new Map<string, Set<string>>();\n\n    for (const node of nodes) {\n      dependencies.set(node.id, new Set(node.dependsOn));\n      if (!dependents.has(node.id)) {\n        dependents.set(node.id, new Set());\n      }\n    }\n\n    for (const node of nodes) {\n      for (const dep of node.dependsOn) {\n        if (!dependencies.has(dep)) {\n          throw new DependencyError(\n            `Node ${node.id} depends on missing node: ${dep}`,\n          );\n        }\n\n        const bucket = dependents.get(dep);\n        if (bucket) {\n          bucket.add(node.id);\n        }\n      }\n    }\n\n    const ready: Node<Context, Input>[] = nodes.filter(\n      (node) => (dependencies.get(node.id)?.size ?? 0) === 0,\n    );\n    const executionPlan: Node<Context, Input>[] = [];\n\n    while (ready.length > 0) {\n      const node = ready.shift();\n      if (!node) {\n        continue;\n      }\n\n      executionPlan.push(node);\n      const downstream = dependents.get(node.id);\n      if (!downstream) {\n        continue;\n      }\n\n      for (const dependentId of downstream) {\n        const deps = dependencies.get(dependentId);\n        if (!deps) {\n          continue;\n        }\n\n        deps.delete(node.id);\n        if (deps.size === 0) {\n          const dependentNode = this.nodes.get(dependentId);\n          if (dependentNode) {\n            ready.push(dependentNode);\n          }\n        }\n      }\n    }\n\n    if (executionPlan.length !== nodes.length) {\n      throw new CyclicDependencyError(\"Workflow contains a cyclic dependency\");\n    }\n\n    return executionPlan;\n  }\n}\n"],
  "mappings": "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",
  "names": ["MIN_RETRY_ATTEMPTS", "MIN_BACKOFF_MULTIPLIER", "MIN_DELAY_MS", "resolve", "cloneMemory"]
}
